define("dom/form",function(require,e){"use strict";function u(e,t){var n;return $.isPlainObject(t)?n=$.post(e,t,"json"):n=$.ajax({url:e,data:t,processData:!1,contentType:!1,dataType:"json",type:"POST"}),n}var t=require("underscore"),n="not support multiple file upload yet.",r=e.pack=function(e,r){var i;return r?i=t.clone(r):i={},t.has(e,"find")||(e=$(e)),e.find("[name]").each(function(e,t){var r;if(t.getAttribute("type")==="file"){r=t.files;if(!t.getAttribute("multiple")){if(!r[0])return!0;r=r[0]}else alert(n)}else r=t.value;i[t.getAttribute("name")]=r}),i},i=e.toFormData=function(e){var r=new FormData,i,s;for(var o in e)if(e.hasOwnProperty(o)){i=e[o],typeof i=="object"&&i.eq&&i.get&&(i=i.get(0));if(t.isElement(i))if(i.type&&i.type.toLowerCase()=="file")if(!i.getAttribute("multiple")){if(!i.files[0])continue;i=i.files[0]}else alert(n);else i=i.value;i!==null&&r.append(o,i)}return r},s=e.hasFile=function(e){return t.any(e.find('[type="file"]'),function(e){return e.value})},o=e.smartPack=function(e,t){var n;return Modernizr.ajaxfileupload&&s(e)?n=i(r(e,t)):n=r(e,t),n};e.post=function(t,n,r){return u(t,o(n,r))},e.validate={file:function(e){if(!e)throw new Error("you need to pass params to form.validate.file method, check the doc");if(!e.files)throw new Error("files is required for form.validate.file method");var n=e.files;if(!n.length)return n;var r={"image/jpeg":"jpg","image/png":"png","image/gif":"gif"},i={KB:Math.pow(1024,1),MB:Math.pow(1024,2),GB:Math.pow(1024,3)},s=$.extend({size:10*Math.pow(1024,2),types:e.$fileInput.attr("accept")||".jpg,.png,.gif"},e.rules);if({}.toString.apply(s.size)==="[object String]"){var o=s.size.toUpperCase().slice(s.size.length-2),u=parseInt(s.size.slice(0,s.size.length-2),10);s.size=u*i[o]}s.types=s.types.replace(/\./gi,"").split(",");for(var a=0;a<n.length;a++){var f=r[n[a].type];n[a].isSizeValid=n[a].size<s.size,n[a].isTypeValid=t.contains(s.types,f)}return n}}}),define("dom/lazy",function(require,e){"use strict";function i(e){e=e||{},e.buffer=e.buffer||200,e.InviewportScrollbody=e.InviewportScrollbody||window,e.direction=e.direction||"y";var r=e.scrollEl||window;r=$(r).get(0);var i=e.scopeEl||r;i=$(i).get(0),r.lazyStopImmediateCheck=e.stopImmediateCheck;var o=t.uniqueId();i.lazyId&&$(r).off("scroll.domlazy"+i.lazyId),i.lazyId=o,r.$lazyEls=null,r===window?s(r,i,e.direction,e.buffer):new n({el:r,buffer:e.buffer,scrollbody:e.InviewportScrollbody,cb:function(){s(r,i,e.direction,e.buffer)}})}function s(e,n,r,i){o(e,n,r,i),$(e).on("scroll.domlazy"+n.lazyId,t.throttle(function(){o(e,n,r,i)},400))}function o(e,t,n,r){var i=$(e),s=!1,o=u(t);o.length?o.each(function(t,i){if(a(e,i,n,r)){var s=$(i);s.removeClass("m-dom-lazy");var o=s.data("src"),u=s.data("bg-src"),f;o&&s.attr("src",o),u&&(u.indexOf("url")<0&&(u="url("+u+")"),s.css("background-image",u))}else if(e.lazyStopImmediateCheck||n==="x")return!1}):s=!0,s&&(i.off("scroll.domlazy"+t.lazyId),e.$lazyEls=null,t.lazyId=null)}function u(e){var t=e;e===window&&(e=document.body);if(t.$lazyEls)return t.$lazyEls=t.$lazyEls.filter(".m-dom-lazy"),t.$lazyEls;var n=$(e),r=n.find(".m-dom-lazy");return n.hasClass("m-dom-lazy")&&r.add($selector),r.length<=16&&(t.$lazyEls=r),r}function a(e,t,n,r){r=r||0,e=e||window;if(n==="x"){if(e===window)var i=document.documentElement&&document.documentElement.scrollLeft||document.body.scrollLeft,s=document.documentElement.clientWidth;else var i=e.scrollLeft,s=e.offsetWidth;var o=0,u=t;for(;;){o+=u.offsetLeft,u=u.offsetParent;if(!u||u===e)break}if(o<i+s+r)return!0}else{if(e===window)var a=document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop,f=document.documentElement.clientHeight;else var a=e.scrollTop,f=e.offsetHeight;var l=0,u=t;for(;;){l+=u.offsetTop,u=u.offsetParent;if(!u||u===e)break}if(l<a+f+r)return!0}return!1}var t=require("underscore"),n=require("ui/Inviewport"),r=require("utils/types");e.listen=i}),define("storage/local",function(require,e){"use strict";function s(e,r){if(e in i){var s=(new Date).getTime();if(s>i[e])return f(e),undefined}if(n){e="localStorage_"+e;var o=t.get(e);o&&(o=unescape(o))}else var o=localStorage.getItem(e);return o?window.JSON?JSON.parse(o):$.parseJSON(o):typeof r=="undefined"?null:r}function o(e,r,s){if(n)e="localStorage_"+e,t.set(e,escape(JSON.stringify(r)));else try{localStorage.setItem(e,JSON.stringify(r))}catch(u){n=!0,e="localStorage_"+e,t.set(e,escape(JSON.stringify(r)))}if(s){if(typeof s=="string"){var a=s.substr(s.length-1,1);s=parseInt(s);switch(a){case"S":break;case"M":s*=60;break;case"H":s*=3600;break;case"d":s*=86400;break;case"m":s*=2592e3;break;case"y":s*=31536e3;break;default:throw Error("The unit of `opt_expiredIn` parameter is not allowed.")}}var f=(new Date).getTime();i[e]=f+s*1e3,o("_expired",i)}}function u(e,t){var n=s("_delon")||{};$.type(t)==="string"&&(t=[t]);for(var r=0,i=t.length;r<i;++r){var u=t[r];n[u]||(n[u]=[]),$.inArray(u,n[u])===-1&&n[u].push(e)}o("_delon",n)}function a(e){var t=s("_delon")||{};for(var n in t)if(t.hasOwnProperty(n)&&n===e){for(var r=0,i=t[n].length;r<i;++r)f(t[n][r]);delete t[n]}o("_delon",t)}function f(e){n?(e="localStorage_"+e,t.del(e)):localStorage.removeItem(e),e in i&&(delete i[e],o("_expired",i))}function l(){var e=Array.prototype.slice.call(arguments);if(e.length)for(var t=0,n=e.length;t<n;++t)f(e[t]);else localStorage.clear()}var t=require("net/cookie"),n=!window.localStorage;if(!n&&Modernizr.webkit&&!Modernizr.chrome)try{localStorage.setItem("testSafariLocalstorage",1),localStorage.getItem("testSafariLocalstorage")?localStorage.removeItem("testSafariLocalstorage"):n=!0}catch(r){n=!0}var i={};return i=s("_expired")||{},{get:s,set:o,del:f,clear:l,delOn:u,doDelOn:a}}),define("css/styleSheets",function(require,e){"use strict";function n(e,n,r){n=t.css(n);var i,s=!1;for(var o=0;o<document.styleSheets.length;o++){if(document.styleSheets[o].href&&document.styleSheets[o].href.indexOf("http")===0&&document.styleSheets[o].href.indexOf(document.domain)===-1)continue;if(document.styleSheets[o].cssRules)i="cssRules";else{if(!document.styleSheets[o].rules)break;i="rules"}for(var u=0;u<document.styleSheets[o][i].length;u++)if(document.styleSheets[o][i][u].selectorText===e&&document.styleSheets[o][i][u].style[n]){document.styleSheets[o][i][u].style[n]=r,s=!0;break}s||(document.styleSheets[o].insertRule?document.styleSheets[o].insertRule(e+" {"+n+": "+r+";}",document.styleSheets[o][i].length):document.styleSheets[o].addRule&&document.styleSheets[o].addRule(e,n+":"+r+";"))}}var t=require("css/vendor");e.insertRule=n}),define("css/transitionend",function(){"use strict";function s(n,r){var s=function(){var i=!1;n.one(t,function(){i||(i=!0,r())});if(Modernizr.webkit)return;var s=n.css("transition-duration");s&&(s=s.split(","),s=parseFloat(e.max(s,function(e){return parseFloat(e)}))*1e3,e.isNumber(s)&&setTimeout(function(){i||(i=!0,r())},s))};Modernizr.csstransitions?t===null?i.done(function(e){t=e,s(),i=null}):s():r()}var e=require("underscore"),t=null,n={transition:"transitionEnd",OTransition:"oTransitionEnd",WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",msTransition:"MSTransitionEnd"},r=function(){var e=$.Deferred(),t=e.then(function(e){return e});if(Modernizr.webkit){var r=$('<div id="css-transitionend"></div>').appendTo(document.body),i;r.css("height","0"),r.css("opacity","0"),r.css("transition","all 0.2s linear"),r.css("-webkit-transition","all 0.2s linear"),r.one("transitionend webkitTransitionEnd transitionEnd -webkit-transitionend WebkitTransitionEnd",function(t){e.resolve(t.type),r.remove()}),r.width(),r.css("height","1px"),r.css("opacity","1")}else e.resolve(n[Modernizr.prefixed("transition")]);return t},i=r();return s}),define("css/vendor",function(require,e){e.dom=function(e){return Modernizr.prefixed(e)},e.css=function(e){return Modernizr.prefixed(e.replace(/-([A-Za-z])/g,function(e,t){return t.toUpperCase()})).replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-")}}),define("ui/backdrop",function(require,e,t){"use strict";var n=require("css/transitionend"),r=$('<div class="m-backdrop" style="display:none;"></div>').appendTo(document.body),i=$.noop,s=!1,o=!1,u;e.show=function(t){return t=t||{},o=!0,u=$.Deferred(),n(r,function(){s=!0,o=!1,u.resolve(s)}),r.attr("class",t.className?"m-backdrop "+t.className:"m-backdrop"),r[t.loader?"addClass":"removeClass"]("with-loader"),r.show(),r.width(),r.css({opacity:1}),t.isBlack&&(r.addClass("m-backdrop-black"),r.css({opacity:.5})),t.anywhereHide&&r.one("click",function(){e.hide()}),e},e.hide=function(){return s&&(o=!0,u=$.Deferred(),n(r,function(){s=!1,o=!1,r.hide(),u.resolve(s)})),r.css({opacity:0}).off(".uibackdrop"),r.width(),s||r.hide(),i(),i=$.noop,e},e.onclick=function(t){return r.on("click.uibackdrop",function(e){t()}),e},e.onhide=function(t){return i=t,e},e.isShown=function(){return o?u:(u=$.Deferred(),u.resolve(s),u)}}),define("ui/carousel",function(require,e){"use strict";var t=require("underscore"),e={},n={},r=function(e){};return e.add=function(e,t,r){var i=$(r);if(!(e.find(t).length>0)){e.removeClass("empty").html("");var s=$('<div class="m-carousel-clip"></div>'),o=$('<div class="m-carousel-holder"></div>');e.append(s),s.append(o),o.html(i);return}e.find(t+":first-child").before(i);var u=e.find(".m-carousel-holder"),a=e.find(".m-carousel-clip"),f=a.width();n[id].$lastItem=u.children().last(),n[id].lastItemW=n[id].$lastItem.outerWidth(),n[id].lastItemLeft=n[id].$lastItem.position().left,n[id].totalPage=Math.ceil((n[id].lastItemLeft+n[id].lastItemW)/f),n[id].page=2,e.find(".m-carousel-prev").trigger("click")},e.render=function(e,r,i){i=i?i:{};var s=t.uniqueId("c");n[s]={},n[s].$lastItem=null,n[s].lastItemW=null,n[s].lastItemLeft=null,n[s].page=1,n[s].totalPage=1,n[s].frozen=!1,n[s].$carousel=e;if(n[s].$carousel.find(r).length){var o=n[s].$carousel.find(".m-carousel-holder"),u=$('<div class="m-carousel-prev s-disabled" data-action="m-carousel-prev"></div>'),a=$('<div class="m-carousel-next" data-action="m-carousel-next"></div>'),f=e.find(".m-carousel-clip"),l=f.width(),c=!1,h=1e6,p=i.perpage?i.perpage:4,d=n[s].$carousel.height();n[s].$lastItem=o.children().last(),n[s].lastItemW=n[s].$lastItem.outerWidth(),n[s].lastItemLeft=n[s].$lastItem.position().left,n[s].page=1,n[s].totalItem=f.find(".cell").length,n[s].totalPage=Math.round((n[s].lastItemLeft+n[s].lastItemW)/l),n[s].totalPage<2&&a.addClass("s-disabled");if(i.startAt&&i.startAt>1){n[s].page=i.startAt;var v=n[s].page;v=v>n[s].totalPage?n[s].totalPage:v;var m=o.children().eq((v-1)*p);t.delay(function(){o.animate({left:-m.position().left},1e3),n[s].page===n[s].totalPage?a.removeClass("s-disabled"):u.removeClass("s-disabled")},1)}n[s].$carousel.on("auto."+s+" resume."+s,function(e){setTimeout(function(){if(c)return;var e=$(this),t=e.data("action"),r=n[s].page+1,i;r=r>n[s].totalPage?n[s].totalPage:r,i=o.children().eq((r-1)*p),n[s].page=r;try{o.animate({left:-i.position().left},1e3)}catch(f){}u.removeClass("s-disabled"),n[s].totalPage===1&&a.addClass("s-disabled"),n[s].page===1?(u.addClass("s-disabled"),a.removeClass("s-disabled"),n[s].$carousel.trigger("auto")):n[s].page===n[s].totalPage?(n[s].page=0,a.addClass("s-disabled"),n[s].$carousel.trigger("auto")):n[s].page!==1&&n[s].$carousel.trigger("auto")},h)}),n[s].$carousel.addClass("m-carousel"),o.css("position","relative"),n[s].$carousel.append(u),n[s].$carousel.append(a),u.css("top",121),a.css("top",121),n[s].totalItem>p&&n[s].$carousel.trigger("auto"),n[s].$carousel.on("mouseenter",function(){c=!0}),n[s].$carousel.on("mouseleave",function(){if(n[s].frozen)return;n[s].frozen=!0,setTimeout(function(){n[s].$carousel.trigger("resume"),c=!1,n[s].frozen=!1},5e3)}),n[s].$carousel.on("click."+s,"[data-action]",function(e){var t=$(this),r=t.data("action"),i;switch(r){case"m-carousel-prev":i=n[s].page-1,i=i<1?1:i;break;case"m-carousel-next":i=n[s].page+1,i=i>n[s].totalPage?n[s].totalPage:i}var f=o.children().eq((i-1)*p);if(!f.length)return;n[s].page=i,f!==null&&o.animate({left:-f.position().left},400),u.removeClass("s-disabled"),a.removeClass("s-disabled"),n[s].page===1&&u.addClass("s-disabled"),(n[s].totalPage===1||n[s].page===n[s].totalPage)&&a.addClass("s-disabled")})}},e}),define("ui/coverflow",function(require,e){"use strict";var t=require("underscore"),n=require("css/vendor"),r=require("libs/jquery.mousewheel"),i={current:0,link:!1,scrollBuffer:!1,isClick:!1};return i.scrollHandler=function(e,n){if(i.scrollBuffer){i.scrollBuffer=!1;return}i.scrollBuffer=!0;var r=e.target.scrollLeft,s=i.itemW,o;if(!i.isClick&&Math.abs(r-i.scrollLeft)<i.itemW/3)return;r>i.scrollLeft?o=Math.ceil(s?r/s:0):o=Math.floor(s?r/s:0),o=o<i.items.length?o:i.items.length-1,n.css("left",-(o*s)+i.center);if(i.current===o){i.scrollBuffer=!1;return}i.scrollLeft=r,i.current=o;for(var u=0;u<i.items.length;u++){var a=$(i.items[u]);u<o?a.addClass("s-past").removeClass("s-next").removeClass("s-current"):u===o?(a.removeClass("s-past").removeClass("s-next").addClass("s-current"),i.link=$(i.items[o]).attr("href")):a.addClass("s-next").removeClass("s-past").removeClass("s-current")}t.delay(function(){i.scrollBuffer=!1,i.isClick=!1},100)},e.init=function(e,t,n){var r,s,o,u=$('<div class="m-coverflow-wrapper"></div>'),a=$('<div class="m-coverflow-btn" data-click="prev"></div>'),f=$('<div class="m-coverflow-btn" data-click="next"></div>');n=n||{},i.items=e.find(t),s=i.items,r=s.length;for(var l=0;l<r;l++)l?$(s[l]).addClass("m-coverflow-item s-next"):(i.itemW=$(s[l]).outerWidth(),i.wrapperW=e.parent().outerWidth(),$(s[l]).addClass("m-coverflow-item s-current"));n.indent=n.indent?n.indent:0,i.center=(i.wrapperW-i.itemW)/2+n.indent;var c=0;e.addClass("m-coverflow").wrap(u).width(i.itemW*r+i.center*2),o=u.clone().append(e.clone()),e.css({left:Modernizr.csstransforms3d?i.center:0}),o.addClass("m-coverflow-scroller").insertAfter(e.parent()),a.insertAfter(o),f.insertAfter(a),o.on("scroll",function(t){i.scrollHandler(t,e)}),$("body").mousewheel(function(t,n){t.target.id===e.attr("id")&&(o.get(0).scrollLeft-=n*i.itemW,t.preventDefault())}),a.on("click",function(e){e.preventDefault(),i.isClick=!0,i.current>0&&o.animate({scrollLeft:i.itemW*(i.current-1)},100)}),f.on("click",function(e){e.preventDefault(),i.isClick=!0,i.current<i.items.length-1&&o.animate({scrollLeft:i.itemW*(i.current+1)},100)}),o.on("click",function(e){e.preventDefault(),i.link&&(n.ga?(_gaq.push(n.ga),setTimeout(function(){location.href=i.link},50)):location.href=i.link)}),$(s[0]).addClass("m-coverflow-item s-current"),$(s[1]).addClass("m-coverflow-item s-next"),i.link=$(s[0]).attr("href"),r>2&&o.animate({scrollLeft:i.itemW*(i.current+1)},100)},e}),define("ui/cropper",function(require,e){"use strict";var t=require("underscore"),n={},r={};return r.markup='<div class="transformer" style="background-image:url(<%= img.url %>);background-position:<%= trans.left %> <%= trans.top %>;width:<%= img.width %>;height:<%= img.height %>"><img src="<%= img.url %>"/><span class="drag left top" data-direction="lefttop" draggable="true"></span><span class="drag right top" data-direction="righttop" draggable="true"></span><span class="drag left bottom" data-direction="leftbottom" draggable="true"></span><span class="drag right bottom" data-direction="rightbottom" draggable="true"></span><div id="transmove" class="transmove" draggable="true"></div></div><div id="item" class="item" style="background-image:url(<%= img.url %>);background-position:<%= item.bg.x %> <%= item.bg.y %>;width:<%= item.width %>px;height:<%= item.height %>px;"><span id="itemmove" class="itemmove" draggable="false"></span></div>',r.destroy=function(e,t){e.unbind("click"),this.backdrop.remove(),e.remove(),setTimeout(function(){t.removeClass("in-cropping")},1)},r.restore=function(e){var t=r.original_data.item,n=r.original_data.trans;e!==undefined?r.el.css({"background-position":t.bg.x+"px "+t.bg.y+"px","background-size":t.bg.width+"px "+t.bg.height+"px"}):(r.trans.css({top:n.top+"px",left:n.left+"px",width:n.width+"px",height:n.height+"px"}),r.item.css({"background-position":t.bg.x+"px "+t.bg.y+"px","background-size":t.bg.width+"px "+t.bg.height+"px"}))},r.save=function(){var e=r.item.css("background-position"),t=r.item.css("background-size"),i=r.imgw,s=parseInt(t.split(" ")[0],10)/i;s=Math.round(s*100),r.el.css("background-position",e),r.el.css("background-size",t),e=e.replace(/px/g,""),e=e.split(" "),e[0]=Math.round(parseInt(e[0],10)),e[1]=Math.round(parseInt(e[1],10)),e=e.join(":"),n.data={backgroundPosition:e,ratio:s},$("body").trigger("cropper-save")},r.dragging=function(e,t,n,r,i,s,o){var u,a,f,l,c=parseInt(e.position().left,10)+parseInt(e.css("width"),10),h=parseInt(e.position().top,10)+parseInt(e.css("height"),10),p=parseInt(t.position().top,10)+parseInt(t.css("height"),10),d=parseInt(t.position().left,10)+parseInt(t.css("width"),10),v=!1;u=n.x,a=n.y,f=u-r,l=a-i,Math.abs(n.x-r)>s&&(v=!0),Math.abs(n.y-i)>o&&(v=!0);var m="";d<c&&(m+="l"),p<h&&(m+="t");if($.trim(m)!==""){n.preventDefault();return}v||(l>0?(t.css("top",0),l=0):t.css("top",l),f>0?(t.css("left",0),f=0):t.css("left",f),e.css("background-position",f+"px "+l+"px"))},r.init=function(e,t,i){var s=$(".drag"),o=$(".transformer"),u=document.getElementById("transmove"),a=$("#item"),f=document.getElementById("itemmove"),l,c,h,p,d="background-position",v="background-size",m=1,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_=!0,D=!1,P=!1,H,B,j,F=new Image,I=$(".transformer img");r.trans=o,r.item=a,B=function(e,t,n,i){t.addClass("ani"),e.addClass("ani");if(t.width()<e.width()||t.height()<e.height()){r.restore();return}var s=e.css("background-position").split(" "),o=1,u=0-(parseInt(t.css("width"),10)-n.right)+o+"px ",a=0-(parseInt(t.css("height"),10)-n.bottom)+o+"px";i==="lt"?(t.css("left",u),t.css("top",a)):i==="l"?(a=s[1],t.css("left",u)):i==="t"&&(u=s[0],t.css("top",a)),e.css("background-position",u+a),setTimeout(function(){t.removeClass("ani"),e.removeClass("ani")},200)},j=function(){var e,t;e=function(){D=!0;var e=Math.round(C*l/k);i.item.bg.cover===!0&&(o.css({width:l,height:e,top:0-Math.round(e-c)/2+0,left:0+m}),r.item.css({"background-size":l+"px "+e+"px","background-position":"0 "+(0-Math.round(e-c)/2)+"px"})),r.original_data.item.bg.x=0,r.original_data.item.bg.y=0-Math.round(e-c)/2,r.original_data.item.bg.width=l,r.original_data.item.bg.height=e,r.original_data.trans.width=l,r.original_data.trans.height=e,r.original_data.trans.top=0-Math.round(e-c)/2,r.original_data.trans.left=0+m},t=function(){P=!0;var e=Math.round(k*c/C);i.item.bg.cover===!0&&(o.css({width:e,height:c,top:0,left:0-(e-l)/2}),r.item.css({"background-size":e+"px "+c+"px","background-position":0-(e-l)/2+"px "+"0"})),r.original_data.item.bg.x=0-(e-l)/2,r.original_data.item.bg.y=0,r.original_data.item.bg.width=e,r.original_data.item.bg.height=c,r.original_data.trans.width=e,r.original_data.trans.height=c,r.original_data.trans.top=0,r.original_data.trans.left=0-(e-l)/2+m},l=parseInt(r.el.css("width"),10),c=parseInt(r.el.css("height"),10),g=parseInt(r.el.position().left,10),y=parseInt(r.el.position().top,10),h=g+l,p=y+c,o.addClass("init"),a.addClass("init"),$("#cropper").css({top:parseInt(r.el.position().top)+m,left:parseInt(r.el.position().left)+m}),i.item.bg.cover===!0?r.item.css(v,"cover"):(r.item.css(d,i.item.bg.x+" "+i.item.bg.y),r.item.css(v,i.item.bg.width+" "+i.item.bg.height),r.trans.css({opacity:.3,width:i.item.bg.width,height:i.item.bg.height,top:i.item.bg.y,left:i.item.bg.x})),l>c?k>C?k/l<C/c?e():t():e():k>C?t():k/l<C/c?e():t()},F.addEventListener("load",function(e){k=e.target.width,C=e.target.height,L=k,A=C,r.imgw=k,H=k/C,j()}),F.src=I.attr("src"),s.on("dragstart",function(e){o.addClass("dragging"),a.addClass("dragging"),o.removeClass("init"),a.removeClass("init");var t=e.originalEvent,n=e.target.getAttribute("data-direction");E=!0,S=e.originalEvent.x,x=e.originalEvent.y,O=parseInt(o.css("width"),10),M=parseInt(o.css("height"),10),e.originalEvent.dataTransfer.effectAllowed="move",T=parseInt(o.css("left"),10),N=parseInt(o.css("top"),10)}),s.on("drag",function(e){var t=e.originalEvent,n=e.target.getAttribute("data-direction"),r=O+(t.x-S),i=M+(t.y-x),s=a.css("background-position"),u,f,h={};n==="lefttop"&&(r=O+(S-t.x),i=M+(x-t.y)),n==="righttop"&&(r=O+(t.x-S),t.y-x>0?i=M-(t.y-x):i=M+(t.y-x)),n==="leftbottom"&&(t.x-S>0?r=O-(t.x-S):r=O+(t.x-S),i=M+(t.y-x)),u=Math.abs(r),f=Math.abs(i);if(t.x===0&&t.y===0)return;if(E){E=!1;return}e.stopPropagation(),u/f<H?u=f*H:f=u*(1/H);if(!(u<L&&f<A))return;k=u,C=f,a.css(v,u+"px "+f+"px"),o.css({height:f,width:u});switch(n){case"lefttop":_&&!D?(h.top=-f-(M===c?0:c)+M,h.left=-(u-O)):(h.top=-f+M+N,h.left=0-(u-parseInt(O,10))+T),a.css(d,h.left+"px "+h.top+"px"),o.css({top:h.top,left:h.left});break;case"righttop":_&&!D?(h.top=-f-(M===c?0:c)+M,h.left=-(O-l)):(h.top=-f+M+N,h.left=T),a.css(d,h.left+"px "+h.top+"px"),o.css({top:h.top,left:h.left});break;case"leftbottom":_&&!P?h.left=0-parseInt(u-O,10):h.left=0-parseInt(u-O,10)+T,a.css(d,h.left+"px "+a.css(d).split(" ")[1]),o.css({left:h.left});break;default:P?s=0-(parseInt(s[0],10)+o.position().left)+"px "+(0-(parseInt(s[1],10)+o.position().top))+"px":s=0-parseInt(s[0],10)+"px "+(0-parseInt(s[1],10))+"px",a.css(d,s)}}),s.on("dragend",function(e){o.removeClass("dragging"),a.removeClass("dragging"),_&&(_=!1);var t="",n={},r={},i=a.css(d).split(" ");n.left=parseInt(a.position().left,10)+m,n.right=n.left+parseInt(a.css("width"),10)+m,n.top=parseInt(a.position().top,10)+m,n.bottom=n.top+parseInt(a.css("height"),10)+m,r.top=parseInt(o.position().top,10),r.bottom=r.top+parseInt(o.css("height"),10),r.left=parseInt(o.position().left,10),r.right=r.left+parseInt(o.css("width"),10),e.preventDefault(),r.left>n.left&&(t+="r"),r.top>n.top&&(t+="b"),r.right<n.right&&(t+="l"),r.bottom<n.bottom&&(t+="t"),$.trim(t)!==""&&B(a,o,n,t)}),s.on("dragover",function(e){e.preventDefault()}),u.addEventListener("dragstart",function(e){o.addClass("dragging"),a.addClass("dragging"),o.removeClass("init"),a.removeClass("init"),e.dataTransfer.effectAllowed="move",b=e.x-o.position().left,w=e.y-o.position().top}),u.addEventListener("drag",function(e){r.dragging(a,o,e,b,w,k,C)}),u.addEventListener("dragover",function(e){e.preventDefault()}),u.addEventListener("dragend",function(e){o.removeClass("dragging"),a.removeClass("dragging");var t="",n={},r,i,s=a.css(d).split(" ");n.right=parseInt(a.position().left,10)+parseInt(a.css("width"),10),n.bottom=parseInt(a.position().top,10)+parseInt(a.css("height"),10),i=parseInt(o.position().top,10)+parseInt(o.css("height"),10),r=parseInt(o.position().left,10)+parseInt(o.css("width"),10),e.preventDefault(),r<n.right&&(t+="l"),i<n.bottom&&(t+="t"),$.trim(t)!==""&&B(a,o,n,t)}),e.on("click",function(i){switch($(i.target).attr("data-action")){case"cropper-submit":i.preventDefault(),r.save(o),r.destroy(e,t),n.getData(a,o);break;case"cropper-cancel":i.preventDefault(),$("body").trigger("cropper-cancel"),r.destroy(e,t);break;case"cropper-restore":i.preventDefault(),r.restore()}})},n.getData=function(e,t){var n="item background-size: "+e.css("background-size")+"<br>item background-position: "+e.css("background-size");return t!==undefined&&(n+="<br>trans width: "+t.css("width")+"<br>trans height: "+t.css("height")+"<br>trans left top (x,y): ("+t.position().left+", "+t.position().top+")"+"<br>trans right bottom (x,y): ("+(parseInt(t.position().left,10)+parseInt(t.css("width"),10))+", "+(parseInt(t.position().top,10)+parseInt(t.css("height"),10))+")"+"<br>item left top (x,y): ("+e.position().left+", "+e.position().top+")"+"<br>item right bottom (x,y): ("+(parseInt(e.position().left,10)+parseInt(e.css("width"),10))+", "+(parseInt(e.position().top,10)+parseInt(e.css("height"),10))+")"),n},n.render=function(e,n,i){e=$(e),r.el=e,e.addClass("in-cropping");var s=e.css("background-position").split(" "),o=e.css("background-size").split(" "),u={img:{url:n,width:0,height:0},item:{width:parseInt(e.css("width"),10),height:parseInt(e.css("height"),10),bg:{cover:!1,width:o[0],height:o[1],x:s[0],y:s[1]}},trans:{top:0,left:0,width:0,height:0}},a=new Image;u.item.bg.width==="cover"&&(u.item.bg.width=0,u.item.bg.height=0,u.item.bg.cover=!0),a.addEventListener("load",function(n){var s=$('<div id="cropper"></div>'),o=$('<div class="btnset"></div>');u.img.width=a.width+"px",u.img.height=a.height+"px",$(t.template(r.markup,u)).appendTo(s),r.submitBtn=$('<a role="button" class="m-button-tiny" data-action="cropper-submit">儲存</a>'),r.cancelBtn=$('<a role="button" data-action="cropper-cancel">取消</a>'),r.resetBtn=$('<a role="button" data-action="cropper-restore">重設</a>'),r.submitBtn.appendTo(o),r.cancelBtn.appendTo(o),r.resetBtn.appendTo(o),s.append(o),r.backdrop=$('<div id="cropper-backdrop" class="cropper-backdrop"></div>'),r.backdrop.css("height",window.innerHeight+"px"),r.backdrop.appendTo($("body")),s.appendTo($(i)),s.addClass("cropper"),r.init(s,e,u),$(window).on("resize",function(){r.backdrop.css("height",window.innerHeight+"px")}),r.original_data=u}),a.addEventListener("error",function(e){alert("Image does not exist.")}),a.src=n},n}),define("ui/discountBadge",function(require,e){"use strict";var t=require("i18n"),n=require("settings"),r=require("underscore");e.processData=function(e){var i="",s="";return e.free_shipping&&(!e.discount||e.discount>=75)?(i=t.gettext("免運"),s="g-discount-badge-free-shipping"):e.discount&&(s="g-discount-badge-discount",n.get("locale").indexOf("zh")===0?i=r.template(t.gettext("<%= discount %><span>折</span>"),{discount:e.discount.toString().replace("0","")}):i=r.template(t.gettext("<%= discount %>%<span>OFF</span>"),{discount:100-e.discount})),{discountBadgeText:i,discountBadgeClass:s}},e.render=function(t){var n=e.processData(t),i="";return n.discountBadgeText&&(i=r.template('<div class="g-discount-badge <%= discountBadgeClass %>"><div><%= discountBadgeText %></div></div>',n)),i}}),define("ui/drawerBar",function(require,e){"use strict";var t=0,n=require("i18n"),r,i=function(e,n){if(e)++t,r.data("show",!0),r.slideDown(500,function(){window.setTimeout(function(){o()},4e3)}),$.browser.msie&&parseInt($.browser.version,10)<7&&rePositionInIE6();else{--t;if(t<=0||n)r.slideUp(300).data("show",!1),t=0}},s=function(e){function u(){$(window).load(function(){$(window).scroll(function(){r.data("show")==1&&r.css({top:$(document).scrollTop()})})})}t=0,r=$("#g-drawer");var n,s=!1,o;o=function(){r.data("show",!1),n=r.find("div").eq(0),r.bind("click",function(e){r.data("show",!1),t=0,r.hide()}),s=!0},r.length?o():$(function(){r=$("#g-drawer"),r.length||(r=$('<div id="g-drawer" class="g-drawer-bar"><div></div></div>'),$(document.body).append(r)),o()}),s&&(t>=1?n.append('<div class="sep"></div>'+e):n.html(e),i(!0))},o=function(e){i(!1,e)};return e.show=s,e.hide=o,e}),define("ui/fillimg",function(require,e){return require("jquery.imagesloaded"),function(e,t,n){var r=$(e);e.is("img")||(r=r.find("img").eq(0));if(!t){var i=r.parent();t=i.width(),n=i.height()}r.imagesLoaded(function(e){var r=e.eq(0),i=r.width(),s=r.height(),o;t>i&&(o=t/i,i=t,s*=o),n>s&&(o=n/s,s=n,i*=o);var u=Math.max(t/i,n/s),a=parseInt(i*u),f=parseInt(s*u);r.css({width:a,height:f,top:-parseInt((f-n)/2),left:-parseInt((a-t)/2)})})}}),define("ui/html5Upload",function(require,e){"use strict";var t=require("underscore"),n=require("dom/form"),r=require("i18n"),i=require("settings"),s=require("ui/drawerBar"),o=!1,u={ie:{zh_TW:"http://windows.microsoft.com/zh-tw/internet-explorer/download-ie",zh_CN:"http://windows.microsoft.com/zh-cn/internet-explorer/download-ie",en:"http://windows.microsoft.com/en-us/internet-explorer/download-ie",ja:"http://windows.microsoft.com/ja-jp/internet-explorer/download-ie",th:"http://windows.microsoft.com/th-th/internet-explorer/download-ie"},chrome:"https://www.google.com/chrome/browser/desktop/"},a=t.template('<div class="download-browser-tip">'+r.gettext('您使用的瀏覽器不支援照片上傳，建議更新您的瀏覽器來達到最佳瀏覽體驗，請點<a href="<%= downloadLink %>" target="_blank">此連結</a>前往下載。')+"</div>",{downloadLink:Modernizr.ie?u.ie[i.get("locale")]:u.chrome}),f=['<div id="html5-upload-progress" class="html5-upload-progress">','<p id="html5-upload-progress-text">',r.gettext("正在上傳..."),"</p>",'<div class="html5-upload-progress-bar-wrap">','<div id="html5-upload-progress-bar" class="html5-upload-progress-bar"></div>',"</div>","</div>"].join(""),l='<div id="err-msgs" class="err-msgs"></div>',c="<p><%= errMsg %></p>",h=r.gettext("檔案太大，檔案大小不能超過 <%= reqSizeLimit %>"),p=r.gettext("檔案格式有誤，請重新檢查是否為 png, jpg, jpeg 或 gif 圖片檔"),d=$(l),v=$(f),m=v.find("#html5-upload-progress-text"),g=v.find("#html5-upload-progress-bar");return e.init=function(e){e=$.extend({error:!0},e);if(!e.$container)throw new Error("$container is required for html5Upload.init method");var t=e.$container;e.progress&&t.append(v),e.error&&t.append(d)},e.emptyErrMsgs=function(){d.empty()},e.$progress=v,e.validate={file:function(e,r){r=$.extend({reqSizeLimit:"10 MB"},r);var i=n.validate.file({$fileInput:e,files:e[0].files});if(!i.length)return i;var s=t.filter(i,function(e){return!e.isSizeValid||!e.isTypeValid}),o="";if(!s.length)return i;if(s.length<10)for(var u=0;u<s.length;u++){var a=s[u];a.isSizeValid||(o+=t.template(c,{errMsg:a.name+" "+t.template(h,{reqSizeLimit:r.reqSizeLimit})})),a.isTypeValid||(o+=t.template(c,{errMsg:a.name+" "+p}))}else{var f=t.template(h,{reqSizeLimit:r.reqSizeLimit}),l=p,v=!1,m=!1;for(var u=0;u<s.length;u++){var g=s[u];g.isSizeValid||(v||(v=!0),f+=" "+g.name),g.isTypeValid||(m||(m=!0),l+=" "+g.name)}o=""+(v?t.template(c,{errMsg:f}):"")+(m?t.template(c,{errMsg:l}):"")}return o&&d.append(o),i}},e.updateProgress=function(e,t){t=$.extend({reqSuccessCounter:1,reqQueue:[""]},t);if(e.lengthComputable){var n=e.loaded/e.total,r=Math.ceil((t.reqSuccessCounter+n)/t.reqQueue.length*95).toString()+"%";g.css({width:r})}},e.addErrMsgs=function(e){d.append(t.template(c,{errMsg:e}))},e.showUploadingUI=function(){o=!0,pinkoi.loader.on(),s.show(r.gettext("檔案正在上傳中，請耐心稍候片刻.....")),v.show(),m.text(r.gettext("正在上傳...")),$(window).on("beforeunload",function(){return r.gettext("離開頁面後，將會立即停止上傳.......")})},e.showDoneUI=function(){o=!1,g.css({width:"100%"}),m.text(r.gettext("✔ 商品上傳完成")),pinkoi.loader.off(),s.show(r.gettext("✔ 商品上傳完成"))},e.showFailUI=function(){o=!1,v.fadeOut(),m.text(r.gettext("✘ 上傳失敗，請重新整理網頁之後再試一次或稍後再試")),d.append(t.template(c,{errMsg:r.gettext("✘ 上傳失敗，請重新整理網頁之後再試一次或稍後再試")})),pinkoi.loader.off()},e.support=Modernizr.ajaxfileupload,e.downloadTip=a,e}),define("ui/Infinitescroll",function(require,e){"use strict";function n(e,n,r){this.$indicator=$(e),this.fetch=n,this.page=r||1,this.inviewport=new t({el:this.$indicator,cb:$.proxy(this._fetch,this),buffer:100})}var t=require("ui/Inviewport");return n.prototype._fetch=function(){++this.page;var e=this.fetch(this.page);return e},n}),define("ui/Inviewport",function(require,e){"use strict";function i(e){var t=this,r;this.$el=$(e.el);if(!this.$el.length)throw Error("This DOM element is not existed.");this.el=this.$el.get(0),this.cb=e.cb,this.buffer=typeof e.buffer!="undefined"?e.buffer:10,this._id=n.uniqueId("uiInviewport"),this.scrollbody=document.getElementById(e.scrollbody)||e.scrollbody||window,this.$scrollbody=$(this.scrollbody),this.scrollbody=this.$scrollbody.get(0),this.cacheHeight=this.$scrollbody.height(),r=this._id,this.scrollbody===window&&$(window).on("resize."+r,n.debounce(function(){t.resize(),t.isShown&&$(window).off("resize."+r)},350)),this.on()}var t=require("settings"),n=require("underscore"),r=require("utils/types");return i.prototype.isShown=function(){var e=this.cacheHeight;if(this.scrollbody===window)var t=document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop,n=this.$el.offset().top;else{var n=0,r=this.el;for(;;){n+=r.offsetTop,r=r.offsetParent;if(!r||r===this.scrollbody)break}var t=this.scrollbody.scrollTop}return n<e+t+this.buffer?!0:!1},i.prototype.on=function(){if(!!this._monitoring)return;this._monitoring=!0,this._on();var e=this;this.$scrollbody.on("scroll."+this._id,n.throttle(function(){e._on()},350))},i.prototype._on=function(){if(this.isShown()&&this._monitoring){this.off();var e=this.cb.call(this);if(e===!0)this.on();else if(r.isDeferred(e)){var t=this;e.done(function(){t.on()})}}},i.prototype.off=function(){this._monitoring=!1,this.$scrollbody.off("scroll."+this._id)},i.prototype.resize=function(){this.cacheHeight=this.$scrollbody.height()},i}),define("ui/localeNotice",function(require,e){"use strict";var t=require("settings"),n=require("underscore"),r,i=require;r=i(t.get("mobile")?"mui/modal":"ui/modal");var s='<div class="m-locale-notice"><h2><%= text.description %></h2><form action="/apiv2/i18n/set_locale" method="POST"><div class="select-wrapper"><%= locale %><%= currency %></div><a data-click="submit" class="'+(t.get("mobile")?"m-btn-important":"m-button")+'"><%= text.confirm %></a>'+"</form>"+"</div>"
,o='<select class="m-select" name="<%= type %>" required><% for(var i=0; i< data.available.length; i++) { %><option value="<%= data.available[i].value %>" <%= (data.available[i].value === data.selected) ? "selected" : "" %>><%= data.available[i].name %></option><% } %></select>';return e.init=function(){var e=t.get("suggestedLocale");if(!e)return;t.get("locale")!==e.locale.selected&&(r.show(n.template(s,{text:e.text,locale:n.template(o,{data:e.locale,type:"locale"}),currency:n.template(o,{data:e.currency,type:"currency"})}),{anywhereHide:!1,verticalCenter:!0,backdrop:!0}),r.on(Modernizr.touch?"touchstart":"click",'[data-click="submit"]',function(e){e.preventDefault(),r.$body.find("form").submit()}))},e}),define("ui/modal",["exports","env","css/transitionend","ui/backdrop"],function(e,t,n,r){"use strict";function a(a,l){i.off(".uimodal"),l=l||{};if(l.withBackdrop!==!1){var c={isBlack:l.blackBackdrop||!1,className:l.className||""};o=!0,r.show(c)}l.on_hide_cb&&(u=l.on_hide_cb),i.attr("class",l.className?"m-modal-wrap "+l.className:"m-modal-wrap"),s.html(a),e.rePosition(),n(i,function(){i.removeClass("m-modal-transitioning")}),i.css({top:-100,opacity:0}).addClass("m-modal-transitioning").show(),s.html(a),i.addClass("m-modal-transitioning").show(),i.width();var h=t.browser==="msie"&&t.browserVersion<8?document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop:0,p=window.scrollY>0?window.scrollY:0;return i.css({top:p+90,opacity:1}),$(window).on("resize.uimodal",function(){e.rePosition()}),l.anywhereHide!==!1&&r.onclick(f),e}function f(){return $(window).off(".uimodal"),i.off(".uimodal"),e.rePosition(),o&&(r.hide(),o=!1),u&&u(),n(i,function(){i.removeClass("m-modal-transitioning").hide()}),i.addClass("m-modal-transitioning").css({top:-150,opacity:0}),s.trigger("modal-hide"),e}function l(t,n,r){var s=t.split(" "),o=[];for(var u=0,a=s.length;u<a;++u)s[u]&&o.push(s[u]+".uimodal");return i.on(o.join(" "),n,r),e}function c(){i.removeAttr("style"),s.removeAttr("style");var e=document.documentElement,t=e.clientHeight<i.height(),n=(e.clientWidth-i.width())/2,r=i.width()>e.clientWidth?e.clientWidth-20:i.width(),o=$("body").scrollTop()+($(window).height()-i.height())/2,u=i.height();o=o<0?0:o,i.css({left:n,width:r,height:u,top:o,opacity:1}),t?s.css({"overflow-y":"scroll"}):(s.height("auto"),i.height("auto"))}var i=$('<div class="m-modal-wrap" style="display:none;"><div class="m-modal"></div><div class="m-modal-close" onclick="require(\'ui/modal\').hide();"></div></div>').appendTo(document.body),s=i.find(".m-modal"),o,u;i.on("click","[data-click]",function(t){var n=$(t.target),r=n.data("click");switch(r){case"m-modal-hide":e.hide()}}),e.show=a,e.hide=f,e.on=l,e.$body=s,e.rePosition=c}),define("ui/requestAnimation",function(){"use strict";var e=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();return function(t){e(t)}}),define("ui/richtext",function(require,e){"use strict";function t(e,t){t=t||{};var n=e,r=!1,i="",s="";return n=n.replace(/__([^gda_\*\r\n<]+)__/gi,'<u class="m-richtext-el">$1</u>'),n=n.replace(/\*\*([^_\*\r\n<]+)\*\*/gi,'<b class="m-richtext-el">$1</b>'),n=n.replace(/\*([^_\*\r\n<]+)\*/gi,'<i class="m-richtext-el">$1</i>'),n=n.replace(/\-\-([^_\*\r\n<]+)\-\-/gi,'<del class="m-richtext-el">$1</del>'),t.imageonload&&(i=' onload="'+t.imageonload+'"'),t.imageonerror&&(s=' onerror="'+t.imageonerror+'"'),n=n.replace(/(https?:\/\/[=\.\+\-\_\/#\w\?\&%~;,:!\(\)]+)(?: \((\S+)\))?/gi,function(e,n,o){n.indexOf("fbcdn")!==-1&&(r=!0);if(!o&&/(?:\.png|\.jpg|\.jpeg|\.gif)/i.test(n))return t.lazy?'<img class="m-dom-lazy m-richtext-el m-richtext-img" src="http://cdn04.pinkoi.com/pinkoi.site/space.gif" data-src="'+n+'" '+i+" "+s+">":'<img class="m-richtext-el m-richtext-img" src="'+n+'"'+i+" "+s+">";if(o&&o.indexOf("http")===0&&/(?:\.png|\.jpg|\.jpeg|\.gif)$/i.test(o))return t.lazy?'<a class="m-richtext-el m-richtext-img-link" href="'+n+'"><img class="m-dom-lazy m-richtext-el m-richtext-img" data-src="'+o+'" '+i+" "+s+"></a>":'<a class="m-richtext-el m-richtext-img-link" href="'+n+'"><img class="m-richtext-el m-richtext-img" src="'+o+'" '+i+" "+s+"></a>";if(n.indexOf("youtube.com")!==-1&&n.indexOf("v=")!==-1){var u=n.match(/v=([^&]+)/i)[1];return'<iframe class="m-richtext-el m-richtext-video" src="http://www.youtube.com/embed/'+u+'" frameborder="0" allowfullscreen></iframe>'}if(n.indexOf("youtu.be")!==-1){var u=n.match(/([\w\-_]+)$/i)[1];return'<iframe class="m-richtext-el m-richtext-video" src="http://www.youtube.com/embed/'+u+'" frameborder="0" allowfullscreen></iframe>'}if(n.indexOf("vimeo.com")!==-1){var u=n.match(/([\w\-_]+)$/i)[1];return'<iframe class="m-richtext-el m-richtext-video" src="http://player.vimeo.com/video/'+u+'" frameborder="0" allowfullscreen></iframe>'}return o?'<a class="m-richtext-el m-richtext-link" href="'+n+'" target="_blank">'+(o.length>35?o.substr(0,35)+"...":o)+"</a>":'<a class="m-richtext-el m-richtext-link" href="'+n+'" target="_blank">'+(n.length>40?n.substr(7,35)+"...":n.substr(7))+"</a>"}),r&&(n=n.replace(/&amp;/gi,"&")),n=n&&n.replace(/\n/g,"<br>"),t.imageonload&&(location.hash=document.height),n}e.parse=t,e.replace=function(e,n){var r=$(e),i=r.find(".m-richtext");i.add(r.filter(".m-richtext")).each(function(e){var r=$(this);n&&n.isios?r.data("richtext",1).html(t(r.text(),n)):r.data("richtext",1).html(t(r.html(),n))})}}),define("ui/scrolltotop",function(require,e){"use strict";function u(){if(s)return;s=!0,a(),o.on("scroll.ui/scrolltotop",t.throttle(a,350))}function a(){var e=document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop;e>400?(i||(i=!0,Modernizr.csstransitions&&r.css("bottom",-65),r.show(),Modernizr.csstransitions&&(r.width(),r.css("bottom",0))),Modernizr.positionfixed||r.css("top",o.height())):i&&(i=!1,r.css("bottom",-65),n(r,function(){r.hide()}))}var t=require("underscore"),n=require("css/transitionend"),r=$('<buttton class="m-scrolltotop" style="display:none;"></button>').appendTo(document.body),i=!1,s=!1,o=$(window);r.on("click",function(){$("html,body").animate({scrollTop:0},450)}),Modernizr.positionfixed||r.css({position:"absolute",bottom:"auto"}),e.init=u}),define("ui/sticky",function(require,e){"use strict";var t=require("underscore"),n=!1,r,i=function(e,t){return e.offset().top-t};e.init=function(e,s){var o,u,a;s=s||{},r=$(e);if(!r.length)return;a=r.height(),$(window).on("scroll.ui.sticky",t.debounce(function(e){var t=document.body.scrollTop;!o&&o!==0&&(o=r.offset().top),!s.dynamicBottom&&!u&&s.bottomEl?u=i(s.bottomEl,a):s.dynamicBottom&&s.bottomEl&&(u=i(s.bottomEl,a)),t>o&&!n&&(!u||t<u)?(r.css("position","fixed"),r.css("top","0"),n=!0):u&&t>u&&n?(r.css("position","absolute"),r.css("top",u-(s.bottomPaddingTop?s.bottomPaddingTop:0)+"px"),n=!1):document.body.scrollTop<o-50&&(r.css("position","static"),n=!1)},10))},e.off=function(){$(window).off("scroll.ui.sticky"),n&&(document.body.scrollTop=0,r.css("position","static"),n=!1)}}),define("ui/tel",function(require,e){"use strict";var t=require("app/modules/intltelinput");e.intlTelFields=function(e,n){var r=$(n),i=$(e);t.init(i),i.val($.trim(i.val())),i.on("keyup",function(e){var t=$(this),n=$.trim(t.val()),r=/[^\d\+]/g;r.test(n)&&(n=n.replace(r,""),t.val(n)),n.indexOf("+")!==0&&(n="+"+n,t.val(n)),r=/(.)\++/g,r.test(n)&&(n=n.replace(r,"$1"),t.val(n))}),r.on("keyup",function(e){var t=$(this),n=$.trim(t.val()),r=/[^\d\+\ \-\(\)]/g;r.test(n)&&t.val(n.replace(r,""))})},e.concatTel=function(e,t){var n=$(t),r=$(e);return $.trim(r.val())+$.trim(n.val())}}),define("ui/toaster",["exports","css/transitionend","external/facebook"],function(e,t,n){"use strict";var r=require("underscore"),i=require("i18n"),s=$('<div id="m-toaster" class="m-toaster"></div>'),o=$('<a class="m-button-stretch"></a>'),u=$('<a class="m-button-stretch"></a>'),a=function(e,f){var l=$('<span class="m-toaster-close"></span>');f=f||{},s.removeClass("show"),s.html(e),s.append(l),f.button_link&&f.button_text&&(o.html(f.text).attr("href",f.button_link),s.append(o)),f.fb_share&&(f.fb_share.cb=function(e){e?a(i.gettext("已經分享到你的塗鴉牆了"),{hide:!0}):a(i.gettext("糟糕！發生不明錯誤，可能是你沒開放塗鴉牆"),{hide:!0})},u.html(i.gettext("分享至 Facebook")).one("click",function(){n.publish(f.fb_share),s.removeClass("show")}),s.append(u)),f.hide!==!1&&t(s,function(){setTimeout(function(){s.removeClass("show")},f.delay?f.delay:5e3)}),f.h_align&&r.contains(["left","center"],f.h_align)&&s.addClass(f.h_align),f.bottom&&(r.isNumber(f.bottom)?s.css("bottom",f.bottom+"px"):s.css("bottom",f.bottom)),f.className&&s.addClass(f.className),l.one("click",function(){s.removeClass("show")}),setTimeout(function(){s.addClass("show")},500)},f=function(){s.removeClass("show")};$("body").append(s),e.show=a,e.hide=f}),define("ui/tooltip",function(require,e){"use strict";var t={},n;return n=$('<div id="tooltip" class="tooltip"></div>'),n.appendTo($("body")),t.on=!1,t.show=function(e,t,r){this.on=!0;var i=[],s,o,u;u=function(e){return Math.round(parseInt(e,10))},e=$(e),s=u(e.css("width")),o=u(e.css("height")),i=[Math.round(e.offset().left),Math.round(e.offset().top)],n.attr("data-pos",t),n.css("opacity","1"),n.html(r);switch(t){case"rb":n.css("top",i[1]+(o+10)+"px"),n.css("left",i[0]+(s-u(n.css("width"))-10)+"px");break;case"cb":n.css("top",i[1]+(o+10)+"px"),n.css("left",i[0]+(s-u(n.css("width")))/2+"px")}},t.close=function(){this.on=!1,n.attr("data-pos",""),n.css("opacity","0")},t.init=function(){var e=require("ui/modal"),t=this;e.$body.on("modal-hide",function(){t.close()})},t.init(),t}),define("ui/waterfall",function(e,t){"use strict";function N(e){m=e.page||0,g=e.pageLimit||50,g+=m,w=e.onpageLimit||$.noop,b=e.parseAjax,a=e.getUrl,u=e.afterFetch||$.noop,E=e.onBeforeRepaint||$.noop,i=$(e.indicator),s=$(e.container);var l=e.cellConfig;f=l.height;if(typeof f=="number"){var y=f;f=function(){return y}}return c=l.width,h=l.margin,d=e.preprocessRows,v=e.postRender,T=new r(i,o),e.cellTemplate&&(p=n.template($(e.cellTemplate).html())),A(),t}function C(e){var t=e.cellConfig;if(t.height){f=t.height;if(typeof f=="number"){var n=f;f=function(){return n}}}c=t.width||c,h=t.margin||h}function k(e){d&&d(e);if(f)var t=$("<div/>");for(var n=0,r=e.length;n<r;++n){var i=L(),o;e[n].desc=e[n].description,e[n].customizedHTML?o=e[n].customizedHTML:p?o=p(e[n]):o=l(e[n]);var u=$(o);u.css({left:y[i].left,top:y[i].height});if(f){u.appendTo(t);var a=f(e[n])}else{s.append(u);var a=u.outerHeight()}y[i].height+=a+h.v,x<y[i].height&&(x=y[i].height,s.css("height",x))}f&&s.append(t.children()),v&&v()}function L(){var e=0,t=y[0].height;for(var n=1,r=y.length;n<r;++n)y[n].height<t&&(t=y[n].height,e=n);return e}function o(){m+=1;var e=new $.Deferred,t=a(m),n=$.ajax({url:t});return n.done(function(n){var r=b(n);r&&(k(r),e.resolve()),u(t)}),m>=g?(w(m),!1):e}function A(){var e=s.width(),t=Math.floor(e/c);for(;;){var n=t*(c+h.h)-h.h;if(!(n>e)){S=Math.round((e-n)/2);break}--t}y=[];var r=S;for(var i=0;i<t;++i)y.push({height:0,left:r}),r+=c+h.h;s.css("height",0),x=0}function O(){A(),s.children().each(function(e,t){var n=$(this),r=L(),i=parseInt(n.outerHeight());n.css({left:y[r].left,top:y[r].height}),y[r].height+=i+h.v,x<y[r].height&&(x=y[r].height,s.css("height",x))})}var n=require("underscore"),r=require("ui/Infinitescroll"),i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=0,T;$(window).on("resize",n.debounce(function(){E(),O()},750)),t.init=N,t.feed=k,t.reConfig=C,t.repaint=O}),define("net/cookie",function(require,e){"use strict";function t(){var e={},t=document.cookie.split(";"),n;for(var r=0,i=t.length;r<i;++r)n=$.trim(t[r]),n=n.split("="),e[n[0]]=n[1];return e}function n(e,t,n,r,i,s){var o="";r="; domain="+(r||location.host),i="; path="+(i||"/"),s=s?"; secure":"",n=n||0;if(typeof n=="string"){var u=n.substr(n.length-1,1);n=parseInt(n);switch(u){case"S":break;case"M":n*=60;break;case"H":n*=3600;break;case"d":n*=86400;break;case"m":n*=2592e3;break;case"y":n*=31536e3;break;default:throw Error("The unit of `second` parameter is not allowed.")}}t=encodeURIComponent(t);if(n<0)o="; expires=Thu, 01 Jan 1970 00:00:00 GMT";else if(n){var a=new Date;a.setTime(a.getTime()+n*1e3),o="; expires="+a.toGMTString()}document.cookie=e+"="+t+o+i+r+s}function r(e,n){var r=t()[e];return r?r=decodeURIComponent(r):typeof r=="undefined"&&typeof n!="undefined"&&(r=n),r}function i(e){n(e,"",-1)}function s(e){return!!t()[e]}function o(){var e=t(),n=[];for(var r in e)e.hasOwnProperty(r)&&n.push(r);return n}return{set:n,get:r,del:i,has:s,keys:o}}),define("net/request",function(require,e){"use strict";function o(e){var o;e=e||{},e.type=e.type||"GET",e.type&&(e.type=e.type.toUpperCase()),i.isJquery(e.data)&&(e.data=$(e.data).get(0)),t.isElement(e.data)&&(e.data=r.pack(e.data));if(!e.contentType&&Modernizr.ajaxfileupload){e.data=r.toFormData(e.data);var u=$.Deferred(),a=new XMLHttpRequest;a.open(e.type,e.url,!0),a.addEventListener("load",function(t){if(a.status==200){var n=JSON.parse(t.currentTarget.responseText);e.success&&e.success(n,"success",a),u.resolve(n,"success",a);return}e.error&&e.error(a,a.statusText,t.currentTarget.responseText)});if(e.progress){if(!("onprogress"in a))throw new Error("Your browser doesn't support progress event");e.type==="POST"?a.upload.addEventListener("progress",e.progress):e.type==="GET"&&a.addEventListener("progress",e.progress)}e.timeout&&a.timeout===0&&({}.toString.apply(e.timeout)==="[object Number]"&&(a.timeout=e.timeout,a.addEventListener("timeout",function(t){e.error?e.error(a,a.statusText,t.currentTarget.responseText):u.reject(a,a.statusText,t.currentTarget.responseText)})),{}.toString.apply(e.timeout)==="[object String]"&&(e.timeout=parseInt(e.timeout,10),isNaN(e.timeout)||(a.timeout=e.timeout))),a.addEventListener("error",function(t){e.error&&e.error(a,a.statusText,t.currentTarget.responseText),u.reject(a,a.statusText,t.currentTarget.responseText)}),a.send(e.data),o=u}else o=$.ajax($.extend(e,s));return e.backdrop&&n.show({loader:!0}),o.always(function(){e.backdrop&&n.hide()}),o}var t=require("underscore"),n=require("ui/backdrop"),r=require("dom/form"),i=require("utils/types"),s={type:"POST",dataType:"json"};return o}),define("net/urlparse",function(require,e){"use strict";function r(e){e=e||document.URL;var t=e.match(n),r={scheme:t[1],domain:t[2],path:t[3],paths:t[4].split("/"),query:t[5],fragment:t[6]};r.queryDict={};if(r.query){var s=r.query.split("&");for(var o=0,u=s.length;o<u;++o){var a=s[o].split("=");r.queryDict[a[0]]=decodeURIComponent(a[1])}}return r.get=i,r}function i(e,t){var n=this.queryDict[e];return typeof n=="undefined"&&(n=t),n}var t=require("underscore"),n=/(https?):\/\/([^\/]+)(\/([^\?#]*))(?:\?([^#]+))?(?:#(.+))?/i;e.current=function(){return r()},e.parse=function(e){return r(e)},e.buildUrlUponCurrent=function(e){var n=r(),i="";i+=e.scheme||n.scheme,i+="://",i+=e.domain||n.domain,i+=e.path||n.path;var s=t.extend(n.queryDict,e.queryDict||{}),o=[];for(var u in s)s.hasOwnProperty(u)&&o.push(u+"="+encodeURIComponent(s[u]));o.length&&(i+="?"+o.join("&"));var a=e.fragment||n.fragment;return a&&(i+="#"+a),i}}),define("utils/console",function(){"use strict";return window.console||(window.console={log:function(){}}),window.console}),define("utils/date",function(require,e){"use strict";function s(e){e instanceof Date?e=e.getTime()/1e3:e=parseInt(e,10);var n=new Date,r=n.getTime()/1e3-e;r=r<0?0:r;var s=Math.floor(r/86400),o="";return s?s<7?o=t.template(i.gettext("<%= s %> 天前"),{s:s}):s>=7&&s<30?o=t.template(i.gettext("<%= s %> 周前"),{s:Math.floor(s/7)}):s<365&&s>=30?o=t.template(i.gettext("<%= s %> 個月前"),{s:Math.floor(s/30)}):o=t.template(i.gettext("<%= s %> 年前"),{s:Math.floor(s/365)}):r?r<60?o=t.template(i.gettext("<%= s %> 秒前"),{s:Math.floor(r)}):r<3600&&r>=60?o=t.template(i.gettext("<%= s %> 分鐘前"),{s:Math.floor(r/60)}):o=t.template(i.gettext("<%= s %> 小時前"),{s:Math.floor(r/3600)}):o=t.template(i.gettext("<%= s %> 秒前"),1),o}function o(e,t){typeof e=="number"&&(e=new Date(e*1e3));var i={Y:e.getFullYear(),m:r.zeroPad(e.getMonth()+1,2),d:r.zeroPad(e.getDate(),2),H:r.zeroPad(e.getHours(),2),i:r.zeroPad(e.getMinutes(),2),s:r.zeroPad(e.getSeconds(),2)};return t?n(t,i):n("%(Y)s/%(m)s/%(d)s %(H)s:%(i)s:%(s)s",i)}var t=require("underscore"),n=require("utils/template"),r=require("utils/number"),i=require("i18n"),u=function(){var e=new Date,t=new Date,n;return t.setDate(e.getDate()+1),t.setHours(0,0,0),n=t.valueOf()-e.valueOf(),Math.floor(n/1e3)};e.timespan=s,e.strftime=o,e.timeToEndOfDayInSec=u}),define("utils/datetime",function(require,e){function a(e){return new Date(e.getFullYear(),0,1)}function f(e,t){return e.getTime()-t.getTime()}function l(e,t){return Math.floor(f(e,t?t:a(e))/864e5)+1}function c(e,t){var n=a(e),r=n.getDay(),i=l(e,n);return Math.floor((i-1+(7+r-t)%7)/7)+1*(r==t)}function h(e){var t=e.getTimezoneOffset(),n=t<0?"+":"-";t=Math.abs(t);var r=Math.floor(t/60),i=t%60;return[n,r,i]}var t=require("utils/format"),n={},r=/(\d{4})-?(\d{2})?-?(\d{2})?[T ]?(\d{2})?:?(\d{2})?:?(\d{2})?(?:\.(\d+))?(Z|[+-]\d{2})?:?(\d{2})?/;n.parseISOString=function(e){if(typeof e!="string")return new Date(NaN);var t=r.exec(e);return t===null?new Date(NaN):(date=new Date(0),date.setUTCFullYear(t[1]||0),date.setUTCMonth((t[2]||1)-1),date.setUTCDate(t[3]||1),date.setUTCHours(t[4]||0),date.setUTCMinutes(t[5]||0),date.setUTCSeconds(t[6]||0),date.setUTCMilliseconds(("0."+(t[7]||0))*1e3),t[8]!=="Z"&&(t[8]||t[9]?date.setUTCHours(date.getUTCHours()-(t[8]||0)*1,date.getUTCMinutes()-(t[9]||0)*(-1+2*(t[8]>=0))):t[4]&&date.setUTCMinutes(date.getUTCMinutes()+(new Date).getTimezoneOffset())),date)},n.parse=function(e){if(e instanceof Date)return e;var t=n.parseISOString(e);return isNaN(t)?new Date(e):t};var i=["日","一","二","三","四","五","六"],s=[" 1"," 2"," 3"," 4"," 5"," 6"," 7"," 8"," 9","10","11","12"],o=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],u=["上午","下午"];n.localeWeekdayAbbrNames={zh_TW:i,zh_CN:i,en_US:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},n.localeWeekdayNames={zh_TW:["周日","周一","周二","周三","周四","周五","周六"],zh_CN:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],en_US:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},n.localeMonthAbbrNames={zh_TW:s,zh_CN:s,en_US:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},n.localeMonthNames={zh_TW:o,zh_CN:o,en_US:["January","February","March","April","May","June","July","August","September","October","November","December"]},n.localePeriodNames={zh_TW:u,zh_CN:u,en_US:["AM","PM"]},n.locale=navigator.language||"zh_TW",n.setLocale=function(e){return e?(e=e.replace(/-/g,"_"),/zh_TW|zh_CN|en_US/.test(e)||(/^zh/i.test(e)?e="zh_TW":e="en_US"),n.locale=e,e):e},n.setLocale(n.locale),n.getLocale=function(){return n.locale};var p=/%(.)/g;return n.format=function(e,r,i){r instanceof Date||(r=n.parse(r));var s;return i?s=function(e,t,n){return n}:s=t.pad,e.replace(p,function(e,t){switch(t){case"a":return n.localeWeekdayAbbrNames[n.locale][r.getDay()];case"A":return n.localeWeekdayNames[n.locale][r.getDay()];case"w":return r.getDay();case"d":return s("0",2,r.getDate());case"b":return n.localeMonthAbbrNames[n.locale][r.getMonth()];case"B":return n.localeMonthNames[n.locale][r.getMonth()];case"m":return s("0",2,r.getMonth()+1);case"y":return r.getYear();case"Y":return r.getFullYear();case"H":return s("0",2,r.getHours());case"I":return s("0",2,r.getHours()%12||12);case"p":return n.localePeriodNames[n.locale][(r.getHours()>=12)*1];case"M":return s("0",2,r.getMinutes());case"S":return s("0",2,r.getSeconds());case"f":return s("0",3,r.getMilliseconds());case"z":var i=h(r);return i[0]+s("0",2,i[1])+s("0",2,i[2]);case"Z":return"UTC";case"j":return s("0",3,l(r));case"U":return s("0",2,c(r,!1));case"W":return s("0",2,c(r,!0));case"c":return r.toLocaleString();case"x":return r.toLocaleDateString();case"X":return r.toLocaleTimeString();default:return t}})},n}),define("utils/format",function(require,e){var t={};return t.pad=function(e,t,n){typeof n!="string"&&(n=n.toString());for(var r=t-n.length;r>0;r--)n=e+n;return n},t.thousandsSep=function(e){typeof e!="string"&&(e=e.toString());var t=e.lastIndexOf(".");t==-1&&(t=e.length);var n=e.slice(t);e=e.slice(0,t);for(var t=e.length-3;t>0;t-=3)e=e.slice(0,t)+","+e.slice(t);return e+n.substr(0,3)},t}),define("utils/hash",function(require,e){"use strict";function t(e){var t=0;for(var n=0,r=e.length;n<r;++n)t+=e.charCodeAt(n);try{return t.toString(36)}catch(i){return""+t}}e.hash=t}),define("utils/number",function(require,e){"use strict";function t(e,t,n){n=n||"0";var r=String(e);return t>r.length&&(r=(new Array(t-r.length+1)).join(n)+r),r}e.zeroPad=t}),define("utils/objpath",function(require,e){var t=require("underscore");e.defaults={valGetter:function(e){return e.text()},valSetter:function(e,t){return e.text(t)},pathGetter:function(e){return e.data("utils-objpath-path")}},e.composeObjectFromElements=function(n,r,i,s){var r=r||{},i=i||e.defaults.valGetter,s=s||e.defaults.pathGetter;return t.each(n,function(e){var t=$(e),n=(s(t)||"").split(".");if(!n.length)return;var o=i(t);if(!o)return;var u=r;for(var a=0,f=n.length-1;a<f;a++){var l=n[a],c=u[l];c===undefined&&(c=u[l]={}),u=c}c[n[f]]=o}),r},e.fillElementsFromObject=function(n,r,i,s){var i=i||e.defaults.valSetter,s=s||e.defaults.pathGetter;t.each(n,function(e){var t=$(e),n=(s(t)||"").split(".");if(!n.length)return;var o=r;for(var u=0,a=n.length;u<a;u++){o=o[n[u]];if(o===undefined)break}o!==undefined&&i(t,o)})}}),define("utils/regexp",function(require,e){"use strict";e.tel=/^[\+\d()\- ]{8,}$/}),define("utils/template",function(require,e){"use strict";var t={"%":function(e){return"%"},b:function(e){return String(parseInt(e).toString(2))},c:function(e){return String.fromCharCode(parseInt(e))},d:function(e){return String(parseInt(e)?parseInt(e):0)},u:function(e){return String(Math.abs(e))},f:function(e,t){return String(t>-1?Math.round(parseFloat(e)*Math.pow(10,t))/Math.pow(10,t):parseFloat(e))},o:function(e){return String(parseInt(e).toString(8))},s:function(e){return String(e)},x:function(e){return String(parseInt(e).toString(16)).toLowerCase()},X:function(e){return String(parseInt(e).toString(16)).toUpperCase()}},n=/%(?:(\d+)?(?:\.(\d+))?|\(([^)]+)\))([%bcdufosxX])/g;return function(){var e=[].slice.call(arguments),r=e[0],i=e.slice(1);if(i.length===1&&typeof i[0]=="object")return i=i[0],r.replace(n,function(e,n,r,s,o,u,a){return t[o](i[s])});var s=0;return r.replace(n,function(e,n,r,o,u,a,f){return t[u](i[s++],r)})}}),define("utils/test_datetime",function(require,e){var t=require("utils/datetime");e.test_nativeDate=function(){var e=["2013-08-29 18:12:34","2013-08-29T18:12:34","2013-08-29 18:12:34+08:00","2013-08-29T18:12:34+08:00"],t=new Date(2013,7,29,18,12,34,0),n=[t,t,t,t];console.log("Start to test native Date ...");var r,i,s;for(var o=0,u=e.length;o<u;o++)r=e[o],i=n[o],s=new Date(r),s.getTime()!==i.getTime()&&console.error("Test Case",o+1,": expect",i,"but got",s);console.log("done.")},e.test_parseISOString=function(){var e=["2013","2013-08","2013-08-28","2013-08-28T10:30Z","2013-08-28T10:30+00:00","2013-08-28T18:30:45+08:00","2013-08-28T18:30:45.123+08:00","2013-08-29 18:12:34","2013-08-29T18:12:34","2013-08-29 18:12:34+08:00","2013-08-29T18:12:34+08:00"],n=new Date(2013,7,29,18,12,34,0),r=[new Date("Tue Jan 01 2013 08:00:00 GMT+0800 (CST)"),new Date("Thu Aug 01 2013 08:00:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 08:00:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:45 GMT+0800 (CST)"),new Date(2013,7,28,18,30,45,123),n,n,n,n];console.log("Start to test datetime.parseISOString ...");var i,s,o;for(var u=0,a=e.length;u<a;u++)i=e[u],s=r[u],o=t.parseISOString(i),o.getTime()!==s.getTime()&&console.error("Test Case",u+1,": expect",s,"but got",o);console.log("done.")},e.test_format=function(){var e=new Date(2013,7,30,18,17,45,123),n=[["en","%Y/%m/%d %H:%M:%S",e],["en","%Y-%m-%dT%H:%M:%S.%f%z",e],["en","%a %b %d %Y %H:%M:%S %Z%z",e],["zh","現在是%A的%p (%m/%d %H:%M:%S)。",e],["en","%%W: %W, %%U: %U",new Date(2012,0,1)],["en","%%W: %W, %%U: %U",new Date(2012,0,2)],["en","%%W: %W, %%U: %U",new Date(2012,0,3)],["en","%%W: %W, %%U: %U",new Date(2011,0,1)],["en","%%W: %W, %%U: %U",new Date(2011,0,2)],["en","%%W: %W, %%U: %U",new Date(2011,0,3)],["en","%%W: %W, %%U: %U",new Date(2011,0,4)],["en","%A","2013-08-19"],["en","%A",13768704e5]],r=["2013/08/30 18:17:45","2013-08-30T18:17:45.123+0800","Fri Aug 30 2013 18:17:45 UTC+0800","現在是周五的下午 (08/30 18:17:45)。","%W: 00, %U: 01","%W: 01, %U: 01","%W: 01, %U: 01","%W: 00, %U: 00","%W: 00, %U: 01","%W: 01, %U: 01","%W: 01, %U: 01","Monday","Monday"];console.log("Start to test datetime.format ...");var i,s,o;for(var u=0,a=n.length;u<a;u++)i=n[u],s=r[u],t.setLocale(i[0]),o=t.format(i[1],i[2]),o!==s&&console.error("Test Case",u+1,": expect",s,"but got",o);console.log("done.")}}),define("utils/types",function(require,e){"use strict";e.isDeferred=function(e){return!!e&&$.isFunction(e.done)},e.isJquery=function(e){return typeof e=="object"&&e.eq&&e.get?!0:!1}}),define("track/ga",function(require,e,t){"use strict";var n=require("settings"),r=function(){var e=document.documentElement||document.body,t;$(e).on("click","[data-ga-category]",function(e){var n=$(e.currentTarget);n.data("ga-action")&&(t=["_trackEvent",n.data("ga-category"),n.data("ga-action")],n.data("ga-label")?t.push(n.data("ga-label")):t.push(null),n.data("ga-value")?t.push(n.data("ga-value")):t.push(null),t.push(!0),_gaq.push(t),n.attr("data-ga-link")!==undefined&&(e.preventDefault(),setTimeout(function(){n.attr("target")==="_blank"?window.open(n.attr("href")):location.href=n.attr("href")},50)))})};e.init=function(){if(n.get("production")){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}else{if(window._gaq&&_gaq.length)for(var i=0,s=_gaq.length;i<s;++i)_gaq.hasOwnProperty(i)&&console.log("GA >",_gaq[i]);_gaq={},_gaq.push=function(t){console.log("GA >",t)}}n.get("mobile")||r()}}),define("external/facebook",function(require,e){var t=require("underscore"),n=require("i18n"),r=require("settings"),i=require("ui/Inviewport"),s=require("utils/console"),o="197994114318",u,a=r.get("uid"),f=$.Deferred(),l={hasOnloadedSDK:!1,hasAppendSDK:!1,hasInitFB:!1,hasError:!1,hasPermission:[]},c=function(e,t){t=t||{},f.done(function(){if(!l.hasInitFB){try{FB.init({appId:o,channelUrl:"/media/xd_receiver_v2.htm",cookie:!0,status:!0,xfbml:!1,oauth:!0,frictionlessRequests:!1,version:"v2.2"})}catch(n){l.hasError=!0,s.log("FB.init error"),s.log(l.hasAppendSDK,l.hasOnloadedSDK),s.log(n);return}l.hasInitFB||(y(),e(t),l.hasInitFB=!0)}});if(l.hasError)return;if(l.hasOnloadedSDK||l.hasInitFB){e(t);return}if(!l.hasAppendSDK){l.hasAppendSDK=!0;var n=document.createElement("script"),i=r.get("locale")||"zh_TW";n.async="async",n.src="//connect.facebook.net/"+i+"/sdk.js",n.onload=function(){l.hasOnloadedSDK=!0,f.resolve()},document.getElementsByTagName("head")[0].appendChild(n)}else l.hasOnloadedSDK&&f.resolve()},h=function(e,t){if(l.hasError){s.log("FB.init error (loginFB)");return}if(u){e(t);return}t=t||{},t.hasOwnProperty("scope")||(t.scope=[]),c(function(){FB.login(function(r){r.status==="connected"?(u=r.authResponse.userID,e(t)):alert(n.gettext("請放心給予 Pinkoi 授權"))},{scope:t.scope.join(",")})})},p=function(e,t){if(l.hasError)return;if(!t||!t.hasOwnProperty("scope"))throw"args.scope is necessary";c(function(){FB.login(function(r){if(r.status==="connected"){u=r.authResponse.userID;try{e(t)}catch(i){alert(n.gettext("請放心給予 Pinkoi 授權"))}}else alert(n.gettext("請放心給予 Pinkoi 授權"))},{scope:t.scope.join(",")})})},d=function(e,t,n){if(l.hasError)return;var r=!1;FB.api(u+"/permissions",function(i){if(i.data){for(var s in i.data)i.data[s].hasOwnProperty("permission")&&$.inArray(i.data[s].permission,e)>-1&&i.data[s].status==="granted"&&(r=!0,l.hasPermission.push(i.data[s].permission));if(r){t(n);return}n=n||{},n.scope=n.scope||[];for(var s=0;s<e.length;s++)n.scope.push(e[s]);p(t,n)}})},v=function(e){return e.name||(e.name=document.getElementsByTagName("title")[0].innerHTML),e.link||(e.link=location.href),e.caption||(e.caption="pinkoi.com"),e.actions||(e.actions=[{name:n.gettext("來逛 Pinkoi"),link:"http://pinkoi.com"}]),e},m=function(e){if(l.hasError)return;var t,r;t=function(e,t){t.cb&&t.cb(e)},r=function(){FB.api(u+"/feed","post",e,function(r){if(!r.id)throw alert(n.gettext("發生錯誤")),r.error;t(r,e)})};if(u){if(!e||e.auto&&!e.message)return;e=v(e),e.auto?$.inArray("publish_actions",l.hasPermission)>0?r():d(["publish_actions"],function(){r()}):(e.method="feed",FB.ui(e,function(n){if(!!n.error)throw n.error;t(n,e)}))}else e.scope=["publish_actions"],c(function(){h(function(){m(e)})})},g=function(e,t){var n=$(e);if(n.length)for(var r=0;r<n.length;r++)t?c(function(){FB.XFBML.parse(n.get(r))}):new i({el:n.get(r),buffer:250,cb:function(){var e=this.el;c(function(){FB.XFBML.parse(e)})}})},y=function(){FB.Event.subscribe("edge.create",function(e){_gaq.push(["_trackSocial","facebook","like"])}),FB.Event.subscribe("edge.remove",function(e){_gaq.push(["_trackSocial","facebook","unlike"])}),FB.Event.subscribe("message.send",function(e){_gaq.push(["_trackSocial","facebook","share"])}),FB.Event.subscribe("comment.create",function(e){_gaq.push(["_trackSocial","facebook","comment"])})},b=function(e,t){c(function(){h(function(t){FB.ui(t,function(t){if(!t.error&&e)e(t);else if(t.error)throw t.error})},t)},t)};e.init=c,e.publish=m,e.parseFBML=g,e.requestPermission=p,e.loginFB=h,e.appId=o,e.ui=b}),function(){var e,t;e=function(){function e(e,t){var n,r;this.options={target:"instafeed",get:"popular",resolution:"thumbnail",sortBy:"none",links:!0,mock:!1,useHttp:!1};if(typeof e=="object")for(n in e)r=e[n],this.options[n]=r;this.context=t!=null?t:this,this.unique=this._genKey()}return e.prototype.hasNext=function(){return typeof this.context.nextUrl=="string"&&this.context.nextUrl.length>0},e.prototype.next=function(){return this.hasNext()?this.run(this.context.nextUrl):!1},e.prototype.run=function(t){var n,r,i;if(typeof this.options.clientId!="string"&&typeof this.options.accessToken!="string")throw new Error("Missing clientId or accessToken.");if(typeof this.options.accessToken!="string"&&typeof this.options.clientId!="string")throw new Error("Missing clientId or accessToken.");return this.options.before!=null&&typeof this.options.before=="function"&&this.options.before.call(this),typeof document!="undefined"&&document!==null&&(i=document.createElement("script"),i.id="instafeed-fetcher",i.src=t||this._buildUrl(),n=document.getElementsByTagName("head"),n[0].appendChild(i),r="instafeedCache"+this.unique,window[r]=new e(this.options,this),window[r].unique=this.unique),!0},e.prototype.parse=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;if(typeof e!="object"){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,"Invalid JSON data"),!1;throw new Error("Invalid JSON response")}if(e.meta.code!==200){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,e.meta.error_message),!1;throw new Error("Error from Instagram: "+e.meta.error_message)}if(e.data.length===0){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,"No images were returned from Instagram"),!1;throw new Error("No images were returned from Instagram")}this.options.success!=null&&typeof this.options.success=="function"&&this.options.success.call(this,e),this.context.nextUrl="",e.pagination!=null&&(this.context.nextUrl=e.pagination.next_url);if(this.options.sortBy!=="none"){this.options.sortBy==="random"?d=["","random"]:d=this.options.sortBy.split("-"),p=d[0]==="least"?!0:!1;switch(d[1]){case"random":e.data.sort(function(){return.5-Math.random()});break;case"recent":e.data=this._sortBy(e.data,"created_time",p);break;case"liked":e.data=this._sortBy(e.data,"likes.count",p);break;case"commented":e.data=this._sortBy(e.data,"comments.count",p);break;default:throw new Error("Invalid option for sortBy: '"+this.options.sortBy+"'.")}}if(typeof document!="undefined"&&document!==null&&this.options.mock===!1){a=e.data,this.options.limit!=null&&a.length>this.options.limit&&(a=a.slice(0,this.options.limit+1||9e9)),n=document.createDocumentFragment(),this.options.filter!=null&&typeof this.options.filter=="function"&&(a=this._filter(a,this.options.filter));if(this.options.template!=null&&typeof this
.options.template=="string"){i="",o="",l="",v=document.createElement("div");for(m=0,b=a.length;m<b;m++)s=a[m],u=s.images[this.options.resolution].url,this.options.useHttp||(u=u.replace("http://","//")),o=this._makeTemplate(this.options.template,{model:s,id:s.id,link:s.link,image:u,caption:this._getObjectProperty(s,"caption.text"),likes:s.likes.count,comments:s.comments.count,location:this._getObjectProperty(s,"location.name")}),i+=o;v.innerHTML=i,S=[].slice.call(v.childNodes);for(g=0,w=S.length;g<w;g++)h=S[g],n.appendChild(h)}else for(y=0,E=a.length;y<E;y++)s=a[y],f=document.createElement("img"),u=s.images[this.options.resolution].url,this.options.useHttp||(u=u.replace("http://","//")),f.src=u,this.options.links===!0?(t=document.createElement("a"),t.href=s.link,t.appendChild(f),n.appendChild(t)):n.appendChild(f);document.getElementById(this.options.target).appendChild(n),r=document.getElementsByTagName("head")[0],r.removeChild(document.getElementById("instafeed-fetcher")),c="instafeedCache"+this.unique,window[c]=void 0;try{delete window[c]}catch(x){}}return this.options.after!=null&&typeof this.options.after=="function"&&this.options.after.call(this),!0},e.prototype._buildUrl=function(){var e,t,n;e="https://api.instagram.com/v1";switch(this.options.get){case"popular":t="media/popular";break;case"tagged":if(typeof this.options.tagName!="string")throw new Error("No tag name specified. Use the 'tagName' option.");t="tags/"+this.options.tagName+"/media/recent";break;case"location":if(typeof this.options.locationId!="number")throw new Error("No location specified. Use the 'locationId' option.");t="locations/"+this.options.locationId+"/media/recent";break;case"user":if(typeof this.options.userId!="number")throw new Error("No user specified. Use the 'userId' option.");if(typeof this.options.accessToken!="string")throw new Error("No access token. Use the 'accessToken' option.");t="users/"+this.options.userId+"/media/recent";break;default:throw new Error("Invalid option for get: '"+this.options.get+"'.")}return n=""+e+"/"+t,this.options.accessToken!=null?n+="?access_token="+this.options.accessToken:n+="?client_id="+this.options.clientId,this.options.limit!=null&&(n+="&count="+this.options.limit),n+="&callback=instafeedCache"+this.unique+".parse",n},e.prototype._genKey=function(){var e;return e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},""+e()+e()+e()+e()},e.prototype._makeTemplate=function(e,t){var n,r,i,s,o;r=/(?:\{{2})([\w\[\]\.]+)(?:\}{2})/,n=e;while(r.test(n))i=n.match(r)[1],s=(o=this._getObjectProperty(t,i))!=null?o:"",n=n.replace(r,""+s);return n},e.prototype._getObjectProperty=function(e,t){var n,r;t=t.replace(/\[(\w+)\]/g,".$1"),r=t.split(".");while(r.length){n=r.shift();if(!(e!=null&&n in e))return null;e=e[n]}return e},e.prototype._sortBy=function(e,t,n){var r;return r=function(e,r){var i,s;return i=this._getObjectProperty(e,t),s=this._getObjectProperty(r,t),n?i>s?1:-1:i<s?1:-1},e.sort(r.bind(this)),e},e.prototype._filter=function(e,t){var n,r,i,s,o;n=[],i=function(e){if(t(e))return n.push(e)};for(s=0,o=e.length;s<o;s++)r=e[s],i(r);return n},e}(),t=typeof exports!="undefined"&&exports!==null?exports:window,t.Instafeed=e}.call(this),define("external/uservoice",function(require,e){"use strict";function n(e){if(!window.UserVoice){var n="Fe2VUJnf1hYTMyuT8LTCpw";t.get("locale")==="ja"&&(n="2ji28LxTznYHVFfgpBOWyg");var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src=("https:"==document.location.protocol?"https://":"http://")+"widget.uservoice.com/"+n+".js",r.onload=e;var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(r,i)}else e()}var t=require("settings");e.showLightbox=function(){n(function(){UserVoice.showLightbox("classic_widget",{mode:"support",locale:t.get("locale")})})}}),define("app/modules/cart",function(require,e){"use strict";function i(e){$.type(e)!=="undefined"&&(e=parseInt(e),t.set("g.cartNum",e));var n=t.get("g.cartNum");if($.type(n)!=="number")$.get("/apiv2/cart/num",function(e){e&&e.result&&i(e.result[0].cart_num)});else{var o=$("#gheader").find(".cart"),u=o.find(".n");u.addClass("active").html(n),n>9?u.addClass("double-digit"):u.removeClass("double-digit"),o.find(".f").addClass("active")}n&&t.get("g.cartNotification")&&!r&&(r=!0,s())}function s(){var e=$($("#gheader").find(".cart")),t=$('<div class="g-header-cart-notification">'+n.gettext("商品放購物車不等於已買到請儘快結帳以免賣完囉！")+"</div>");e.append(t)}var t=require("storage/local"),n=require("i18n"),r=!1;e.updateNum=i,e.clearNum=function(){t.del("g.cartNum")},e.noticeVacation=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=$("#group_"+t);n.length&&n.find('[name="shipping_method"]').on("change",function(){alert(e[t])})}}}),define("app/modules/engage",function(require,e){"use strict";function a(n){if(e.shown)return;var r=t.template(['<div class="m-engage m-engage-to-be-closed <%= button ? "m-engage-with-right" : "m-engage-not-with-right" %> <%= image ? "m-engage-with-left" : "m-engage-not-with-left" %>" data-hash="<%= hashV %>" <% if (expire) {print(\'data-expire="\' + expire + \'"\');} %> data-url="<%= url ? url : "" %>">','<div class="m-engage-close" onclick="require(\'app/modules/engage\').close(this);">',o.gettext("關閉"),"</div>","<a <% if (url) {print('onclick=\"require(\\'app/modules/engage\\').link(this);\" class=\"m-engage-hasurl\"');} %>>",'<% if (image) { %><div class="m-engage-section m-engage-left"><div class="m-engage-image" style="background-image:url(\'<%= image %>\');"></div></div><% } %>','<div class="m-engage-section m-engage-middle">','<div class="m-engage-body">','<% if (title) { %><h1 class="m-engage-title"><%= title %></h1><% } %>',"<% if (description) { %><div class=\"m-engage-description <% if (image) {print('m-engage-hasimage')} %>\"><%= description %></div><% } %>","</div>","<% if (button) { %>",'<div class="m-engage-right m-engage-section"><div class="m-button m-engage-button"><%= button %></div></div>',"<% } %>","</div>","</a>","</div>"].join(""));$("#gheader").after(r(n)),e.shown=!0}function f(r){var i=t.template(['<div class="m-engage m-engage-expander" <% if (expire) {print(\'data-expire="\' + expire + \'"\');} %> data-url="<%= url ? url : "" %>" >','<div class="top-wrapper" onclick="<% if(onclickcb) { %><%= onclickcb %><% } if(content) { %> $($(this).next()).toggleClass(\'s-hidden\')<% } %>">','<div class="expander-title"><%= title %></div>','<p class="expander-desc">',"<%= description %>","</p>","</div>",'<div class="bottom-wrapper m-engage-to-be-closed <%= isHideBottomWrapper ? "s-hidden" : "" %>" data-hash="expander" data-action="hide" data-url="<%= url %>">','<div class="m-engage-close" onclick="require(\'app/modules/engage\').close(this);">',o.gettext("關閉"),"</div>",'<div class="expander-content">',"<p>","<%= content %>","</p>","</div>",n.get("locale")==="zh_TW"||n.get("locale")==="zh_CN"?'<div class="expander-button"><a class="m-button" onclick="require(\'app/modules/engage\').link(this);" href="<%= url %>" data-url="<%= url %>"><%= button %></a></div>':"","</div>","</div>"].join(""));$("#gheader").after(i(r)),e.shown=!0}function l(t,n){n=n||{};var r=$(t).closest(".m-engage-to-be-closed"),s=r.data("hash"),o=r.data("expire")||"1m",u=r.data("url")||"";i.set("m.engage."+s,1,o),n.openUrl?_gaq.push(["_trackEvent","Engage Module","Open URL",u,null,!0]):_gaq.push(["_trackEvent","Engage Module","Close",u,null,!0]),n.openUrl&&setTimeout(function(){location.href=u},100),r.data("action")==="hide"?r.addClass("s-hidden"):r.remove(),e.shown=!1}function c(e){l(e,{openUrl:!0})}function h(e){if(n.get("app/modules/engage")&&n.get("app/modules/engage").disabled)return;if(t.contains(u,s.current().paths[0]))return;if(s.current().paths[0]==="magz"&&s.current().paths[1]==="1cqJQmrq")return;for(var o=0,f=e.length;o<f;++o){var l=(e[o].url?e[o].url:"")+(e[o].title?e[o].title:"")+(e[o].button?e[o].button:"")+(e[o].hash?String(e[o].hash):""),c=r.hash(l);if(!i.get("m.engage."+c)){if(e[o].condition&&!e[o].condition())continue;if(e[o].url&&e[o].url===location.pathname)continue;a(t.extend({hashV:c,expire:null,image:null,title:null,description:null,url:null,button:null},e[o]));break}}}var t=require("underscore"),n=require("settings"),r=require("utils/hash"),i=require("storage/local"),s=require("net/urlparse"),o=require("i18n"),u=["admin","app","event","friends","lifestyle","offers","panel","zine","page"];e.show=h,e.showExpander=f,e.close=l,e.link=c,e.shown=!1}),define("app/modules/fav",function(require,e){"use strict";var t=require("underscore"),n=require("mapp/modules/request"),r=require("i18n"),i=require("ui/modal"),s=require("mapp/pages/login"),o=require("settings"),u=require("ui/drawerBar");e.addFav=function(e,i){return n({type:"POST",url:"/apiv2/item/fav",data:{tid:e}}).done(function(e,n,s){if(e.error)return u.show(e.error.message);e.result[0].reward.plus>0?u.show(t.template(r.gettext("已加入慾望清單 紅利點數 <%= plus %>"),{plus:e.result[0].reward.plus})):u.show(r.gettext("已加入慾望清單")),i&&i(e,n,s)})},e.removeFav=function(e,t){if(!e)throw new Error("need tid");return o.get("uid")?n({type:"POST",url:"/apiv2/item/unfav",data:{tid:e}}).done(function(e,n,r){if(e.error)return u.show(e.error.message);t&&t(e,n,r)}):s.loginModal(i)},e.getFav=function(e,t){e=$.extend({limit:999},e);var r="/apiv2/item/get_fav",i="?";return $.each(e,function(e,t){i=i+e+"="+t+"&"}),i=r+i.substr(0,i.length-1),n({type:"GET",url:i}).done(function(e,n,r){if(e.error)return u.show(e.error.message);t&&t(e,n,r)})},e.init=function(t){t=t||{};var n=t.offset||{top:8,left:6},r=t.binder||document,u=t.zoomboxCase,a=$('<a class="g-fav-proxy" style="display:none;"></a>');a.appendTo("body");var f,l,c,h;u&&$(r).on("click","[data-click=zoombox]",function(){h={top:n.top,right:n.left}}),$(r).on("mouseenter","[data-hover]",function(){f=$(this),l=f.parent(),c={top:l.offset().top+n.top,left:l.offset().left+l.width()-a.width()-n.left},f.data("hover")==="fav"&&(a.data("tid",f.data("tid")),u?a.clone().css(h).appendTo(l).show():a.css(c).show())}).on("mouseout","[data-hover]",function(e){$(e.relatedTarget).is(".g-fav-proxy")||(u?l.find(".g-fav-proxy").remove():a.hide())}).on("click",".g-fav-proxy",function(t){if(!o.get("uid")){u?l.find(".g-fav-proxy").remove():a.hide(),t.preventDefault(),s.loginModal(i);return}$('<a class="g-fav"></a>').css({top:n.top,right:n.left}).appendTo(l).show(),f.data("hover","faved"),u?l.find(".g-fav-proxy").remove():a.hide();var r=f.data("tid");e.addFav(r)})}}),define("app/modules/fluid-carousel",function(require,e){"use strict";var t=require("underscore"),n=require("app/modules/url"),r=require("ui/Inviewport"),i={},s=500;i.on=function(e){if(!i.ison)i.divide();else if(i.getWrapW()<1e3)for(var t=0;t<i.$els.length;t++){var n=$(i.$els[t].$el);i.resize(n,i.$els[t].$item,i.getWrapW())}i.ison=!0},i.resize=function(e,t,n){var r=Math.round(i.getWrapW()*(t.length/8+2));i.ison||e.wrap('<div class="m-carousel-outerwrapper m-carousel-adjust"><div class="inner"></div></div>'),e.width(r),setTimeout(function(){$(".m-carousel-adjust").width(i.getWrapW())},10),e.data("total-page",t.length/8+2),$(".section-carousel-wrapper").css(Modernizr.prefixed("transform"),"translate(-"+n+"px, 0)")},i.off=function(){i.ison=!1;var e=i.getWrapW(),t;$(".m-carousel-adjust").width("auto");if(i.$els.length)for(var n=0;n<i.$els.length;n++){t=$(i.$els[n].$el);if(i.$els[n].$item){for(var r=0;r<i.$els[n].$item.length;r++)t&&t.append(i.$els[n].$item[r]);$(i.$els[n].$el).removeAttr("style"),$(i.$els[n].$el).width("auto")}}$(".m-carousel-page").remove()},i.getWrapW=function(){return Math.round(document.body.clientWidth>1040?1e3:document.body.clientWidth*.96)},i.divide=function(){var e={},n=[],r=[],s=i.getWrapW();for(var o=0;o<i.$els.length;o++){e=$(i.$els[o].$el);var u=$(e.find(i.itemSelector)),a,l;i.$els[o].$item=u;for(var c=0;c<u.length;c++)r.push(u[c]),r.length===8&&(n.push(r),r=[]);for(var h=0;h<n.length;h++){var p=$('<div class="m-carousel-page m-carousel-adjust" style="width:'+s+'px"></div>');for(var d=0;d<n[h].length;d++)p.append(n[h][d]);h===0?a=p.clone():h===n.length-1&&(l=p.clone()),e.append(p)}e.append(a),e.prepend(l),i.goToPage(e,t.random(1,n.length)),i.resize(e,u,s),n=[]}f()},i.goToPage=function(e,t,n){var r=i.getWrapW(),o=parseInt(e.data("total-page"),10)-1;if(!n&&e.hasClass("no-transition"))return;t===o||t>o?setTimeout(function(){e.addClass("no-transition"),i.goToPage(e,1,!0)},s):(t===0||t<0)&&setTimeout(function(){e.addClass("no-transition"),i.goToPage(e,o-1,!0)},s),n&&setTimeout(function(){e.removeClass("no-transition")},100),e.css(Modernizr.prefixed("transform"),"translate("+ -r*t+"px, 0)"),e.data("now",t)};var o=function(e){var t=i.getWrapW();t<768||!Modernizr.csstransforms?(f(),i.off()):i.on(t)},u=function(){var e='<span class="carousel-prev" data-action="carousel-prev"></span><span class="carousel-next" data-action="carousel-next"></span>';for(var n=0;n<i.$els.length;n++){var r=$(e),s=$(i.$els[n].$el),o=$('<div class="m-carousel-pagi-wrapper"></div>');if(s){r.attr("id","m-carousel-pagi-"+n).data("id",n),o.insertAfter(s.parent()),o.append(r);var u=t.random(0,s.find(".m-carousel-page").length-1);s.data("now",u),i.goToPage(s,u)}}i.$wrap.on("click","[data-action]",function(e){e.preventDefault();var t=$(i.$els[parseInt($(e.target).data("id"),10)].$el),n=$(e.target).data("action");if(n==="carousel-prev"){i.goToPage(t,parseInt(t.data("now"),10)-1),$(e.target).data("frozen",!0);return}if(n==="carousel-next"){i.goToPage(t,parseInt(t.data("now"),10)+1),$(e.target).data("frozen",!0);return}if(n==="more"){var r=parseInt($(e.target).data("page"),10),s=document.body.clientWidth<481?4:6,o=Math.floor(t.find(".item").length/s);t.addClass("on-"+r),r++,$(e.target).data("page",r);var u=t.find(".item");for(var a=0;a<s;a++)$(u[r*s+a])&&$(u[r*s+a]).addClass("on");r===o&&$(e.target).remove();return}})},a=function(e){var t=e.find("img[data-src]");for(var r=0;r<t.length;r++){var i=$(t[r]);i.attr("src",n.getItemImg(i.data("tid"),"320x320",{seq:i.data("map")})).data("src",""),$(i.parent().parent()).addClass("loaded")}},f=function(){for(var e=0;e<i.$els.length;e++){var t=i.$els[e].$el;new r({el:t,buffer:100,cb:function(){a($(this.el))}})}};e.init=function(e){var t=$(e.el),n=0;i.$wrap=$(e.wrap),i.itemSelector=e.item;if(!t||!i.$wrap)return;i.$els=[];for(var r=0;r<t.length;r++)i.$els.push({$el:$(t[r]),now:0});$(window).on("resize",function(e){o()}),o(),u()}}),define("app/modules/intltelinput",function(require,e){"use strict";e.init=function(e,t,n){var r=$(e),i={preferredCountries:["tw","hk","cn","us","jp","th","my","au","mo","sg","ca"],autoHideDialCode:!1},t=t;if(t)for(var s in t)i[s]=t[s];r.length&&(r.intlTelInput(i),r.val().search(/\+/g)===-1&&(r.intlTelInput("selectCountry",n?n:"tw"),r.val("+886")))},e.countryCode=function(t,n,r){e.init(t,n,r);var i=$(t),s=i.closest(".intl-tel-input").find(".country-list"),o=i.intlTelInput("getSelectedCountryData");return i.closest(".intl-tel-input").find("input").val(o.name),s.on("click",function(){o=i.intlTelInput("getSelectedCountryData");var e=$(this).closest(".intl-tel-input").find("input");e.val(o.name),e.data("country",o.iso2.toUpperCase())}),i.on("click",function(){i.intlTelInput("showDropdown")}),{updateFlag:function(e){i.intlTelInput("selectCountry",e.toLowerCase());var t=i.closest(".intl-tel-input").find("input");o=i.intlTelInput("getSelectedCountryData"),t.val(o.name),t.data("country",o.iso2.toUpperCase())}}}}),define("app/modules/item",function(require,e){"use strict";e.discountPrice=function(e,t){return t?Math.ceil(e*(t/100)):e}}),define("app/modules/request",function(){"use strict";function e(e){return $.ajax(e)}return e}),define("app/modules/share",function(require,e){"use strict";var t=require("settings");return function(e,n,r){r=r||{};var i=n.size===40?"m-share-size-40":"m-share-size-32",s=$('<div class="m-share '+i+'"></div>'),o="<ul>";n.title=n.title?n.title:document.title,n.url=n.url?n.url:location.href,n.imgTag=n.img?'<img src="'+n.img+'">':"";if(Modernizr.iphone)var u=n.title+'<br><a href="'+n.url+'">'+n.url+'</a><br><br><a href="'+n.url+'">'+n.imgTag+"</a>";else var u=n.title+" "+n.url;r.line||(o+='<li class="line-wrapper"><a class="m-share-line" href="http://line.naver.jp/R/msg/text/?'+encodeURIComponent(n.title+" "+n.url)+'" target="_blank">Line</a></li>'),r.facebook||(o+='<li><a class="m-share-facebook" href="http://facebook.com/sharer.php?u='+encodeURIComponent(n.url)+'" target="_blank">Facebook</a></li>');if(!r.twitter||t.get("locale")!="zh_CN")o+='<li><a class="m-share-twitter" href="https://twitter.com/share?text='+encodeURIComponent(n.title)+"&url="+encodeURIComponent(n.url)+'" target="_blank">Twitter</a></li>';r.email||(o+='<li><a class="m-share-email" href="mailto:?subject='+encodeURIComponent(n.title)+"&body="+encodeURIComponent(u)+'" target="_blank">Email</a></li>'),r.pinterest||(o+='<li><a class="m-share-pinterest" href="//pinterest.com/pin/create/button/?url='+encodeURIComponent(n.url)+"&description="+encodeURIComponent(n.title)+"&media="+encodeURIComponent(n.img)+'" target="_blank">Pinterest</a></li>'),r.weibo||(o+='<li><a class="m-share-weibo" href="http://service.weibo.com/share/share.php?url='+encodeURIComponent(n.url)+'" target="_blank">Weibo</a></li>'),o+="</ul></div>",s.append(o),$(e).replaceWith(s)}}),define("app/modules/sizechart",function(require,e){"use strict";var t=require("underscore"),n=require("i18n"),r=window.devicePixelRatio>1,i="http://cdn04.pinkoi.com/pinkoi.site/panel/sizechart/",s,o=!1,u={content:null,chart:null,type:null};e.sizechart={size_category_map:{shoulder:n.gettext("肩寬"),chest:n.gettext("胸寬"),waist:n.gettext("腰圍"),butt:n.gettext("臀圍"),thigh:n.gettext("大腿寬"),neck:n.gettext("頸圍"),foot:n.gettext("腳圍"),shirt_length:n.gettext("衣長"),sleeve_length:n.gettext("袖長"),skirt_length:n.gettext("裙長"),lower_dress_length:n.gettext("下擺"),pants_width:n.gettext("褲管寬"),pants_length:n.gettext("褲長"),foot_length:n.gettext("腳長"),foot_width:n.gettext("腳寬"),wrist:n.gettext("手腕圍"),ring_inner_diameter:n.gettext("內徑"),animal_length:n.gettext("身長")},model:{cat:{size:{unit:"cm",category:["neck","chest","animal_length"],default_size:[["S","11-15","28-36","26-33"],["M","15-20","36-43","33-41"],["L","19-25","43-51","41-48"]]}},dog:{size:{unit:"cm",category:["neck","chest","animal_length"],default_size:[["XS","16-20","20-23","27-32"],["S","20-23","23-26","32-37"],["M","23-29","26-29","37-42"],["L","29-32","29-32","42-47"]]}},dress:{size:{unit:"cm",category:["chest","waist","lower_dress_length","skirt_length"],default_size:[["S","84","60","90","161"],["M","87","63","93","164"],["L","90","66","96","167"]]}},foot:{size:{unit:"cm",category:["foot","foot_width","foot_length"],default_size:[["M 3.5/ W 5",null,null,"22.8"],["M 4.5/ W 6",null,null,"23.5"],["M 5.5/ W 7",null,null,"24.1"],["M 6.5/ W 8",null,null,"24.8"],["M 7.5/ W 9",null,null,"25.4"],["M 8.5/ W 10",null,null,"26"],["M 9.5/ W 11",null,null,"26.7"],["M 10.5/ W 12",null,null,"27.3"],["M 11.5/ W 13",null,null,"27.9"],["M 12.5/ W 14",null,null,"28.6"]]}},jacket:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"],default_size:[["S","50","56","64","64"],["M","53","59","67","67"],["L","56","62","70","70"]]}},pants:{size:{unit:"cm",category:["waist","butt","thigh","pants_width","pants_length"],default_size:[["XS","60","92","51","45","117"],["S","65","95","54","48","120"],["M","70","98","57","51","123"],["L","75","101","60","54","126"]]}},ring:{size:{unit:"mm",category:["ring_inner_diameter"],default_size:[["5","15.7"],["6","16.5"],["7","17.3"],["8","18.2"],["9","18.9"],["10","19.8"],["11","20.6"],["12","21.3"],["13","22.2"]]}},shirt:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"],default_size:[["XS","46","48","74","60"],["S","47","49","76","61"],["M","48","50","76","61.5"],["L","49","51","76","62"]]}},shorts:{size:{unit:"cm",category:["waist","butt","thigh","pants_width","pants_length"],default_size:[["XS","60","92","51","50","88"],["S","65","95","54","53","91"],["M","70","98","57","56","94"],["L","75","101","60","59","97"]]}},skirt_l:{size:{unit:"cm",category:["waist","lower_dress_length","skirt_length"],default_size:[["XS","60","85","110"],["S","65","88","113"],["M","70","91","115"],["L","75","94","118"]]}},skirt_s:{size:{unit:"cm",category:["waist","lower_dress_length","skirt_length"],default_size:[["XS","60","72","88"],["S","65","75","91"],["M","70","78","94"],["L","75","81","97"]]}},tank:{size:{unit:"cm",category:["shoulder","chest","shirt_length"],default_size:[["S","28","49","70"],["M","31","52","73"],["L","34","55","76"]]}},tops:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"],default_size:[["S","49","55","62","62"],["M","52","58","65","65"],["L","55","61","68","68"]]}},tshirt_m:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"],default_size:[["XS","66","46","70","16"],["S","69","49","73","19"],["M","72","52","76","21"],["L","75","55","79","24"]]}},tshirt_w:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"],default_size:[["XS","35","49","58","15"],["S","38","52","61","18"],["M","41","55","64","21"],["L","44","58","67","24"]]}},wrist:{size:{unit:"cm",category:["wrist"],default_size:[["XS","14-15.5"],["S","15.5-16.5"],["M","16.5-18"],["L","18-19"]]}}}};var a=e.sizechart;e.getTable=function(e,t){var r=[],i="",s=["A","B","C","D","E","F"],o="";a.model[e].size.category.length<2&&(o="two-col");for(var u=0;u<a.model[e].size.category.length;u++)r.push(s[u]+" <span>"+a.size_category_map[a.model[e].size.category[u]]+"</span>");for(var f=0;f<t.length;f++){var l=[];for(var c=0;c<t[f].length;c++)if(t[f][c]||t[f][c]===null)t[f][c]=t[f][c]==="N/A"?"-":t[f][c],l.push(t[f][c]);i+='<tr data-row="'+f+'"><td class="'+o+'">'+l.join("</td><td>")+"</td></tr>"}return'<table class="m-sizechart-table"><thead><tr><th class=" '+o+'">'+n.gettext("尺寸")+"（"+a.model[e].size.unit+"）</th><th>"+r.join("</th><th>")+"</th></tr></thead>"+"<tbody>"+i+"</tbody></table>"},e.getContent=function(t){return u.content?u:e.hasSizechart(t)?t.substring(0,t.indexOf("[SIZECHART]")):t},e.getJSON=function(e){return o||f(e),u.chart},e.getType=function(e){return o||f(e),e?u.type:"shirt"},e.fromStringToTable=function(n){if(e.hasSizechart(n)){var s=$.parseJSON(n),o=t.keys(s),u='<div class="m-sizechart-sample-picture-product <%= key %>-product"><img class="m-dom-lazy" src="'+i+'<%= key %>.png"></div>';return o=t.reject(o,function(e){return e==="picture"}),n='<div id="m-sizechart" class="m-sizechart m-sizechart-fancytable">'+(s.picture?t.template(u,{key:o+(r?"%402x":"")}):"")+'<div id="m-sizechart-table">'+e.getTable(o,s[o].size.sizes,!1)+"</div>"+"</div>",n}return n},e.hasSizechart=function(e){try{return $.parseJSON(e)&&t.size($.parseJSON(e))?!0:!1}catch(n){return!1}},e.reset=function(){o=!1,u={},s=null};var f=function(n){if(o)return;o=!0;if(e.hasSizechart(n)){try{u.chart=$.parseJSON(n)}catch(r){u.chart=null}return u.type=t.reject(t.keys(u.chart),function(e){return e==="picture"})[0],u.content=n,u.type}};e.on=function(e){$(e).addClass("s-on")}}),define("app/modules/store-black",function(require,e){"use strict";var t=require("i18n");e.init=function(e,n,r){var i=$(e),s=!1;i.on("click","[data-click]",function(){var e=$(this),o=e.data("click");switch(o){case"add_black":i.closest(".g-store-black").removeClass("hidden");break;case"save":var u=i.find("[name=edit]").find("textarea").val(),a=parseInt(i.find('[name="punish_rank"]').val());$.ajax({type:"POST",url:"/apiv2/store/add_black",contentType:"application/json",data:JSON.stringify({sid:n,tid:r,memo:u,punish_rank:a}),beforeSend:function(){pinkoi.drawer.on(t.gettext("已更新！"))}}),s=!1;break;case"delete":confirm(t.gettext("確定要移除黑名單，沒有辦法回復喔！"))&&$.ajax({type:"POST",url:"/apiv2/store/delete_black",data:{sid:n}}).done(function(e){e.error?setTimeout(function(){alert(e.error.message)},1e3):location.reload()})}});var o=$("#g-store-black").find("textarea");o.height(o.get(0).scrollHeight),o.on("focus",function(){s=!0}),window.onbeforeunload=function(){if(s)return t.gettext("內容有所變更，但尚未儲存。是否確定不儲存離開？")}}}),define("app/modules/url",function(require,e){"use strict";function n(e,n){if(n||t.get("production"))var r=["cdn01.pinkoi.com","cdn02.pinkoi.com"];else var r=["dev.cdn01.pinkoi.com","dev.cdn02.pinkoi.com"];return r[(e.charCodeAt(e.length-1)&e.charCodeAt(e.length-2))%r.length]}var t=require("settings");e.getItemImg=function(e,r,i){i=i||{};var s=n(e,t.get("getProdIImgOnDev"));i.seq=i.seq||"0",e.indexOf(".")!==-1&&(e=e.split("."),i.seq=e[1],e=e[0]);var o="";return i.protocol=i.protocol||"http",i.protocol&&(o+=i.protocol+":"),o+="//"+s+"/product/"+e,i.seq&&(o+="/"+i.seq),i.rev&&(o+="/"+i.rev),o+="/"+r+".jpg",o},e.getItemUrl=function(e,t){return(t?location.origin:"")+"/product/"+e},e.getStoreBannerImg=function(e,n){var r="";return n&&(n==="thumbnail"?r="banner_t":r="banner"),t.get("production")?location.protocol+"//s3-ap-southeast-1.amazonaws.com/pinkoi.store/"+e+"/"+r+".jpg":location.protocol+"//s3-ap-southeast-1.amazonaws.com/pinkoi.test/"+e+"/"+r+".jpg"},e.getStoreUrl=function(e,t){return(t?location.origin:"")+"/store/"+e},e.getDefaultImg=function(t,n){if(n.el){var r=$(n.el).data("tid"),i=e.getItemImg(r,t,n),s=new Image;s.onload=function(){n.el.src=i},s.onerror=function(){var e=t.split("x")[0]+"px";$(n.el).after('<div style="background:#FFF;height:'+e+";width:"+e+';"></div>').remove()},s.src=i}},e.getAvatar=function(e,t,r){r=r||{},r.seq=r.seq||"0",t=t?t:"100x100";if(e.indexOf("fb_")===0)return e=e.substr(3),t=t.split("x")[0],"http://graph.facebook.com/"+e+"/picture?width="+t+"&height="+t;if(e.indexOf("wb_")===0)return e=e.substr(3),t==="50x50"?"http://tp1.sinaimg.cn/"+e+"/50/100":"http://tp1.sinaimg.cn/"+e+"/180/100";if(e.indexOf("tt_")===0)return"/apiv2/user/avatar?uid="+e;var i="",s=n(e);return r.protocol?i+=r.protocol+":":i+="http:",i+="//"+s+"/user/"+e+"/avatar",r.rev&&(i+="/"+r.rev),i+="/"+t+".jpg",i}}),define("app/modules/user",function(require,e){"use strict";function r(){s()}function i(){s(),document.cookie="st=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="st=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="sessionid=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="sessionid=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",$.post("/apiv2/account/logout").done(function(e){location.href=e.result[0].next})}function s(){n.clear("g.cartNum"),n.clear("g.slot.collection"),n.clear("g.slot.promo"),n.clear("g.slot.hasRead"),n.clear("g.slot.recentShow")}function o(){return!!t.get("uid")}function u(){return!t.get("uid")}function a(){return!!t.get("isAdmin")}var t=require("settings"),n=require("storage/local");e.login=r,e.logout=i,e.isLogin=o,e.notLogin=u,e.isAdmin=a}),define("app/modules/event/headerNav",function(require,e){"use strict";e.init=function(){var e=$("#g-header-rwd"),t=e.find(".mobile-nav-indicator-wrap"),n=require("ui/backdrop"),r=function(){e.removeClass("full"),n.hide()},i=function(){e.addClass("full"),n.show(),n.onclick(r)};t.on("click",function(t){e.hasClass("full")?r():i()})}}),define("app/events",function(require,e){"use strict";function f(e,t,f){switch(e){case"g-fav":var l=t.data("tid");l&&(i.isLogin()?u.addFav(l).done(function(e,r,i){t.hasClass("m-button-fav")&&t.data("click","g-unfav").removeClass("m-button-fav").addClass("m-button-unfav").html(n.gettext("已收藏到慾望清單"))}):o.loginModal(r));break;case"g-unfav":var l=t.data("tid");l&&u.removeFav(l,function(e,r,i){t.hasClass("m-button-unfav")&&(t.data("click","g-fav").removeClass("m-button-unfav").addClass("m-button-fav").html(n.gettext("收藏到慾望清單")),a.show(n.gettext("✔ 已成功移除")))});break;case"g-switch-intl":s.show(r);break;case"g-logout":i.logout()}}function l(){var e="";$(document.body).on("keydown",function(n){t.indexOf([37,38,39,40,65,66],n.keyCode)!==-1?e!=="383840403739373966"?e+=n.keyCode.toString():n.keyCode===65&&$(document.body).trigger("konami"):e=""})}var t=require("underscore"),n=require("i18n"),r=require("ui/modal"),i=require("app/modules/user"),s=require("app/globals/footerLocale"),o=require("mapp/pages/login"),u=require("app/modules/fav"),a=require("ui/drawerBar");e.on=function(){$(document).on("click","[data-click]",function(e){var t=$(this),n=t.data("click");n=n.split(",");for(var r=0,i=n.length;r<i;++r)n[r].substr(0,2)==="g-"&&f(n[r],t,e)}),l()}}),define("app/postinit",function(require,e){"use strict";function N(){n.get("locale")!=="zh_CN"&&y.parseFBML(S)}var t=require("underscore"),n=require("settings"),r=require("net/cookie"),i=require("net/urlparse"),s=require("storage/local"),o=require("track/ga"),u=require("ui/Inviewport"),a=require("app/events"),f=require("app/modules/user"),l=require("app/modules/request"),c=require("app/modules/cart"),h=require("app/globals/menu"),p=require("app/globals/eventNotice"),d=require("mapp/pages/login"),v=require("ui/modal"),m=require("ui/toaster"),g=require("ui/localeNotice"),y=require("external/facebook"),b=require("app/globals/browseHistory"),w=require("app/globals/point"),E=require("app/globals/voiceInput"),S=$(".m-fb-fbml");h.init(),o.init(),a.on(),f.isLogin()&&c.updateNum(),r.has("m2")||r.set("m2",!Modernizr.touch||navigator.userAgent.indexOf("Windows")>0&&window.innerWidth>768?"0":"1","1y"),$("#g-switch-mobile").on("click",function(e){r.set("m2","1","1y"),r.del("desktop"),s.del("g.ua"),setTimeout(function(){location.reload()},200)});if(Modernizr.touch){var x=s.get("g.ua"),T=navigator.userAgent;s.set("g.ua",T),x&&x!==T&&/mobile/i.test(navigator.userAgent)&&(r.del("desktop"),s.del("g.ua"),setTimeout(function(){location.reload()},200))}$("#g-footer").length&&new u({el:"#g-footer",buffer:250,cb:function(){b.render(7)}}),S.length&&setTimeout(N,40),n.get("uid")&&w.init(),n.get("production")&&window.console&&console.log($("head").find('meta[name="X-Recruiting"]').attr("content")),n.get("suggestedLocale")&&g.init(),E.init();if(!f.isLogin())(i.current().get("next")||i.current().get("_login"))&&d.loginModal(v);else{var C=n.get("unreadMsg");C&&$("#gheader .message").after('<a class="notice_unread" href="/message">'+C+"</a>")}p.init()}),define("app/globals/footerLocale",function(require,e){"use strict";var t=require("underscore"),n=require("i18n"),r,i=function(e,n,r,i){return e.type=n,e.value=e[n],e.checked=r?"checked":"",e.notShowCode=!!i,t.template('<input id="g-footer-<%= type %>-<%= value %>" name="<%= type %>" type="radio" value="<%= value %>" <%= checked %>><label for="g-footer-<%= type %>-<%= value %>"><%= name %> <% if (!notShowCode) { %>(<%= value %>)<% } %></label>',e)},s=function(e){var t=e.locale.code||"",r=e.locale.currency||"",s=e.result[0],o="";o+='<div class="g-footer-locale"><form method="POST" action="/apiv2/i18n/set_locale"><div class="col"><span>'+n.gettext("語言/Language")+"</span>"+"<ul>";if(s.locale)for(var u in s.locale)s.locale[u].name&&(o+="<li>"+i(s.locale[u],"locale",t===s.locale[u].locale,!0)+"</li>");o+='</ul></div><div class="col"><ul><span>'+n.gettext("貨幣/Currency")+"</span>";if(s.currency)for(var u in s.currency)s.currency[u].name&&(o+="<li>"+i(s.currency[u],"currency",r===s.currency[u].currency)+"</li>");return o+="</ul></div>",o+='<div class="button-wrapper"><a class="m-button m-btn-important" data-click="submit">'+n.gettext("確定")+"</a></div></form>",o+="</div>",o},o=function(e){$.ajax({url:"/apiv2/i18n/get_available_locale",type:"GET"}).done(function(t){t.result&&(e.show(s(t),{className:"g-footer-locale-modal",verticalCenter:!0,backdrop:!0}),e.on("click",'[data-click="submit"]',function(){e.$body.find("form").submit()}))})};e.show=o}),define("app/globals/menu",function(require,e){"use strict";var t=require("settings"),n=require("net/urlparse"),r=n.current().paths[0],i=$("#g-menu"),s=null,o=function(e){return $(e).hasClass("tab")},u=function(e){return $(e).hasClass("clicked")},a=function(e){return $(e).hasClass("leaf")};e.init=function(){i.find(".nav").append('<b class="heart"></b>'),i.on("mouseover focus",function(e){s&&(clearTimeout(s),s=null),o(e.target)&&!u(e.target)&&f();if(o(e.target)){var t=e.target,n=$(t);if(a(t))f();else{f(),n.addClass("clicked");var r=n.closest("li");r.addClass("clicked adjacent_active").prev().addClass("adjacent_active");var i=$(t).nextAll("div.sub");i.slideDown(100),i.children().animate({top:0},{queue:!1,duration:100},"swing")}}}).on("mouseout blur",function(e){s=setTimeout(function(){f()},100)}).on("click",function(e){s&&(clearTimeout(s),s=null);if(o(e.target)){var t=e.target,n=$(t);if(u(t)||a(t)){var r=n.closest("li");f(),r.addClass("adjacent_active").prev().addClass("adjacent_active")}else{var i=$(t).nextAll("div");f(),n.addClass("clicked"),n.closest("li").addClass("clicked"),i.slideDown(100),i.children().animate({top:"0"},{queue:!1,duration:100}
,"swing")}}});var e;r&&$.inArray(r,["window","wall","magz","user","my","panel","friends"])<0&&(r="browse"),r=r?r:"home",e=i.find("li."+r).addClass("active"),e&&e.prev().addClass("adjacent_active")};var f=function(){var e=i.find("li > a.clicked"),t=e.nextAll("div"),n=t.height()+20;t.children().animate({top:-n+"px"},{queue:!1,duration:100},"swing"),t.slideUp(200),e.removeClass("clicked");var r=e.closest("li");r.removeClass("clicked"),r.next()&&!r.next().hasClass("active")&&r.removeClass("adjacent_active"),r.hasClass("active")||r.prev().removeClass("adjacent_active")}}),define("app/globals/browseHistory",function(require,e){"use strict";var t=require("underscore"),n=require("i18n"),r=require("settings"),i=require("net/urlparse"),s=require("storage/local"),o=require("app/modules/url"),u=i.current().paths,a=u[0],f,l=35,c=$("#g-browse-history"),h=function(e,n){e.length>=l&&e.shift();if(e.length)for(var r=0;r<e.length;r++)if(e[r].tid===n)return e[r]="",t.compact(e);return e},p=function(){var e;a==="product"&&r.get("product")?(e=r.get("product"),f.product||(f.product=[]),f.product=h(f.product,e.tid),f.product.push({tid:e.tid,title:e.title,price:e.price}),s.set("g.browseHistory.product",f.product),f.product.pop()):a==="magz"&&r.get("magz")&&(e=r.get("magz"),f.magz||(f.magz=[]),f.magz=h(f.magz,e.tid),f.magz.push({tid:e.tid,title:e.title,img:e.img}),s.set("g.browseHistory.magz",f.magz),f.magz.pop())},d=function(){f={product:s.get("g.browseHistory.product"),magz:s.get("g.browseHistory.magz")},p()},v=function(e){var r="",i=[],s=[],u,a=0;e=e?e:l,u=function(e,n){if(n==="product")return e.img=o.getItemImg(e.tid,"160x160"),t.template('<li><a href="/product/<%= tid %>" style="background-image:url(<%= img %>);" data-ga-category="History" data-ga-action="/product/<%= tid %>"><span><%= title %></span><i><%= price %></i></a></li>',e);if(n==="magz")return t.template('<li><a href="/magz/<%= tid %>" style="background-image:url(<%= img %>);" data-ga-category="History" data-ga-action="/magz/<%= tid %>"><span><%= title %></span></a></li>',e)};if(f.product&&f.product.length){i.push("<h3>"+n.gettext("你最近瀏覽過的商品")+'...</h3><ul class="product-list">');for(var h=f.product.length-1;h>-1&&a<e;h--)i.push(u(f.product[h],"product")),a++;i.push("</ul>")}a=0;if(f.magz&&f.magz.length){s.push("<h3>"+n.gettext("你最近瀏覽過的設計誌")+"...</h3><ul>");for(var p=f.magz.length-1;p>-1&&a<e;p--)s.push(u(f.magz[p],"magz")),a++;s.push("</ul>")}if(f.product&&f.product.length||f.magz&&f.magz.length){if(!c.length)return;c.addClass("g-browse-history").html("<div><h2>"+n.gettext("你的瀏覽紀錄小秘書")+"</h2>"+i.join("")+s.join("")+"</div>").show();if(e<l&&f.product&&f.product.length>e||f.magz&&f.magz.length>e){var d=$('<a class="more">'+n.gettext("看更多紀錄")+"</a>");d.one("click",function(){v(l),d.remove()}),$("#g-browse-history > div").append(d)}}};e.render=v,d()}),define("app/globals/point",function(require,e){"use strict";var t=require("underscore"),n=require("settings"),r=require("i18n"),i=require("storage/local"),s=require("css/transitionend"),o=require("ui/requestAnimation"),u=parseInt((new Date).getTime()/1e3,10),a=function(e,n){n=n||0;var u=$("#g-point"),a='<span class="note">'+r.gettext("目前紅利<b><%= point %></b>點")+' ( <a href="/page/reward" target="_blank">?</a> )'+"</span>",f=$('<div class="point-bar"></div>'),l=$('<div class="point-bar-status"></div>'),c=$('<div class="point-bar-plus"></div>'),h=0,p=0;l.appendTo(f),u.append(t.template(a,{point:e})),u.append(f),u.width(),u.on("click",function(e){$(e.target).is("a")||(location.href="/my/reward")}),p=Math.sqrt(e)>99?"95":Math.sqrt(e),n&&(c.appendTo(f),i.set("g.point.plus",0,"1y"),h=n/e*p,p-=h,h=Math.floor(h),h=h<3?3:h,h=h>100?100:h),p=Math.floor(p),o(function(){parseInt(n,10)>0&&s(l,function(){f.addClass("s-plus"),c.css("width",h+"%"),p||f.addClass("s-zero"),f.append('<span class="plus" style="left:'+(p+h-7)+'%">+'+n+"</span>")}),l.css("width",p+"%")})};e.init=function(){if(n.get("uid")){var e=parseInt(i.get("g.point"),10)||0,t=0;e?a(e,0):$.ajax({type:"GET",url:"/api/user/point"}).done(function(n){n.result&&(e=n.result.points,t=n.result.plus,i.set("g.point",e,"10M"),i.set("g.point.plus",t,"1M"),a(e,t))})}},e.clearCache=function(){i.del("g.point")}}),define("app/globals/voiceInput",function(require,e){"use strict";var t=require("underscore"),n=require("settings"),r=require("i18n"),i=function(e,i){if(!("webkitSpeechRecognition"in window)){i.remove();return}var s,o=!1,u={zh_TW:"cmn-Hant-TW",zh_CN:"cmn-Hans-CN",ja:"ja-JP",en:"en-US",th:"th-TH"};i.removeClass("s-hide-tip"),i.attr("data-tip",r.gettext("請允許麥克風權限")),s=new webkitSpeechRecognition,s.continuous=!0,s.interimResults=!0,s.lang=u[n.get("locale")]?u[n.get("locale")]:"en-US",n.get("geo")==="HK"&&n.get("locale")==="zh_TW"&&(s.lang="yue-Hant-HK"),s.start(),i.on("click",function(e){s.start()}),s.onstart=function(){o=!1,i.addClass("s-hide-tip s-recording")},s.onresult=function(n){var r=n.results,u="";for(var a=0;a<r.length;a++){for(var f=0;f<r[a].length;f++)u+=r[a][f].transcript;r[a].isFinal&&(o=!0,e.attr("value",u),i.removeClass("s-recording"),_gaq.push(["_trackEvent","Voice input","Search",u+" ("+s.lang+")",null,!0]),t.delay(function(){e.closest("form").submit()},500))}u&&!o&&e.attr("value",u)}},s=function(){if(!("webkitSpeechRecognition"in window))return;$(".g-voiceinput-form").append('<span class="g-voiceinput s-hide-tip"></span>'),$(".g-voiceinput").on("click",function(e){_gaq.push(["_trackEvent","Voice input","Start Search","Click start",null,!0]),i($('.g-voiceinput-form input[type="search"]'),$(e.currentTarget))})};e.init=s}),define("app/globals/eventNotice",function(require,e){"use strict";var t=require("net/cookie"),n=require("storage/local"),r=require("ui/toaster");e.init=function(){var e=t.get("kkboxtw_issued"),i=n.get("kkboxtw_noticed");e&&!i&&(e==="1"?r.show("<p>50 元購物金已經加到你的帳戶，購物金可於 Pinkoi 全站使用，不限消費金額皆可折抵。</p>",{hide:!1,className:"g-kkbox-toaster"}):e==="2"&&r.show('<p>每個帳號僅限領取一次噢，快來逛逛能讓你越聽越 high 的個性化 3C 配件吧！</p><a class="m-button" href="http://www.pinkoi.com/browse/?category=11&subcategory=1107">好音樂不落漆→</a>',{hide:!1,className:"g-kkbox-toaster"}),t.del("kkboxtw_issued"),n.set("kkboxtw_noticed",1,"1d"));var s=t.get("kkboxhk_issued"),o=n.get("kkboxhk_noticed");s&&!o&&(s==="1"?r.show("<p>台幣 50 元現金獎賞已經存入你的帳戶，現金獎賞適用於 Pinkoi 所有商品，不限消費金額皆可使用。</p>",{hide:!1,className:"g-kkbox-toaster"}):s==="2"&&r.show('<p>每個帳號僅限領取一次噢，快來搜購能讓你越聽越high的音樂配件吧！</p><a class="m-button" href="http://www.pinkoi.com/browse/?category=11&subcategory=1107">好音樂好設計→</a>',{hide:!1,className:"g-kkbox-toaster"}),t.del("kkboxhk_issued"),n.set("kkboxhk_noticed",1,"1d"));var u=t.get("cityzine_issued"),a=n.get("cityzine_noticed1"),f=n.get("cityzine_noticed2");u&&!a&&(u==="1"?r.show("<p>20 元人民币的购物金已经加到你的 Pinkoi 账户。请查收站内信了解详情。</p>",{hide:!1,className:"g-cityzine-toaster"}):u==="2"&&cityzine_noticed2&&r.show("<p>你已经领取过 20 元专属购物金啦！快点开始逛设计小旅行吧。</p>",{hide:!1,className:"g-cityzine-toaster"}),t.del("cityzine_issued"),n.set("cityzine_noticed1",1,"1d"));var l=t.get("hkonly_issued"),c=n.get("hkonly_noticed1"),h=n.get("hkonly_noticed2"),p=n.get("hkonly_noticed3");l&&(l==="1"&&!c?(r.show("<p>港幣50元購物金已經加到你的 Pinkoi 帳戶，請查收站內信以了解詳情>！</p>",{hide:!1,className:"g-cityzine-toaster"}),n.set("hkonly_noticed1",1,"1d")):l==="2"&&!h?(r.show('<p>你已經領取了港幣50元購物金，也把優惠分享給朋友！<a class="m-button-fb" href="https://www.facebook.com/sharer/sharer.php?u=http://pinkoi.com/event/hk_member" target="_blank">分享至 Facebook</a></p>',{hide:!1,className:"g-cityzine-toaster"}),n.set("hkonly_noticed2",1,"1d")):l==="3"&&!p&&(r.show("<p>已經是會員的無法領取是次購物金！</p>",{hide:!1,className:"g-cityzine-toaster"}),n.set("hkonly_noticed3",1,"1d")),t.del("hkonly_issued"))}}),define("mapp/pages/login",function(require,e){"use strict";var t=require("i18n"),n=require("underscore"),r=require("settings"),i=require("net/urlparse"),s=require("net/cookie"),o=require("storage/local"),u=require("app/modules/url"),a=["#forgetpassword","#signup","#resend","#resend","#not_confirm_email"],f,l,c="",h,p=!1,d=i.parse(parent.location.href).queryDict.next||r.get("next"),v,m,g={};d||(d=i.parse(parent.location.href).path),r.del("next");var y=function(){return f=$(".n-login"),l=$("#n-login-form"),{$el:$('<div class="n-login-modal"></div>'),tpls:{forgetpassword:$("#n-login-forgetpassword-tpl").html(),resend:$("#n-login-resend-tpl").html(),signup:$("#n-login-signup-tpl").html(),need_email:$("#n-login-need-email-tpl").html(),not_confirm_email:$("#n-login-not-confirm-email-tpl").html()},init:function(e){h=location.hash!=="#signup",$(".n-login-wrapper").append(g.$el),e||$(window).on("popstate",function(e){h=location.hash!=="#signup"&&window.history.state===null;var t=!1,n,i=window.history.state||e.state;n=function(){location.href=d},i&&(t=i.page==="login"||i.page==="signup",(i.page=v)&&n()),!h&&i&&i.page=="signup"&&t&&n();if(i===null||i===undefined){v==="signup"||v==="login"?n():g.handler();return}h?n():t&&v===i.page?location.href=d:t||(g.handler(i.page==="login"?null:i.page),r.get("mobile")&&b(g.$el))})},handler:function(e){v=e,e?(f.addClass("s-modal"),g.$el.html(g.tpls[e]),window.history.pushState&&window.history.pushState({page:e},e,"#"+e)):(f.removeClass("s-modal"),l.removeClass("s-error"),g.$el.empty()),b($(document.body))},error:function(e,t){e.addClass("s-error"),$(e.find(".n-login-message")).html(t),b(e)},success:function(e){e.removeClass("s-error").addClass("s-success"),$(".s-success-hide").hide(),$(".s-success-show").show(),h=!1,p=!1,b(e)}}},b=function(e){if(i.parse(location.href).paths[0]==="product")return;setTimeout(function(){e.width(),document.body.scrollTop=0},100)},w=function(e){n.delay(function(){e.data("submitted",!1)},1e3)},E=function(e){var t=e.find("[login-required]");$(t).removeClass("s-notice");var n=function(t){w(e),t.removeClass("s-notice"),g.error(e,t.next().data("error"))};for(var r=0;r<t.length;r++){var i=$(t[r]),s=$.trim(i.val()),o=i.attr("type");i.removeAttr("class",""),i.width();if(s==="")return i.addClass("s-notice"),i.width(),Modernizr.ie&&alert(i.next().data("notice")),!1;switch(o){case"text":if(i.data("type")==="id"&&!/^[A-Za-z0-9\-_]+$/g.test(s))return g.error(e,$(i.next()).data("error")),n(i),!1;if(i.data("type")==="signup-id"&&!/^[A-Za-z0-9\-]+$/g.test(s))return g.error(e,$(i.next()).data("error")),n(i),!1;break;case"password":if(i.attr("id")!=="n-login-password"&&!/^[A-Za-z0-9]{6,}$/g.test(s))return n(i),!1;break;case"e-mail":if(!/^([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}[\s,]*){1,4}?/i.test(s))return n(i),!1}}return!0};e.init=function(e,i){if(!e){var s=new Date;if(s.getFullYear()==2015&&s.getMonth()==6&&s.getDate()>=16&&s.getDate()<=30)var o=t.gettext("限時活動！6月底前加入送 1,000 點紅利，結帳時可抵消費。");else var o=t.gettext("加入會員馬上送你 500 點紅利購物金");$("#n-login").append(n.template(c,{originEntry:i||d,loginButton:x(i),text:o})),g=y(),g.init()}$("#n-login").on("submit",".n-login-form",function(e){e.preventDefault();var n=$(e.target),i=$(n.find('input[type="submit"]'));n.removeClass("s-error s-notice"),p=!0;if(!E(n)){n.width();return}if(n.data("submitted"))return;n.data("submitted",!0);var s={},o;o=n.data("action");if(!o)throw"No specific action type.";if(o==="pinkoi_login"||o==="register")s.uid=$.trim(n.find('[name="id"]').get(0).value),s.passwd=$.trim(n.find('[name="passwd"]').get(0).value),s.campaign=$.trim(r.get("campaign","")),s.next=n.data("next");o!=="pinkoi_login"&&(s.email=$.trim(n.find('[name="email"]').get(0).value));if(o==="need_email"){i.addClass("s-loading"),$.getJSON("/apiv2/account/need_email"+(location.search||"?")+encodeURI("&email="+s.email)).done(function(e){e.error?(w(n),g.error(n,e.error.message)):(g.success(n),w(n),$("#n-login-need-email-h2").remove(),n.data("action","need_email_success"),$(n.find(".your-email")[0]).text(s.email))}).always(function(){i.removeClass("s-loading")});return}if(o==="need_email_success"){n.data("next")?location.href=n.data("next"):location.href=d;return}i&&i.addClass("s-loading"),$.ajax({type:"POST",url:"/apiv2/account/"+(o==="forgetpassword"?"reset_passwd":o),data:s,dataType:"json"}).done(function(e){if(e.error){i.removeClass("s-loading").width(),w(n);switch(e.error.detail){case"not_confirm_email":g.handler("not_confirm_email")}g.error(n,e.error.message)}else{i.attr("data-click","go-to-next").attr("value",t.gettext("繼續逛 Pinkoi")).removeClass("s-login-loading");if(o==="pinkoi_login")location.href=n.data("next");else{g.success(n);switch(o){case"register":break;case"forgetpassword":$(n.find(".your-email")[0]).text(s.email);break;case"resend":$(n.find(".your-email")[0]).text(s.email)}}(o==="resend"||o==="forgetpassword")&&$(n.find(".your-email")[0]).text(s.email)}}).fail(function(){i.attr("value",t.gettext("發生錯誤，請稍候再試")).width(),w(n)})}),$("#n-login").on("focus blur","form input[data-focus]",function(e){e.type==="focus"||e.type==="focusin"?($(e.currentTarget.parentNode).addClass("focus"),m&&m.val()===""&&m.attr("id")!==$(e.target).attr("id")&&($(m.parents()).removeClass("focus"),$(m).removeClass("s-notice")),m=$(e.target),Modernizr.android&&g.$el.css("top","-120px"),!r.get("mobile")):($(e.target).removeClass("s-notice"),m&&m.val()===""&&m.attr("id")===$(e.target).attr("id")&&$($(e.target).parents()).removeClass("focus"),Modernizr.android&&g.$el.css("top","0px"))}),$("#n-login").on("click touchstart","[data-click]",function(e){var t=$(e.target),n=t.data("click");switch(n){case"fb":case"weibo":case"twitter":break;case"signup":g.handler("signup"),p=!1,e.preventDefault();break;case"forgetpassword":g.handler("forgetpassword");break;case"resend":g.handler("resend");break;case"back-to-main":g.handler(),window.history.pushState&&!h&&window.history.pushState({page:"login"},"login","/login?next="+encodeURIComponent(d));break;case"go-to-next":t.data("next")?location.href=t.data("next"):location.href=d;break;case"login":t.width(),location.reload();break;case"btn-next":$("#social-btn").addClass("next");break;case"btn-prev":$("#social-btn").removeClass("next")}}),e&&(g=y(),g.init(e));if(location.hash==="#signup"){g.handler("signup"),h=!1;return}location.href.indexOf("need_email")===-1?location.hash="":g.handler("need_email");if(!r.get("mobile"))return;$(".n-login-upper").hammer().on("dragleft dragright drag scroll",function(e){e.type==="dragleft"?$("#social-btn").addClass("next"):$("#social-btn").removeClass("next"),(e.type==="drag"||e.type==="scroll")&&e.preventDefault()})},e.loginModal=function(r,i,s){i=i?i:d;var o=s?s:t.gettext("加入會員馬上送你 500 點紅利購物金");r&&(r.show('<div id="n-login" class="s-modal">'+n.template(c,{originEntry:i,loginButton:x(i),text:o})+"</div>",{className:"n-login-modal-wrapper",isBlack:!0}),e.init(!0,i))};var S=function(e){return r.get("locale")===e?!0:!1},x=function(e){var n,s,o=r.get("locale"),u,a,f;e&&(d=e);var l=i.current().get("campaign");if(!l){var c=i.current().get("_login");c&&(r.get("mobile")?l="_mlogin":l="_login")}r.set("campaign",l);var h=l?"campaign="+l+"&":"",p=encodeURIComponent(d);u='<a class="m-button-fb" data-oauth="true" data-click="fb" href="/apiv2/account/facebook_oauth?'+h+"next="+p+'">'+t.gettext("用<span>Facebook</span>登入")+"</a>",f='<a class="m-button-weibo" data-oauth="true" href="/apiv2/account/weibo_oauth?'+h+"next="+p+'">'+t.gettext("用<span>Weibo</span>微博登录")+"</a>",a='<a class="m-button-twitter" data-oauth="true" data-click="twitter" href="/apiv2/account/twitter_oauth?'+h+"next="+p+'">'+t.gettext("用<span>Twitter</span>登入")+"</a>";if(o==="th")n=u+a,s=f;else if(o==="ja"||o==="en")n=u+a;else{var v=i.current().get("_disable");v?v==="facebook"?(n=f,s=u):v==="weibo"&&(n=u,s=a):(n=u+f,s=a)}return n='<div class="social-login-btn">'+n+"</div>",s?s='<div class="social-login-btn">'+s+"</div>":s="",n+s};c='<div class="n-login g-btn-new" ontouchstart="">     <div class="n-login-wrapper">         <div class="n-login-main inner-wrapper">           <div class="n-login-upper">            <div class="logo"></div>            <h1>'+t.gettext("登入 Pinkoi")+"</h1>"+'            <div id="social-btn" class="social-login-btn-wrapper m-carousel-container">'+'               <div class="inner-btn-wrapper">'+"<%= loginButton %>"+"               </div>"+"            </div>"+'            <div class="prev-next"><i data-click="btn-prev"></i><i data-click="btn-next"></i></div>'+'            <p class="promo"><%= text %></p>'+"           </div>"+'            <div class="form-wrapper">'+'                <form id="n-login-form"class="n-login-form" data-next="<%= originEntry %>" data-action="pinkoi_login">'+'                    <div class="n-login-message"></div>'+'                    <p class="n-login-pinkoi-account">'+t.gettext("或使用 Pinkoi 帳號登入")+"</p>"+"                    <ul>"+"                        <li>"+'                            <input id="n-login-id"  autocomplete="off" type="text" name="id" data-focus="true" data-type="id" login-required>'+'                            <label for="n-login-id" data-notice="'+t.gettext("請填入帳號")+'" data-error="'+t.gettext("請檢查帳號")+'">'+t.gettext("Pinkoi 帳號")+"</label>"+"                        </li>"+"                        <li>"+'                            <input id="n-login-password"  autocomplete="off" type="password" name="passwd" data-focus="true" login-required>'+'                            <label for="n-login-password" data-notice="'+t.gettext("請填入密碼")+'">'+t.gettext("密碼")+"</label>"+"                        </li>"+"                    </ul>"+'                    <div class="button-wrapper">'+'                        <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("登入")+'">'+"                    </div>"+"                </form>"+'                <div class="n-login-help">'+'                    <div class="n-login-problem left-block"> '+'                        <span data-click="forgetpassword">'+t.gettext("忘記密碼")+"</span>"+'                        <span data-click="resend">'+t.gettext("未收到認證信")+"</span>"+"                    </div>"+'                    <div class="right-block"><span data-click="signup">'+t.gettext("註冊新帳號")+"</span></div>"+"                </div>"+"            </div>"+"        </div>"+"    </div>"+"</div>"+'<script id="n-login-signup-tpl" type="text/html">'+'    <div class="n-login-signup">'+'        <div class="logo"></div>'+'        <div class="form-wrapper">'+'            <h2 class="s-success-hide">'+t.gettext("註冊個人帳號")+"</h2> "+'            <form id="n-login-signup-form" class="n-login-form" data-next="<%= originEntry %>" data-action="register">'+'                <div class="n-login-message">'+t.gettext("錯誤訊息")+"</div>"+'                <div class="n-login-result">'+"                    <h2>"+t.gettext("註冊成功")+"</h2>"+"                    <p>"+t.gettext("我們已經將一封認證信寄至你的信箱，請點擊信裡的確認連結以開通帳號。")+t.gettext("連結只在兩週內有效，快去收信吧！")+"</p>"+'                    <p class="note">'+t.gettext("（找不到認證信時，請記得查看垃圾信箱喔）")+"</p>"+"                </div>"+'                <ul class="n-login-signup-ul s-success-hide">'+"                    <li>"+'                        <input id="n-login-signup-id" type="text" name="id" data-focus="true" maxlength="16" data-type="signup-id" login-required>'+'                        <label for="n-login-signup-id" data-notice="'+t.gettext("請填入帳號")+'" data-error="'+t.gettext("帳號只能是英文字母、數字和-")+'">'+t.gettext("你喜歡的 Pinkoi 帳號")+"</label>"+"                    </li>"+"                    <li>"+'                        <input id="n-login-signup-password" type="password" name="passwd" data-focus="true" login-required>'+'                        <label for="n-login-signup-password" data-notice="'+t.gettext("請填入密碼")+'" data-error="'+t.gettext("密碼限英文大小寫或數字，但不含標點符號與空格，總長度至少 6 碼以上")+'">'+t.gettext("密碼")+"</label>"+"                    </li>"+"                    <li>"+'                        <input id="n-login-signup-email" type="e-mail" name="email" data-focus="true" login-required>'+'                        <label for="n-login-signup-email" data-notice="'+t.gettext("請填入 Email")+'" data-error="'+t.gettext("請檢查 Email")+'">'+t.gettext("Email 信箱")+"</label>"+"                    </li>"+"                </ul>"+'                <p class="n-login-tos  s-success-hide">'+t.gettext('點擊註冊的同時，表示您已詳閱<a href="http://www.pinkoi.com/policy" target="_blank">我們的資料使用政策與使用條款</a>，同意使用 Pinkoi 所提供的服務並訂閱電子報。')+"                </p>"+'                <div class="button-wrapper s-success-hide">'+'                    <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("註冊")+'">'+"                </div>"+"            </form>"+'            <div class="button-wrapper s-success-show">'+'                <input type="button" class="m-button-pink m-button-xl m-button-stretch" data-click="go-to-next" value="'+t.gettext("繼續逛 Pinkoi")+'">'+"            </div>"+'            <div class="back-to-main s-success-hide" data-click="back-to-main">'+t.gettext("已經有帳號了？馬上登入")+"</div>"+"        </div>"+"    </div>"+"</script>"+'<script id="n-login-resend-tpl" type="text/html">'+'    <div class="n-login-resend">'+'        <div class="logo"></div>'+'        <div class="form-wrapper">'+'            <form id="n-login-resend-form" class="n-login-form" data-next="<%= originEntry %>" data-action="resend">'+'                <div class="n-login-message">'+t.gettext("錯誤訊息")+"</div>"+"                <h2>"+t.gettext("未收到認證信？")+"</h2>"+'                <div class="n-login-result">'+"                    <p>"+t.gettext("已將認證信寄至您的信箱")+"</p>"+'                    <em class="your-email"></em>'+"                </div>"+'                <ul class="s-success-hide">'+"                    <li>"+'                        <input id="n-login-resend-email" type="e-mail" name="email" data-focus="true" login-required>'+'                        <label for="n-login-resend-email" data-notice="'+t.gettext("請填入 Email")+'" data-error="'+t.gettext("Email 錯誤")+'">'+t.gettext("註冊時用的 Email 信箱")+"</label>"+"                    </li>"+"                </ul>"+'                <div class="button-wrapper s-success-hide">'+'                    <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("重新寄送認證信")+'">'+"                </div>"+'                <div class="button-wrapper s-success-show">'+'                    <input type="button" class="m-button-pink m-button-xl m-button-stretch" data-click="go-to-next" value="'+t.gettext("繼續逛 Pinkoi")+'">'+"                </div>"+"            </form>"+"        </div>"+"    </div>"+"</script>"+'<script id="n-login-forgetpassword-tpl" type="text/html">'+'    <div class="n-login-forgetpassword">'+'        <div class="logo"></div>'+'        <div class="form-wrapper">'+'            <form id="n-login-forgetpassword-form" class="n-login-form" data-next="<%= originEntry %>" data-action="forgetpassword">'+'                <div class="n-login-message">'+t.gettext("錯誤訊息")+"</div>"+"                <h2>"+t.gettext("忘記密碼？")+"</h2>"+'                <div class="n-login-result">'+"                    <p>"+t.gettext("已將更換新密碼的資訊寄至您的信箱")+"</p>"+'                    <em class="your-email"></em>'+"                </div>"+'                <ul class="s-success-hide">'+"                    <li>"+'                        <input id="n-login-forgetpassword-email" type="e-mail" name="email" data-focus="true" login-required>'+'                        <label for="n-login-forgetpassword-email" data-notice="'+t.gettext("請填入 Email")+'" data-error="'+t.gettext("Email 錯誤")+'">'+t.gettext("註冊時用的 Email 信箱")+"</label>"+"                    </li>"+"                </ul>"+'                <div class="button-wrapper s-success-hide">'+'                    <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("重設密碼")+'"> '+"                </div>"+'                <div class="button-wrapper s-success-show">'+'                    <input type="button" class="m-button-pink m-button-xl m-button-stretch" data-click="go-to-next" value="'+t.gettext("繼續逛 Pinkoi")+'">'+"                </div>"+"            </form>"+"        </div>"+"    </div>"+"</script>"+'<script id="n-login-need-email-tpl" type="text/html">'+'    <div class="n-login-need-email">'+'        <div class="logo"></div>'+'        <div class="form-wrapper">'+'            <h2 id="n-login-need-email-h2">'+t.gettext("只差最後一步")+"</h2>"+'            <form id="n-login-need-email-form" class="n-login-form" data-next="<%= originEntry %>" data-action="need_email">'+'                <div class="n-login-message">'+t.gettext("錯誤訊息")+"</div>"+'                <div class="n-login-result">'+"                    <p>"+t.gettext("我們已經將一封認證信寄至你的信箱，請點擊信裡的確認連結以開通帳號。")+"</p>"+"                    <p>"+t.gettext("連結只在兩週內有效，快去收信吧！")+"</p>"+'                    <em class="your-email"></em>'+"                </div>"+"                <ul>"+"                    <li>"+'                        <input id="n-login-need-email-email" type="e-mail" name="email" data-focus="true" login-required>'+'                        <label for="n-login-need-email-email" data-notice="'+t.gettext("請填入 Email")+'" data-error="'+t.gettext("Email 錯誤")+'">'+t.gettext("Email 信箱")+"</label>"+"                    </li>"+"                </ul>"+'                <div class="button-wrapper">'+'                    <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("繼續逛 Pinkoi")+'">'+"                </div>"+"            </form>"+"        </div>"+"    </div>"+"</script>"+'<script id="n-login-not-confirm-email-tpl" type="text/html">'+'    <div class="n-login-resend">'+'        <div class="logo"></div>'+'        <div class="form-wrapper">'+'            <form id="n-login-not-confirm-email-form" class="n-login-form" data-next="<%= originEntry %>" data-action="resend">'+'                <div class="n-login-message">'+t.gettext("錯誤訊息")+"</div>"+'                <div class="n-login-result s-success-hide" style="visibility:visible;height:auto;">                                                          '+'                    <p class="s-success-hide" style="font-size:16px;">'+t.gettext("這個帳號已被註冊但尚未開通，請回到當初申請這個帳號的 Email 信箱，點擊認證信中的連結以開通帳號，完成註冊流程。")+"</p>"+'                    <p style="margin-bottom:18px;margin-top:15px;font-size:16px;">'+t.gettext("如未收到也可以重寄認證信：")+"</p>  "+"                </div>"+'                <div class="n-login-result s-success-show" style="display:none;">'+"                    <p>"+t.gettext("已將認證信寄至您的信箱")+"</p>"+'                    <em class="your-email"></em>'+"                </div>"+'                <ul class="s-success-hide">'+"                    <li>"+'                        <input id="n-login-not-confirm-email" type="e-mail" name="email" data-focus="true" login-required>'+'                        <label for="n-login-not-confirm-email" data-notice="'+t.gettext("請填入 Email")+'" data-error="'+t.gettext("Email 錯誤")+'">'+t.gettext("註冊時用的 Email 信箱")+"</label>"+"                    </li>"+"                </ul>"+'                <div class="button-wrapper s-success-hide">'+'                    <input type="submit" class="m-button-pink m-button-xl m-button-stretch" value="'+t.gettext("重新寄送認證信")+'">'+"                </div>"+"            </form>"+"        </div>"+"    </div>"+"</script>"}),define("mapp/modules/request",function(require,e){"use strict";function o(e){var o;e=e||{},e.type=e.type||"GET",e.type&&(e.type=e.type.toUpperCase()),i.isJquery(e.data)&&(e.data=$(e.data).get(0)),t.isElement(e.data)&&(e.data=r.pack(e.data));if(!e.contentType&&Modernizr.ajaxfileupload){e.data=r.toFormData(e.data);var u=$.Deferred(),a=new XMLHttpRequest;a.open(e.type,e.url,!0),a.addEventListener("load",function(t){if(a.status==200)try{var n=JSON.parse(t.currentTarget.responseText);e.success&&e.success(n,"success",a),u.resolve(n,"success",a);return}catch(r){alert("JSON.parse Error")}else e.error(a,a.statusText,t.currentTarget.responseText)});if(e.progress){if(!("onprogress"in a))throw new Error("Your browser doesn't support progress event");e.type==="POST"?a.upload.addEventListener("progress",e.progress):e.type==="GET"&&a.addEventListener("progress",e.progress)}e.timeout&&a.timeout===0&&({}.toString.apply(e.timeout)==="[object Number]"&&(a.timeout=e.timeout,a.addEventListener("timeout",function(t){e.error?e.error(a,a.statusText,t.currentTarget.responseText):u.reject(a,a.statusText,t.currentTarget.responseText)})),{}.toString.apply(e.timeout)==="[object String]"&&(e.timeout=parseInt(e.timeout,10),isNaN(e.timeout)||(a.timeout=e.timeout))),a.addEventListener("error",function(t){e.error&&e.error(a,a.statusText,t.currentTarget.responseText),u.reject(a,a.statusText,t.currentTarget.responseText)}),a.send(e.data),o=u}else o=$.ajax($.extend(e,s));return e.backdrop&&n.show({loader:!0}),o.always(function(){e.backdrop&&n.hide()}),o}var t=require("underscore"),n=require("ui/backdrop"),r=require("dom/form"),i=require("utils/types"),s={type:"POST",dataType:"json"};return o});// gettext shorthand
var _=function(e){try{return typeof l10n[e]!="undefined"?l10n[e]:e}catch(t){}return e};(function(e){e=typeof e=="undefined"?{}:e;var t,n,r,i;require(["net/request","underscore","dom/form","ui/html5Upload"],function(e,s,o,u){t=e,n=s,r=o,i=u});try{e.error.defaultMsg=e.template(_('系統發生意外狀況.. 已經自動幫你通知系統人員來解決這個問題，或<a href="%s">按我直接連絡站方客服協助</a>！'),"javascript:require(['external/uservoice'], function(uservoice){uservoice.showLightbox()})")}catch(s){}e.shard={CACHE_SERVER:["http://pinkoi-cache01.appspot.com","http://pinkoi-cache02.appspot.com","http://pinkoi-cache03.appspot.com","http://pinkoi-cache04.appspot.com","http://pinkoi-cache05.appspot.com","http://pinkoi-cache06.appspot.com "],CACHE_NUMBER:6,get:function(t){var n=t.charAt(0).charCodeAt(),r=t.charAt(1).charCodeAt();return e.shard.CACHE_SERVER[(n+r)%e.shard.CACHE_NUMBER]}},e.namespace("pinkoi.webStorageConf"),e.webStorageConf={local:{uid:"uid",mark:"mark",itemBrowseHistory:"itemBrowseHistory",postBrowseHistory:"postBrowseHistory",point:"point"}},e.namespace("pinkoi.mark"),e.mark.map={tip_product_banner:"10",tip_product_jump_page:"11",tip_product_fav:"12",tip_product_friend:"13",tip_product_message:"14",tip_cart_shipping:"21",tip_cart_shipping_method:"22",tip_login:"99"},e.mark.hasa=function(t){var n=$.webStorage.local().getItem(e.webStorageConf.local.mark);if(n)try{if($.inArray(e.mark.map[t],n)!=-1)return!0}catch(r){}return!1},e.mark.sweep=function(t){var n=$.webStorage.local().getItem(e.webStorageConf.local.mark),r=e.mark.map[t],i;n&&(n.del(r),e.count(n)>0?$.webStorage.local().setItem(e.webStorageConf.local.mark,n):$.webStorage.local().removeItem(e.webStorageConf.local.mark))},e.mark.mark=function(t){var n=$.webStorage.local().getItem(e.webStorageConf.local.mark),r=e.mark.map[t];n||(n=[]),$.inArray(r,n)==-1&&n.push(r),$.webStorage.local().setItem(e.webStorageConf.local.mark,n)},e.namespace("pinkoi.regex"),e.regex.enable=function(){if(e.regex.enabled)return;e.regex.enabled=!0,e.regex.imgUrl=/http:\/\/[=\.\+\-\_\/#\w\?\&%~;,:!]+?\.(?:jpg|png|gif|jpeg)/ig},e.conf={superseller:"annual_sales",useAmazon:!0,host:document.location.protocol+"//"+location.hostname,imageHost:document.location.protocol+"//"+location.hostname,imagePort:"80",s3ItemHost:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.item",s3StoreHost:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.store",s3TestHost:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.test",s3MagzHost:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.magz",fbApp:{apiKey:"53de5aa34c11adf6590a049edbf83496",receiver:"/media/xd_receiver_v2.htm",pageId:"108929339140462",appHost:"http://apps.facebook.com/ilovepinkoi",appId:"197994114318"},getCdnHost:function(t){var n=(t.charCodeAt(t.length-1)&t.charCodeAt(t.length-2))%e.conf.cdnHostsNum;return e.conf.cdnHosts[n]},itemImageUrl:function(t,n,r){r=r||{},r.seq=r.seq||"0";var i="";return r.protocol=r.protocol||"http",i+=r.protocol+":",i+="//"+e.conf.getCdnHost(t)+"/product/"+t,i+="/"+r.seq,r.rev&&(i+="/"+r.rev),i+="/"+n+".jpg",i},getAvatar:function(t,n,r){r=r||{},r.seq=r.seq||"0",n=n?n:"100x100";if(t.indexOf("fb_")===0)return t=t.substr(3),n=n.split("x")[0],"http://graph.facebook.com/"+t+"/picture?width="+n+"&height="+n;if(t.indexOf("wb_")===0)return t=t.substr(3),n==="50x50"?"http://tp1.sinaimg.cn/"+t+"/50/100":"http://tp1.sinaimg.cn/"+t+"/180/100";if(t.indexOf("tt_")===0)return"/apiv2/user/avatar?uid="+t;var i="",s=e.conf.getCdnHost(t);return r.protocol?i+=r.protocol+":":i+="http:",i+="//"+s+"/user/"+t+"/avatar",r.rev&&(i+="/"+r.rev),i+="/"+n+".jpg",i},profileURL:function(e,t){return t?this.host+"/user/"+e:"/user/"+e},canvasURL:function(e,t){return t?this.host+"/styleboard/"+e:"/styleboard/"+e},storeURL:function(e){return"/store/"+e},itemURL:function(e,t,n,r){return n?(t?this.host:"")+"/product/"+e+"/"+encodeURIComponent(n)+(r?"?category="+r:""):(t?this.host:"")+"/product/"+e+(r?"?category="+r:"")},orderURL:function(e,t){return t=t||"buyer","/order?oid="+e+"&role="+t},loaderURL:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/loader.gif",editImg:"//s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/edit.png",loaderHTML:'<img src="http://s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/loader.gif" style="width:16px;height:16px;"/>',spaceURL:"http://s3-ap-southeast-1.amazonaws.com/pinkoi.site/space.gif",magzUrl:function(e,t){return(t?this.host:"")+"/magz/"+e}},PRODUCTION?e.conf.cdnHosts=["cdn01.pinkoi.com","cdn02.pinkoi.com"]:e.conf.cdnHosts=["dev.cdn01.pinkoi.com","dev.cdn02.pinkoi.com"],e.conf.cdnHostsNum=e.conf.cdnHosts.length,e.conf.fbApp.channelUrl=e.conf.host+"/media/xd_receiver_v2.htm",e.administrator={fb_1185878374:1},e.uri={admin_magz:e.conf.host+"/api/admin/magz",admin_remove_item:e.conf.host+"/admin/remove/item",admin_remove_store:e.conf.host+"/admin/remove/store",admin_itemmeta_edit:e.conf.host+"/admin/itemmeta/edit",admin_itemmeta_get:e.conf.host+"/admin/itemmeta/get",admin_pinboard_get:e.conf.host+"/apiv2/match",admin_pinboard_set:e.conf.host+"/admin/pinboard/set",admin_pinboard_notify:e.conf.host+"/admin/pinboard/notify",admin_pinboard_clear:e.conf.host+"/admin/pinboard/clear",admin_pinboard_preview:e.conf.host+"/admin/pinboard/preview",admin_pinboard_delete:e.conf.host+"/admin/pinboard/delete",event_invite:e.conf.host+"/api/event/invite",event_validate:e.conf.host+"/api/event/validate",event_newfriend:e.conf.host+"/api/event/newfriend",event_check:e.conf.host+"/api/event/check",friend:e.conf.host+"/api/connect/friend",fan:e.conf.host+"/api/connect/fan",unfriend:e.conf.host+"/api/connect/unfriend",unfan:e.conf.host+"/api/connect/unfan",befriend:e.conf.host+"/api/connect/request",intl_shipping_add:e.conf.host+"/api/intl/shipping_add",intl_shipping_del:e.conf.host+"/api/intl/shipping_del",intl_shipping_default:e.conf.host+"/api/intl/shipping_default",store:e.conf.host+"/api/store",store_get:e.conf.host+"/api/store/get",news:e.conf.host+"/api/store/news",unnews:e.conf.host+"/api/store/unnews",getItem:e.conf.host+"/api/store/getitem",unlist:e.conf.host+"/api/store/unlist",list:e.conf.host+"/api/store/list",setStore:e.conf.host+"/api/store",store_music:e.conf.host+"/api/store/music",searchImage:e.conf.host+"/api/search/img",category_get:e.conf.host+"/api/category/get",item_get:e.conf.host+"/api/item/get",item_edit:e.conf.host+"/api/item/edit",item_imageedit:e.conf.host+"/api/item/imageedit",item_picks:e.conf.host+"/api/item/picks",item_music:e.conf.host+"/api/item/music",item_archive:e.conf.host+"/api/item/archive",tag_get:e.conf.host+"/api/tag/get",tag_delete:e.conf.host+"/api/tag/delete",tag_add:e.conf.host+"/api/tag/add",clip_get:e.conf.host+"/api/clip/get",clip_update:e.conf.host+"/api/clip/update",clip_delete:e.conf.host+"/api/clip/delete",message_mark:e.conf.host+"/apiv2/message/read",message_send:e.conf.host+"/apiv2/message/send",message_delete:e.conf.host+"/apiv2/message/delete",like:e.conf.host+"/api/like",order_commit:e.conf.host+"/order/commit",order_commit_paypal:e.conf.host+"/paypal/pay",order_commit_cathaybk:e.conf.host+"/cathaybk/pay",order_append:e.conf.host+"/apiv2/order/note",order_shipped:e.conf.host+"/apiv2/order/shipped",order_received:e.conf.host+"/apiv2/order/received",order_scheduled:e.conf.host+"/apiv2/order/scheduled",order_canceled:e.conf.host+"/apiv2/order/canceled",review_add:e.conf.host+"/apiv2/review/add",review_get:e.conf.host+"/api/review/get",cart_calculate:e.conf.host+"/apiv2/cart/calculate",canvas_get:e.conf.host+"/api/styleboard/get",canvas_update:e.conf.host+"/api/styleboard/update",canvas_new:e.conf.host+"/styleboard/new",canvas_get_bg:e.conf.host+"/api/styleboard/background",canvas_draft:e.conf.host+"/api/styleboard/draft",choose_get:e.conf.host+"/api/choose/get",choose_vote:e.conf.host+"/api/choose/vote",bill_pay:e.conf.host+"/api/bill/pay",variation_get:e.conf.host+"/api/variation/get",user:e.conf.host+"/api/user",user_findcontacts:e.conf.host+"/api/user/findcontacts",user_invitecontacts:e.conf.host+"/email/invitecontacts",user_allfriends:e.conf.host+"/api/user/getallfriends",user_publish:e.conf.host+"/api/user/publish",user_point:e.conf.host+"/api/user/point",album_get:e.conf.host+"/api/album/get",pounce:e.conf.host+"/jump_on_it",sell:e.conf.host+"/sell",window_n:e.conf.host+"/window/new",window_get:e.conf.host+"/api/window",userimg_delete:e.conf.host+"/api/userimg/delete",userimg_rotate:e.conf.host+"/api/userimg/rotate",discount:e.conf.host+"/api/discount",discount_store:e.conf.host+"/api/discount/store",coupon:e.conf.host+"/api/coupon",coupon_edit:e.conf.host+"/api/coupon/edit",coupon_apply:e.conf.host+"/api/coupon/apply",giftcard_apply:e.conf.host+"/api/giftcard/apply",shipping:e.conf.host+"/api/shipping",magz_n:e.conf.host+"/magz/new",magz_update:e.conf.host+"/magz/update",magz_fav:e.conf.host+"/api/magz/fav",magz_draft:e.conf.host+"/api/magz/draft",magz_get:e.conf.host+"/api/magz",magz_getByUrl:e.conf.host+"/api/magz/getByUrl",invitation_send:e.conf.host+"/api/invitation/send",invitation_remind:e.conf.host+"/api/invitation/remind",waitlist_add:e.conf.host+"/apiv2/item/wait"},e.fb_embed=function(){var t='<tr><td class="x1"><a href="http://www.facebook.com/profile.php?id=%(uid)s" target="_blank"><img src="%(avatar)s"/></a></td>                            <td class="x2">%(nick)s</td><td class="x3"><a class="m-button" target="_blank" onclick="pinkoi.fb_embed.addToProfile();">'+_("嵌入到個人頁")+"</a></td></tr>",n='<tr><td class="x1"><a href="%(page_url)s" target="_blank"><img src="%(pic_square)s"/></a></td><td class="x2">%(name)s</td>                        <td class="x3"><a class="m-button" onclick="pinkoi.fb_embed.register(\'%(page_id)s\', this);" target="_blank">'+_("嵌入到粉絲頁")+"</a></td></tr>";return{load:function(t,r){function i(){e.request("POST","/apiv2/facebook/embed",{data:{external:"fb"},success:function(i){if(!i.error){if(r){e.fb_embed.addToProfile(i.result[0].profile[0].uid,i.result[0].profile[0].avatar);return}$("#embed .step1").hide(),$("#embed .step2").show();var s="";e.globals.set("fbPageAppAdded",{}),s+='<div><b class="fbembed_title">'+_("嵌入粉絲頁")+"</b><table>";for(var o=0;o<i.result[0].pages.length;++o)s+=e.template(n,i.result[0].pages[o]);s+="</table></div>";var u=$(s);$(t).html(u);try{$("html,body").animate({scrollTop:$("#embed").offset().top-10},1100)}catch(a){}}else e.error()}})}require(["external/facebook"],function(e){e.requestPermission(function(){i()},{scope:["email","manage_pages","publish_actions"]})})},register:function(t,n){if(t){e.request("POST","/apiv2/facebook/embed",{data:{external:"fb",pageid:t}},null,!1);var r=null,n=$(n);e.globals.get("fbPageAppAdded")[t]?(r="http://www.facebook.com/pages/x/"+t,n.attr("href",r)):(r="http://www.facebook.com/add.php?api_key="+window[NAMESPACE].conf.fbApp.apiKey+"&pages=1&page="+t+"#",n.attr("href",r))}},addToProfile:function(e,t){FB.Connect.showProfileTabDialog()}}}(),e.login_modal=function(){var t=null;return{load:function(){require(["mapp/pages/login","ui/modal"],function(n,r){t=r,n.loginModal(r,e.login_modal.next)})},close:function(){t.hide()},redirect:function(t){t=e.login_modal.next||e.urlParam.get("next")||t||location.href,e.login_modal.next=null,t==location.href?window.location.reload(!1):location.href=t}}}(),e.review_modal=function(){var n='        <div class="g_mod_review">            <form method="POST" enctype="multipart/form-data" action="'+e.uri.review_add+'">                <h2 class="title_">'+_("交易評價")+' <span style="font-size:13px;padding-left:5px;">%(heading)s</span></h2>                %(photo)s                <div class="box_ form_ fillbg_">                    <div>                        <label>'+_("評價分數")+'</label>                        <span class="inline_block">                            <a class="g-large-rating g-large-rating-single-on" score="1" title="'+_("很不滿意")+'"></a>                            <a class="g-large-rating g-large-rating-single-on" score="2" title="'+_("不滿意")+'"></a>                            <a class="g-large-rating g-large-rating-single-on" score="3" title="'+_("普通")+'"></a>                            <a class="g-large-rating g-large-rating-single-on" score="4" title="'+_("推薦")+'"></a>                            <a class="g-large-rating g-large-rating-single-on" score="5" title="'+_("大力推薦")+'"></a>                            <span style="vertical-align:middle;margin-left:4px;" class="rating_text">'+_("滑動你的滑鼠，按下左鍵來確定")+'</span>                        </span>                    </div>                </div>                <div class="sep_"></div>                <div class="box_">                    <div class="title_ subtitle_">%(reviewTitle)s</div>                    <div class="fillbg_"><textarea rows="7" score="%(defaultScore)s"/></div>'+('<div class="translatehelp '+e.globals.get("locale")+'">'+_("如需任何對話翻譯協助，<a onclick=\"javascript:require(['external/uservoice'], function(uservoice){pinkoi.gmodal.close();uservoice.showLightbox();});\">請聯絡我們</a>。")+"</div>")+'</div>                <div class="sep_"></div>                <div class="box_ review-img">                    <div class="title_ subtitle_">'+_("上傳開箱照")+'</div>                    <div class="caption_" style="line-height:20px;">'+_("分享收到禮物美好片刻: )")+'</div>                    <div class="fillbg_">\n                        <input name="file" type="file">                    </div>\n                </div>                <div class="footer"><a class="submit m-button g_btns_send">'+_("送出")+'</a></div>                <input type="hidden" name="score">                <input type="hidden" name="oid">                <input type="hidden" name="tid">                <input type="hidden" name="who">                <input type="hidden" name="description">                <input type="hidden" name="other">                <input type="hidden" name="contenttype" value="html">            </form>        </div>',r=5,s=_("大力推薦");return{load:function(s,o){if(s.role=="seller")var u=_('你想說的話<div class="caption_">對顧客表達你的感謝</div>');else var u=_('由你的親身體驗來推薦這件設計品<div class="caption_">分享你對實際商品的心得和評論，你的推薦會幫助很多網友做出更好的購買決定。<span style="color:#e00;">如果還沒有收到商品，請收到商品再給評價喔！</span></div>');o=o||$.noop;var a="",f="";if(s.tid){var l=s.tid.split(",");if(l.length===1)f=e.template('<img class="topright_img_" src="%(photo)s"/>',{photo:e.conf.itemImageUrl(l[0],"80x80")});else{f='<div class="topright">';for(var c=0;c<l.length;++c)f+=e.template('<img src="%(photo)s"/>',{photo:e.conf.itemImageUrl(l[c],"80x80")});f+="</div>"}}var h=e.template(n,{to:s.to,nick:s.nick||"",title:s.title,tid:s.tid,photo:f,heading:a,defaultScore:r,reviewTitle:u});e.gmodal.load(h),s.role=="seller"&&e.gmodal.content.find(".review-img").remove(),Modernizr.ajaxfileupload||e.gmodal.content.find(".review-img input[type=file]").replaceWith(i.downloadTip),e.gmodal.content.find(".footer .submit").click(function(n){if(n.target.disabled)return;var i=e.gmodal.content.find("textarea"),u=$.trim(i.val());if(u){var a=i.attr("score")||r,f=e.gmodal.content.find("form");f.find('input[name="role"]').val(s.role),f.find('input[name="score"]').val(a),f.find('input[name="oid"]').val(s.oid),f.find('input[name="seller"]').val(s.seller),f.find('input[name="tid"]').val(s.tid),f.find('input[name="who"]').val(s.to),f.find('input[name="description"]').val(u),f.find('input[name="other"]').val(s.other||""),e.loader.on(),n.target.disabled=!0,t({type:"POST",url:"/apiv2/review/add",data:f}).done(function(t){e.loader.off(),t.error?alert(t.error.message):(e.review_modal.close(),e.drawer.on(_("評價已送出")),o(t)),e.gmodal.close()})}else e.drawer.on(_("記得寫評價內容哦"))}),e.review_modal.enableRating()},close:function(){e.gmodal.close()},enableRating:function(){function r(e,r){n.html(r);for(var i=e;i<t.length;i++)t.eq(i).addClass("g-large-rating-single-off");for(var i=e-1;i>=0;i--)t.eq(i).removeClass("g-large-rating-single-off")}var t=e.gmodal.content.find(".g-large-rating"),n=e.gmodal.content.find(".rating_text");t.mouseenter(function(e){var t=$(e.target),n=parseInt(t.attr("score"),10),i=t.attr("title");r(n,i)}).mouseleave(function(t){var n=e.gmodal.content.find("textarea");r(n.attr("score"),n.attr("title")||s)}).click(function(t){var n=$(t.target),r=parseInt(n.attr("score"),10),i=n.attr("title");e.gmodal.content.find("textarea").attr("score",r).attr("title",i)})}}}(),e.recommend_modal=function(){var t=['<div class="g_mod_recommend">','<h2 class="title_">',_("推薦商品"),'<p class="caption_">'+_("想推薦些什麼好東西給朋友嗎？")+"</p>","</h2>",'<form class="form_ fillbg_">',"<div>","<label>"+_("商品網址")+"</label>",'<input type="text" id="product_url"/>',"</div>","<div>","<label>"+_("想說的話")+"</label>",'<textarea id="message"/></texarea>',"</div>","</form>",'<div class="footer_"><a class="m-button g_btns_send submit">'+_("送出")+"</a></div>","</div>"].join("");return{load:function(n){if(n===undefined)return;var r=e.template(t,{});e.gmodal.load(r),e.gmodal.content.find(".submit").click(function(t){var r=$(t.target);if(r.data("disabled"))return;var i=e.gmodal.content.find("#product_url").val(),s=/[[\w-~]{8,10}/.exec(i);if(s===null){e.gmodal.content.find("#product_url").css("background-color","#FFE6E6"),e.drawer.on(_("請輸入正確的商品網址，像這樣：http://www.pinkoi.com/product/1yIw11oY"));return}var o=e.conf.itemImageUrl(s[0],"320x320",{protocol:"http"}),u=[$.trim(e.gmodal.content.find("#message").val())];u.push(i+" ("+o+")"),u.push(i+_(" (前往這個商品)")),tid=tid[0];var a={description:u.join("\n"),title:_("覺得你會喜歡這個！"),item:tid,receiver:n,contenttype:"html"};r.data("disabled",!0),e.request("POST",e.uri.message_send,{data:a,success:function(){r.data("disabled",!1),e.recommend_modal.close(),e.drawer.on(_("已送出推薦"))}})})},close:function(){e.gmodal.close()}}}(),e.message_modal=function(){var n=['<div id="n-form-msg" class="g_mod_qna">','<h2 class="title_">%(prompt)s<span style="font-size:13px;padding-left:5px;">%(heading)s</span></h2>',"%(photo)s","%(vacationHtml)s",'<form id="form-msg" method="POST" enctype="multipart/form-data" action="'+e.uri.message_send+'" class="form_ fillbg_">',"<div>","<label>"+_("關於")+"</label>",'<input type="text" name="title" value="%(title)s"/>',"</div>","<div>","<label>"+_("訊息內容")+"</label>",'<textarea name="description" rows="7">%(content)s</textarea>',"</div>",'<div style="font-size: 10px; color: #999; padding-left: 110px; margin-top: -7px"><a onclick="$(this).parent().nextAll(\'.stop\').show();$(this).parent().remove()">'+_("使用特殊語法")+"?</a></div>",'<div class="stop" style="line-height:1.7em; font-size:11px; color:#999; display:none">'+_("**粗體字** → 包含在兩對星號間的文字會變成粗體字")+"<br>",_("__底線字__ → 包含在兩對底線間的文字會自動畫底線")+"<br>",_("*斜體字* → 包含在一對星號間的文字會變成斜體字")+"<br>",_("--刪除線-- → 包含在一對--間的文字會自動加上刪除線")+"<br>",_("http://example.com/picture.jpg → 貼上外站圖片的網址會自動轉成圖片，提醒你的外站圖片如果檔外連，將會使圖片無法正確顯示，建議使用 Flickr 相簿圖片連結")+"<br>",_("http://pinkoi.com/product/1qXQ92Ck → 貼上Pinkoi的網址會自動轉成超連結")+"<br>",_("http://www.youtube.com/watch?v=Glny4jSciVI → 貼上Youtube網址會自動轉成影片")+"</div>","<div>","<label>"+_("附加圖片")+"</label>",'<div class="file-wrap">','<input name="file" type="file" accept=".jpg,.png,.gif">','<div id="err-msgs" class="err-msgs"></div>',"</div>","</div>",'<div class="translatehelp '+e.globals.get("locale")+'">'+_("如需任何對話翻譯協助，<a onclick=\"javascript:require(['external/uservoice'], function(uservoice){pinkoi.gmodal.close();uservoice.showLightbox();});\">請聯絡我們</a>。")+"</div>",'<div style="font-weight: bold; line-height: 1.6;">',_("大部分交易糾紛都是因私下交易所引起，為保障您的權益，強烈建議您透過 Pinkoi 下訂單，同時可獲得優惠券及累積紅利折抵購物金，提供最好的服務品質和購物體驗是 Pinkoi 最重要的事情。"),"</div>",'<div class="footer_">','<input class="m-button g_btns_send submit" type="submit" value="',_("送出"),'">',"</div>",'<input type="hidden" name="receiver" value="%(to)s">','<input type="hidden" name="item" value="%(tid)s">','<input type="hidden" name="oid" value="%(oid)s">','<input type="hidden" name="contenttype" value="html">',"</form>","</div>"].join("");return{load:function(r,s){r=r||{},s=s||$.noop,r.content=e.util.escape(r.content||""),r.heading="",r.prompt=r.prompt||(r.oid?_("訂單有任何問題，在這裡直接發訊息討論吧！"):_("想了解更多商品購買細節？在這裡詢問設計師吧！")),r.tid=r.tid||e.globals.get("PAGE_TID")||"",r.title=r.title||(e.globals.get("PAGE_TITLE")?e.util.unescape(e.globals.get("PAGE_TITLE")):"")||"",r.to=r.to?r.to:e.globals.get("PAGE_OWNER"),r.oid=r.oid||"";var o="";if(r.tid){var u=r.tid.split(",");if(u.length===1)o=e.template('<img class="topright_img_" src="%(photo)s"/>',{photo:e.conf.itemImageUrl(u[0],"80x80")});else{o='<div class="topright">';for(var a=0;a<u.length;++a)o+=e.template('<img src="%(photo)s"/>',{photo:e.conf.itemImageUrl(u[a],"80x80")});o+="</div>"}}var f="";e.globals.vacation&&(f='<span class="vacation">'+e.template(_("目前設計館休假中：%(message)s"),{message:e.globals.vacation.description})+"</span>");var l=e.template(n,{to:r.to,title:r.title?e.util.escape(r.title):"",prompt:r.prompt,tid:r.tid,oid:r.oid,heading:r.heading,content:r.content,photo:o,vacationHtml:f});e.gmodal.load(l);var c=e.gmodal.content.find("#n-form-msg"),h=c.find("#form-msg"),p=c.find(".submit");Modernizr.ajaxfileupload||h.find("input[type=file]").replaceWith(i.downloadTip);var d=function(n){n.preventDefault();if(p.prop("disabled"))return!1;var r=$.trim(c.find('input[name="title"]').val()),o=$.trim(c.find("textarea").val()),u=!0;r.length||(e.drawer.on(_("標題不能是空的哦")),u=!1),o.length||(e.drawer.on(_("內容不能是空的哦")),u=!1);if(Modernizr.ajaxfileupload){var a=c.find("input[type=file]");i.init({$container:c.find(".file-wrap")}),i.emptyErrMsgs();var f=i.validate.file(a);f.length&&(!f[0].isSizeValid||!f[0].isTypeValid)&&(u=!1,a.val(null))}if(!u)return!1;p.prop("disabled",!0).removeClass("m-button").addClass("m-button-disabled"),e.loader.on(),t({type:"POST",url:"/apiv2/message/send",data:h}).done(function(t){p.prop("disabled",!1).addClass("m-button").removeClass("m-button-disabled"),e.loader.off();if(t.error)return e.drawer.on(t.error.message),!1;t.result?(e.drawer.on(_("已送出")),s(t)):t.error?e.drawer.on(t.error.message):e.error(),e.gmodal.close()})};h.on("submit",d)},close:function(){e.gmodal.close()}}}(),e.makeFriend=function(t,n,r){if(!e.isLogin())return;var i=function(t){t.status=="ok"?r&&r():e.error()},s=null;switch(n){case"befriend":s=e.uri.befriend;break;case"unfriend":s=e.uri.unfriend;break;case"friend":s=e.uri.friend}s&&e.request("POST",s,{data:{uid:t},success:i})},e.makeFan=function(t,n,r){if(!e.isLogin())return;var i=function(t){t.status=="ok"?r&&r():e.error()},s=null;switch(n){case"fan":s=e.uri.fan;break;case"unfan":s=e.uri.unfan}s&&e.request("POST",s,{data:{uid:t},success:i})},e.isLogin=function(t){return e.globals.get("uid")?(t&&(location.href=t),!0):(t&&(e.login_modal.next=t),e.login_modal.load(),!1)},e.billpay_modal=function(){var t='        <div class="g_mod_billpay">            <h2 class="title_">繳納設計館管理費</h2>            <div class="box_ fillbg_ message_">                Pinkoi 的匯款帳號是：永豐銀行 銀行代號807 敦北分行 分行代號 0025<br/> 帳號：002-001-0002589-1<br/>                請您於匯款完成後，填寫下方表單通知我們，或撥(02)2392-7951 陳小姐<br/> Pinkoi團隊會有專人為您確認款項。謝謝！            </div>            <form class="form_ fillbg_">                <div>                    <label>匯款金額（NTD）</label>                    <input type="text" name="payment" limit_val="integer" value="%(payment)s"/>                </div>                <div>                    <label>你的銀行帳號後五碼</label>                    <input type="text" name="account" value="%(account)s"/>                </div>            </form>            <div class="footer"><a class="submit m-button g_btns_send">送出</a></div>';return{load:function(n,r,i){r=r||"",i=i||$.noop;var s=e.template(t,{payment:n,account:r});e.gmodal.load(s),e.forms.limitVal(e.gmodal.content),e.gmodal.content.find(".footer .submit").click(function(t){var n=$(t.target);if(n.data("disabled"))return;var r=$.trim(e.gmodal.content.find('input[name="payment"]').val()),i=$.trim(e.gmodal.content.find('input[name="account"]').val());n.data("disabled",!0),e.request("POST",e.uri.bill_pay,{data:{payment:r,account:i},success:function(t){n.data("disabled",!1);if(t.status=="ok"){e.gmodal.close();var r=$("#bill #summary");r.find(".submit").remove();var i=new Date;i=i.getTime()/1e3,r.find("span.deadline").html(_("轉帳查核中 ")+e.strftime(i,"%(Y)s/%(m)s/%(d)s")),e.drawer.on(_("謝謝你！帳款已繳，等待轉帳查核中....."))}else e.error()}})})},close:function(){e.gmodal.close()}}}(),e.selector_modal=function(){var t=$("#g_img_selector"),n=t.find(".wrap_"),r=t.overlay({top:"center",oneInstance:!0,expose:{maskId:"g_mod_modal_bg",loadSpeed:500,closeSpeed:0},closeOnClick:!1,closeOnEsc:!1,onBeforeLoad:function(){e.globals.set("isModalOpen",!0)},onBeforeClose:function(){e.globals.set("isModalOpen",!1)},api:!0});return{load:function(t){t=t?t:{};if(!t.bypass&&!e.isLogin())return;r.load()},content:n,close:function(){r.close()}}}(),e.friend_selector_modal=function(){function r(t){var n="";if(t){for(var r in t)if(t.hasOwnProperty(r)){var i=r,s=t[r].avatar,o=t[r].nick;n+=e.template('<li uid="%(uid)s" class="select"><img src="%(avatar)s"/><div>%(nick)s</div></li>',{uid:i,avatar:s,nick:o})}}else n=_('<center class="noresult" style="margin:4px;height:150px;padding:20px;">你目前沒有朋友<div class="small">你可以<a href="/friends/find">邀請/尋找你的朋友</a>。也可以參觀<a href="/stores">站內設計師的商店</a>，和他們交朋友，聽聽他們的故事。當然記得去<a href="/user">你的個人頁面</a>看看！</div></center>');return n}var t="g_mod_friend_selector",n='        <div id="'+t+'">            <div class="head">                <h2 class="title_">'+_("你的Pinoki專屬朋友圈")+"</h2>                <span>"+_("你選擇的朋友數：")+'<em class="count">0</em> | <a class="clear">'+_("清除全部")+'</a></span>            </div>            <ul class="friends clr">%(friends)s</ul>            <div class="body fillbg_">                <div>                    <label>'+_("訊息標題")+'</label>                    <input name="title" value=""/>                </div>                <div>                    <label>'+_("訊息內容")+'</label>                    <textarea name="message"></textarea>                </div>                <div>'+_("你目前的頁面：")+'%(currentPageURL)s</div>            </div>            <div class="footer clr"><a class="submit gbutton">'+_("分享給朋友")+"</a></div>        </div>";return{load:function(i,s){if(!e.isLogin())return;s=s||$.noop,e.request("POST",e.uri.user_allfriends,{success:function(i){var s=i.result,o=e.template(n,{friends:r(s),currentPageURL:location.href});e.gmodal.load(o),e.gmodal.content.find("#"+t).bind("click",function(n){var r=e.gmodal.content.find("#"+t+" .head .count"),i=0,s=$(n.target);if(s.is("li.select")||s.parent().is("li.select"))s.parent().is("li.select")&&(s=s.parent()),s.toggleClass("selected"),s.hasClass("selected")?i=parseInt(r.html())+1:i=parseInt(r.html())-1,r.html(i);else if(s.hasClass("clear"))e.gmodal.content.find("ul.friends li.selected").each(function(){$(this).removeClass("selected")}),r.html("0");else if(s.hasClass("submit")){if(s.data("disabled"))return;var o=[];e.gmodal.content.find("ul.friends li.selected").each(function(){o.push($(this).attr("uid"))});if(!o.length){e.drawer.on(_("你需要先選擇一些朋友哦"));return}var u=$.trim(e.gmodal.content.find('input[name="title"]').val()),a=$.trim(e.gmodal.content.find('textarea[name="message"]').val());a&&(a+="<br/>"),s.data("disabled",!0),e.request("POST",e.uri.message_send,{data:{title:u,description:a+e.template(_("分享頁面：")+'<a href="%(currentPageURL)s">%(on)s</a>',{currentPageURL:location.href}),receiver:o.join(","),contenttype:"html"},success:function(t){s.data("disabled",!1),t.result?e.gmodal.close():e.error()}})}})}})},close:function(){e.gmodal.close()}}}(),e.register_modal=function(){require(["mapp/pages/login","ui/modal"],function(e,t){modal=t,e.loginModal(t)})},e.resend_modal=function(){var t=['<div class="g_mod_resend g_mod_register g_mod_login">','<div class="title_">'+_("Pinkoi 買設計、品設計、賣設計 - 亞洲最大設計商品購物網站")+"</div>",'<div class="facebook-box">','<div class="box_">','<div class="fillbg_"><a class="fblogin_btn g_btns g_btns_fblogin" href="/apiv2/account/facebook_oauth" data-click="g-fb-login">'+_("用 Facebook 登入")+'</a> <span style="margin-left: 8px; font-size: 14px; color: #e00; letter-spacing: 1px;"></span></div>',"</div>",'<div class="sep_"></div>',"</div>",'<div class="box_">',_('<div class="title_">重新寄送確認信</div>'),'<div class="form_">','<div class="fillbg_">',"<div>","<label>"+_("註冊時的Email")+"</label>",'<input type="text" name="email"/>',"</div>","</div>",'<div class="footer clr">','<a class="submit m-button g_btns_resend">'+_("重新寄送")+"</a>",'<a style="margin-left:29px;" onclick="pinkoi.resend_modal.close();pinkoi.login_modal.load();">'+_("已經有 Pinkoi 帳號")+"</a>","<a style=\"margin-left:15px;\" onclick=\"var email = pinkoi.gmodal.content.find('[name=email]').val(); pinkoi.register_modal.load(); pinkoi.gmodal.content.find('[name=email]').val(email)\">"+_("註冊一個新帳號")+"</a>","</div>",'<div class="policy">',_('點擊「重新寄送」的同時，表示您同意接受我們的個人資料提供同意書以及使用條款，也詳讀和完全了解我們的資料使用政策，包括Cookie的使用，詳細資訊及內容請參考 <a href="/policy">隱私權政策及服務條款</a>'),"</div>","</div>","</div>","</div>"].join("");return{load:function(){if(e.globals.get("uid")){e.drawer.on(_("你已經是 Pinkoi 的一份子囉 :)"));return}var n=e.template(t);e.gmodal.load(n,{bypass:!0});var r=e.gmodal.content.find("[name=email]").select(),i=e.gmodal.content.find(".submit");i.click(function(){if(i.data("submitting"))return;var t=$.trim(r.val());if(!e.forms.validate("!empty",t)){e.drawer.on(_("Emaili 不能是空白的喔！")),r.select();return}if(!e.forms.validate("email",t)){e.drawer.on(_("Email 格式不正確！")),r.select();return}i.data("submitting",!0),e.request("POST","/apiv2/account/resend",{data:{email:t},success:function(t){i.data("submitting",!1);if(t.error){e.drawer.on(t.error.message||_("伺服器不喜歡你的要求")),r.select();return}gTrackEvent("Membership","Pinkoi","Resend"),e.gmodal.close(),alert(_("我們已重新將註冊確認信寄至你的信箱！請至信箱收信，以完成註冊流程 :)\n\n（提醒：如果找不到確認信可以到垃圾信箱中找看看喔！）"))}})})},close:function(){e.gmodal.close()}}}(),e.canvas_edit_modal=function(){function n(e,t){var n="",r=null;for(var i=0;i<e.length;i++){r=e[i];var s=r.id,o=r.title;s==t?n+='<option value="'+s+'" selected="selected">'+o+"</optoin>":n+='<option value="'+s+'">'+o+"</optoin>"}return n&&(n='<select name="album">'+n+"</select>"),n}var t='        <div class="g_page_user_canvas">            <div class="title box_">                <div class="title_">'+_("拼貼標題")+'</div>                <div class="fillbg_"><input type="text" name="title" value="%(title)s" /></div>            </div>            <div class="title box_">                <div class="title_">'+_("拼貼集")+'</div>                <div class="fillbg_">%(albumHTML)s</div>            </div>            %(sellerHtml)s            <div class="footer">                <a class="m-button submit">'+_("更新")+'</a>                 <a class="edit" style="padding-left:5px;" href="%(editLink)s">'+_("修改拼貼")+"</a>            </div>        </div>";return{load:function(r){e.request("GET","/api/combine/edit_styleboard?ts="+(new Date).getTime(),{data:{owner:e.globals.get("uid"),tid:r},success:function(i){if(i.status=="ok"){var s={};s.albumHTML=n(i.result.albums,i.result.styleboard.album),s.editLink="/styleboard/new?edit=1&tid="+r,s.title=i.result.styleboard.title,s.sellerHtml=e.globals.get("isSeller")?'                        <div class="title box_">                            <div class="title_">'+_("設計館雜誌")+'</div>                            <div class="fillbg_"><input class="checkbox_" type="checkbox" name="store" value="1"'+($.inArray(r,i.result.storeStyleboardTids)!=-1?' checked="checked"':"")+"> "+_("同時發佈於設計館")+"</div>                        </div>":"",e.gmodal.load(e.template(t,s)),e.gmodal.content.find(".g_page_user_canvas .submit").bind("click",function(){var t=$(this);if(t.data("submitting"))return;var n=$.trim(e.gmodal.content.find(".g_page_user_canvas [name=title]").val()),s=e.gmodal.content.find(".g_page_user_canvas [name=album]").val();if(n&&s){t.data("submitting",!0);var o={};o.tid=r,o.title=n,o.album=s;var u=$.inArray(r,i.result.storeStyleboardTids)!=-1;if(e.globals.get("isSeller")){var a=e.gmodal.content.find(".g_page_user_canvas [name=store]").is(":checked");u!=a&&(o.is_store_styleboard=a?1:0)}e.request("POST",e.uri.canvas_update,{data:o,success:function(t){t.status=="ok"?window.location.reload(!1):e.error()}})}})}else e.error()}})},close:function(){e.gmodal.close()}}}(),e.pagination=function(t,n,r){t=parseInt(t,10),n=parseInt(n,10),r=r?r:{};var i=r.expand?r.expand:3,s=Math.min(t+i,n+1),o=Math.max(t-i,1),u=[];r.noWrap||u.push('<div class="'+(r.wrapClass||"g_pagination")+'">');if(t>1){u.push(e.template('<a class="dosth" sth="pagination" page="%s">◄ '+_("上一頁")+"</a>",t-1,t-1)),o>1&&(u.push('<a class="dosth" sth="pagination" page="1">1</a>'),o!==2&&u.push('<b class="dot">···</b>'));for(var a=o;a<t;a++)u.push(e.template('<a class="dosth" sth="pagination" page="%s">%s</a>',a,a,a))}u.push(e.template('<a class="active dosth" sth="pagination" page="%s">%s</a>',t,t));if(t<n){for(var a=t+1;a<=Math.min(s,n);a++)u.push(e.template('<a class="dosth" sth="pagination" page="%s">%s</a>',a,a));s<n&&(s!==n-1&&u.push('<b class="dot">···</b>'
),u.push(e.template('<a class="dosth" sth="pagination" page="%s">%s</a>',n,n))),u.push(e.template('<a class="dosth" sth="pagination" page="%s">下一頁 ►</a>',t+1))}return r.noWrap||u.push("</div>"),u.join("")},e.checkViolation=function(t){var n=t;if($.inArray(e.globals.get("uid"),e.checkViolation.whitelist)!=-1)return!0;var r=e.globals.get("isSeller"),i=_("為保障交易安全及維護個人資料隱私及法律個人資料的保障，如訊息內容含有電話、電子郵件將無法寄出，\n謝謝您的配合！"),s=new RegExp("[a-zA-Z0-9._-]+(?:@|\\W+at\\W+)[a-zA-Z0-9.-]+(?:\\.|\\W+dot\\W+)[a-zA-Z]{2,4}","ig"),o=n.match(s);if(o)return alert(i),!1;n=n.replace(s,"");var u=new RegExp("https?://[=.+-_/#w?&%~;,:!\\(\\)]+","ig"),a=n.match(u),f=_("請勿留下站外網址");if(a){for(var l=0;l<a.length;l++){if(/(?:\.png|\.jpg|\.pdf|\.gif|\.jpeg)/i.test(a[l]))continue;if(!/pinkoi\.com|pinkoi\.me|usps\.com|youtube\.com|vimeo\.com|sf-express\.com|7-11\.com\.tw|famiport\.com\.tw|post\.gov\.tw|surveymonkey\.com|roy\.ptow/i.test(a[l]))return alert(f),!1}n=n.replace(u,"")}var c=new RegExp("[a-zA-Z0-9\\-]+\\.(?:cc|com|org|net|tw)(?:\\.tw)?[=\\.\\+\\-\\_\\/#\\w\\?\\&%~;,:!]*","ig"),h=n.match(c);if(h){for(var l=0;l<h.length;l++)if(!/pinkoi\.com|youtube\.com|usps\.com|vimeo\.com|sf-express\.com|7-11\.com\.tw|famiport\.com\.tw|post\.gov\.tw|surveymonkey\.com|roy\.ptow/i.test(h[l]))return alert(f),!1;n=n.replace(c,"")}var p=new RegExp("(?:[A-Za-z]{1,})?[\\d\\-\\+ \\(\\)]+","ig"),d=n.match(p);if(d){var v=new RegExp("0?\\d{8,9}","ig"),m=new RegExp("^[A-Za-z]+"),g=new RegExp("^201\\d+");for(var l=0;l<d.length;l++){var y=d[l],b=y.match(m);if(b&&b[0].length===1)continue;var w=y.match(/\+/g);if(w&&w.length>1)continue;var E=y.match(/\-/g);if(E&&E.length>3)continue;var S=y.replace(/[\-\+ \(\)]/g,"");if(S.length<15&&S.match(v)){if(S.replace(/[a-zA-Z]+/g,"").match(g))continue;return alert(i),!1}}}return!0},e.checkViolation.whitelist=["sidonieyang","pinkoi","fb_1185878374","fb_669026370","fb_1386957571","hanlinpo","fb_606933012","pinkoiadmin","24hour"],e.itemSelector=function(t,n,r){require(["app/modules/fav"],function(i){function f(){if(n.skipRender)return e.globals.get("itemSelector_"+n.type);c()}function l(t,r){r=r||n.type,e.globals.set("itemSelector_"+r,t);var i="itemSelector_dict_"+r;e.globals.set(i,{});for(var s=0;s<t.length;s++)e.globals.get(i)[t[s].tid]=t[s]}function c(){var r='<div class="g_mod_itemselector"><div class="title_">'+_("請選擇商品");return n.multiple&&(r+="<small>"+_("（可複選商品進行設定）")+"</small>"),r+='</div><div class="header">'+_("快速搜尋：")+'<input type="text"/></div><div class="body clr">',r+=h(),r+='</div><div class="filter clr"></div><div class="footer"><a class="m-button dosth" sth="submit">'+_("確定")+"</a></div></div>",e.gmodal.load(r),e.gmodal.content.find(".g_mod_itemselector").bind("click",function(r){var i=$(r.target);if(i.hasClass("dosth")){var s=i.attr("sth");switch(s){case"select":var o=i.closest(".item");o.toggleClass("active"),n.multiple||e.gmodal.content.find(".g_mod_itemselector .active").not(o).removeClass("active");break;case"submit":var u=e.gmodal.content.find(".g_mod_itemselector .active"),a=null;if(u.length)if(n.multiple){var f=[];u.each(function(){f.push($(this).attr("tid"))}),a=f.join(",")}else a=u.attr("tid");n.noClose||e.gmodal.close(),t(a)}}}),e.gmodal.content.find(".g_mod_itemselector").bind("keyup",function(t){var n=$.trim(e.gmodal.content.find(".g_mod_itemselector .header :input").val()),r=e.gmodal.content.find(".g_mod_itemselector .body"),i=e.gmodal.content.find(".g_mod_itemselector .filter");n?(r.hide(),i.show(),i.html(h(n))):(i.hide(),r.show()),e.gmodal.content.find(".g_mod_itemselector .active").removeClass("active")}),r}function h(t){t&&(t=new RegExp(t,"i"));var r=e.globals.get("itemSelector_"+n.type),i="",s;for(var o=0;o<r.length;o++){if(t&&!t.test(r[o].title))continue;if(n.skipTids&&$.inArray(r[o].tid,n.skipTids)!==-1)continue;s="",n.activeTids&&$.inArray(r[o].tid,n.activeTids)!==-1&&(s=" active"),i+='<div class="item'+s+'" tid="'+r[o].tid+'"><img class="dosth" src="'+e.conf.itemImageUrl(r[o].tid,"80x80")+'" title="'+r[o].title+'" sth="select"/><div class="title dosth" title="'+r[o].title+'" sth="select">'+r[o].title+"</div></div>"}return i||(i='<center class="noresult">'+_("沒有搜尋到相關商品")+"</center>"),i}n=n||{},n.multiple=n.multiple||!1,n.type=n.type||(e.globals.get("isSeller")&&n.type!="myfavs"?"myitems":"myfavs"),r&&(n.type="myitems"),r=r||e.globals.get("uid");var s=e.globals.get("itemSelector_myitems")?!0:!1;!s&&n.myitems&&(l(n.myitems,"myitems"),s=!0);var o=e.globals.get("itemSelector_myfavs")?!0:!1;!o&&n.myfavs&&(l(n.myfavs,"myfavs"),o=!0);if(s&&n.type=="myitems"||o&&n.type=="myfavs")f();else if(n.type=="myitems"){var u={fields:"tid,title,price",limit:999,archive:n.archive?1:0,owner:r,orderby:"created desc"};e.globals.get("storeCurrency")&&(u._currency=e.globals.get("storeCurrency").code);var a=e.request("GET","/apiv2/item/get",{data:u},"json",!1);l(a.result),f()}else i.getFav(null,function(e,t,n){l(e.result),f()})})},e.tag=function(e){e=e||{},e.max=e.max||50,e.tag=e.tag||"tag",e.tagline=e.tagline||"",$("#"+e.tag).autocomplete(e.tagline,{multiple:!0,autoFill:!0,max:e.max,multipleSeparator:" "})},e.pwd=function(){var e=window.location.pathname.split("/"),t="",n="";try{t=e[1]}catch(r){}try{n=e[2]}catch(r){}return{where:t,tid:n}}(),e.palette=function(){return{bind:function(){$(".m-palette a").click(function(e){var t=$(this);$(".m-palette a").removeClass("active").addClass("inactive"),t.removeClass("inactive").addClass("active")})},render:function(){return'<div class="m-palette m-clearfix" name="color"><a title="red" value="red" class="red"></a><a title="orange" value="orange" class="orange"></a><a title="yellow" value="yellow" class="yellow"></a><a title="green" value="green" class="green"></a><a title="blue" value="blue" class="blue"></a><a title="purple" value="purple" class="purple"></a><a title="pink" value="pink" class="pink"></a><a title="khaki" value="khaki" class="khaki"></a><a title="brown" value="brown" class="brown"></a><a title="gold" value="gold" class="gold"></a></a><a title="black" value="black" class="black"></a><a title="grey" value="grey" class="grey"></a><a title="white" value="white" class="white"></a><a title="multi" value="multi" class="multi"></a></div>'}}}(),e.placeJumpPage_=function(){var t=$(".gwrap").offset(),n=e.getViewportSize();if($(document.body).width()<=e.placeJumpPage.pageMinWidth||$.browser.msie&&parseInt($.browser.version,10)<7){var r=parseInt($(document).scrollTop()+n.height/2),i=parseInt(t.left-e.placeJumpPage.holderOffset);$("#g-jump-page").css({left:i,top:r,marginLeft:0,position:"absolute"}),e.placeJumpPage.scrollEvent()}else $("#g-jump-page").css({left:"50%",top:"50%",marginLeft:e.placeJumpPage.holderMarginLeft,position:"fixed"})},e.placeJumpPage=function(t){e.placeJumpPage.pageMinWidth=1200,e.placeJumpPage.holderWidth=1120,t&&(e.placeJumpPage.pageMinWidth=t,e.placeJumpPage.holderWidth=t-80),$(function(){if($("html,body").width()<e.placeJumpPage.pageMinWidth){$("#g-jump-page").remove();return}t&&$("#g-jump-page").css("width",e.placeJumpPage.holderWidth),e.placeJumpPage.holderOffset=(e.placeJumpPage.holderWidth-940)/2,$("html,body").css("min-width",e.placeJumpPage.pageMinWidth),e.placeJumpPage.holderMarginLeft=-parseInt(e.placeJumpPage.holderWidth/2),e.placeJumpPage_(),$(window).resize(function(){e.placeJumpPage_()})})},e.placeJumpPage.afterScroll=function(){var t=(new Date).getTime();t-e.placeJumpPage.timer>400&&(e.placeJumpPage_(),window.clearInterval(e.placeJumpPage.interval))},e.placeJumpPage.scrollEvent=function(){$(window).scroll(function(){e.placeJumpPage.timer=(new Date).getTime(),window.clearInterval(e.placeJumpPage.interval),e.placeJumpPage.interval=window.setInterval(e.placeJumpPage.afterScroll,600)}),e.placeJumpPage.scrollEvent=$.noop},e.namespace("pinkoi.admin"),e.admin.remove=function(){function t(t,n){var r=confirm(_("物件將會被永久刪除，而且無法回復..."));r&&e.request("POST",t,{data:n,success:function(t){t.status!="ok"?e.drawer.on(_("這件商品沒辦法被刪除")):window.location.reload(!1)}})}return{item:function(n,r){return t(e.uri.admin_remove_item,{tid:n,owner:r})},store:function(n){return t(e.uri.admin_remove_store,{uid:n})}}}(),e.gridHeart=function(t,n,r){var t=t||".g_grid_items",r=r||".item",n=n||{},i=n.H||8,s=n.L||35,o=$(t);o.each(function(){var t=$(this),n=$('<a class="heart-proxy" style="display:none"></a>');t.append(n);var o=t.find(r);if(o.length&&o.is(r)){var u=o.width()-s;o=null,t.bind("mouseover",function(e){var t=$(e.target);if(t.is("img")){var s=t.closest(r);if(!s.find(".heart").length){var o=s.position();n.show().css({left:o.left+u,top:o.top+i}),n.data("item",s)}}}).bind("mouseout",function(e){var t=$(e.target);t.is("img")&&!$(e.relatedTarget).is(".heart-proxy")&&(n.hide(),n.data("item",null))}).bind("click",function(t){var r=$(t.target);if(r.is(".heart-proxy")){if(!e.globals.get("uid")){e.login_modal.load();return}n.data("item")&&(function(e){var t=e.attr("tid")||e.find(".title a").attr("href"),r=e.attr("title")||e.find(".title a").text();t=t.split("/"),t=t[t.length-1],e.append('<a class="heart"></a>'),n.hide(),require(["app/modules/fav"],function(e){e.addFav(t)}),gTrackEvent("Heart","Via Grid")}(n.data("item")),n.data("item",null))}else r.is(".heart")})}})},e.resetPasswd=function(){e.gmodal.load('<div class="reset-passwd" style="font-size:16px; padding:30px 0">'+_("請輸入你註冊時使用的 Email ")+'<input type="text" name="email" style="border:2px solid #ddd; padding:5px 10px; width:150px"/> <a class="submit g_btns g_btns_ok"></a></div>',{bypass:!0}),e.gmodal.content.find(".reset-passwd .submit").bind("click",function(t){var n=$.trim(e.gmodal.content.find(".reset-passwd input[name=email]").val());if(!n||!e.forms.validate("email",n)){e.drawer.on(_("Email 不正確哦"));return}e.request("POST","/api/user/reset-passwd",{data:{email:n},success:function(t){t.status=="ok"?e.gmodal.load('<div style="font-size:16px; padding:30px 0">'+_("已經將更換新密碼的資訊寄到你的 Email")+"</div>",{bypass:!0}):e.gmodal.load('<div style="font-size:16px; padding:30px 0">'+_("嗯？我們找不到這個信箱，還是你之前是透過 Facebook 或微博加入的呢？這樣按下「用Facebook/微博登入」就行囉，再請你試試看！。")+"</div>",{bypass:!0})}})})},e.select711Store=function(t){e.gmodal.load('<h2 class="title_">'+_("7-11交貨便 - 直接到你指定的7-11門市取貨，限台灣本島")+'<span class="caption_">'+_("讓你在家裡附近的7-11取貨，購買安心、貼心又方便！位於金門、馬祖、澎湖的朋友請改選用一般郵寄")+'</span></h2>                        <div class="711"><a class="m-button" onclick="pinkoi.select711Store.select()" data-id="select-seven">'+_("選擇 7-11 取貨門市")+'</a><img src="//s3-ap-southeast-1.amazonaws.com/pinkoi.site/cart/711-shipping.jpeg" style="margin-left:30px;vertical-align:middle;"></div>                        <div class="caption_" style="margin-top:15px;">'+_("提醒你交貨便是取貨服務，你會在訂單後面步驟選擇付款的金流方式。")+'</div>                        <div class="result" style="position:relative;margin-top:15px"></div>'),e.select711Store.cb=t||$.noop},e.select711Store.done=function(){e.gmodal.close(),e.select711Store.cb(e.select711Store.data)},e.select711Store.data=null,e.select711Store.select=function(){var t="/page/711select",n=screen.availHeight,r=screen.availWidth;e.select711Store.winMapFSZ=window.open(t,"winMapFSZ","left=230px,top=50px,width="+r*3/4+"px,height="+n*3/4+"px,menubar=0,resize=0,scrollbars=yes,resizable=no,status=no"),e.select711Store.winMapFSZ.focus()},e.select711Store.callback=function(t){e.select711Store.data=$.extend({},t),e.select711Store.winMapFSZ.close(),e.gmodal.content.find(".result").html(_("門市名稱：")+e.select711Store.data.storename+"<br/>"+_("門市地址：")+e.select711Store.data.storeaddress+"<br/>"+_("門市代碼：")+e.select711Store.data.storeid),e.gmodal.content.find(".g_btns_ok").length||($(".g_btns_711").next().remove(),e.select711Store.done())},e.selectFamiportStore=function(t){e.gmodal.load(['<h2 class="title_">'+_("全家店到店 - 直接到你指定的全家超商門市取貨，限台灣本島")+'<span class="caption_">'+_("提醒你店到店是取貨服務，你會在訂單後面步驟選擇付款的金流方式。位於金門、馬祖、澎湖的朋友請改選用一般郵寄。")+"</span></h2>",'<div class="selects fillbg_">','<div class="city" style="margin-bottom:10px;"></div>','<div class="zone" style="margin-bottom:10px; display:none;"></div>','<div class="road" style="margin-bottom:10px; display:none;"></div>','<div class="store" style="margin-bottom:10px; display:none;"></div>',"</div>",'<div class="footer_"><a class="m-button" onclick="pinkoi.selectFamiportStore.done();">'+_("確認取貨門市")+"</a></div>"].join("")),e.selectFamiportStore.cb=t||$.noop,e.selectFamiportStore.renderCity();var n=e.gmodal.content.find(".city"),r=e.gmodal.content.find(".zone");e.gmodal.content.find(".selects").on("change","select",function(t){var n=$(t.target),r=n.attr("name");if(r==="city")e.selectFamiportStore.renderZone(n.val());else if(r==="zone")e.selectFamiportStore.renderRoad(e.gmodal.content.find('select[name="city"]').val(),n.val());else if(r==="road")e.selectFamiportStore.renderStore(e.gmodal.content.find('select[name="city"]').val(),e.gmodal.content.find('select[name="zone"]').val(),n.val());else if(r==="store"){var i=n.val();e.gmodal.content.find(".map").html(i?'<a href="http://maps.google.com.tw/maps?q='+encodeURIComponent(n.find('option[value="'+i+'"]').data("address"))+'&hl=zh-TW&ie=UTF8&t=m&z=17" target="_blank">'+_("地圖位置")+"</a>":"")}})},e.selectFamiportStore.renderCity=function(){var t=e.gmodal.content.find(".city"),n=e.request("GET","/api/shipping/famiportStores",{data:{query:"city"}},"json",!1),r=n.result,i=['<select name="city"><option value="">'+_("請選擇縣市")+"</option>"];for(var s=0,o=r.length;s<o;++s)i.push('<option name="'+r[s]+'">'+r[s]+"</option>");i.push("</select>"),t.html(i.join(""))},e.selectFamiportStore.renderZone=function(t){e.gmodal.content.find(".zone, .road, .store").hide().empty();if(t){var n=e.gmodal.content.find(".zone"),r=e.request("GET","/api/shipping/famiportStores",{data:{query:"zone",city:t}},"json",!1),i=r.result,s=['<select name="zone"><option value="">'+_("請選擇鄉鎮市區")+"</option>"];for(var o=0,u=i.length;o<u;++o)s.push('<option value="'+i[o]+'">'+i[o]+"</option>");s.push("</select>"),n.html(s.join("")).show()}},e.selectFamiportStore.renderRoad=function(t,n){e.gmodal.content.find(".road, .store").hide().empty();if(t&&n){var r=e.request("GET","/api/shipping/famiportStores",{data:{query:"road",city:t,zone:n}},"json",!1),i=r.result,s=['<select name="road"><option value="">'+_("請選擇街道")+"</option>"];for(var o=0,u=i.length;o<u;++o)s.push('<option value="'+i[o]+'">'+i[o]+"</option>");s.push("</select>"),e.gmodal.content.find(".road").html(s.join("")).show()}},e.selectFamiportStore.renderStore=function(t,n,r){e.gmodal.content.find(".store").hide().empty();if(t&&n&&r){var i=e.request("GET","/api/shipping/famiportStores",{data:{query:"store",city:t,zone:n,road:r}},"json",!1),s=i.result,o=['<select name="store"><option value="">'+_("請選擇門市")+"</option>"];for(var u=0,a=s.length;u<a;++u){var f=s[u];o.push('<option value="'+f.id+'" data-store="'+f.store+'" data-address="'+f.address+'">'+f.store+" ("+f.address+")"+"</option>")}o.push('</select> <span class="map"></span>'),e.gmodal.content.find(".store").html(o.join("")).show()}},e.selectFamiportStore.done=function(){var t=e.gmodal.content.find('select[name="store"]');if(!t.length||!t.val())e.drawer.on(_("請先選擇取貨門市"));else{var n=t.val(),r=t.find('option[value="'+n+'"]'),i=r.data("store"),s=r.data("address");e.gmodal.close(),e.selectFamiportStore.cb({storeid:n,storename:i,storeaddress:s})}},e.friendlyprint_bill=function(){var t=$(".g-friendlyprint"),n=[],r=$("#admin_bill .store");if(r.length){var i=0;r.each(function(t){var r=$(this),s=r.find(".title").text(),o=r.find(".address .text").text(),u=r.find(".phone .text").text(),a=r.find(".taxid .text").text(),f=r.attr("uid");if(a&&o){i%14===0&&n.push('<div class="pagebreak"> ');var l=e.template('<div class="label"><div class="slip"><p class="name">%s</p><p class="addr">%s</p><p class="tel">%s</p><p class="name">http://www.pinkoi.com/%s</p></div></div>',s,o,u,f);n.push(l),i%14===13&&n.push("</div>"),i+=1}}),i%14!==0&&n.push("</div>"),t.append(n.join(""))}},e.logout=function(){document.cookie="st=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="st=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="sessionid=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",document.cookie="sessionid=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/",e.request("POST","/apiv2/account/logout",{success:function(e){location.href=e.result[0].next}})}})(pinkoi),pinkoi.namespace("pinkoi.notify"),pinkoi.notify=function(e){pinkoi.notify.queue.push(e),pinkoi.notify.run()},pinkoi.notify.queue=[],pinkoi.notify.init=function(){$(function(){var e=$('<div class="m-notify-wrap"><div class="m-notify-innerwrap"><div class="m-notify" style="display:none"></div></div></div>');$(document.body).append(e),pinkoi.notify.$=e.find(".m-notify"),e=null,pinkoi.notify.$.bind("click",function(e){pinkoi.notify.$.hide()})})},pinkoi.notify.run=function(){if(!pinkoi.notify.$){pinkoi.notify.init(),$(function(){window.setTimeout(function(){pinkoi.notify.run()},50)});return}var e=[];for(var t=0,n=pinkoi.notify.queue.length;t<n;t++)e[t]=pinkoi.notify.queue[t];e.push('<span class="x">x</span>'),pinkoi.notify.$.empty().html(e.join("")).show(),pinkoi.notify.queue.length=0},pinkoi.namespace("pinkoi.sidetab"),pinkoi.sidetab=function(e){$(function(){var t=$('<div class="g-sidetab"><div><b>'+_("聯絡設計師")+"</b></div></div>");t.click(function(){e&&(typeof e=="function"?e():typeof e=="string"&&(window.location.href=e))}),$(document.body).append(t)})},pinkoi=typeof pinkoi=="undefined"?{}:pinkoi,pinkoi.user={},function(e){e.user.makeFriend=function(t,n,r){e.makeFriend(n,r,function(){r=="befriend"||r=="friend"?(r=="befriend"?e.drawer.on(_("✔ 已發出朋友請求")):e.drawer.on(_("✔ 已成功加為朋友")),$(t).replaceWith('<div class="m-engage-button m-button-important" onclick="pinkoi.user.makeFriend(this, \''+n+"', 'unfriend');\"><span>"+_("從朋友中移除")+"</span></div>")):r=="unfriend"&&($(t).replaceWith('<div class="m-engage-button m-button-important" onclick="pinkoi.user.makeFriend(this, \''+n+"', 'befriend');\"><span>"+_("加為朋友")+"</span></div>"),e.drawer.on(_("✔ 已成功移除")))})},e.user.review=function(t,n,r){function f(e){var t="";for(var n=0;n<e;n++)t+='<img src="http://cdn04.pinkoi.com/pinkoi.site/fgp/star.png"/>';return t}function p(t,n){e.request("GET",e.uri.review_get,{data:n,success:function(n){n.status=="ok"&&(e.loader.off(),d(n.result,t))}})}function d(t,n){var s="",f={5:0,4:0,3:0,2:0,1:0};for(var l in t)if(t.hasOwnProperty(l)){var c,h,p,d,v="",m="";n=="received"?(c=t[l].score,v=e.template('From <a href="%(profileURL)s">%(nick)s</a>',{profileURL:e.conf.profileURL(t[l].owner),nick:t[l].nick}),h=t[l].description,r.isOwner?d=e.template('<a href="/order?oid=%(oid)s&role=%(role)s">%(created)s</a>',{oid:t[l].oid,role:t[l].role=="seller"?"buyer":"seller",created:t[l].created}):d=t[l].created):n=="given"?(c=t[l].score,v=e.template('To <a href="%(profileURL)s">%(nick)s</a>',{profileURL:e.conf.profileURL(t[l].who),nick:t[l].nick}),h=t[l].description,r.isOwner?d=e.template('<a href="/order?oid=%(oid)s&role=%(role)s">%(created)s</a>',t[l]):d=t[l].created):n=="pending"?(o.order[t[l].oid]=t[l],i==t[l].buyer&&!t[l].breviewed?(d=e.template('<a href="/order?oid=%(oid)s&role=buyer">%(created)s</a>',t[l]),h=e.template(a.reviewToSeller,{oid:t[l].oid}),p=""):i==t[l].seller&&!t[l].sreviewed&&(d=e.template('<a href="/order?oid=%(oid)s&role=seller">%(created)s</a>',t[l]),h=e.template(a.reviewToBuyer,{oid:t[l].oid}),p="")):n=="waiting"?(o.order[t[l].oid]=t[l],i==t[l].buyer&&!t[l].sreviewed?(d=e.template('<a href="/order/?oid=%(oid)s&role=buyer">%(created)s</a>',t[l]),h=e.template(a.contactSeller,{oid:t[l].oid}),p=""):i==t[l].seller&&!t[l].breviewed&&(d=e.template('<a href="/order/?oid=%(oid)s&role=seller">%(created)s</a>',t[l]),h=e.template(a.contactBuyer,{oid:t[l].oid}),p="")):e.error("msg","something wrong");try{if($.inArray(n,["pending","waiting"])===-1){var g="",y=t[l].other?t[l].other.split(","):[],b=t[l].tid;y.push(b);for(var w=0;w<y.length;++w){var E=y[w];g+=e.template('<a href="%(itemURL)s"><img src="%(itemPhotoURL)s"/></a>',{itemURL:e.conf.itemURL(E),itemPhotoURL:e.conf.itemImageUrl(E,"80x80")})}g+=e.template('<a href="%(itemURL)s" target="_blank">%(item)s</a>',{itemURL:e.conf.itemURL(b),item:e.trunk(t[l].title,10)}),s+=e.template(a.reviewRow,{score_clz:c*10,score:c,title:v,review:h,created:t[l].created,profileURL:e.conf.profileURL(p),items:g,style:l%2!==0?"even":"",order:d}),f[parseInt(t[l].score)]+=1}else s+=e.template(a.actionRow,{order:d,review:h,contact:m,owner:p,created:t[l].created,item:e.trunk(t[l].title,20),profileURL:e.conf.profileURL(p),itemURL:e.conf.itemURL(t[l].tid),itemPhotoURL:e.conf.itemImageUrl(t[l].tid,"80x80"),style:l%2!==0?"even":""})}catch(S){s=""}}s||(s='<center class="noresult">'+_("目前沒有評價")+'                        <div class="small" style="padding-left:10px;">'+_("要有交易才會有評價！")+"</div>                    </center>"),$("#"+n).html(s),u[n]=!1}if(e.user.review.initialized)return;var i=r.username;r.isOwner=e.globals.get("uid")==r.username;var s=$(t),o={};o.score={},o.order={};var u={received:!0,from_buyer:!0,from_seller:!0,given:!0,waiting:!0,pending:!0},a={score:'            <ul class="score clr">                <li class="avg"><span>0</span></li>                <li>'+f(5)+"：<span>0</span></li>                <li>"+f(4)+"：<span>0</span></li>                <li>"+f(3)+"：<span>0</span></li>                <li>"+f(2)+"：<span>0</span></li>                <li>"+f(1)+"：<span>0</span></li>            </ul>",reviewHolder:"<div></div>",sellerView:['<div class="xtabilify">','<a selector="#received" class="tab active">'+_("收到的評價")+"</a>",'<a selector="#given" class="tab">'+_("給出的評價")+"</a>",r.isOwner?'<a selector="#waiting" class="tab">'+_("尚未收到的評價")+'</a><a selector="#pending" class="tab">'+_("尚未給出的評價")+"</a>":"",'<div class="h0 divider"></div>','<div id="received" class="t active"></div>','<div id="given" class="t"></div>',r.isOwner?'<div id="waiting" class="t"></div><div id="pending" class="t"></div>':"","</div>"],buyerView:['<div class="xtabilify">','<a selector="#received" class="tab active">'+_("收到的評價")+"</a>",'<a selector="#given" class="tab">'+_("給出的評價")+"</a>",r.isOwner?'<a selector="#waiting" class="tab">'+_("尚未收到的評價")+'</a><a selector="#pending" class="tab">'+_("尚未給出的評價")+"</a>":"",'<div class="h0 divider"></div>','<div id="received" class="t active"></div>','<div id="given" class="t"></div>',r.isOwner?'<div id="waiting" class="t"></div><div id="pending" class="t"></div>':"","</div>"],rowHead:['<div class="row head">','<div class="review">'+_("評價等級")+"</div>",'<div class="feedback">'+_("意見")+"</div>",'<div class="item">'+_("商品")+"</div>",'<div class="created">'+_("日期")+"</div>","</div>"],reviewRow:'            <div class="row %(style)s">                <div class="review"><a class="g-rating g-rating%(score_clz)s"></a></div>                <div class="feedback"><div class="who">%(title)s</div><div>%(review)s</div></div>                <div class="item">%(items)s</div>                <div class="created">%(order)s</div>            </div>',actionRow:'            <div class="row %(style)s">                <div class="review">%(review)s</div>                <div class="feedback">%(contact)s</div>                <div class="item"><img src="%(itemPhotoURL)s"/> <a href="%(itemURL)s" target="_blank">%(item)s</a></div>                <div class="created">%(order)s</div>            </div>',reviewToSeller:'<a class="m-button-small btn_review2_seller dosth" sth="reviewToSeller" oid="%(oid)s">'+_("給設計師評價")+"</a>",reviewToBuyer:'<a class="m-button-small btn_review2_buyer dosth" sth="reviewToBuyer" oid="%(oid)s">'+_("給買家評價")+"</a>",contactSeller:'<a class="m-button-small btn_contact_seller dosth" sth="qnaToSeller" oid="%(oid)s">'+_("請設計師評價")+"</a>",contactBuyer:'<a class="m-button-small btn_contact_buyer dosth" sth="qnaToBuyer" oid="%(oid)s">'+_("請買家評價")+"</a>"},l=$(a.score),c=l.find("span"),h=$(a.reviewHolder);s.append(h),r.isSeller?h.append(a.sellerView.join("")):h.append(a.buyerView.join("")),h.find(".h0").after(a.rowHead.join("")),e.tabilify(".xtabilify .tab",!1,{click:function(e){var t=$(this),n=t.attr("selector").substr(1);if(u[n])switch(n){case"received":p(n,{who:r.username,type:"received"});break;case"from_buyer":p(n,{who:r.username,role:"buyer"});break;case"from_seller":p(n,{who:r.username,role:"seller"});break;case"given":p(n,{owner:r.username,type:"given"});break;case"pending":var i=r.isSeller?"seller":"buyer";p(n,{type:"pending",role:i,owner:r.username});break;case"waiting":var i=r.isSeller?"seller":"buyer";p(n,{type:"waiting",role:i,owner:r.username})}}}),s.bind("click",function(t){var n=$(t.target);if(n.hasClass("dosth")){var r=n.attr("sth"),i=o.order[n.attr("oid")];switch(r){case"qnaToBuyer":e.message_modal.load({prompt:_("資訊"),photo:e.conf.itemImageUrl(i.tid,"80x80"),to:i.buyer,title:i.title,tid:i.tid,oid:i.oid,content:_("請幫我評價，謝謝!")},function(t){t.result?e.drawer.on(_("✔ 已成功送出")):e.error()});break;case"qnaToSeller":e.message_modal.load({prompt:_("資訊"),photo:e.conf.itemImageUrl(i.tid,"80x80"),to:i.seller,title:i.title,tid:i.tid,oid:i.oid,content:_("請幫我評價，謝謝!")},function(t){t.result?e.drawer.on(_("✔ 已成功送出")):e.error()});break;case"reviewToBuyer":e.review_modal.load({photo:e.conf.itemImageUrl(i.tid,"80x80"),to:i.buyer,title:i.title,tid:i.tid,oid:i.oid,verb:_("購買"),role:"seller",seller:i.seller},function(t){t.result?(n.replaceWith('<a class="gbutton">'+_("已評價")+"</a>"),e.drawer.on(_("✔ 已成功評價"))):e.error("msg","something wrong")});break;case"reviewToSeller":e.review_modal.load({photo:e.conf.itemImageUrl(i.tid,"80x80"),to:i.seller,title:i.title,tid:i.tid,oid:i.oid,verb:_("販售"),role:"buyer",seller:i.seller},function(t){t.result?(n.replaceWith('<a class="gbutton">'+_("已評價")+"</a>"),e.drawer.on(_("✔ 已成功評價"))):e.error("msg","something wrong")})}}}),s.find("a[selector=#"+r.defaultTab+"]").click(),e.user.review.initialized=!0,$("html,body").animate({scrollTop:$("#bottom").offset().top-10},800)},e.user.magz=function(t,n){if(e.user.magz.alreadyInit)return;e.user.magz.alreadyInit=!0;var r=null;e.request("GET",e.uri.category_get,{data:{type:"magz"},success:function(t){t.status=="ok"?r=t.result:e.error()}},null,!1);var i=0,s=4,o=null,u=$(n),a='<li class="post"><img class="photo" src="%(photo)s" onload="window.imgload(this,1);" onerror="window.imgerror(this,1);" onclick="pinkoi.magz.list.read(this);" tid="%(tid)s" magz_thumb="magz_thumb" mindim="300"/><div class="info"><span class="not_published">%(published_str)s</span><a class="title" href="%(magzUrl)s">%(title)s</a><div class="owner">by<a class="owner" href="%(profileUrl)s">%(nick)s</a></div></div><a class="category" href="/magz/list?category=%(category)s">%(categoryName)s</a><b class="fav%(favedFlag)s" tid="%(tid)s"></b></lio>',f=function(t,n,s){var f=[];for(var l=0,c=t.length;l<c;l++){var h=t[l];h.magzUrl=e.conf.magzUrl(h.tid),h.profileUrl=e.conf.profileURL(h.owner),h.nick=n[h.owner].nick,h.categoryName=r[h.category],h.published_str=h.published?"":"["+_("未發布")+"]",s&&$.inArray(h.tid,s)!=-1?h.favedFlag=" faved":h.favedFlag="",f[l]=e.template(a,h)}f='<ul class="l_magz_list clr">'+f.join("")+"</ul>",f+=e.pagination(i,o),u.html(f)},l=function(n){i=n;var r={};r.owner=t,r.limit=s,r.start=(i-1)*s,r.total=1,r.returns="userMap";var u=!1;e.globals.get("uid")&&(r.returns+=",favs",u=!0),e.request("GET",e.uri.magz_get,{data:r,success:function(t){if(t.status=="ok"){if(!t.result||!t.result.length)return;o=Math.ceil(t.total/s),f(t.result,t.returns.userMap,u?t.returns.favs:!1)}else e.error();$("html,body").animate({scrollTop:$("#bottom").offset().top-10},800)}})};u.bind("click",function(e){var t=$(e.target);if(t.hasClass("dosth")){var n=t.attr("sth");if(n=="pagination"){var r=t.attr("page");l(r)}}}),l(1),e.magz.bindFav(u)},e.user.fav=function(t,n){function r(){function l(n){n?s=parseInt(n):++s,require(["app/modules/fav"],function(n){n.getFav({uid:t,page:s,limit:i,need_page_count:1}).done(function(t,n,i){var o=[];if(t.result.length===0)s===1&&o.push('<center class="noresult">'+_("你一點慾望也沒有！怎麼會呢？")+'<div class="small">'+_('把喜歡的設計品放到慾望清單還可以拿紅利折抵消費喔。建議你<a href="/wall">逛逛找靈感</a>，最新的<a href="/offers">好日推好物企劃</a>，欣賞大家蒐集的<a href="/window">品味櫥窗</a>，或者可以<a href="/magz">閱讀設計誌</a>。相信你會發現好多有趣的設計品。<br><br>還是不曉得從哪開始逛起？建議你可以<a href="/browse">從商品分類開始</a>～')+"</div></center>");else{var u=0;for(var l in t.result)if(t.result.hasOwnProperty(l)){++u,a&&(e.user.fav.myFavlist[t.result[l].tid]?t.result[l].favAdd='<a class="g_favlist g_favlist_faved"></a>':t.result[l].favAdd='<a class="dosth g_favlist" sth="addFav"></a>');var c=t.result[l];c._flag=u%2==1?"":" even",c.itemURL=e.conf.itemURL(t.result[l].tid),c.photo=e.conf.itemImageUrl(t.result[l].tid,"80x80"),c.storeURL=e.conf.storeURL(t.result[l].owner),c.symbol=c.currency.symbol,o.push(e.template(f,c))}t.pagination.paeg_count&&t.pagination.paeg_count>1&&o.push(e.pagination(s,t.pagination.paeg_count))}r.html(o.join("")),$("html,body").animate({scrollTop:$("#bottom").offset().top-10},800)})})}var r=$(n),i=16,s=0,o="",u="",a=!1;e.globals.get("uid")&&(e.globals.get("uid")==t?o='<a class="g_x_btn dosth" sth="remove" title="'+_("移除")+'"></a>':(u="%(favAdd)s",a=!0));var f='<div class="item%(_flag)s" tid="%(tid)s" owner="%(owner)s"><a class="photo" href="%(itemURL)s" title="%(title)s"><img src="%(photo)s"/></a><div class="detail"><a class="title" href="%(itemURL)s" title="%(title)s">%(title)s</a><div class="price">%(symbol)s<b>%(price)s</b></div></div>'+o+u+"</div>";l(),r.bind("click",function(t){var n=$(t.target);if(n.hasClass("dosth")){var r=n.attr("sth");require(["app/modules/fav"],function(t){if(r=="pagination"){var i=n.attr("page");l(i)}else if(r=="addFav"){var s=n.closest(".item").attr("tid");t.addFav(s)}else if(r=="remove"){var o=n.closest(".item"),s=o.attr("tid");t.removeFav(s,function(t,r,i){n.removeClass("dosth").fadeOut(function(){n.remove()}),o.animate({opacity:.3},1400),e.drawer.on(_("✔ 已成功移除"))})}})}})}if(e.user.fav.alreadyInit)return;e.user.fav.alreadyInit=!0,e.globals.get("uid")&&e.globals.get("uid")!=t?require(["app/modules/fav"],function(t){t.getFav(null,function(t,n,i){e.user.fav.myFavlist={};for(var s=0;s<t.result.length;s++)e.user.fav.myFavlist[t.result[s].tid]=1;r()})}):r()}}(pinkoi),pinkoi.friends={},jQuery.fn.extend({glideToAni:function(e,t,n){typeof t=="object"&&(n=t,t=undefined),n=n||{};var r=t||n.complete;n.complete=function(){s.remove(),i.show(),r&&r.call(this)};var i=this,s=this.clone();s.css("position","relative"),i.after(s).hide();var o=e.offset(),u=s.offset(),a={top:s.css("top"),left:s.css("left")};return s.animate({top:o.top-u.top,left:o.left-u.left},n),this}}),pinkoi.friends.invite=function(e){e=e||{},e.method="apprequests",e.message=e.message||"Invite friends",e.scope=["user_friends"],require(["external/facebook"],function(t){t.ui(function(t){e.cb&&e.cb(t)},e)})},pinkoi.friends.mkCounters=function(e,t,n){function s(){var e=["confirmed","requested","requesting"],r=0;for(var s=0,o=e.length;s<o;s++){var u=e[s],a=t[u],f=i[u];a>0?(f.find("i").html(a),f.show(),r+=a):(f.hide(),n&&n(u))}r==0&&n&&n("all")}var r=$(e),i={confirmed:r.find(".confirmed"),requested:r.find(".requested"),requesting:r.find(".requesting")};return{inc:function(e){t[e]++},dec:function(e){t[e]--},update:s}},pinkoi.friends.grant_fb_permission=function(){require(["external/facebook"],function(e){e.loginFB(function(){location.reload()})})},pinkoi.friends.initDefault=function(e,t,n){function f(){var e=260,t=r.children(":last"),n=0;t.length?n=t.offset().top-r.offset().top+t.outerHeight():s.fadeIn(),r.animate({height:a||n<=e?n:e},{duration:Math.log(e,10)*100}),n<=e&&o.fadeOut()}function l(){o.bind("click",function(e){a=!a,f();switch(a){case!0:o.html(_("<a>少一點</a>"));break;case!1:o.html(_("<a>看全部</a>"))}}),r.bind("click",function(e){var t=$(e.target);if(t.hasClass("doajax")&&e.target.tagName.toLowerCase()=="a"){var n=t.attr("action"),i=t.attr("uid"),s=t.closest(".buttons"),o=s.closest(".sticker");function u(){s.html(_("已送出邀請")),o.fadeTo(null,0,function(){var e=r.children(":last");e.glideToAni(o,function(){o.replaceWith(e),f()})})}pinkoi.request("POST",pinkoi.uri.befriend,{data:{uid:i},success:u}),s.html(_("處理中..."))}})}var r=$(e),i=$(t),s=$(n),o=r.parent().find(".toggle:eq(0)"),u=pinkoi.friends.mkCounters(t,{confirmed:parseInt(i.find(".confirmed i").html()),requested:parseInt(i.find(".requested i").html()),requesting:parseInt(i.find(".requesting i").html())}),a=!1;l(),f()},pinkoi.friends.initList=function(e,t,n){function s(e,t,n,r){return'<a class="doajax '+e+'" action="'+t+'" uid="'+n+'">'+r+"</a>"}function o(e,t){var n=[];switch(e){case"confirmed":n.push('<a class="recommend" onclick="pinkoi.recommend_modal.load(\''+t+"')\">"+_("推薦商品")+"</a>"),n.push(s("x","unfriend",t,"&times;"));break;case"requested":n.push(s("confirm","friend",t,_("確認加入好友"))),n.push(s("ignore","unfriend",t,_("忽略")));break;case"requesting"
:n.push(s("cancel","unfriend",t,_("取消")))}return n.join("")}function u(e,t,n){var r=[];return r.push('<div class="sticker '+t+'">'),r.push('<div class="column">'),r.push('<a target="_blank" href="/user/'+t+'"><img src="'+n.avatar+'"></a>'),r.push("</div>"),r.push('<div class="column">'),r.push("<h4>"+n.nick+"</h4>"),r.push('<div class="buttons">'),r.push(o(e,t)),r.push("</div>"),r.push("</div>"),r.push("</div>"),r.join("")}function a(){function e(e){return"<h3>"+e+"</h3>"}var t=[],i=["confirmed","requested","requesting"];for(var s=0,o=i.length;s<o;++s){var a=i[s];if(!$.isEmptyObject(n[a])){t.push('<a name="'+a+'"></a>');switch(a){case"confirmed":break;case"requested":t.push(e(_("這些朋友還在等著你回覆")));break;case"requesting":t.push(e(_("這些朋友還沒確認你的邀請")))}t.push('<div class="section '+a+(a=="requesting"?" last ":"")+' clr">');for(var f in n[a]){var l=n[a];l.hasOwnProperty(f)&&t.push(u(a,f,l[f]))}t.push("</div>")}t.push("</div>")}r.html(t.join(""))}function f(){r.bind("click",function(e){var t=$(e.target);if(t.hasClass("doajax")&&t.get(0).tagName.toLowerCase()=="a"){var n=t.attr("action"),s=t.attr("uid"),u=t.closest(".buttons"),a=u.closest(".sticker");function f(){var e="";t.hasClass("confirm")?(e=_("已確認加入好友"),i.inc("confirmed"),i.dec("requested")):t.hasClass("x")?(e=_("已刪除好友"),i.dec("confirmed")):t.hasClass("ignore")?(e=_("已忽略好友"),i.dec("requested")):t.hasClass("cancel")&&(e=_("已取消好友"),i.dec("requesting")),u.html(e),i.update();switch(n){case"friend":var f=$('<div class="sticker" style="opacity: 0">'),l=r.find("div.confirmed");l.length==0&&(l=$('<div class="section confirmed clr">'),r.prepend(l)),f.appendTo("div.confirmed");var c=f.clone();a.glideToAni(f,function(){u.html(o("confirmed",s)),a.replaceWith(c),f.replaceWith(a);var e=c.nextAll().last();e.length?e.glideToAni(c,function(){c.replaceWith(e)}):c.remove()});break;case"unfriend":a.fadeTo(null,0,function(){var e=a.nextAll().last();e.length?e.glideToAni(a,function(){a.replaceWith(e)}):a.remove()})}}switch(n){case"friend":pinkoi.request("POST",pinkoi.uri.friend,{data:{uid:s},success:f});break;case"unfriend":pinkoi.request("POST",pinkoi.uri.unfriend,{data:{uid:s},success:f})}u.html(_("處理中..."))}})}var r=$(e),i=pinkoi.friends.mkCounters(t,{confirmed:pinkoi.count(n.confirmed),requested:pinkoi.count(n.requested),requesting:pinkoi.count(n.requesting)},function(e){switch(e){case"all":r.prepend('<center class="noresult">'+_('這裡好空喔！來用 Pinkoi 新的<a href="/friends/find">找朋友工具</a>來填滿這裡吧！')+"</center>");break;default:var t=r.find("."+e);t.prevAll("h3:first").fadeOut(),t.fadeOut(function(){t.remove()})}});a(),i.update(),f()},pinkoi.friends.message_modal=function(){var e=['<div class="g_mod_message">','<h2 class="title_">%s</h2>','<div id="n-friends-message-wrapper">%s</div>','<div class="footer_">',"%s　%s","</div>","</div>"].join(""),t='<a class="m-button" href="%(href)s">%(text)s</a>',n='<a class="m-button-gray" href="%(href)s">%(text)s</a>';return{load:function(r,i,s,o){var u='<a class="m-button" href="/">'+_("回首頁逛設計")+"</a>",a="";s!==undefined&&(u=pinkoi.template(t,s)),o!==undefined&&(a=pinkoi.template(n,o));var f=pinkoi.template(e,r,i,u,a);pinkoi.gmodal.load(f,{bypass:!0}),pinkoi.gmodal.onetimeOnBeforeClose=function(){document.location.href=s&&s.href||"/"}},close:function(){pinkoi.gmodal.close()}}}(),pinkoi.friends.renderContacts=function(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)){if(!e[n])continue;t.push(n)}t.sort();var r='        <tr class="%(style)s">            <td class="check"><input type="checkbox"></td>            <td class="nick">%(name)s</td>            <td class="email">%(email)s</td>        </tr>',i=[];i.push('<table id="n-friends-contacts-table">'),i.push("<tr><th></th><th>"+_("姓名")+"</th><th>"+_("信箱")+"</th></tr>");var s=!0;for(var o=0,u=t.length;o<u;o++){var n=t[o];i.push(pinkoi.template(r,{email:e[n],name:n,style:s?"odd":"even"})),s=!s}return i.push("</table>"),i.join("")},pinkoi.friends.contact_modal=function(){function t(){pinkoi.gmodal.content.find("#n-friends-contacts-wrapper").click(function(e){var t=e.target.tagName.toLowerCase();if(t!="td"&&t!="input")return;var n=$(e.target).closest("tr"),r=n.find("[type=checkbox]:eq(0)");if(r.length===0)return;n.toggleClass("selected"),n.hasClass("selected")?r.attr("checked",""):r.removeAttr("checked")}),pinkoi.gmodal.content.find(".submit").click(function(e){var t=$(e.target);if(t.data("disabled"))return;nicks=[],emails=[],$("#n-friends-contacts-table .selected").each(function(){var e=$(this);nicks.push(e.find(".nick").html()),emails.push(e.find(".email").html())});if(!nicks.length||!emails.length){pinkoi.drawer.on(_("請選擇一個以上的好友"));return}var n={method:"email",nicks:nicks.join(","),emails:emails.join(",")};t.data("disabled",!0),pinkoi.request("POST",pinkoi.uri.invitation_send,{data:n,success:function(){t.data("disabled",!1),pinkoi.friends.message_modal.load(_("邀請函已送出"),"<p>"+_("已經透過 E-mail 寄出邀請函，朋友如果點擊邀請函中的連結註冊成功，你們兩個都可以獲得 250 點紅利喔！")+"</p>",{text:_("邀請更多朋友"),href:"/friends/find"})}})})}var e=['<div class="g_mod_contact">','<h2 class="title_">',_("送出邀請函"),'<p class="caption_">'+_("想邀請誰來 Pinkoi 呢？")+"</p>","</h2>",'<div id="n-friends-contacts-wrapper">%s</div>','<div class="footer_"><a class="m-button g_btns_send submit">'+_("送出")+"</a></div>","</div>"].join("");return{load:function(n){var r="(空)";n!==undefined&&(r=pinkoi.friends.renderContacts(n)),r=pinkoi.template(e,r),pinkoi.gmodal.load(r),t()},close:function(){pinkoi.gmodal.close()}}}(),pinkoi.friends.initFind=function(){function t(){$(".first.section").bind("click",function(t){if(t.target.tagName.toLowerCase()!="a")return;var n=$(t.target);if(n.data("disabled"))return;var r=n.attr("action");if(!r)return;n.data("disabled",!0);switch(r){case"slide":var i=n.attr("to");if(!i)return;e[i].slideto(),n.data("disabled",!1);break;case"sendFacebookInvitation":if(!pinkoi.isLogin())return;pinkoi.friends.invite({message:"想邀請誰來 Pinkoi 呢？",cb:function(e){if(!e){n.data("disabled",!1);return}pinkoi.request("POST",pinkoi.uri.invitation_send,{data:{method:"facebook",fbroid:e.request,fbids:e.to.join(",")},success:function(){pinkoi.friends.message_modal.load("邀請訊息已送出","<p>已經透過 Facebook 通知送出邀請訊息，Facebook 朋友如果點擊這個訊息註冊成功，你們兩個都可以獲得 250 點紅利喔！</p>",{text:"邀請更多朋友",href:"/friends/find"}),n.data("disabled",!1)}})}});case"fetchContacts":if(!pinkoi.isLogin())return;var s=n.attr("source");if(!s)return;var o=n.closest(".slide"),u=o.find("[type=text]").val(),a=o.find("[type=password]").val();n.data("disabled",!0),pinkoi.request("POST",pinkoi.uri.user_findcontacts,{data:{source:s,email:u,password:a},success:function(e){e.status=="ok"&&(e.contacts?pinkoi.friends.contact_modal.load(e.contacts):pinkoi.drawer.on("哎呀！你的好友名單似乎是空的，或者你輸錯帳號或密碼了呢？")),n.data("disabled",!1)}})}}),$("#n-friends-inviting-table").bind("click",function(e){function o(e){if(!e){t.data("disabled",!1);return}pinkoi.request("GET",pinkoi.uri.invitation_remind+"?checksum="+i,{success:function(){pinkoi.drawer.on("已再次將邀請送出囉！"),t.fadeOut(),t.data("disabled",!1)}})}if(e.target.tagName.toLowerCase()!="a")return;var t=$(e.target);if(t.data("disabled"))return;var n=t.attr("action");if(n!="remind")return;var r=t.attr("method"),i=t.attr("checksum");if(!r||!i)return;var s=t.attr("to");if(r=="facebook"&&!s)return;t.data("disabled",!0);switch(r){case"facebook":pinkoi.friends.invite({message:"再發一次邀請訊息給他",to:s,cb:o});break;case"email":o(!0)}})}var e=function(){var e={active:"facebook"},t=$("#triangle"),n=[8.5,61,113.5],r=$("#slide-container"),i=["facebook","gmail","msn"];for(var s=0,o=i.length;s<o;s++)e[i[s]]={slideJQ:$("."+i[s]+".slide"),iconJQ:$("."+i[s]+".icon")},e[i[s]].slideto=function(){var o=n[s],u=i[s],a=e[i[s]],f=s;return function(){var n=e[e.active];n.iconJQ.removeClass("now"),n.slideJQ.removeClass("now"),a.slideJQ.addClass("now"),a.iconJQ.addClass("now"),t.animate({top:o}),r.animate({top:-f*230}),e.active=u}}();return e}();t()},pinkoi.friends.initInvitation=function(){if(pinkoi.urlParam.all.checksum||pinkoi.urlParam.all.inviter)$(document).ready(function(){require(["mapp/pages/login","ui/modal","i18n"],function(e,t,n){modal=t,e.loginModal(t,pinkoi.login_modal.next,n.gettext("接受邀請拿 250 點紅利購物金，再送你 500 點當見面禮。"))})});else if(pinkoi.urlParam.all.error)switch(pinkoi.urlParam.all.error){case"not_found":pinkoi.friends.message_modal.load("找不到邀請函","<p>我們找不到這封邀請函，是不是邀請函連結複製錯了呢？</p>");break;case"inviter_not_found":pinkoi.friends.message_modal.load("找不到邀請你的朋友","<p>我們找不到邀請你的朋友，是不是邀請連結複製錯了呢？</p>");break;case"was_accepted":pinkoi.friends.message_modal.load("邀請函已被接受","<p>這封邀請函已經被人接受囉，一封邀請函僅能使用一次。</p>");break;case"has_registered":pinkoi.friends.message_modal.load("很開心在 Pinkoi 認識你，記得邀請更多朋友加入，快速累積紅利！",'<p>想邀請朋友加入嗎？轉貼你的<a href="/friends/find">個人專屬連結</a>，快速累積紅利！你也可以用 <a href="/friends/find">找朋友工具</a> 找到站上好友，一起在 Pinkoi 開心購買設計商品。</p>',{text:"邀請朋友拿 250 紅利購物金",href:"/friends/find"},{text:"繼續逛設計",href:"/"});break;default:document.location.href="/"}else if(pinkoi.globals.get("uid")&&pinkoi.urlParam.all.earn_reward){var e=parseInt(pinkoi.urlParam.all.earn_reward);isNaN(e)&&(document.location.href="/"),pinkoi.friends.message_modal.load("使用邀請函註冊成功","<p>你成功地使用邀請函註冊了！你和你的朋友都獲得了紅利 "+e+' 點囉，想買設計時別忘了使用它。<br><br><a target="_blank" href="/page/reward">如何使用紅利？</a></p>',{text:"邀請朋友拿 250 紅利購物金",href:"/friends/find"},{text:"繼續逛設計",href:"/"})}};pinkoi.namespace("pinkoi.magz"),pinkoi.magz.create=function(e,t){function y(e){if(e&&e.length){var t="";for(var n=0,r=e.length;n<r;n++){var i=e[n];l.push(i.tid),t+=pinkoi.template(g,{tid:i.tid,title:i.title})}a.append(t).show(),s.find(".related .select_sec").hide(),s.find(".related .holder").show()}}function b(e){var t=e.attr("tid");e.remove(),l.del(t),!l.length&&!f.length&&(s.find(".related .select_sec").show(),s.find(".related .holder").hide())}function E(e){if(e&&e.length){var t="";for(var n=0,r=e.length;n<r;n++){var i=e[n];f.push(i.tid),t+=pinkoi.template(w,{tid:i.tid,title:i.title})}u.append(t).show(),s.find(".related .select_sec").hide(),s.find(".related .holder").show()}}function S(e){var t=e.attr("tid");e.remove(),f.del(t),!l.length&&!f.length&&(s.find(".related .select_sec").show(),s.find(".related .holder").hide())}function x(e){e&&x.queue.push(e);if(x.isInit)while(x.queue.length)tinyMCE.execInstanceCommand("description","mceInsertContent",!1,x.queue.shift())}e=e||{};var n=e.items,r=e.favs,i=$("#magz_n"),s=$("#magz_n form"),o=!1,u=i.find("#related_item"),a=i.find("#related_window"),f=[],l=[],c=s3Ids_after=couchdbIds_new=null,h=function(e){if(o)return;var t=$.trim(tinymce.activeEditor.getContent());if(!t){e&&(pinkoi.drawer.on(_("文章還沒有內容哦")),N.seekto(1));return}var n={};n.description=t,n.title=$.trim(s.find(":input[name=title]").val()),n.category=s.find(":input[name=category]").val(),n.rel=s.find(":input[name=rel]").val(),n.tags=s.find(":input[name=tags]").val(),n.store=s.find(":input[name=store]").val(),n.relatedItems=[],u.find("a").each(function(){var e=$(this);e.attr("tid")&&e.attr("tid")!="undefined"&&n.relatedItems.push({tid:e.attr("tid"),title:e.html()})}),n.relatedWindows=[],a.find("a").each(function(){var e=$(this);e.attr("tid")&&e.attr("tid")!="undefined"&&n.relatedWindows.push({tid:e.attr("tid"),title:e.html()})}),e?pinkoi.request("POST",pinkoi.uri.magz_draft,{data:{draft:JSON.stringify(n)},success:function(e){e.status=="ok"?pinkoi.drawer.on(_("已儲存")):pinkoi.error()}}):pinkoi.request("POST",pinkoi.uri.magz_draft,{data:{draft:JSON.stringify(n)}},null,!1)},p=/src=.?([^"'\s>]+)/i,d=function(e){var t=[];if(e){var n=e.match(/<img[^>]+>/ig);if(n)for(var r=0,i=n.length;r<i;r++){var s=n[r];try{var o=s.match(p)[1];t.push(o)}catch(u){}}}return t},v=function(e){var t=[],n=new RegExp(pinkoi.conf.s3MagzHost+"/[^/]+/(.+?)\\.jpg$","i");for(var r=0,i=e.length;r<i;r++)try{var s=e[r],o=s.match(n)[1];t.push(o)}catch(u){}return t},m=function(e){var t=[],n=new RegExp(".*?/magzimg/[^/]+/([^/]+)","i");for(var r=0,i=e.length;r<i;r++)try{var s=e[r],o=s.match(n)[1];t.push(o)}catch(u){}return t};s.bind("click",function(e){if(o)return;var n=$(e.target);if(n.hasClass("dosth")){var r=n.attr("sth");if(r=="us")s.find(":input[name=rel]").val("us"),N.seekTo(1);else if(r=="import"){if(!s.find(":input[name=title]").hasClass("m_defaultval_changed"))return pinkoi.drawer.on(_("✘ 別忘了幫你的文章下個標題")),pinkoi.focused(s.find(":input[name=title]")),!1;pinkoi.gmodal.load('<div class="l-magz-new"><div class="form_"><h3 class="title_">'+_("請輸入文章的網址")+"</h3>"+'<input type="text" name="source" default_val="true" value="例如：http://www.small.idv.tw/blog/designexpo-2010-and-pinkoi" />'+"</div>"+'<a class="m-button dosth" sth="submit">'+_("確定")+"</a>"+"</div>"),pinkoi.forms.defaultVal(pinkoi.gmodal.content.find(".l-magz-new")).bind("click",function(e){var t=$(e.target);if(t.hasClass("dosth")){var n=$.trim(pinkoi.gmodal.content.find(".l-magz-new :input[name=source]").val());pinkoi.forms.validate("url",n)?(pinkoi.drawer.on(_("載入文章中.......")),pinkoi.gmodal.close(),pinkoi.request("GET",pinkoi.uri.magz_getByUrl,{data:{url:n},success:function(e){e.status=="ok"?(s.find(":input[name=rel]").val("import"),s.find(":input[name=source]").val(n),tinymce.activeEditor.setContent(e.result),N.seekTo(1)):pinkoi.error()}})):pinkoi.drawer.on(_("你輸入的網址不太正確哦"))}})}else if(r=="submit"||r=="preview"){var i=s.find(":input[name=rel]").val(),u=$.trim(s.find(":input[name=title]").val()),a=$.trim(tinymce.activeEditor.getContent()),p=s.find(":input[name=category]").val();if(!u){pinkoi.drawer.on(_("✘ 別忘了幫你的文章下個標題")),N.seekTo(0),pinkoi.focused(s.find(":input[name=title]"));return}var g="",w="";if(!a){pinkoi.drawer.on(_("✘ 文章還沒有內容哦")),N.seekTo(1);return}try{g=a.match(/<img[^>]*?src=["'\s]?([^"'\s>]+)/i)[1]}catch(x){if(!a.match(/player\.vimeo\.com/i)){pinkoi.drawer.on(_("✘ 你的文章內容必需要有圖片哦")),N.seekTo(1);return}}i=="import"&&(w=s.find(":input[name=source]").val());if(r=="submit")var T=confirm(_("確定要送出了嗎？"));else var T=!0;if(T){var C=$.trim(s.find(":input[name=tags]").val()),k=$.trim(s.find(":input[name=store]").val()),L={title:u,category:p,rel:i};$("#clear_img").prop("checked")&&(L.clear_img=1),L.published=$("#set_published").prop("checked")?1:0,g&&(g=g.replace("..",pinkoi.conf.imageHost),L.photo=g),w&&(L.source=w),a&&(L.description=a),C&&(L.tags=C),k&&(L.store=k),f.length&&(L.relatedItems=f.join(",")),l.length&&(L.relatedWindows=l.join(","));var A=d(L.description);if(t&&t.tid){L.method="update",L.tid=t.tid,s3Ids_after=v(A);var O=[];for(var M=0,D=c.length;M<D;M++)$.inArray(c[M],s3Ids_after)==-1&&O.push(c[M]);L.img_delete=O.join(",");var P=pinkoi.uri.magz_update}else var P=pinkoi.uri.magz_n;couchdbIds_new=m(A),L.img_add=couchdbIds_new.join(",");if(r=="preview"){var H=$("#preview_form");H.length||(H=$('<form id="preview_form" method="post" action="/magz/preview" target="_blank" style="position:absolute;left:-9999px;top:0;"><input type="hidden" name="rel"/><input type="hidden" name="source"/><input type="hidden" name="description"/><input type="hidden" name="relatedItems"/><input type="hidden" name="relatedWindows"/><input type="hidden" name="owner"/><input type="hidden" name="category"/><input type="hidden" name="title"/></form>'),$(document.body).append(H));for(var B in L)L.hasOwnProperty(B)&&H.find(":input[name="+B+"]").val(L[B]);H.submit();return}pinkoi.fulldrop.on(),pinkoi.request("POST",P,{data:L,success:function(e){o=!0,pinkoi.fulldrop.off();if(e.status=="ok")if(!e.result)pinkoi.gmodal.load('<div style="font-size:14px;margin-bottom:15px;">'+_("你的文章已經成功送出，當審核通過後你的文章將會出現在設計誌中！這可能需要兩分鐘～兩天的時間。")+'</div><a class="m-button gpointer" onclick="pinkoi.gmodal.close();">'+_("確定")+"</a>"),pinkoi.gmodal.onetimeOnBeforeClose=function(){window.location.href="/magz"};else{var t=pinkoi.conf.magzUrl(e.result,!0);pinkoi.gmodal.onetimeOnBeforeClose=function(){window.location.href=t},pinkoi.gmodal.load('<div class="g_pubfb_or_skip">                                        <h3 class="title_">'+_("你的文章已經成功發表")+'</h3>                                        <table cellspacing="10"><tbody><tr>                                            <td><a class="fbpub">'+_("分享給 Facebook 好友")+"<br/>"+_("前往你剛發表的文章")+'</a></td>                                            <td><a href="'+t+'">'+_("看你剛發表的文章")+"</a></td>                                        </tr></tbody></table>                                    </div>"),pinkoi.gmodal.content.find(".g_pubfb_or_skip .fbpub").bind("click",function(e){try{require(["external/facebook"],function(e){pinkoi.drawer.on(_("分享到 Facebook 中...")),e.publish({message:_("Pinkoi 設計誌 - ")+u,name:u,caption:_("{*actor*} 剛發表了一篇文章 @ Pinkoi"),description:a.replace("<[^>]+>","").substr(0,256),link:t,picture:g,actions:[{name:_("來逛逛我的 Pinkoi"),link:pinkoi.conf.profileURL(pinkoi.globals.get("uid"),!0)}],auto:!0,cb:function(e){window.location.href=t}})})}catch(n){window.location.href=t}})}else o=!1,e.errMsg?pinkoi.error(e.errMsg):pinkoi.error()}})}}else if(r=="relatedWindow")pinkoi.gmodal.load('<div class="l_magz_new">                    <h3 class="title_">'+_("請輸入櫥窗的網址")+'</h3>                    <div class="box_ fillbg_"><input type="text" name="windowurl" default_val="true" value="'+_("例如：")+'http://www.pinkoi.com/window/1AR-Ou7P"/></div>                    <div class="footer"><a class="m-button dosth" sth="submit">'+_("確定")+'</a>　<a href="/window/new" target="_blank">'+_("建立新櫥窗")+"</a></div>                </div>"),pinkoi.forms.defaultVal(pinkoi.gmodal.content.find(".l_magz_new")).bind("click",function(e){var t=$(e.target);if(t.hasClass("dosth")){var n=t.attr("sth");if(n=="submit"){var r=$(this).find(":input[name=windowurl]").val();try{var i=r.match(/\/window\/([^\/?#]+)/i)[1];if($.inArray(i,l)!=-1){pinkoi.drawer.on(_("✘ 這個櫥窗已經被挑選過囉"));return}}catch(s){pinkoi.drawer.on(_("✘ 無效的網址，請檢查網址是否正確"));return}pinkoi.request("get",pinkoi.uri.window_get,{data:{tid:i,fields:"tid,title"},success:function(e){if(e.status=="ok")try{var t=e.result[0];y([{tid:t.tid,title:t.title}]),pinkoi.gmodal.close()}catch(n){pinkoi.drawer.on(_("✘ 無效的網址，請檢查網址是否正確"));return}else pinkoi.error(),pinkoi.debug("ajax error at pinkoi.uri.window_get")}})}}});else if(r=="removeWindow")b(n);else if(r=="removeItem")S(n);else if(r=="relatedItem"){var j=pinkoi.globals.get("isSeller")?'　<a class="dosth" sth="fromstore">'+_("從你的設計館挑選")+"</a>":"";pinkoi.gmodal.load('<div class="l_magz_new">                    <h3 class="title_">'+_("請輸入商品的網址")+'<div class="caption_">'+_("你可以用空白隔開多個網址")+'</div></h3>                    <div class="fillbg_"><input type="text" name="itemurl" default_val="true" value="'+_("例如：")+'http://www.pinkoi.com/product/1qFdi7AH"/></div>                    <div class="footer_"><a class="m-button dosth" sth="submit">'+_("確定")+'</a>　<a class="dosth" sth="fromfav">'+_("從慾望清單挑選")+"</a>"+j+"</div>                </div>"),pinkoi.forms.defaultVal(pinkoi.gmodal.content).find(".l_magz_new").bind("click",function(e){var t=$(e.target);if(t.hasClass("dosth")){var n=t.attr("sth");if(n=="submit"){var r=$(this).find(":input[name=itemurl]").val();try{var i=r.match(/\/product\/([^\/?#\s]+)/ig);if(!i)throw"";var s=[],o;for(var u=0,a=i.length;u<a;u++){o=i[u].match(/\/product\/([^\/?#\s]+)/i)[1];if($.inArray(o,f)!=-1)continue;s.push(o)}if(s.length==0)throw"";s=s.join(",")}catch(l){pinkoi.drawer.on(_("✘ 無效的網址，請檢查網址是否正確"));return}pinkoi.request("get",pinkoi.uri.item_get,{data:{tid:s,fields:"tid,title"},success:function(e){if(e.status=="ok"){if(!e.result||!e.result.length){pinkoi.drawer.on(_("✘ 無效的網址，請檢查網址是否正確"));return}E(e.result),pinkoi.gmodal.close()}else pinkoi.error(),pinkoi.debug("ajax error at pinkoi.uri.item_get")}})}else n=="fromfav"?pinkoi.itemSelector(function(e){if(e){e=e.split(",");var t=[],n=pinkoi.globals.get("itemSelector_dict_myfavs");for(var r=0,i=e.length;r<i;r++)t.push({tid:e[r],title:n[e[r]].title});E(t)}},{multiple:1,type:"myfavs",skipTids:f}):n=="fromstore"&&pinkoi.itemSelector(function(e){if(e){e=e.split(",");var t=[],n=pinkoi.globals.get("itemSelector_dict_myitems");for(var r=0,i=e.length;r<i;r++)t.push({tid:e[r],title:n[e[r]].title});E(t)}},{multiple:1,type:"myitems",skipTids:f})}})}else r=="draft"&&h(!0)}});var g='<a class="g_remove_btn dosth" sth="removeWindow" tid="%(tid)s">%(title)s</a>',w='<a class="g_remove_btn dosth" sth="removeItem" tid="%(tid)s">%(title)s</a>';pinkoi.magz.create.insertHtml2Editor=x,x.queue=[],x.isInit=!1,tinymce.init({selector:"#description",language:"zh_TW",convert_urls:!1,height:400,plugins:"textcolor colorpicker code link image media table fullscreen",toolbar:["removeformat | fontselect | fontsizeselect | forecolor backcolor | alignleft aligncenter alignright alignjustify","undo redo | styleselect | bold italic underline | link unlink | image media | numlist bullist outdent indent | blockquote "],setup:function(e){e.on("init",function(){if(t){var e=s.find(".page");e.eq(0).find(":input[name=category]").val(t.category),e.eq(0).find(":input[name=title]").val(pinkoi.util.unescape(t.title)).addClass("m_defaultval_changed"),s.find(":input[name=rel]").val(t.rel),tinymce.activeEditor.setContent(t.description),t.rel!="us"&&t.rel=="import"&&e.eq(0).find(":input[name=source]").val(t.source),t.tags&&e.eq(2).find(":input[name=tags]").val(pinkoi.util.unescape(t.tags)),t.store&&e.eq(2).find(":input[name=store]").val(pinkoi.util.unescape(t.store));if(t.relatedItems||t.relatedWindows)E(t.relatedItems),y(t.relatedWindows);if(t.tid){i.find("#main").prepend('<div class="g_note_pink" style="margin-bottom:10px;"><b>'+_("狀態")+"</b>"+_("編輯模式")+" / "+(t.published?_("已發布"):_("未發布"))+"</div>"),e.eq(0).find(".select_sec").remove();if(t.relatedItems||t.relatedWindows)e.eq(2).find(".related .select_sec").remove(),e.eq(2).find(".related .holder").show();e.eq(2).find("#set_published").prop("checked",t.published>0),e.eq(2).find("[sth=submit]").html(_("更新")),s.find(".footer [sth=draft]").remove(),c=v(d(t.description))}else N.seekTo(1),pinkoi.drawer.on(_("這是你先前儲存的草稿"))}})}});var T=$("#magz_n").scrollable({size:1,clickable:!1,keyboard:!1}),N=T.scrollable();pinkoi.magz.create.scrollapi=N;var C=$("#magz_n #status a"),k=C.parent().offset().top-5;N.onSeek(function(e,t){t==1&&x()}),N.onBeforeSeek(function(e,t){s.find(":input[name=rel]").val()=="import"?s.find("[sth=preview],[sth=draft]").hide():s.find("[sth=preview],[sth=draft]").show();if(t>=1){if(!s.find(":input[name=title]").hasClass("m_defaultval_changed"))return pinkoi.drawer.on(_("✘ 別忘了幫你的文章下個標題")),N.seekTo(0),pinkoi.focused(s.find(":input[name=title]")),!1;if(!s.find(":input[name=rel]").val())return pinkoi.drawer.on(_("✘ 請選擇你想「發表自己的文章」或「轉貼別人的文章」")),N.seekTo(0),!1}t==1&&s.find(":input[name=rel]").val()=="us"?$("#sider").show():$("#sider").hide(),C.removeClass("active").eq(t).addClass("active"),$("html,body").animate({scrollTop:k},600)}),C.bind("click",function(e){var t=parseInt($(e.target).attr("seekto"));N.seekTo(t)}),pinkoi.forms.defaultVal("#magz_n"),pinkoi.forms.textLimit("#magz_n .title");if(t){var L=s.find(".page");L.eq(0).find(":input[name=category]").val(t.category),L.eq(0).find(":input[name=title]").val(pinkoi.util.unescape(t.title)).addClass("m_defaultval_changed"),s.find(":input[name=rel]").val(t.rel),x(t.description),t.rel!="us"&&t.rel=="import"&&L.eq(0).find(":input[name=source]").val(t.source),t.tags&&L.eq(2).find(":input[name=tags]").val(pinkoi.util.unescape(t.tags)),t.store&&L.eq(2).find(":input[name=store]").val(pinkoi.util.unescape(t.store));if(t.relatedItems||t.relatedWindows)E(t.relatedItems),y(t.relatedWindows)}(!t||!t.tid)&&pinkoi.onbeforeunload(function(){var e=s.find(":input[name=rel]").val();if(e=="us"){var t=$.trim(tinymce.activeEditor.getContent());t&&(h(),tinymce.activeEditor.setContent(""))}})},pinkoi.namespace("pinkoi.magz.list"),pinkoi.magz.list.read=function(e){location.href=pinkoi.conf.magzUrl($(e).attr("tid"))},pinkoi.magz.bindFav=function(e){if(e instanceof jQuery)var t=e;else var t=$(e);t.bind("click",function(e){var t=$(e.target);if(t.hasClass("fav"))if(!pinkoi.globals.get("uid"))pinkoi.login_modal.load();else if(!t.data("submitting")){var n={};n.tid=t.attr("tid"),t.hasClass("faved")&&(n.method="remove"),t.data("submitting",!0),pinkoi.request("post",pinkoi.uri.magz_fav,{data:n,success:function(e){e.status=="ok"?n.method?t.removeClass("faved"):(t.addClass("faved"),pinkoi.drawer.on(_("♥ 你已收藏這篇文章"))):pinkoi.error(),t.data("submitting",!1)}})}})},pinkoi.magz.home=function(){var e=$("#magz_home #pop .ul"),t=e.find(".li").length,n=10;$("#magz_home #pop .g_prevnext_s a").bind("click",function(r){var i=$(r.target);if(i.hasClass("p")){var s=t-n;s<0&&(s=0),e.find(".li").slice(s,t).prependTo(e)}else e.find(".li").slice(0,n).appendTo(e)}),pinkoi.magz.subscribe()},pinkoi.magz.subscribe=function(){$("#feedburner-form").bind("submit",function(e){var t=$.trim($(this).find(".email").val());return pinkoi.forms.validate("email",t)?(pinkoi.request("POST_MUTE","/api/misc/subscribe",{data:{email:t}}),window.open("http://feedburner.google.com/fb/a/mailverify?uri=pinkoi-magazine","popupwindow","scrollbars=yes,width=550,height=520"),!0):(e.preventDefault(),e.stopImmediatePropagation(),pinkoi.drawer.on(_("Email 不太對耶")),!1)})},function(e){function t(t,n,r){var i=this;i.id=r,i.options=n,i.status={animated:!1,rendered:!1,disabled:!1,focused:!1},i.elements={target:t.addClass(i.options.style.classes.target),tooltip:null,wrapper:null,content:null,contentWrapper:null,title:null,button:null,tip:null,bgiframe:null},i.cache={mouse:{},position:{},toggle:0},i.timers={},e.extend(i,i.options.api,{show:function(t){function s(){i.options.position.type!=="static"&&i.focus(),i.onShow.call(i,t),e.browser.msie&&i.elements.tooltip.get(0).style.removeAttribute("filter")}var n,r;if(!i.status.rendered)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"show");if(i.elements.tooltip.css("display")!=="none")return i;i.elements.tooltip.stop(!0,!1),n=i.beforeShow.call(i,t);if(n===!1)return i;i.cache.toggle=1,i.options.position.type!=="static"&&i.updatePosition(t,i.options.show.effect.length>0),typeof i.options.show.solo=="object"?r=e(i.options.show.solo):i.options.show.solo===!0&&(r=e("div.qtip").not(i.elements.tooltip)),r&&r.each(function(){e(this).qtip("api").status.rendered===!0&&e(this).qtip("api").hide()});if(typeof i.options.show.effect.type=="function")i.options.show.effect.type.call(i.elements.tooltip,i.options.show.effect.length),i.elements.tooltip.queue(function(){s(),e(this).dequeue()});else{switch(i.options.show.effect.type.toLowerCase()){case"fade":i.elements.tooltip.fadeIn(i.options.show.effect.length,s);break;case"slide":i.elements.tooltip.slideDown(i.options.show.effect.length,function(){s(),i.options.position.type!=="static"&&i.updatePosition(t,!0)});break;case"grow":i.elements.tooltip.show(i.options.show.effect.length,s);break;default:i.elements.tooltip.show(null,s)}i.elements.tooltip.addClass(i.options.style.classes.active)}return e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_SHOWN,"show")},hide:function(t){function r(){i.onHide.call(i,t)}var n;if(!i.status.rendered)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"hide");if(i.elements.tooltip.css("display")==="none")return i;clearTimeout(i.timers.show),i.elements.tooltip.stop(!0,!1),n=i.beforeHide.call(i,t);if(n===!1)return i;i.cache.toggle=0;if(typeof i.options.hide.effect.type=="function")i.options.hide.effect.type.call(i.elements.tooltip,i.options.hide.effect.length),i.elements.tooltip.queue(function(){r(),e(this).dequeue()});else{switch(i.options.hide.effect.type.toLowerCase()){case"fade":i.elements.tooltip.fadeOut(i.options.hide.effect.length,r);break;case"slide":i.elements.tooltip.slideUp(i.options.hide.effect.length,r);break;case"grow":i.elements.tooltip.hide(i.options.hide.effect.length,r);break;default:i.elements.tooltip.hide(null,r)}i.elements.tooltip.removeClass(i.options.style.classes.active)}return e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_HIDDEN,"hide")},updatePosition:function(t,n){var r,s,o,u,a,f,l,h,p,d,v,m,y,b;if(!i.status.rendered)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"updatePosition");if(i.options.position.type=="static")return e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.CANNOT_POSITION_STATIC,"updatePosition");s={position:{left:0,top:0},dimensions:{height:0,width:0},corner:i.options.position.corner.target},o={position:i.getPosition(),dimensions:i.getDimensions(),corner:i.options.position.corner.tooltip};if(i.options.position.target!=="mouse"){if(i.options.position.target.get(0).nodeName.toLowerCase()=="area"){u=i.options.position.target.attr("coords").split(",");for(r=0;r<u.length;r++)u[r]=parseInt(u[r]);a=i.options.position.target.parent("map").attr("name"),f=e('img[usemap="#'+a+'"]:first').offset(),s.position={left:Math.floor(f.left+u[0]),top:Math.floor(f.top+u[1])};switch(i.options.position.target.attr("shape").toLowerCase()){case"rect":s.dimensions={width:Math.ceil(Math.abs(u[2]-u[0])),height:Math.ceil(Math.abs(u[3]-u[1]))};break;case"circle":s.dimensions={width:u[2]+1,height:u[2]+1};break;case"poly":s.dimensions={width:u[0],height:u[1]};for(r=0;r<u.length;r++)r%2==0?(u[r]>s.dimensions.width&&(s.dimensions.width=u[r]),u[r]<u[0]&&(s.position.left=Math.floor(f.left+u[r]))):(u[r]>s.dimensions.height&&(s.dimensions.height=u[r]),u[r]<u[1]&&(s.position.top=Math.floor(f.top+u[r])));s.dimensions.width=s.dimensions.width-(s.position.left-f.left),s.dimensions.height=s.dimensions.height-(s.position.top-f.top);break;default:return e.fn.qtip.log.error.call(i,4,e.fn.qtip.constants.INVALID_AREA_SHAPE,"updatePosition")}s.dimensions.width-=2,s.dimensions.height-=2}else i.options.position.target.add(document.body).length===1?(s.position={left:e(document).scrollLeft(),top:e(document).scrollTop()},s.dimensions={height:e(window).height(),width:e(window).width()}):(typeof i.options.position.target.attr("qtip")!="undefined"?s.position=i.options.position.target.qtip("api").cache.position:s.position=i.options.position.target.offset(),s.dimensions={height:i.options.position.target.outerHeight(),width:i.options.position.target.outerWidth()});l=e.extend({},s.position),s.corner.search(/right/i)!==-1&&(l.left+=s.dimensions.width),s.corner.search(/bottom/i)!==-1&&(l.top+=s.dimensions.height),s.corner.search(/((top|bottom)Middle)|center/)!==-1&&(l.left+=s.dimensions.width/2),s.corner.search(/((left|right)Middle)|center/)!==-1&&(l.top+=s.dimensions.height/2)}else s.position=l={left:i.cache.mouse.x,top:i.cache.mouse.y},s.dimensions={height:1,width:1};o.corner.search(/right/i)!==-1&&(l.left-=o.dimensions.width),o.corner.search(/bottom/i)!==-1&&(l.top-=o.dimensions.height),o.corner.search(/((top|bottom)Middle)|center/)!==-1&&(l.left-=o.dimensions.width/2),o.corner.search(/((left|right)Middle)|center/)!==-1&&(l.top-=o.dimensions.height/2),h=e.browser.msie?1:0,p=e.browser.msie&&parseInt(e.browser.version.charAt(0))===6?1:0,i.options.style.border.radius>0&&(o.corner.search(/Left/)!==-1?l.left-=i.options.style.border.radius:o.corner.search(/Right/)!==-1&&(l.left+=i.options.style.border.radius),o.corner.search(/Top/)!==-1?l.top-=i.options.style.border.radius:o.corner.search(/Bottom/)!==-1&&(l.top+=i.options.style.border.radius)),h&&(o.corner.search(/top/)!==-1?l.top-=h:o.corner.search(/bottom/)!==-1&&(l.top+=h),o.corner.search(/left/)!==-1?l.left-=h:o.corner.search(/right/)!==-1&&(l.left+=h),o.corner.search(/leftMiddle|rightMiddle/)!==-1&&(l.top-=1)),i.options.position.adjust.screen===!0&&(l=c.call(i,l,s,o)),i.options.position.target==="mouse"&&i.options.position.adjust.mouse===!0&&(i.options.position.adjust.screen===!0&&i.elements.tip?v=i.elements.tip.attr("rel"):v=i.options.position.corner.tooltip,l.left+=v.search(/right/i)!==-1?-6:6,l.top+=v.search(/bottom/i)!==-1?-6:6),!i.elements.bgiframe&&e.browser.msie&&parseInt(e.browser.version.charAt(0))==6&&e("select, object").each(function(){m=e(this).offset(),m.bottom=m.top+e(this).height(),m.right=m.left+e(this).width(),l.top+o.dimensions.height>=m.top&&l.left+o.dimensions.width>=m.left&&g.call(i)}),l.left+=i.options.position.adjust.x,l.top+=i.options.position.adjust.y,y=i.getPosition();if(l.left!=y.left||l.top!=y.top){b=i.beforePositionUpdate.call(i,t);if(b===!1)return i;i.cache.position=l,n===!0?(i.status.animated=!0,i.elements.tooltip.animate(l,200,"swing",function(){i.status.animated=!1})):i.elements.tooltip.css(l),i.onPositionUpdate.call(i,t),typeof t!="undefined"&&t.type&&t.type!=="mousemove"&&e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_POSITION_UPDATED,"updatePosition")}return i},updateWidth:function(t){var n;return i.status.rendered?t&&typeof t!="number"?e.fn.qtip.log.error.call(i,2,"newWidth must be of type number","updateWidth"):(n=i.elements.contentWrapper.siblings().add(i.elements.tip).add(i.elements.button),t||(typeof i.options.style.width.value=="number"?t=i.options.style.width.value:(i.elements.tooltip.css({width:"auto"}),n.hide(),e.browser.msie&&i.elements.wrapper.add(i.elements.contentWrapper.children()).css({zoom:"normal"}),t=i.getDimensions().width+1,i.options.style.width.value||(t>i.options.style.width.max&&(t=i.options.style.width.max),t<i.options.style.width.min&&(t=i.options.style.width.min)))),t%2!==0&&(t-=1),i.elements.tooltip.width(t),n.show(),i.options.style.border.radius&&i.elements.tooltip.find(".qtip-betweenCorners").each(function(n){e(this).width(t-i.options.style.border.radius*2)}),e.browser.msie&&(i.elements.wrapper.add(i.elements.contentWrapper.children()).css({zoom:"1"}),i.elements.wrapper.width(t),i.elements.bgiframe&&i.elements.bgiframe.width(t).height(i.getDimensions.height)),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_WIDTH_UPDATED,"updateWidth")):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"updateWidth")},updateStyle:function(t){var n,r,o,a,f;return i.status.rendered?typeof t!="string"||!e.fn.qtip.styles[t]?e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.STYLE_NOT_DEFINED,"updateStyle"):(i.options.style=d.call(i,e.fn.qtip.styles[t],i.options.user.style),i.elements.content.css(h(i.options.style)),i.options.content.title.text!==!1&&i.elements.title.css(h(i.options.style.title,!0)),i.elements.contentWrapper.css({borderColor:i.options.style.border.color}),i.options.style.tip.corner!==!1&&(e("<canvas>").get(0).getContext?(n=i.elements.tooltip.find(".qtip-tip canvas:first"),o=n.get(0).getContext("2d"),o.clearRect(0,0,300,300),a=n.parent("div[rel]:first").attr("rel"),f=v(a,i.options.style.tip.size.width,i.options.style.tip.size.height),u.call(i,n,f,i.options.style.tip.color||i.options.style.border.color)):e.browser.msie&&(n=i.elements.tooltip.find('.qtip-tip [nodeName="shape"]'),n.attr("fillcolor",i.options.style.tip.color||i.options.style.border.color))),i.options.style.border.radius>0&&(i.elements.tooltip.find(".qtip-betweenCorners").css({backgroundColor:i.options.style.border.color}),e("<canvas>").get(0).getContext?(r=m(i.options.style.border.radius),i.elements.tooltip.find(".qtip-wrapper canvas").each(function(){o=e(this).get(0).getContext("2d"),o.clearRect(0,0,300,300),a=e(this).parent("div[rel]:first").attr("rel"),s.call(i,e(this),r[a],i.options.style.border.radius,i.options.style.border.color)})):e.browser.msie&&i.elements.tooltip.find('.qtip-wrapper [nodeName="arc"]').each(function(){e(this).attr("fillcolor",i.options.style.border.color)})),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_STYLE_UPDATED,"updateStyle")):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"updateStyle")},updateContent:function(t,n){function u(){i.updateWidth(),n!==!1&&(i.options.position.type!=="static"&&i.updatePosition(i.elements.tooltip.is(":visible"),!0),i.options.style.tip.corner!==!1&&a.call(i))}var r,s,o;if(!i.status.rendered)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"updateContent");if(!t)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.NO_CONTENT_PROVIDED,"updateContent");r=i.beforeContentUpdate.call(i,t);if(typeof r=="string")t=r;else if(r===!1)return;return e.browser.msie&&i.elements.contentWrapper.children().css({zoom:"normal"}),t.jquery&&t.length>0?t.clone(!0).appendTo(i.elements.content).show():i.elements.content.html(t),s=i.elements.content.find("img[complete=false]"),s.length>0?(o=0,s.each(function(t){e('<img src="'+e(this).attr("src")+'" />').load(function(){++o==s.length&&u()})})):u(),i.onContentUpdate.call(i),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_CONTENT_UPDATED,"loadContent")},loadContent:function(t,n,r){function o(t){i.onContentLoad.call(i),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_CONTENT_LOADED,"loadContent"),i.updateContent(t)}var s;return i.status.rendered?(s=i.beforeContentLoad.call(i),s===!1?i:(r=="post"?e.post(t,n,o):e.get(t,n,o),i)):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"loadContent")},updateTitle:function(t){return i.status.rendered?t?(returned=i.beforeTitleUpdate.call(i),returned===!1?i:(i.elements.button&&(i.elements.button=i.elements.button.clone(!0)),i.elements.title.html(t),i.elements.button&&i.elements.title.prepend(i.elements.button),i.onTitleUpdate.call(i),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_TITLE_UPDATED,"updateTitle"))):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.NO_CONTENT_PROVIDED,"updateTitle"):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"updateTitle")},focus:function(t){var n,r,s,o;if(!i.status.rendered)return e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"focus");if(i.options.position.type=="static")return e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.CANNOT_FOCUS_STATIC,"focus");n=parseInt(i.elements.tooltip.css("z-index")),r=99e3+e("div.qtip[qtip]").length-1;if(!i.status.focused&&n!==r){o=i.beforeFocus.call(i,t);if(o===!1)return i;e("div.qtip[qtip]").not(i.elements.tooltip).each(function(){e(this).qtip("api").status.rendered===!0&&(s=parseInt(e(this).css("z-index")),typeof s=="number"&&s>-1&&e(this).css({zIndex:parseInt(e(this).css("z-index"))-1}),e(this).qtip("api").status.focused=!1)}),i.elements.tooltip.css({zIndex:r}),i.status.focused=!0,i.onFocus.call(i,t),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_FOCUSED,"focus")}return i},disable:function(t){return i.status.rendered?(t?i.status.disabled?e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.TOOLTIP_ALREADY_DISABLED,"disable"):(i.status.disabled=!0,e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_DISABLED,"disable")):i.status.disabled?(i.status.disabled=!1,e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_ENABLED,"disable")):e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.TOOLTIP_ALREADY_ENABLED,"disable"),i):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"disable")},destroy:function(){var t,n,r;n=i.beforeDestroy.call(i);if(n===!1)return i;i.status.rendered?(i.options.show.when.target.unbind("mousemove.qtip",i.updatePosition),i.options.show.when.target.unbind("mouseout.qtip",i.hide),i.options.show.when.target.unbind(i.options.show.when.event+".qtip"),i.options.hide.when.target.unbind(i.options.hide.when.event+".qtip"),i.elements.tooltip.unbind(i.options.hide.when.event+".qtip"),i.elements.tooltip.unbind("mouseover.qtip",i.focus),i.elements.tooltip.remove()):i.options.show.when.target.unbind(i.options.show.when.event+".qtip-create");if(typeof i.elements.target.data("qtip")=="object"){r=i.elements.target.data("qtip").interfaces;if(typeof r=="object"&&r.length>0)for(t=0;t<r.length-1;t++)r[t].id==i.id&&r.splice(t,1)}return delete e.fn.qtip.interfaces[i.id],typeof r=="object"&&r.length>0?i.elements.target.data("qtip").current=r.length-1:i.elements.target.removeData("qtip"),i.onDestroy.call(i),e.fn.qtip.log.error.call(i,1,e.fn.qtip.constants.EVENT_DESTROYED,"destroy"),i.elements.target},getPosition:function(){var t,n;return i.status.rendered?(t=i.elements.tooltip.css("display")!=="none"?!1:!0,t&&i.elements.tooltip.css({visiblity:"hidden"}).show(),n=i.elements.tooltip.offset(),t&&i.elements.tooltip.css({visiblity:"visible"}).hide(),n):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"getPosition")},getDimensions:function(){var t,n;return i.status.rendered?(t=i.elements.tooltip.is(":visible")?!1:!0,t&&i.elements.tooltip.css({visiblity:"hidden"}).show(),n={height:i.elements.tooltip.outerHeight(),width:i.elements.tooltip.outerWidth()},t&&i.elements.tooltip.css({visiblity:"visible"}).hide(),n):e.fn.qtip.log.error.call(i,2,e.fn.qtip.constants.TOOLTIP_NOT_RENDERED,"getDimensions")}})}function n(){var t,n,i,s,u,a,c;t=this,t.beforeRender.call(t),t.status.rendered=!0,t.elements.tooltip='<div qtip="'+t.id+'" class="qtip '+(t.options.style.classes.tooltip||t.options.style)+'"style="display:none; -moz-border-radius:0; -webkit-border-radius:0; border-radius:0;position:'+t.options.position.type+';">  <div class="qtip-wrapper" style="position:relative; overflow:hidden; text-align:left;">    <div class="qtip-contentWrapper" style="overflow:hidden;">       <div class="qtip-content '+t.options.style.classes.content+'"></div></div></div></div>',t.elements.tooltip=e(t.elements.tooltip),t.elements.tooltip.appendTo(t.options.position.container),t.elements.tooltip.data("qtip",{current:0,interfaces:[t]}),t.elements.wrapper=t.elements.tooltip.children("div:first"),t.elements.contentWrapper=t.elements.wrapper.children("div:first").css({background:t.options.style.background}),t.elements.content=t.elements.contentWrapper.children("div:first").css(h(t.options.style)),e.browser.msie&&t.elements.wrapper.add(t.elements.content).css({zoom:1}),t.options.hide.when.event=="unfocus"&&t.elements.tooltip.attr("unfocus",!0),typeof t.options.style.width.value=="number"&&t.updateWidth(),e("<canvas>").get(0).getContext||e.browser.msie?(t.options.style.border.radius>0?r.call(t):t.elements.contentWrapper.css({border:t.options.style.border.width+"px solid "+t.options.style.border.color}),t.options.style.tip.corner!==!1&&o.call(t)):(t.elements.contentWrapper.css({border:t.options.style.border.width+"px solid "+t.options.style.border.color}),t.options.style.border.radius=0,t.options.style.tip.corner=!1,e.fn.qtip.log.error.call(t,2,e.fn.qtip.constants.CANVAS_VML_NOT_SUPPORTED,"render")),typeof t.options.content.text=="string"&&
t.options.content.text.length>0||t.options.content.text.jquery&&t.options.content.text.length>0?i=t.options.content.text:typeof t.elements.target.attr("title")=="string"&&t.elements.target.attr("title").length>0?(i=t.elements.target.attr("title").replace("\\n","<br />"),t.elements.target.attr("title","")):typeof t.elements.target.attr("alt")=="string"&&t.elements.target.attr("alt").length>0?(i=t.elements.target.attr("alt").replace("\\n","<br />"),t.elements.target.attr("alt","")):(i=" ",e.fn.qtip.log.error.call(t,1,e.fn.qtip.constants.NO_VALID_CONTENT,"render")),t.options.content.title.text!==!1&&f.call(t),t.updateContent(i),l.call(t),t.options.show.ready===!0&&t.show(),t.options.content.url!==!1&&(s=t.options.content.url,u=t.options.content.data,a=t.options.content.method||"get",t.loadContent(s,u,a)),t.onRender.call(t),e.fn.qtip.log.error.call(t,1,e.fn.qtip.constants.EVENT_RENDERED,"render")}function r(){var t,n,r,i,o,u,a,f,l,c,h,p,d,v,g;t=this,t.elements.wrapper.find(".qtip-borderBottom, .qtip-borderTop").remove(),r=t.options.style.border.width,i=t.options.style.border.radius,o=t.options.style.border.color||t.options.style.tip.color,u=m(i),a={};for(n in u)a[n]='<div rel="'+n+'" style="'+(n.search(/Left/)!==-1?"left":"right")+":0; position:absolute; height:"+i+"px; width:"+i+'px; overflow:hidden; line-height:0.1px; font-size:1px">',e("<canvas>").get(0).getContext?a[n]+='<canvas height="'+i+'" width="'+i+'" style="vertical-align: top"></canvas>':e.browser.msie&&(f=i*2+3,a[n]+='<v:arc stroked="false" fillcolor="'+o+'" startangle="'+u[n][0]+'" endangle="'+u[n][1]+'" style="width:'+f+"px; height:"+f+"px; margin-top:"+(n.search(/bottom/)!==-1?-2:-1)+"px; margin-left:"+(n.search(/Right/)!==-1?u[n][2]-3.5:-1)+'px; vertical-align:top; display:inline-block; behavior:url(#default#VML)"></v:arc>'),a[n]+="</div>";l=t.getDimensions().width-Math.max(r,i)*2,c='<div class="qtip-betweenCorners" style="height:'+i+"px; width:"+l+"px; overflow:hidden; background-color:"+o+'; line-height:0.1px; font-size:1px;">',h='<div class="qtip-borderTop" dir="ltr" style="height:'+i+"px; margin-left:"+i+'px; line-height:0.1px; font-size:1px; padding:0;">'+a.topLeft+a.topRight+c,t.elements.wrapper.prepend(h),p='<div class="qtip-borderBottom" dir="ltr" style="height:'+i+"px; margin-left:"+i+'px; line-height:0.1px; font-size:1px; padding:0;">'+a.bottomLeft+a.bottomRight+c,t.elements.wrapper.append(p),e("<canvas>").get(0).getContext?t.elements.wrapper.find("canvas").each(function(){d=u[e(this).parent("[rel]:first").attr("rel")],s.call(t,e(this),d,i,o)}):e.browser.msie&&t.elements.tooltip.append('<v:image style="behavior:url(#default#VML);"></v:image>'),v=Math.max(i,i+(r-i)),g=Math.max(r-i,0),t.elements.contentWrapper.css({border:"0px solid "+o,borderWidth:g+"px "+v+"px"})}function s(e,t,n,r){var i=e.get(0).getContext("2d");i.fillStyle=r,i.beginPath(),i.arc(t[0],t[1],n,0,Math.PI*2,!1),i.fill()}function o(t){var n,r,i,s,o;n=this,n.elements.tip!==null&&n.elements.tip.remove(),r=n.options.style.tip.color||n.options.style.border.color;if(n.options.style.tip.corner===!1)return;t||(t=n.options.style.tip.corner),i=v(t,n.options.style.tip.size.width,n.options.style.tip.size.height),n.elements.tip='<div class="'+n.options.style.classes.tip+'" dir="ltr" rel="'+t+'" style="position:absolute; height:'+n.options.style.tip.size.height+"px; width:"+n.options.style.tip.size.width+'px; margin:0 auto; line-height:0.1px; font-size:1px;">',e("<canvas>").get(0).getContext?n.elements.tip+='<canvas height="'+n.options.style.tip.size.height+'" width="'+n.options.style.tip.size.width+'"></canvas>':e.browser.msie&&(s=n.options.style.tip.size.width+","+n.options.style.tip.size.height,o="m"+i[0][0]+","+i[0][1],o+=" l"+i[1][0]+","+i[1][1],o+=" "+i[2][0]+","+i[2][1],o+=" xe",n.elements.tip+='<v:shape fillcolor="'+r+'" stroked="false" filled="true" path="'+o+'" coordsize="'+s+'" style="width:'+n.options.style.tip.size.width+"px; height:"+n.options.style.tip.size.height+"px; line-height:0.1px; display:inline-block; behavior:url(#default#VML); vertical-align:"+(t.search(/top/)!==-1?"bottom":"top")+'"></v:shape>',n.elements.tip+='<v:image style="behavior:url(#default#VML);"></v:image>',n.elements.contentWrapper.css("position","relative")),n.elements.tooltip.prepend(n.elements.tip+"</div>"),n.elements.tip=n.elements.tooltip.find("."+n.options.style.classes.tip).eq(0),e("<canvas>").get(0).getContext&&u.call(n,n.elements.tip.find("canvas:first"),i,r),t.search(/top/)!==-1&&e.browser.msie&&parseInt(e.browser.version.charAt(0))===6&&n.elements.tip.css({marginTop:-4}),a.call(n,t)}function u(e,t,n){var r=e.get(0).getContext("2d");r.fillStyle=n,r.beginPath(),r.moveTo(t[0][0],t[0][1]),r.lineTo(t[1][0],t[1][1]),r.lineTo(t[2][0],t[2][1]),r.fill()}function a(t){var n,r,i,s,o;n=this;if(n.options.style.tip.corner===!1||!n.elements.tip)return;t||(t=n.elements.tip.attr("rel")),r=positionAdjust=e.browser.msie?1:0,n.elements.tip.css(t.match(/left|right|top|bottom/)[0],0),t.search(/top|bottom/)!==-1?(e.browser.msie&&(parseInt(e.browser.version.charAt(0))===6?positionAdjust=t.search(/top/)!==-1?-3:1:positionAdjust=t.search(/top/)!==-1?1:2),t.search(/Middle/)!==-1?n.elements.tip.css({left:"50%",marginLeft:-(n.options.style.tip.size.width/2)}):t.search(/Left/)!==-1?n.elements.tip.css({left:n.options.style.border.radius-r}):t.search(/Right/)!==-1&&n.elements.tip.css({right:n.options.style.border.radius+r}),t.search(/top/)!==-1?n.elements.tip.css({top:-positionAdjust}):n.elements.tip.css({bottom:positionAdjust})):t.search(/left|right/)!==-1&&(e.browser.msie&&(positionAdjust=parseInt(e.browser.version.charAt(0))===6?1:t.search(/left/)!==-1?1:2),t.search(/Middle/)!==-1?n.elements.tip.css({top:"50%",marginTop:-(n.options.style.tip.size.height/2)}):t.search(/Top/)!==-1?n.elements.tip.css({top:n.options.style.border.radius-r}):t.search(/Bottom/)!==-1&&n.elements.tip.css({bottom:n.options.style.border.radius+r}),t.search(/left/)!==-1?n.elements.tip.css({left:-positionAdjust}):n.elements.tip.css({right:positionAdjust})),i="padding-"+t.match(/left|right|top|bottom/)[0],s=n.options.style.tip.size[i.search(/left|right/)!==-1?"width":"height"],n.elements.tooltip.css("padding",0),n.elements.tooltip.css(i,s),e.browser.msie&&parseInt(e.browser.version.charAt(0))==6&&(o=parseInt(n.elements.tip.css("margin-top"))||0,o+=parseInt(n.elements.content.css("margin-top"))||0,n.elements.tip.css({marginTop:o}))}function f(){var t=this;t.elements.title!==null&&t.elements.title.remove(),t.elements.title=e('<div class="'+t.options.style.classes.title+'">').css(h(t.options.style.title,!0)).css({zoom:e.browser.msie?1:0}).prependTo(t.elements.contentWrapper),t.options.content.title.text&&t.updateTitle.call(t,t.options.content.title.text),t.options.content.title.button!==!1&&typeof t.options.content.title.button=="string"&&(t.elements.button=e('<a class="'+t.options.style.classes.button+'" style="float:right; position: relative"></a>').css(h(t.options.style.button,!0)).html(t.options.content.title.button).prependTo(t.elements.title).click(function(e){t.status.disabled||t.hide(e)}))}function l(){function o(n){if(t.status.disabled===!0)return;t.options.hide.when.event=="inactive"&&(e(i).each(function(){r.bind(this+".qtip-inactive",s),t.elements.content.bind(this+".qtip-inactive",s)}),s()),clearTimeout(t.timers.show),clearTimeout(t.timers.hide),t.timers.show=setTimeout(function(){t.show(n)},t.options.show.delay)}function u(n){if(t.status.disabled===!0)return;if(t.options.hide.fixed===!0&&t.options.hide.when.event.search(/mouse(out|leave)/i)!==-1&&e(n.relatedTarget).parents("div.qtip[qtip]").length>0)return n.stopPropagation(),n.preventDefault(),clearTimeout(t.timers.hide),!1;clearTimeout(t.timers.show),clearTimeout(t.timers.hide),t.elements.tooltip.stop(!0,!0),t.timers.hide=setTimeout(function(){t.hide(n)},t.options.hide.delay)}var t,n,r,i;t=this,n=t.options.show.when.target,r=t.options.hide.when.target,t.options.hide.fixed&&(r=r.add(t.elements.tooltip));if(t.options.hide.when.event=="inactive"){i=["click","dblclick","mousedown","mouseup","mousemove","mouseout","mouseenter","mouseleave","mouseover"];function s(n){if(t.status.disabled===!0)return;clearTimeout(t.timers.inactive),t.timers.inactive=setTimeout(function(){e(i).each(function(){r.unbind(this+".qtip-inactive"),t.elements.content.unbind(this+".qtip-inactive")}),t.hide(n)},t.options.hide.delay)}}else t.options.hide.fixed===!0&&t.elements.tooltip.bind("mouseover.qtip",function(){if(t.status.disabled===!0)return;clearTimeout(t.timers.hide)});t.options.show.when.target.add(t.options.hide.when.target).length===1&&t.options.show.when.event==t.options.hide.when.event&&t.options.hide.when.event!=="inactive"||t.options.hide.when.event=="unfocus"?(t.cache.toggle=0,n.bind(t.options.show.when.event+".qtip",function(e){t.cache.toggle==0?o(e):u(e)})):(n.bind(t.options.show.when.event+".qtip",o),t.options.hide.when.event!=="inactive"&&r.bind(t.options.hide.when.event+".qtip",u)),t.options.position.type.search(/(fixed|absolute)/)!==-1&&t.elements.tooltip.bind("mouseover.qtip",t.focus),t.options.position.target==="mouse"&&t.options.position.type!=="static"&&n.bind("mousemove.qtip",function(e){t.cache.mouse={x:e.pageX,y:e.pageY},t.status.disabled===!1&&t.options.position.adjust.mouse===!0&&t.options.position.type!=="static"&&t.elements.tooltip.css("display")!=="none"&&t.updatePosition(e)})}function c(t,n,r){var i,s,u,a,f,l;return i=this,r.corner=="center"?n.position:(s=e.extend({},t),a={x:!1,y:!1},f={left:s.left<e.fn.qtip.cache.screen.scroll.left,right:s.left+r.dimensions.width+2>=e.fn.qtip.cache.screen.width+e.fn.qtip.cache.screen.scroll.left,top:s.top<e.fn.qtip.cache.screen.scroll.top,bottom:s.top+r.dimensions.height+2>=e.fn.qtip.cache.screen.height+e.fn.qtip.cache.screen.scroll.top},u={left:f.left&&(r.corner.search(/right/i)!=-1||r.corner.search(/right/i)==-1&&!f.right),right:f.right&&(r.corner.search(/left/i)!=-1||r.corner.search(/left/i)==-1&&!f.left),top:f.top&&r.corner.search(/top/i)==-1,bottom:f.bottom&&r.corner.search(/bottom/i)==-1},u.left?(i.options.position.target!=="mouse"?s.left=n.position.left+n.dimensions.width:s.left=i.cache.mouse.x,a.x="Left"):u.right&&(i.options.position.target!=="mouse"?s.left=n.position.left-r.dimensions.width:s.left=i.cache.mouse.x-r.dimensions.width,a.x="Right"),u.top?(i.options.position.target!=="mouse"?s.top=n.position.top+n.dimensions.height:s.top=i.cache.mouse.y,a.y="top"):u.bottom&&(i.options.position.target!=="mouse"?s.top=n.position.top-r.dimensions.height:s.top=i.cache.mouse.y-r.dimensions.height,a.y="bottom"),s.left<0&&(s.left=t.left,a.x=!1),s.top<0&&(s.top=t.top,a.y=!1),i.options.style.tip.corner!==!1&&(s.corner=new String(r.corner),a.x!==!1&&(s.corner=s.corner.replace(/Left|Right|Middle/,a.x)),a.y!==!1&&(s.corner=s.corner.replace(/top|bottom/,a.y)),s.corner!==i.elements.tip.attr("rel")&&o.call(i,s.corner)),s)}function h(t,n){var r,i;r=e.extend(!0,{},t);for(i in r)n===!0&&i.search(/(tip|classes)/i)!==-1?delete r[i]:!n&&i.search(/(width|border|tip|title|classes|user)/i)!==-1&&delete r[i];return r}function p(e){return typeof e.tip!="object"&&(e.tip={corner:e.tip}),typeof e.tip.size!="object"&&(e.tip.size={width:e.tip.size,height:e.tip.size}),typeof e.border!="object"&&(e.border={width:e.border}),typeof e.width!="object"&&(e.width={value:e.width}),typeof e.width.max=="string"&&(e.width.max=parseInt(e.width.max.replace(/([0-9]+)/i,"$1"))),typeof e.width.min=="string"&&(e.width.min=parseInt(e.width.min.replace(/([0-9]+)/i,"$1"))),typeof e.tip.size.x=="number"&&(e.tip.size.width=e.tip.size.x,delete e.tip.size.x),typeof e.tip.size.y=="number"&&(e.tip.size.height=e.tip.size.y,delete e.tip.size.y),e}function d(){var t,n,r,i,s,o;t=this,r=[!0,{}];for(n=0;n<arguments.length;n++)r.push(arguments[n]);i=[e.extend.apply(e,r)];while(typeof i[0].name=="string")i.unshift(p(e.fn.qtip.styles[i[0].name]));return i.unshift(!0,{classes:{tooltip:"qtip-"+(arguments[0].name||"defaults")}},e.fn.qtip.styles.defaults),s=e.extend.apply(e,i),o=e.browser.msie?1:0,s.tip.size.width+=o,s.tip.size.height+=o,s.tip.size.width%2>0&&(s.tip.size.width+=1),s.tip.size.height%2>0&&(s.tip.size.height+=1),s.tip.corner===!0&&(s.tip.corner=t.options.position.corner.tooltip==="center"?!1:t.options.position.corner.tooltip),s}function v(e,t,n){var r={bottomRight:[[0,0],[t,n],[t,0]],bottomLeft:[[0,0],[t,0],[0,n]],topRight:[[0,n],[t,0],[t,n]],topLeft:[[0,0],[0,n],[t,n]],topMiddle:[[0,n],[t/2,0],[t,n]],bottomMiddle:[[0,0],[t,0],[t/2,n]],rightMiddle:[[0,0],[t,n/2],[0,n]],leftMiddle:[[t,0],[t,n],[0,n/2]]};return r.leftTop=r.bottomRight,r.rightTop=r.bottomLeft,r.leftBottom=r.topRight,r.rightBottom=r.topLeft,r[e]}function m(t){var n;return e("<canvas>").get(0).getContext?n={topLeft:[t,t],topRight:[0,t],bottomLeft:[t,0],bottomRight:[0,0]}:e.browser.msie&&(n={topLeft:[-90,90,0],topRight:[-90,90,-t],bottomLeft:[90,270,0],bottomRight:[90,270,-t]}),n}function g(){var e,t,n;e=this,n=e.getDimensions(),t='<iframe class="qtip-bgiframe" frameborder="0" tabindex="-1" src="javascript:false" style="display:block; position:absolute; z-index:-1; filter:alpha(opacity=\'0\'); border: 1px solid red; height:'+n.height+"px; width:"+n.width+'px" />',e.elements.bgiframe=e.elements.wrapper.prepend(t).children(".qtip-bgiframe:first")}e.fn.qtip=function(r,i){var s,o,u,a,f,l,c,h;if(typeof r=="string"){typeof e(this).data("qtip")!="object"&&e.fn.qtip.log.error.call(self,1,e.fn.qtip.constants.NO_TOOLTIP_PRESENT,!1);if(r=="api")return e(this).data("qtip").interfaces[e(this).data("qtip").current];if(r=="interfaces")return e(this).data("qtip").interfaces}else{r||(r={});if(typeof r.content!="object"||r.content.jquery&&r.content.length>0)r.content={text:r.content};typeof r.content.title!="object"&&(r.content.title={text:r.content.title}),typeof r.position!="object"&&(r.position={corner:r.position}),typeof r.position.corner!="object"&&(r.position.corner={target:r.position.corner,tooltip:r.position.corner}),typeof r.show!="object"&&(r.show={when:r.show}),typeof r.show.when!="object"&&(r.show.when={event:r.show.when}),typeof r.show.effect!="object"&&(r.show.effect={type:r.show.effect}),typeof r.hide!="object"&&(r.hide={when:r.hide}),typeof r.hide.when!="object"&&(r.hide.when={event:r.hide.when}),typeof r.hide.effect!="object"&&(r.hide.effect={type:r.hide.effect}),typeof r.style!="object"&&(r.style={name:r.style}),r.style=p(r.style),a=e.extend(!0,{},e.fn.qtip.defaults,r),a.style=d.call({options:a},a.style),a.user=e.extend(!0,{},r)}return e(this).each(function(){if(typeof r=="string"){l=r.toLowerCase(),u=e(this).qtip("interfaces");if(typeof u=="object")if(i===!0&&l=="destroy")while(u.length>0)u[u.length-1].destroy();else{i!==!0&&(u=[e(this).qtip("api")]);for(s=0;s<u.length;s++)l=="destroy"?u[s].destroy():u[s].status.rendered===!0&&(l=="show"?u[s].show():l=="hide"?u[s].hide():l=="focus"?u[s].focus():l=="disable"?u[s].disable(!0):l=="enable"&&u[s].disable(!1))}}else{c=e.extend(!0,{},a),c.hide.effect.length=a.hide.effect.length,c.show.effect.length=a.show.effect.length,c.position.container===!1&&(c.position.container=e(document.body)),c.position.target===!1&&(c.position.target=e(this)),c.show.when.target===!1&&(c.show.when.target=e(this)),c.hide.when.target===!1&&(c.hide.when.target=e(this)),o=e.fn.qtip.interfaces.length;for(s=0;s<o;s++)if(typeof e.fn.qtip.interfaces[s]=="undefined"){o=s;break}f=new t(e(this),c,o),e.fn.qtip.interfaces[o]=f,typeof e(this).data("qtip")=="object"?(typeof e(this).attr("qtip")=="undefined"&&(e(this).data("qtip").current=e(this).data("qtip").interfaces.length),e(this).data("qtip").interfaces.push(f)):e(this).data("qtip",{current:0,interfaces:[f]}),c.content.prerender===!1&&c.show.when.event!==!1&&c.show.ready!==!0?c.show.when.target.bind(c.show.when.event+".qtip-"+o+"-create",{qtip:o},function(t){h=e.fn.qtip.interfaces[t.data.qtip],h.options.show.when.target.unbind(h.options.show.when.event+".qtip-"+t.data.qtip+"-create"),h.cache.mouse={x:t.pageX,y:t.pageY},n.call(h),h.options.show.when.target.trigger(h.options.show.when.event)}):(f.cache.mouse={x:c.show.when.target.offset().left,y:c.show.when.target.offset().top},n.call(f))}})},e(document).ready(function(){e.fn.qtip.cache={screen:{scroll:{left:e(window).scrollLeft(),top:e(window).scrollTop()},width:e(window).width(),height:e(window).height()}};var t;e(window).bind("resize scroll",function(n){clearTimeout(t),t=setTimeout(function(){n.type==="scroll"?e.fn.qtip.cache.screen.scroll={left:e(window).scrollLeft(),top:e(window).scrollTop()}:(e.fn.qtip.cache.screen.width=e(window).width(),e.fn.qtip.cache.screen.height=e(window).height());for(i=0;i<e.fn.qtip.interfaces.length;i++){var t=e.fn.qtip.interfaces[i];t.status.rendered===!0&&(t.options.position.type!=="static"||t.options.position.adjust.scroll&&n.type==="scroll"||t.options.position.adjust.resize&&n.type==="resize")&&t.updatePosition(n,!0)}},100)}),e(document).bind("mousedown.qtip",function(t){e(t.target).parents("div.qtip").length===0&&e(".qtip[unfocus]").each(function(){var n=e(this).qtip("api");e(this).is(":visible")&&!n.status.disabled&&e(t.target).add(n.elements.target).length>1&&n.hide(t)})})}),e.fn.qtip.interfaces=[],e.fn.qtip.log={error:function(){return this}},e.fn.qtip.constants={},e.fn.qtip.defaults={content:{prerender:!1,text:!1,url:!1,data:null,title:{text:!1,button:!1}},position:{target:!1,corner:{target:"bottomRight",tooltip:"topLeft"},adjust:{x:0,y:0,mouse:!0,screen:!1,scroll:!0,resize:!0},type:"absolute",container:!1},show:{when:{target:!1,event:"mouseover"},effect:{type:"fade",length:100},delay:140,solo:!1,ready:!1},hide:{when:{target:!1,event:"mouseout"},effect:{type:"fade",length:100},delay:0,fixed:!1},api:{beforeRender:function(){},onRender:function(){},beforePositionUpdate:function(){},onPositionUpdate:function(){},beforeShow:function(){},onShow:function(){},beforeHide:function(){},onHide:function(){},beforeContentUpdate:function(){},onContentUpdate:function(){},beforeContentLoad:function(){},onContentLoad:function(){},beforeTitleUpdate:function(){},onTitleUpdate:function(){},beforeDestroy:function(){},onDestroy:function(){},beforeFocus:function(){},onFocus:function(){}}},e.fn.qtip.styles={defaults:{background:"white",color:"#111",overflow:"hidden",textAlign:"left",width:{min:0,max:250},padding:"5px 9px",border:{width:1,radius:0,color:"#d3d3d3"},tip:{corner:!1,color:!1,size:{width:13,height:13},opacity:1},title:{background:"#e1e1e1",fontWeight:"bold",padding:"7px 12px"},button:{cursor:"pointer"},classes:{target:"",tip:"qtip-tip",title:"qtip-title",button:"qtip-button",content:"qtip-content",active:"qtip-active"}},cream:{border:{width:3,radius:0,color:"#F9E98E"},title:{background:"#F0DE7D",color:"#A27D35"},background:"#FBF7AA",color:"#A27D35",classes:{tooltip:"qtip-cream"}},light:{border:{width:3,radius:0,color:"#E2E2E2"},title:{background:"#f1f1f1",color:"#454545"},background:"white",color:"#454545",classes:{tooltip:"qtip-light"}},dark:{border:{width:3,radius:0,color:"#303030"},title:{background:"#404040",color:"#f3f3f3"},background:"#505050",color:"#f3f3f3",classes:{tooltip:"qtip-dark"}},red:{border:{width:3,radius:0,color:"#CE6F6F"},title:{background:"#f28279",color:"#9C2F2F"},background:"#F79992",color:"#9C2F2F",classes:{tooltip:"qtip-red"}},green:{border:{width:3,radius:0,color:"#A9DB66"},title:{background:"#b9db8c",color:"#58792E"},background:"#CDE6AC",color:"#58792E",classes:{tooltip:"qtip-green"}},blue:{border:{width:3,radius:0,color:"#ADD9ED"},title:{background:"#D0E9F5",color:"#5E99BD"},background:"#E5F6FE",color:"#4D9FBF",classes:{tooltip:"qtip-blue"}}}}(jQuery),typeof pinkoi=="undefined"&&(pinkoi={}),function(e){require(["net/request","underscore","dom/form","ui/html5Upload"],function(t,n,r,i){e.message=function(){var n=e,r=function(){this.cache={}},s=r.prototype;s.init=function(t,n,r,i,s,o,u){this.wrapJQ=$("#"+t),this.me=n,this.user=s,this.on=o,this.total=u,this.page=parseInt(i,10),this.individual=e.urlParam.get("mid")?!0:!1,this.tabJQ=$('<div class="message_tab clr">                        <div id="msg" class="t"></div>                        </div>'),this.wrapJQ.append(this.tabJQ),this.box=this.wrapJQ.attr("id")=="sent"?"sent":"inbox";try{e.urlParam.get("mid")?this.box=n==r[0]["sender"]?"sent":"inbox":this.activate()}catch(a){}this.render(r),this.wrapJQ.on("click","[data-click]",function(t){var n=$(t.target),r=n.data("click");switch(r){case"translate":if(n.data("translated"))return;n.data("translated",!0),n.html(_("翻譯中..."));var i=n.closest(".row"),s=i.attr("id"),o=n.data("tolocale");_gaq.push(["_trackEvent","Message Translation",e.globals.get("uid"),s,!0]),$.ajax({type:"GET",url:"/apiv2/translation/message",data:{mid:s,to_locale:o}}).done(function(t){var r=t.result[0];n.html(_("已翻譯")).addClass("translated"),i.find(".message-title").html(r.title),i.find(".message-description").html(e.magicText.replace(r.description,{imgMaxW:560,italic:!1})),i.find(".message-reply-description").each(function(t){$(this).html(e.magicText.replace(r.reply[t].description,{imgMaxW:560,italic:!1}))})})}})};var o='<div class="head clr"><span class="total">'+e.template(_("共有 %s 信件"),"<b>%(cnt)s/%(total)s</b>")+' </span><span class="hint">From</span><div class="pagination">%(pagination)s</div></div>',u='<div class="head clr"><span class="total">'+e.template(_("共有 %s 信件"),"<b>%(cnt)s/%(total)s</b>")+' </span><span class="hint">To</span><div class="pagination">%(pagination)s</div></div>',a=' <input name="file" type="file" accept=".png,.jpg,.gif,.ai,.psd,.bmp,.eps,.cdr,.pdf">',f=['<div class="row clr %(read)s" id="%(mid)s">','<span class="%(replied)s"></span>','<div class="from">','<a href="%(whoProfileURL)s" class="avatar" target="_blank"><img src="%(avatar)s"/></a>','<a href="%(whoProfileURL)s" target="_blank">%(nick)s</a>',"</div>",'<div class="subject">','<div class="translation-pod" style="%(translationStyle)s">'+_("自動翻譯")+'<a class="translate" data-click="translate" data-tolocale="%(translateToLocale)s">%(translateToLocaleName)s</a>%(translateToEn)s</div>','<div class="line"><b class="message-title">%(title)s</b>%(linkback)s</div>','<div class="description magictext message-description">%(summary)s</div>','<div class="created">%(created)s</div>','<a class="delete" mid="%(mid)s" role="%(role)s">&times;</a>','<div class="hidable">','<div class="wrap">','<form method="POST" enctype="multipart/form-data" action="'+e.uri.message_send+'">','<textarea name="description" mid="%(mid)s" item="%(item)s" title="%(title)s" receiver="%(who)s"></textarea>','<div class="action clr">','<div class="file"> ',_("附加圖片或檔案"),Modernizr.ajaxfileupload?a:i.downloadTip,"</div>",'<a class="m-button-small submit" onclick="pinkoi.message.send(this);return false;">'+_("回覆訊息")+"</a>","</div>",'<input type="hidden" name="mid">','<input type="hidden" name="title">','<input type="hidden" name="item">','<input type="hidden" name="receiver">','<input type="hidden" name="contenttype" value="html">',"</form>",'<div class="permlink"><a class="cancel" onclick="pinkoi.message.closeRow($(this).parents(\'.row\'));return false;">'+_("關閉此訊息串")+"</a> "+_("永久連結")+'：<a href="/message/%(box)s?mid=%(mid)s" target="_blank">%(permlink)s</a></div>','<div class="notice">'+_("使用翻譯系統後，若仍無法完整了解訊息內容，<a onclick=\"javascript:require(['external/uservoice'], function(uservoice){uservoice.showLightbox()});\">請聯絡我們</a>。")+"</div>","</div>","</div>","</div>","</div>"].join(""),l=['<div class="reply clr">','<img class="avatar" src="%(avatar)s">','<div class="subject">','<p class="text magictext message-reply-description">%(description)s</p>','<div class="created">%(created)s</div>',"</div>","</div>"].join("");return s.parseReply=function(t){t=t.split("");var n=[];for(var r=0;r<t.length;++r)try{if(t.hasOwnProperty(r)){var i=t[r].split(""),s=e.conf.getAvatar(i[0],"50x50"),o=parseInt(i[1],10)*1e3,u=new Date(o),a=u.getMinutes();a/10<1&&(a="0"+a),o=u.toDateString()+" at "+u.getHours()+":"+a,n.push({uid:i[0],avatar:s,created:o,description:i[2]})}}catch(f){}return n},s.render=function(t){var n=this,r="",i="",s=0,a=0,l=this.box=="sent";for(var c=0;c<t.length;c++)try{if(t.hasOwnProperty(c)){var h=t[c];l&&(h.sender=h.receiver),h.read=h.read==0&&!l?"unread":"",h.who=h.receiver==h.viewer&&h.receiver==this.me||h.receiver==this.me?h.sender:h.receiver,h.nick=this.user[h.who].nick||h.who,h.avatar=e.conf.getAvatar(h.who,"50x50"),h.link="#",h.box=this.box,h.permlink=e.conf.host+"/message/"+this.box+"?mid="+h.mid,h.role=this.me==h.receiver?"receiver":"sender",h.order=h.oid?' <span style="font-size:10px;color:#808080;"> - '+_("訂單")+" "+h.oid+"</span>":"",h.item=h.target;if(h.reply){h.reply=this.parseReply(h.reply);var p=h.reply[h.reply.length-1];h.summary=p.description,p.uid==this.me&&(h.read=""),h.replied="replied"}else h.summary=h.description.substr(0,80),h.replied="noreply";var d=h.risky?_('<br><span style="color:#f00;">提醒您發信人不當使用系統資源，來源企圖可疑，目前已被站方停權，您將無法回覆此信件</span>'):"",v=null,m=null;h.oid?(v=_("回到訂單"),m=e.conf.orderURL(h.oid)):h.target?(v=_("回到商品頁"),m=e.conf.itemURL(h.target)):this.user[h.receiver].seller&&(v=_("回到設計館"),m=e.conf.storeURL(h.receiver)),h.linkback=m&&v?'<a style="margin-left:10px;font-size:10px;" href="'+m+'" target="_blank">'+v+"</a> "+d:"",h.whoProfileURL=e.conf.profileURL(h.who),h.translationStyle="display:none;",h.translateToLocale=h.translateToLocaleName=h.translateToEn="",(this.user[h.sender].locale!==this.user[h.receiver].locale||this.user[h.sender].geo!==this.user[h.receiver].geo)&&(h.replied==="replied"||e.globals.get("uid")!==h.sender)&&(h.translationStyle="",h.translateToLocale=e.globals.get("locale"),h.translateToLocaleName=e.globals.get("localeName"),e.globals.get("locale")!=="en"&&(h.translateToEn='<a class="translate" data-click="translate" data-tolocale="en">English</a>')),r+=e.template(f,h),s++,this.cache[h.mid]=h}}catch(g){alert("some reply cannot be shown, message id "+t[c].mid)}var y=l?u:o,b="/message/"+this.box,w={cnt:s,type:"msg",total:this.total,pagination:""};r&&!this.individual?this.page===1&&this.total>s?w.pagination=e.template('<a href="%(paginationURL)s?on=%(type)s&p=%(olderPage)s">'+_("較舊的信件")+" ›</a>",{paginationURL:b,olderPage:this.page+1,type:"msg"}):this.page===2?w.pagination=e.template('<a href="%(paginationURL)s?on=%(type)s&p=%(newerPage)s">‹ '+_("較新的信件")+'</a><a href="%(paginationURL)s?on=%(type)s&p=%(olderPage)s">'+_("較舊的信件")+" ›</a>",{paginationURL:b,olderPage:this.page+1,newerPage:this.page-1,type:"msg"}):this.page>2&&(w.pagination=e.template('<a href="%(paginationURL)s?on=%(type)s&p=%(newestPage)s">« '+_("最新")+'</a><a href="%(paginationURL)s?on=%(type)s&p=%(newerPage)s">‹ '+_("較新的信件")+'</a><a href="%(paginationURL)s?on=%(type)s&p=%(olderPage)s">'+_("較舊的信件")+" ›</a>",{paginationURL:b,olderPage:this.page+1,newerPage:this.page-1,newestPage:1,type:"msg"})):this.page===2?w.pagination=e.template('<a href="%(paginationURL)s?on=%(type)s&p=%(newerPage)s">‹ '+_("較新的信件")+"</a>",{paginationURL:b,newerPage:this.page-1,type:"msg"}):this.page>2&&(w.pagination=e.template('<a href="%(paginationURL)s?on=%(type)s&p=%(newestPage)s">« '+_("最新")+'</a><a href="%(paginationURL)s?on=%(type)s&p=%(newerPage)s">‹ '+_("較新的信件")+"</a>",{paginationURL:b,newerPage:this.page-1,newestPage:1,type:"msg"}));var E=e.template(y,w);r=r?r:'<center class="noresult">'+_("目前沒有任何訊息")+"</center>",this.tabJQ.find("#msg").append(E+r),$("#message .row").click(function(e){if(e.target.nodeName.toLowerCase()==="textarea"||e.target.className.indexOf("submit")!==-1||e.target.className.indexOf("delete")!==-1||e.target.className.indexOf("cancel")!==-1)return;n.toggleRow(this)}).mouseover(function(e){var t=$(this);t.hasClass("unread")||$(this).addClass("hover")}).mouseout(function(e){$(this).removeClass("hover")}),$("#message .row .delete").click(function(t){var n=$(t.target),r=n.attr("mid"),i=n.attr("role"),s=confirm(_("提醒你！刪除信件後，將無法再回復"));s&&e.request("POST",e.uri.message_delete,{data:{mid:r,role:i},success:function(t){t.result?n.parents(".row").fadeOut(1200,function(){n.remove()}):e.error(_("現在暫時無法刪除信件，請稍後在試！"))}})})},s.activate=function(e){var e=e||document.URL,t=e.substr(e.indexOf("/message")+"/message".length+1),n=t.split("/"),r=n[0]||"inbox",i=n[1]||"msg",s=$("#"+r+" #"+i);return s&&(s.addClass("active"),r=="sent"&&this.showSent(),$("#message #nav #"+r+"_"+i+"_nav").show().addClass("active")),!0},s.showSent=function(){$("#sent_msg_nav").show()},s.toggleSent=function(){$("#sent_msg_nav").toggle()},s.toggleRow=function(e){e=$(e),e.hasClass("active")||this._openRow(e)},s.closeRow=function(e){return e=$(e),e.hasClass("active")&&this._closeRow(e),!1},s._closeRow=function(e){var t=this.cache[e.attr("id")];e.removeClass("active"),e.find(".description").html(t.summary),e.find(".subject .hidable").hide()},s.openRow=function(e){e=$(e),e.hasClass("active")||this._openRow(e)},s._openRow=function(t){t.addClass("active");var n=this.cache[t.attr("id")];if(!n.append&&n.replied=="replied"){var r="";for(var i=0;i<n.reply.length;i++)n.reply.hasOwnProperty(i)&&(n.reply[i].profileURL=e.conf.profileURL(n.reply[i].uid),r+=e.template(l,n.reply[i]));t.find(".subject .wrap").before(r),n.append=!0}t.find(".description").html(n.description);var s=t.find(".subject .hidable");s.show();if(t.hasClass("unread")){t.removeClass("unread");var o=this.wrapJQ.attr("id")=="sent",u=e.globals.get("unreadMsg");o||(e.request("POST",e.uri.message_mark,{data:{mid:n.mid}}),e.globals.set("unreadMsg",u-1),u-1?$(".notice_unread").text(u-1):$(".notice_unread").remove())}e.magicText(t,{imgMaxW:560,italic:!1})},s.send=function(n){var r=this,i=$(n);if(i.data("submiting"))return;var s=i.closest("form"),o=i.parents(".row"),u=s.find("textarea"),a=u.attr("mid"),f=u.val(),c=u.attr("item"),h=u.attr("receiver"),p=u.attr("title");if(Modernizr.ajaxfileupload){var d=s.find('input[name="file"]').val();if(d&&!/^.+?(?:png|jpg|jpeg|gif|ai|psd|bmp|eps|cdr|pdf)/i.test(d)){e.drawer.on(e.template(_("只能上傳 %(img_ext)s 圖片檔 或 %(file_ext)s 設計檔 供你提供客製化需求跟設計師討論！"),{img_ext:["png","jpeg","gif","bmp"].join(", "),file_ext:["ai","psd","eps","cdr","pdf"].join(", ")})),s.find('input[name="file"]').val("");return}}f&&f.length>0?(s.find('input[name="mid"]').val(a),s.find('input[name="receiver"]').val(h),s.find('input[name="item"]').val(c),s.find('input[name="title"]').val(p),s.find('input[name="description"]').val(f),e.loader.on(),i.data("submiting",!0),t({type:"POST",url:"/apiv2/message/send",data:s}).done(function(t){e.loader.off(),i.data("submiting",!1);if(t.error){e.drawer.on(t.error.message),e.focused(o.find("textarea"));return}if(t.result){var n=t.result[0];n.description=e.util.escape(f),n.photo_url&&(n.description+="\n\n"+n.photo_url),n.profileURL=e.conf.profileURL(e.globals.uid);var u=e.template(l,n);o.find(".subject .wrap").before(u),e.magicText(o,{imgMaxW:560,italic:!1});var a=r.cache[o.attr("id")];a.summary=f,s.get(0).reset()}})):e.drawer.on(_("內容不能是空的哦"))},s.magictextMoadl=function(){e.gmodal.load([_("**粗體字** → 包含在兩對星號間的文字會變成租體字"),_("__底線字__ → 包含在兩對底線間的文字會自動畫底線"),_("*斜體字* → 包含在一對星號間的文字會變成斜體字"),_("--刪除線-- → 包含在一對--間的文字會自動加上刪除線"),_("http://example.com/picture.jpg → 貼上外站圖片的網址會自動轉成圖片，提醒你的外站圖片如果檔外連，將會使圖片無法正確顯示，建議使用 Flickr 相簿圖片連結"),_("http://pinkoi.com/product/1qXQ92Ck → 貼上 Pinkoi 的網址會自動轉成超連結"),_("http://www.youtube.com/watch?v=Glny4jSciVI → 貼上 YouTube 網址會自動轉成影片")].join('<div style="height:8px"></div>'))},new r}()})}(pinkoi);var pinkoi=typeof pinkoi=="undefined"?{}:pinkoi;pinkoi.gallery=function(){function n(e,t,n){var r=e.getElementsByTagName(t);for(var i=0,s=r.length,o=[];i<s;i++)r[i].className==n&&o.push(r[i]);return o.length==1&&(o=o[0]),o}function i(e,t,n){window.addEventListener?e.addEventListener(t,n,!1):window.attachEvent&&(r=e.attachEvent("on"+t,n))}function s(e,t){var n=!1;if(document.createElement("canvas").getContext){n=document.createElement("canvas"),n.width=t.width,n.height=t.height;var r=n.getContext("2d");r.translate(0,t.height),r.scale(1,-1),r.drawImage(t,0,0,t.width,t.height),n.style.opacity="0.25"}else n=document.createElement("img"),n.src=t.src,n.style.filter="flipv progid:DXImageTransform.Microsoft.Alpha(opacity=25, style=1, finishOpacity=0, startx=0, starty=0, finishx=0, finishy="+t.height*.25+")";return n.style.position="absolute",n.style.left="-4000px",e.appendChild(n),n}function o(e,t,r,i,s,o,u,a){this.diapos=[],this.scr=!1,this.size=i,this.zoom=s,this.horizon=r,this.bdw=o,this.oCont=e,this.oc=document.getElementById(e),this.text=n(this.oc,"div","text"),this.title=n(this.text,"div","title"),this.legend=n(this.text,"div","legend"),this.bar=n(this.oc,"img","bar"),this.arL=n(this.oc,"div","g_prev"),this.arR=n(this.oc,"div","g_next"),this.bw=this.bar.width,this.alw=this.arL.width-5,this.arw=this.arR.width-5,this.bar.parent=this.oc.parent=this,this.arL.parent=this.arR.parent=this,this.view=this.back=-1,this.time_start=u*62.5||0,this.time_inter=a*62.5||0,this.time_out=
this.time_start,this.time=0,this.time_dir=1,this.resize(),this.oc.onselectstart=function(){return!1},this.NF=t.length;for(var f=0;f<this.NF;f++){var l=t[f];this.diapos[f]=new Diapo(this,f,l.src,l.title,l.description,l.link,l.target||"_self",l.tid)}window.addEventListener&&this.oc.addEventListener("DOMMouseScroll",function(e){return e.preventDefault&&e.preventDefault(),this.parent.scroll(-e.detail),!1},!1),this.oc.onmousewheel=function(){return this.parent.scroll(event.wheelDelta),!1},this.arR.onclick=this.arR.ondblclick=function(){this.parent.view<this.parent.NF-1&&this.parent.calc(1)},this.arL.onclick=this.arL.ondblclick=function(){this.parent.view>0&&this.parent.calc(-1)}}var e=0,t=[];return o.prototype={calc:function(e){e&&(this.view+=e,this.time=0,this.time_out=this.time_start);var t=0,n=0,r=this.diapos[this.view];if(r&&r.loaded){var i=this.diapos[this.back];i&&i!=r&&(i.img.className="diapo",i.z1=1),this.title.innerHTML=r.title,r.url?(r.img.className="diapo link",window.status="hyperlink: "+r.url):(r.img.className="diapo",window.status=""),r.r<1?r.w1=Math.min(r.iw,this.wh*.8,Math.round(this.ht*this.horizon/r.r))*r.z1:r.w1=Math.round(this.ht*this.horizon/r.r)*r.z1;var s=r.x1=this.wh*.5-r.w1*.5,o=s+r.w1+this.bdw;for(var u=this.view+1,r;r=this.diapos[u];u++)r.loaded&&(r.x1=o,r.w1=this.ht/r.r*this.size,o+=r.w1+this.bdw,t+=r.w1+this.bdw);o=s-this.bdw;for(var u=this.view-1,r;r=this.diapos[u];u--)r.loaded&&(r.w1=this.ht/r.r*this.size,r.x1=o-r.w1,o-=r.w1+this.bdw,t+=r.w1+this.bdw,n+=r.w1+this.bdw);this.back=this.view}},scroll:function(e){e<0?this.view<this.NF-1&&this.calc(1):this.view>0&&this.calc(-1)},resize:function(){this.wh=this.oc.clientWidth,this.ht=this.oc.clientHeight,this.calc(),this.run(!0)},run:function(e){var t=this.NF;while(t--)this.diapos[t].move(e);if(this.time_out){this.time++;if(this.time>this.time_out){this.view+=this.time_dir;if(this.view>=this.NF||this.view<0)this.time_dir=-this.time_dir,this.view+=this.time_dir*2;this.calc(),this.time=0,this.time_out=this.time_inter}}}},Diapo=function(e,t,n,r,i,s,o,u){this.parent=e,this.loaded=!1,this.text=i+'<a href="/product/'+u+'"> ...</a>',this.title='<a href="/product/'+u+'">'+r+"</a>",this.url=s,this.target=o,this.N=t,this.img=document.createElement("img"),this.img.src=n,this.img.parent=this,this.img.className="diapo",this.x0=this.parent.oc.clientWidth,this.x1=this.x0,this.w0=0,this.w1=0,this.z1=1,this.z2=0,this.img.parent=this,this.img.onclick=function(){this.parent.click()},this.parent.oc.appendChild(this.img),s&&(this.img.onmouseover=function(){this.className="diapo link"},this.img.onmouseout=function(){this.className="diapo"})},Diapo.prototype={move:function(e){var t=this.parent;if(this.loaded){var n=this.x1-this.x0,r=this.w1-this.w0;if(Math.abs(n)>2||Math.abs(r)>2||e){this.x0+=n*.1,this.w0+=r*.1;var i=this.w0*this.r;this.z2=Math.ceil((t.ht*t.horizon+1-this.z2-i)*.5);if(this.x0<t.wh&&this.x0+this.w0>0){this.visible=!0;var s=this.img.style;s.left=Math.floor(this.x0)+"px",s.bottom=Math.floor(t.ht*(1-t.horizon)+this.z2)+"px",s.width=Math.floor(this.w0)+"px",s.height=Math.floor(i)+"px";if(this.flx){var s=this.flx.style;s.left=Math.floor(this.x0)+"px",s.top=Math.ceil(t.ht*t.horizon-this.z2)+"px",s.width=Math.floor(this.w0)+"px",s.height=Math.floor(i)+"px"}}else this.visible&&(this.visible=!1,this.img.style.width="0px",this.flx&&(this.flx.style.width="0px"))}}else this.img.complete&&this.img.width&&(this.iw=this.img.width,this.ih=this.img.height,this.r=this.ih/this.iw,this.loaded=!0,this.flx=null,t.view<0?t.view=this.N:this.N==0&&(t.view=this.N),t.calc())},click:function(){return this.parent.time=0,this.parent.time_out=this.parent.time_start,this.parent.view==this.N?this.url?window.open(this.url,this.target):(this.z1=this.z1==1?this.parent.zoom:1,this.parent.calc()):(this.parent.view=this.N,this.parent.calc()),!1}},{create:function(e,n,r,s,u,a,f,l){var c=$("<div></div>");c.css({backgroundColor:"#fff",height:$(document).height(),width:$(document).width(),left:0,top:0,position:"absolute",zIndex:7777}),$(document.body).append(c);var h=function(){var c=!1,h=t.length;while(h--)t[h].oCont==e&&(c=!0);c||(t.push(new o(e,n,r,s,u,a,f,l)),pinkoi.gallery.initialized||(pinkoi.gallery.initialized=!0,i(window,"resize",function(){var e=t.length;while(e--)t[e].resize()}),i(document.getElementById(e),"mouseout",function(e){e||(e=window.event);var n=e.relatedTarget||e.toElement;if(n&&n.tagName=="HTML"){var r=t.length;while(r--)t[r].oc.onmousemove=null}return!1}),setInterval(function(){var e=t.length;while(e--)t[e].run()},16)))};i(window,"load",function(){h()})}}}(),jQuery&&function(e){e.extend(e.fn,{uploadify:function(t){e(this).each(function(){var n=e.extend({id:e(this).attr("id"),uploader:"uploadify.swf",script:"uploadify.php",expressInstall:null,folder:"",height:30,width:120,cancelImg:"cancel.png",wmode:"opaque",scriptAccess:"sameDomain",fileDataName:"Filedata",method:"POST",queueSizeLimit:999,simUploadLimit:1,queueID:!1,displayData:"percentage",removeCompleted:!0,onInit:function(){},onSelect:function(){},onSelectOnce:function(){},onQueueFull:function(){},onCheck:function(){},onCancel:function(){},onClearQueue:function(){},onError:function(){},onProgress:function(){},onComplete:function(){},onAllComplete:function(){}},t);e(this).data("settings",n);var r=location.pathname;r=r.split("/"),r.pop(),r=r.join("/")+"/";var i={};i.uploadifyID=n.id,i.pagepath=r,n.buttonImg&&(i.buttonImg=escape(n.buttonImg)),n.buttonText&&(i.buttonText=escape(n.buttonText)),n.rollover&&(i.rollover=!0),i.script=n.script,i.folder=escape(n.folder);if(n.scriptData){var s="";for(var o in n.scriptData)s+="&"+o+"="+n.scriptData[o];i.scriptData=escape(s.substr(1))}i.width=n.width,i.height=n.height,i.wmode=n.wmode,i.method=n.method,i.queueSizeLimit=n.queueSizeLimit,i.simUploadLimit=n.simUploadLimit,n.hideButton&&(i.hideButton=!0),n.fileDesc&&(i.fileDesc=n.fileDesc),n.fileExt&&(i.fileExt=n.fileExt),n.multi&&(i.multi=!0),n.auto&&(i.auto=!0),n.sizeLimit&&(i.sizeLimit=n.sizeLimit),n.checkScript&&(i.checkScript=n.checkScript),n.fileDataName&&(i.fileDataName=n.fileDataName),n.queueID&&(i.queueID=n.queueID),n.onInit()!==!1&&(e(this).css("display","none"),e(this).after('<a class="m-button">'+_("選擇照片")+'</a><div id="'+e(this).attr("id")+'Uploader"></div>'),swfobject.embedSWF(n.uploader,n.id+"Uploader",n.width,n.height,"9.0.24",n.expressInstall,i,{quality:"high",wmode:n.wmode,allowScriptAccess:n.scriptAccess},{},function(e){typeof n.onSWFReady=="function"&&e.success&&n.onSWFReady()}),n.queueID==0?e("#"+e(this).attr("id")+"Uploader").after('<div id="'+e(this).attr("id")+'Queue" class="uploadifyQueue"></div>'):e("#"+n.queueID).addClass("uploadifyQueue")),typeof n.onOpen=="function"&&e(this).bind("uploadifyOpen",n.onOpen),e(this).bind("uploadifySelect",{action:n.onSelect,queueID:n.queueID},function(t,r,i){if(t.data.action(t,r,i)!==!1){var s=Math.round(i.size/1024*100)*.01,o="KB";s>1e3&&(s=Math.round(s*.001*100)*.01,o="MB");var u=s.toString().split(".");u.length>1?s=u[0]+"."+u[1].substr(0,2):s=u[0],i.name.length>20?fileName=i.name.substr(0,20)+"...":fileName=i.name,queue="#"+e(this).attr("id")+"Queue",t.data.queueID&&(queue="#"+t.data.queueID),e(queue).append('<div id="'+e(this).attr("id")+r+'" class="uploadifyQueueItem">								<div class="cancel">									<a href="javascript:jQuery(\'#'+e(this).attr("id")+"').uploadifyCancel('"+r+'\')"><img src="'+n.cancelImg+'" border="0" /></a>								</div>								<span class="fileName">'+fileName+" ("+s+o+')</span><span class="percentage"></span>								<div class="uploadifyProgress">									<div id="'+e(this).attr("id")+r+'ProgressBar" class="uploadifyProgressBar"><!--Progress Bar--></div>								</div>							</div>')}}),e(this).bind("uploadifySelectOnce",{action:n.onSelectOnce},function(t,r){t.data.action(t,r),n.auto&&(n.checkScript?e(this).uploadifyUpload(null,!1):e(this).uploadifyUpload(null,!0))}),e(this).bind("uploadifyQueueFull",{action:n.onQueueFull},function(e,t){e.data.action(e,t)!==!1&&alert("The queue is full.  The max size is "+t+".")}),e(this).bind("uploadifyCheckExist",{action:n.onCheck},function(t,n,i,s,o){var u=new Object;u=i,u.folder=s.substr(0,1)=="/"?s:r+s;if(o)for(var a in i)var f=a;e.post(n,u,function(n){for(var r in n)if(t.data.action(t,n,r)!==!1){var i=confirm("Do you want to replace the file "+n[r]+"?");i||document.getElementById(e(t.target).attr("id")+"Uploader").cancelFileUpload(r,!0,!0)}o?document.getElementById(e(t.target).attr("id")+"Uploader").startFileUpload(f,!0):document.getElementById(e(t.target).attr("id")+"Uploader").startFileUpload(null,!0)},"json")}),e(this).bind("uploadifyCancel",{action:n.onCancel},function(t,n,r,i,s,o){if(t.data.action(t,n,r,i,o)!==!1&&s){var u=o==1?0:250;e("#"+e(this).attr("id")+n).fadeOut(u,function(){e(this).remove()})}}),e(this).bind("uploadifyClearQueue",{action:n.onClearQueue},function(t,r){var i=n.queueID?n.queueID:e(this).attr("id")+"Queue";r&&e("#"+i).find(".uploadifyQueueItem").remove(),t.data.action(t,r)!==!1&&e("#"+i).find(".uploadifyQueueItem").each(function(){var t=e(".uploadifyQueueItem").index(this);e(this).delay(t*100).fadeOut(250,function(){e(this).remove()})})});var u=[];e(this).bind("uploadifyError",{action:n.onError},function(t,n,r,i){if(t.data.action(t,n,r,i)!==!1){var s=new Array(n,r,i);u.push(s),e("#"+e(this).attr("id")+n).find(".percentage").text(" - "+i.type+" Error"),e("#"+e(this).attr("id")+n).find(".uploadifyProgress").hide(),e("#"+e(this).attr("id")+n).addClass("uploadifyError")}}),typeof n.onUpload=="function"&&e(this).bind("uploadifyUpload",n.onUpload),e(this).bind("uploadifyProgress",{action:n.onProgress,toDisplay:n.displayData},function(t,n,r,i){t.data.action(t,n,r,i)!==!1&&(e("#"+e(this).attr("id")+n+"ProgressBar").animate({width:i.percentage+"%"},250,function(){i.percentage==100&&e(this).closest(".uploadifyProgress").fadeOut(250,function(){e(this).remove()})}),t.data.toDisplay=="percentage"&&(displayData=" - "+i.percentage+"%"),t.data.toDisplay=="speed"&&(displayData=" - "+i.speed+"KB/s"),t.data.toDisplay==null&&(displayData=" "),e("#"+e(this).attr("id")+n).find(".percentage").text(displayData))}),e(this).bind("uploadifyComplete",{action:n.onComplete},function(t,r,i,s,o){t.data.action(t,r,i,unescape(s),o)!==!1&&(e("#"+e(this).attr("id")+r).find(".percentage").text(" - Completed"),n.removeCompleted&&e("#"+e(t.target).attr("id")+r).fadeOut(250,function(){e(this).remove()}),e("#"+e(t.target).attr("id")+r).addClass("completed"))}),typeof n.onAllComplete=="function"&&e(this).bind("uploadifyAllComplete",{action:n.onAllComplete},function(e,t){e.data.action(e,t)!==!1&&(u=[])})})},uploadifySettings:function(t,n,r){var i=!1;e(this).each(function(){if(t=="scriptData"&&n!=null){if(r)var s=n;else var s=e.extend(e(this).data("settings").scriptData,n);var o="";for(var u in s)o+="&"+u+"="+s[u];n=escape(o.substr(1))}i=document.getElementById(e(this).attr("id")+"Uploader").updateSettings(t,n)});if(n==null&&t=="scriptData"){var s=unescape(i).split("&"),o=new Object;for(var u=0;u<s.length;u++){var a=s[u].split("=");o[a[0]]=a[1]}i=o}return i},uploadifyUpload:function(t,n){e(this).each(function(){n||(n=!1),document.getElementById(e(this).attr("id")+"Uploader").startFileUpload(t,n)})},uploadifyCancel:function(t){e(this).each(function(){document.getElementById(e(this).attr("id")+"Uploader").cancelFileUpload(t,!0,!0,!1)})},uploadifyClearQueue:function(){e(this).each(function(){document.getElementById(e(this).attr("id")+"Uploader").clearFileUploadQueue(!1)})}})}(jQuery);var swfobject=function(){function C(){if(b)return;try{var e=a.getElementsByTagName("body")[0].appendChild(U("span"));e.parentNode.removeChild(e)}catch(t){return}b=!0;var n=c.length;for(var r=0;r<n;r++)c[r]()}function k(e){b?e():c[c.length]=e}function L(t){if(typeof u.addEventListener!=e)u.addEventListener("load",t,!1);else if(typeof a.addEventListener!=e)a.addEventListener("load",t,!1);else if(typeof u.attachEvent!=e)z(u,"onload",t);else if(typeof u.onload=="function"){var n=u.onload;u.onload=function(){n(),t()}}else u.onload=t}function A(){l?O():M()}function O(){var n=a.getElementsByTagName("body")[0],r=U(t);r.setAttribute("type",i);var s=n.appendChild(r);if(s){var o=0;(function(){if(typeof s.GetVariable!=e){var t=s.GetVariable("$version");t&&(t=t.split(" ")[1].split(","),T.pv=[parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)])}else if(o<10){o++,setTimeout(arguments.callee,10);return}n.removeChild(r),s=null,M()})()}else M()}function M(){var t=h.length;if(t>0)for(var n=0;n<t;n++){var r=h[n].id,i=h[n].callbackFn,s={success:!1,id:r};if(T.pv[0]>0){var o=R(r);if(o)if(W(h[n].swfVersion)&&!(T.wk&&T.wk<312))V(r,!0),i&&(s.success=!0,s.ref=_(r),i(s));else if(h[n].expressInstall&&D()){var u={};u.data=h[n].expressInstall,u.width=o.getAttribute("width")||"0",u.height=o.getAttribute("height")||"0",o.getAttribute("class")&&(u.styleclass=o.getAttribute("class")),o.getAttribute("align")&&(u.align=o.getAttribute("align"));var a={},f=o.getElementsByTagName("param"),l=f.length;for(var c=0;c<l;c++)f[c].getAttribute("name").toLowerCase()!="movie"&&(a[f[c].getAttribute("name")]=f[c].getAttribute("value"));P(u,a,r,i)}else H(o),i&&i(s)}else{V(r,!0);if(i){var p=_(r);p&&typeof p.SetVariable!=e&&(s.success=!0,s.ref=p),i(s)}}}}function _(n){var r=null,i=R(n);if(i&&i.nodeName=="OBJECT")if(typeof i.SetVariable!=e)r=i;else{var s=i.getElementsByTagName(t)[0];s&&(r=s)}return r}function D(){return!w&&W("6.0.65")&&(T.win||T.mac)&&!(T.wk&&T.wk<312)}function P(t,n,r,i){w=!0,g=i||null,y={success:!1,id:r};var o=R(r);if(o){o.nodeName=="OBJECT"?(v=B(o),m=null):(v=o,m=r),t.id=s;if(typeof t.width==e||!/%$/.test(t.width)&&parseInt(t.width,10)<310)t.width="310";if(typeof t.height==e||!/%$/.test(t.height)&&parseInt(t.height,10)<137)t.height="137";a.title=a.title.slice(0,47)+" - Flash Player Installation";var f=T.ie&&T.win?"ActiveX":"PlugIn",l="MMredirectURL="+u.location.toString().replace(/&/g,"%26")+"&MMplayerType="+f+"&MMdoctitle="+a.title;typeof n.flashvars!=e?n.flashvars+="&"+l:n.flashvars=l;if(T.ie&&T.win&&o.readyState!=4){var c=U("div");r+="SWFObjectNew",c.setAttribute("id",r),o.parentNode.insertBefore(c,o),o.style.display="none",function(){o.readyState==4?o.parentNode.removeChild(o):setTimeout(arguments.callee,10)}()}j(t,n,r)}}function H(e){if(T.ie&&T.win&&e.readyState!=4){var t=U("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(B(e),t),e.style.display="none",function(){e.readyState==4?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(B(e),e)}function B(e){var n=U("div");if(T.win&&T.ie)n.innerHTML=e.innerHTML;else{var r=e.getElementsByTagName(t)[0];if(r){var i=r.childNodes;if(i){var s=i.length;for(var o=0;o<s;o++)(i[o].nodeType!=1||i[o].nodeName!="PARAM")&&i[o].nodeType!=8&&n.appendChild(i[o].cloneNode(!0))}}}return n}function j(n,r,s){var o,u=R(s);if(T.wk&&T.wk<312)return o;if(u){typeof n.id==e&&(n.id=s);if(T.ie&&T.win){var a="";for(var f in n)n[f]!=Object.prototype[f]&&(f.toLowerCase()=="data"?r.movie=n[f]:f.toLowerCase()=="styleclass"?a+=' class="'+n[f]+'"':f.toLowerCase()!="classid"&&(a+=" "+f+'="'+n[f]+'"'));var l="";for(var c in r)r[c]!=Object.prototype[c]&&(l+='<param name="'+c+'" value="'+r[c]+'" />');u.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+a+">"+l+"</object>",p[p.length]=n.id,o=R(n.id)}else{var h=U(t);h.setAttribute("type",i);for(var d in n)n[d]!=Object.prototype[d]&&(d.toLowerCase()=="styleclass"?h.setAttribute("class",n[d]):d.toLowerCase()!="classid"&&h.setAttribute(d,n[d]));for(var v in r)r[v]!=Object.prototype[v]&&v.toLowerCase()!="movie"&&F(h,v,r[v]);u.parentNode.replaceChild(h,u),o=h}}return o}function F(e,t,n){var r=U("param");r.setAttribute("name",t),r.setAttribute("value",n),e.appendChild(r)}function I(e){var t=R(e);t&&t.nodeName=="OBJECT"&&(T.ie&&T.win?(t.style.display="none",function(){t.readyState==4?q(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function q(e){var t=R(e);if(t){for(var n in t)typeof t[n]=="function"&&(t[n]=null);t.parentNode.removeChild(t)}}function R(e){var t=null;try{t=a.getElementById(e)}catch(n){}return t}function U(e){return a.createElement(e)}function z(e,t,n){e.attachEvent(t,n),d[d.length]=[e,t,n]}function W(e){var t=T.pv,n=e.split(".");return n[0]=parseInt(n[0],10),n[1]=parseInt(n[1],10)||0,n[2]=parseInt(n[2],10)||0,t[0]>n[0]||t[0]==n[0]&&t[1]>n[1]||t[0]==n[0]&&t[1]==n[1]&&t[2]>=n[2]?!0:!1}function X(n,r,i,s){if(T.ie&&T.mac)return;var o=a.getElementsByTagName("head")[0];if(!o)return;var u=i&&typeof i=="string"?i:"screen";s&&(E=null,S=null);if(!E||S!=u){var f=U("style");f.setAttribute("type","text/css"),f.setAttribute("media",u),E=o.appendChild(f),T.ie&&T.win&&typeof a.styleSheets!=e&&a.styleSheets.length>0&&(E=a.styleSheets[a.styleSheets.length-1]),S=u}T.ie&&T.win?E&&typeof E.addRule==t&&E.addRule(n,r):E&&typeof a.createTextNode!=e&&E.appendChild(a.createTextNode(n+" {"+r+"}"))}function V(e,t){if(!x)return;var n=t?"visible":"hidden";b&&R(e)?R(e).style.visibility=n:X("#"+e,"visibility:"+n)}function $(t){var n=/[\\\"<>\.;]/,r=n.exec(t)!=null;return r&&typeof encodeURIComponent!=e?encodeURIComponent(t):t}var e="undefined",t="object",n="Shockwave Flash",r="ShockwaveFlash.ShockwaveFlash",i="application/x-shockwave-flash",s="SWFObjectExprInst",o="onreadystatechange",u=window,a=document,f=navigator,l=!1,c=[A],h=[],p=[],d=[],v,m,g,y,b=!1,w=!1,E,S,x=!0,T=function(){var s=typeof a.getElementById!=e&&typeof a.getElementsByTagName!=e&&typeof a.createElement!=e,o=f.userAgent.toLowerCase(),c=f.platform.toLowerCase(),h=c?/win/.test(c):/win/.test(o),p=c?/mac/.test(c):/mac/.test(o),d=/webkit/.test(o)?parseFloat(o.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,v=!1,m=[0,0,0],g=null;if(typeof f.plugins!=e&&typeof f.plugins[n]==t)g=f.plugins[n].description,g&&(typeof f.mimeTypes==e||!f.mimeTypes[i]||!!f.mimeTypes[i].enabledPlugin)&&(l=!0,v=!1,g=g.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),m[0]=parseInt(g.replace(/^(.*)\..*$/,"$1"),10),m[1]=parseInt(g.replace(/^.*\.(.*)\s.*$/,"$1"),10),m[2]=/[a-zA-Z]/.test(g)?parseInt(g.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof u.ActiveXObject!=e)try{var y=new ActiveXObject(r);y&&(g=y.GetVariable("$version"),g&&(v=!0,g=g.split(" ")[1].split(","),m=[parseInt(g[0],10),parseInt(g[1],10),parseInt(g[2],10)]))}catch(b){}return{w3:s,pv:m,wk:d,ie:v,win:h,mac:p}}(),N=function(){if(!T.w3)return;(typeof a.readyState!=e&&a.readyState=="complete"||typeof a.readyState==e&&(a.getElementsByTagName("body")[0]||a.body))&&C(),b||(typeof a.addEventListener!=e&&a.addEventListener("DOMContentLoaded",C,!1),T.ie&&T.win&&(a.attachEvent(o,function(){a.readyState=="complete"&&(a.detachEvent(o,arguments.callee),C())}),u==top&&function(){if(b)return;try{a.documentElement.doScroll("left")}catch(e){setTimeout(arguments.callee,0);return}C()}()),T.wk&&function(){if(b)return;if(!/loaded|complete/.test(a.readyState)){setTimeout(arguments.callee,0);return}C()}(),L(C))}(),J=function(){T.ie&&T.win&&window.attachEvent("onunload",function(){var e=d.length;for(var t=0;t<e;t++)d[t][0].detachEvent(d[t][1],d[t][2]);var n=p.length;for(var r=0;r<n;r++)I(p[r]);for(var i in T)T[i]=null;T=null;for(var s in swfobject)swfobject[s]=null;swfobject=null})}();return{registerObject:function(e,t,n,r){if(T.w3&&e&&t){var i={};i.id=e,i.swfVersion=t,i.expressInstall=n,i.callbackFn=r,h[h.length]=i,V(e,!1)}else r&&r({success:!1,id:e})},getObjectById:function(e){if(T.w3)return _(e)},embedSWF:function(n,r,i,s,o,u,a,f,l,c){var h={success:!1,id:r};T.w3&&!(T.wk&&T.wk<312)&&n&&r&&i&&s&&o?(V(r,!1),k(function(){i+="",s+="";var p={};if(l&&typeof l===t)for(var d in l)p[d]=l[d];p.data=n,p.width=i,p.height=s;var v={};if(f&&typeof f===t)for(var m in f)v[m]=f[m];if(a&&typeof a===t)for(var g in a)typeof v.flashvars!=e?v.flashvars+="&"+g+"="+a[g]:v.flashvars=g+"="+a[g];if(W(o)){var y=j(p,v,r);p.id==r&&V(r,!0),h.success=!0,h.ref=y}else{if(u&&D()){p.data=u,P(p,v,r,c);return}V(r,!0)}c&&c(h)})):c&&c(h)},switchOffAutoHideShow:function(){x=!1},ua:T,getFlashPlayerVersion:function(){return{major:T.pv[0],minor:T.pv[1],release:T.pv[2]}},hasFlashPlayerVersion:W,createSWF:function(e,t,n){return T.w3?j(e,t,n):undefined},showExpressInstall:function(e,t,n,r){T.w3&&D()&&P(e,t,n,r)},removeSWF:function(e){T.w3&&I(e)},createCSS:function(e,t,n,r){T.w3&&X(e,t,n,r)},addDomLoadEvent:k,addLoadEvent:L,getQueryParamValue:function(e){var t=a.location.search||a.location.hash;if(t){/\?/.test(t)&&(t=t.split("?")[1]);if(e==null)return $(t);var n=t.split("&");for(var r=0;r<n.length;r++)if(n[r].substring(0,n[r].indexOf("="))==e)return $(n[r].substring(n[r].indexOf("=")+1))}return""},expressInstallCallback:function(){if(w){var e=R(s);e&&v&&(e.parentNode.replaceChild(v,e),m&&(V(m,!0),T.ie&&T.win&&(v.style.display="block")),g&&g(y)),w=!1}}}}();/*
 * Autocomplete - jQuery plugin 1.1pre
 *
 * Copyright (c) 2007 Dylan Verheul, Dan G. Switzer, Anjesh Tuladhar, Jörn Zaefferer
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Revision: $Id: jquery.autocomplete.js 5785 2008-07-12 10:37:33Z joern.zaefferer $
 *
 */(function(e){e.fn.extend({autocomplete:function(t,n){var r=typeof t=="string";return n=e.extend({},e.Autocompleter.defaults,{url:r?t:null,data:r?null:t,delay:r?e.Autocompleter.defaults.delay:10,max:n&&!n.scroll?10:150},n),n.highlight=n.highlight||function(e){return e},n.formatMatch=n.formatMatch||n.formatItem,this.each(function(){new e.Autocompleter(this,n)})},result:function(e){return this.bind("result",e)},search:function(e){return this.trigger("search",[e])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(e){return this.trigger("setOptions",[e])},unautocomplete:function(){return this.trigger("unautocomplete")}}),e.Autocompleter=function(t,n){function p(){var e=c.selected();if(!e)return!1;var t=e.result;o=t;if(n.multiple){var r=v(i.val());r.length>1&&(t=r.slice(0,r.length-1).join(n.multipleSeparator)+n.multipleSeparator+t),t+=n.multipleSeparator}return i.val(t),b(),i.trigger("result",[e.data,e.value]),!0}function d(e,t){if(f==r.DEL){c.hide();return}var s=i.val();if(!t&&s==o)return;o=s,s=m(s),s&&s.length>=n.minChars?(i.addClass(n.loadingClass),n.matchCase||(s=s.toLowerCase()),E(s,w,b)):(x(),c.hide())}function v(t){if(!t)return[""];var r=t.split(n.multipleSeparator),i=[];return e.each(r,function(t,n){e.trim(n)&&(i[t]=e.trim(n))}),i}function m(e){if(!n.multiple)return e;var t=v(e);return t[t.length-1]}function g(s,u){n.autoFill&&m(i.val()).toLowerCase()==s.toLowerCase()&&f!=r.BACKSPACE&&(i.val(i.val()+u.substring(m(o).length)),e.Autocompleter.Selection(t,o.length,o.length+u.length))}function y(){clearTimeout(s),s=setTimeout(b,200)}function b(){var r=c.visible();c.hide(),clearTimeout(s),x(),n.mustMatch&&i.search(function(e){if(!e)if(n.multiple){var t=v(i.val()).slice(0,-1);i.val(t.join(n.multipleSeparator)+(t.length?n.multipleSeparator:""))}else i.val("")}),r&&e.Autocompleter.Selection(t,t.value.length,t.value.length)}function w(e,t){t&&t.length&&a?(x(),c.display(t,e),g(e,t[0].value),c.show()):b()}function E(r,i,s){n.matchCase||(r=r.toLowerCase());var o=u.load(r);if(o&&o.length)i(r,o);else if(typeof n.url=="string"&&n.url.length>0){var a={timestamp:+(new Date)};e.each(n.extraParams,function(e,t){a[e]=typeof t=="function"?t():t}),e.ajax({mode:"abort",port:"autocomplete"+t.name,dataType:n.dataType,url:n.url,data:e.extend({q:m(r),limit:n.max},a),success:function(e){var t=n.parse&&n.parse(e)||S(e);u.add(r,t),i(r,t)}})}else c.emptyList(),s(r)}function S(t){var r=[],i=t.split("\n");for(var s=0;s<i.length;s++){var o=e.trim(i[s]);o&&(o=o.split("|"),r[r.length]={data:o,value:o[0],result:n.formatResult&&n.formatResult(o,o[0])||o[0]})}return r}function x(){i.removeClass(n.loadingClass)}var r={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},i=e(t).attr("autocomplete","off").addClass(n.inputClass),s,o="",u=e.Autocompleter.Cache(n),a=0,f,l={mouseDownOnSelect:!1},c=e.Autocompleter.Select(n,t,p,l),h;e.browser.opera&&e(t.form).bind("submit.autocomplete",function(){if(h)return h=!1,!1}),i.bind((e.browser.opera?"keypress":"keydown")+".autocomplete",function(t){f=t.keyCode;switch(t.keyCode){case r.UP:t.preventDefault(),c.visible()?c.prev():d(0,!0);break;case r.DOWN:t.preventDefault(),c.visible()?c.next():d(0,!0);break;case r.PAGEUP:t.preventDefault(),c.visible()?c.pageUp():d(0,!0);break;case r.PAGEDOWN:t.preventDefault(),c.visible()?c.pageDown():d(0,!0);break;case n.multiple&&e.trim(n.multipleSeparator)==","&&r.COMMA:case r.TAB:case r.RETURN:if(p())return t.preventDefault(),h=!0,!1;break;case r.ESC:c.hide();break;default:clearTimeout(s),s=setTimeout(d,n.delay)}}).focus(function(){a++}).blur(function(){a=0,l.mouseDownOnSelect||y()}).click(function(){a++>1&&!c.visible()&&d(0,!0)}).bind("search",function(){function n(e,n){var r;if(n&&n.length)for(var s=0;s<n.length;s++)if(n[s].result.toLowerCase()==e.toLowerCase()){r=n[s];break}typeof t=="function"?t(r):i.trigger("result",r&&[r.data,r.value])}var t=arguments.length>1?arguments[1]:null;e.each(v(i.val()),function(e,t){E(t,n,n)})}).bind("flushCache",function(){u.flush()}).bind("setOptions",function(){e.extend(n,arguments[1]),"data"in arguments[1]&&u.populate()}).bind("unautocomplete",function(){c.unbind(),i.unbind(),e(t.form).unbind(".autocomplete")}).bind("input",function(){d(0,!0)})},e.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(e){return e[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180},e.Autocompleter.Cache=function(t){function i(e,n){t.matchCase||(e=e.toLowerCase());var r=e.indexOf(n);return t.matchContains=="word"&&(r=e.toLowerCase().search("\\b"+n.toLowerCase())),r==-1?!1:r==0||t.matchContains}function s(e,i){r>t.cacheLength&&u(),n[e]||r++,n[e]=i}function o(){if(!t.data)return!1;var n={},r=0;t.url||(t.cacheLength=1),n[""]=[];for(var i=0,o=t.data.length;i<o;i++){var u=t.data[i];u=typeof u=="string"?[u]:u;var a=t.formatMatch(u,i+1,t.data.length);if(a===!1)continue;var f=a.charAt(0).toLowerCase();n[f]||(n[f]=[]);var l={value:a,data:u,result:t.formatResult&&t.formatResult(u)||a};n[f].push(l),r++<t.max&&n[""].push(l)}e.each(n,function(e,n){t.cacheLength++,s(e,n)})}function u(){n={},r=0}var n={},r=0;return setTimeout(o,25),{flush:u,add:s,populate:o,load:function(s){if(!t.cacheLength||!r)return null;if(!t.url&&t.matchContains){var o=[];for(var u in n)if(u.length>0){var a=n[u];e.each(a,function(e,t){i(t.value,s)&&o.push(t)})}return o}if(n[s])return n[s];if(t.matchSubset)for(var f=s.length-1;f>=t.minChars;f--){var a=n[s.substr(0,f)];if(a){var o=[];return e.each(a,function(e,t){i(t.value,s)&&(o[o.length]=t)}),o}}return null}}},e.Autocompleter.Select=function(t,n,r,i){function p(){if(!l)return;c=e("<div/>").hide().addClass(t.resultsClass).css("position","absolute").appendTo(document.body),h=e("<ul/>").appendTo(c).mouseover(function(t){d(t).nodeName&&d(t).nodeName.toUpperCase()=="LI"&&(u=e("li",h).removeClass(s.ACTIVE).index(d(t)),e(d(t)).addClass(s.ACTIVE))}).click(function(t){return e(d(t)).addClass(s.ACTIVE),r(),n.focus(),!1}).mousedown(function(){i.mouseDownOnSelect=!0}).mouseup(function(){i.mouseDownOnSelect=!1}),t.width>0&&c.css("width",t.width),l=!1}function d(e){var t=e.target;while(t&&t.tagName!="LI")t=t.parentNode;return t?t:[]}function v(e){o.slice(u,u+1).removeClass(s.ACTIVE),m(e);var n=o.slice(u,u+1).addClass(s.ACTIVE);if(t.scroll){var r=0;o.slice(0,u).each(function(){r+=this.offsetHeight}),r+n[0].offsetHeight-h.scrollTop()>h[0].clientHeight?h.scrollTop(r+n[0].offsetHeight-h.innerHeight()):r<h.scrollTop()&&h.scrollTop(r)}}function m(e){u+=e,u<0?u=o.size()-1:u>=o.size()&&(u=0)}function g(e){return t.max&&t.max<e?t.max:e}function y(){h.empty();var n=g(a.length);for(var r=0;r<n;r++){if(!a[r])continue;var i=t.formatItem(a[r].data,r+1,n,a[r].value,f);if(i===!1)continue;i=pinkoi.util.escape(i);var l=e("<li/>").html(t.highlight(i,f)).addClass(r%2==0?"ac_even":"ac_odd").appendTo(h)[0];e.data(l,"ac_data",a[r])}o=h.find("li"),t.selectFirst&&(o.slice(0,1).addClass(s.ACTIVE),u=0),e.fn.bgiframe&&h.bgiframe()}var s={ACTIVE:"ac_over"},o,u=-1,a,f="",l=!0,c,h;return{display:function(e,t){p(),a=e,f=t,y()},next:function(){v(1)},prev:function(){v(-1)},pageUp:function(){u!=0&&u-8<0?v(-u):v(-8)},pageDown:function(){u!=o.size()-1&&u+8>o.size()?v(o.size()-1-u):v(8)},hide:function(){c&&c.hide(),o&&o.removeClass(s.ACTIVE),u=-1},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(o.filter("."+s.ACTIVE)[0]||t.selectFirst&&o[0])},show:function(){var r=e(n).offset();c.css({width:typeof t.width=="string"||t.width>0?t.width:e(n).width(),top:r.top+n.offsetHeight,left:r.left}).show();if(t.scroll){h.scrollTop(0),h.css({maxHeight:t.scrollHeight,overflow:"auto"});if(e.browser.msie&&typeof document.body.style.maxHeight=="undefined"){var i=0;o.each(function(){i+=this.offsetHeight});var s=i>t.scrollHeight;h.css("height",s?t.scrollHeight:i),s||o.width(h.width()-parseInt(o.css("padding-left"))-parseInt(o.css("padding-right")))}}},selected:function(){var t=o&&o.filter("."+s.ACTIVE).removeClass(s.ACTIVE);return t&&t.length&&e.data(t[0],"ac_data")},emptyList:function(){h&&h.empty()},unbind:function(){c&&c.remove()}}},e.Autocompleter.Selection=function(e,t,n){if(e.createTextRange){var r=e.createTextRange();r.collapse(!0),r.moveStart("character",t),r.moveEnd("character",n),r.select()}else e.setSelectionRange?e.setSelectionRange(t,n):e.selectionStart&&(e.selectionStart=t,e.selectionEnd=n);e.focus()}})(jQuery),pinkoi=typeof pinkoi=="undefined"?{}:pinkoi,pinkoi.form=function(){var e={},t={init:function(){$('.prompt, .editable:not(".ok")').live("click",function(e){e.stopPropagation();if(/input|a|select|option|textarea|object|embed/i.test(e.target.nodeName))return;var t=$(this);t.hasClass("editable")&&(t=t.children(".prompt"));if(t.css("display")=="none")return;var n=t.toggle().next(".input").toggle();n.hasClass("edit")&&!n.hasClass("nofill")?t.find("a").length?n.children(":input").val(pinkoi.util.br2nl(pinkoi.util.unescape(t.find("a").html()))):n.children(":input").val(pinkoi.util.br2nl(pinkoi.util.unescape(t.html()))):n.hasClass("nofill")||n.children(":input").val("")}),$(".editable .ok").live("click",function(e){e.stopPropagation();var t=$(this);if(t.hasClass("notoggle"))return;var n=!!t.attr("groupis"),r=t.closest(".editable").eq(0),i=$([]),s=$([]);if(n){var o=r.find(".group");$.each(o,function(){var e=$(this);if(!e.find(".gkey").attr("checked"))return!0;s=s.add(this),i=i.add(e.find(":input"))})}else i=r.find(":input");pinkoi.form.prompt.onconfirm&&(t.attr("packto")&&(pinkoi.form.prompt.onconfirm.options.packto=t.attr("packto")),pinkoi.form.prompt.onconfirm(i,pinkoi.form.prompt.onconfirm.options));var u=t.attr("mapto");if(u&&u=="true"){var a=r.html(),f=a.match(/<input.*?>\s*<label>.+?<\/label>/ig);if(f.length){u={};var o=null;$.each(f,function(e,t){if(t.search(/type="?radio"?/i)!==-1||t.search(/type="?checkbox"?/i)!==-1)o=t.match(/value="?([^" ]+)"?.*?\s*<label>(.+?)<\/label>/i),u[o[1]]=o[2]})}}var l={};i.length>1?i.each(function(){var e=$(this),t=e.attr("type").toLowerCase(),n=e.attr("name");if(t=="radio"&&!e.attr("checked"))return;if(t=="file")return;t=="checkbox"?e.attr("checked")&&(typeof l[n]=="undefined"?l[n]=e.val():l[n]+=", "+e.val()):l[n]=e.val()}):l[0]=i.val(),u&&$.each(l,function(e,t){$.each(u,function(t,n){l[e]=l[e].replace(t,n)})});var c="";if(!n){var h=t.attr("template");h?(h=h.replace(/<br ?\/?>/ig,"\n"),c=pinkoi.template(h,l)):$.each(l,function(){c+=this})}else s.each(function(e){e>0&&(c+=", ");var t=$(this).attr("template").replace(/<br ?\/?>/ig,"\n");c+=pinkoi.template(t,l)});var p=t.parent().removeClass("add").addClass("edit").toggle().prev(".prompt").toggle();p.find("a").length?p.find("a").html(pinkoi.util.nl2br(pinkoi.util.escape(c))):c&&p.html(pinkoi.util.nl2br(pinkoi.util.escape(c))),t.parent().prevAll(".icon").attr("src","/media/img/edit.gif"),t.parents(".editable").removeClass("add").addClass("edit")}),$(".cancel").live("click",function(e){e.stopPropagation();var t=$(this);t.parent().toggle().prev(".prompt").toggle()})},onconfirm:function(e,t){typeof e=="function"?(this.onconfirm=e,this.onconfirm.options=t||{}):this.onconfirm=null}},n=function(e,t){t=t?t:{};if(e){var n={};e.each(function(){var e=$(this),t=e.attr("type").toLowerCase(),r=e.attr("name");if(t=="radio"&&!e.attr("checked"))return;t=="checkbox"?e.attr("checked")&&(typeof n[r]=="undefined"?n[r]=[e.val()]:typeof n[r]=="object"&&n[r].push(e.val())):typeof n[r]=="undefined"?n[r]=e.val():typeof n[r]=="string"?(n[r]=[n[r]],n[r].push(e.val())):typeof n[r]=="object"&&n[r].push(e.val())});if(t.packto){var r={};r[t.packto]=JSON.stringify(n),n=r}var i=t.path||location.pathname,s=t.success||$.noop,o=t.fail||$.noop,u=function(t){s(t,e);try{t.status=="ok"?pinkoi.drawer.on(_("✔ 已更改")):pinkoi.drawer.on(_("✘ 更改失敗"))}catch(n){}};pinkoi.request("POST",i,{data:n,success:u})}};return{submit:n,prompt:t}}(),pinkoi.geocoder=function(){var e=null;try{e=new google.maps.Geocoder}catch(t){}return{query:function(t,n){e||(e=new google.maps.Geocoder),e.geocode({language:"zh-TW",address:t},function(e,t){t==google.maps.GeocoderStatus.OK?n&&n(e[0]):n(!1)})}}}(),pinkoi.namespace("pinkoi.product"),pinkoi.product.main=function(){(function(){var e=500,t=800,n=$("#photo .primary .photo-holder"),r=n.find(".primaryzoom"),i=n.attr("tid"),s=n.data("irev"),o=$('#photo .thumbs img:not(".not")');o.click(function(e){r.html("");var t=$(this),n=t.attr("seq"),u={seq:n};n=="0"&&s&&(u.rev=s);var a=pinkoi.conf.itemImageUrl(i,"500x0",u),f=$('<img src ="'+a+'">');o.removeClass("active"),t.addClass("active"),r.html(f),r.attr("href",a),f.attr("zoom","/zoom/itemimg/"+i+"/"+n)})})(),$("#photo .zoom").mouseenter(function(e){$(this).attr("href",$("#photo .primary img").attr("zoom"))}),$("#detail").find(".description").on("contextmenu",function(){return!1});try{pinkoi.placeJumpPage(1250)}catch(e){}var t=function(){var e={tid:pinkoi.globals.get("PAGE_TID")};$.post(pinkoi.uri.waitlist_add,e,function(e){if(e.error){alert(e.error.message);return}pinkoi.drawer.on(_("排隊成功～當這件商品有現貨時會立即 Email 通知你！Pinkoi 也會幫你告訴設計師你正在排隊等候哦"))}).fail(function(e){alert(_("排隊失敗!"))})};pinkoi.product.main.doWaitlist=t,$("#cart [data-id=waitlist]").bind("click",function(e){if(pinkoi.globals.get("uid")){var n=confirm(_("此商品目前沒有現貨\n當有現貨上架時會即時寄 Email 通知你\n你要排隊等候通知嗎？"));n&&t()}else pinkoi.login_modal.load()}),pinkoi.forms.limitVal($("#cart")),$.browser.msie&&$("#cart :input[name=variations]").bind("mouseenter",function(){$(this).width("auto")}).bind("blur change",function(){$(this).width("100%")}),$(".g_mod_qna_form textarea").focus(function(e){if(!pinkoi.isLogin())return}),$("#translator").click(function(){var e=$(this);pinkoi.translate(".translate",e.data("from"),e.data("to"))})},pinkoi.product.buy=function(e){var t=$(e),n=t.attr("data-vacation");if(typeof n!="undefined"){var r=_("這位設計師目前休假中，要等他回來後才能處理你的訂單哦\r\r");if(t.attr("data-vacationActivated")!=="0")var i=new Date(parseInt(t.attr("data-vacationActivated"),10)*1e3),s=pinkoi.template("%s/%s/%s %s:%s ~",i.getFullYear(),i.getMonth()+1,i.getDate(),("0"+i.getHours()).slice(-2),("0"+i.getMinutes()).slice(-2));else var s="";var o=new Date(parseInt(t.attr("data-vacationExpired"),10)*1e3),u=pinkoi.template("%s/%s/%s %s:%s",o.getFullYear(),o.getMonth()+1,o.getDate(),("0"+o.getHours()).slice(-2),("0"+o.getMinutes()).slice(-2));n&&(r+=pinkoi.template(_("休假訊息：\n%s\n\n休假時間：\n%s %s"),n,s,u)),r+=_("\n\n你想先下單並等候嗎？");var a=confirm(r);if(!a)return!1}var f=t.closest(".add2Cart"),l={tid:pinkoi.globals.get("PAGE_TID"),quantity:parseInt(f.find(':input[name="quantity"]').val())||1},c=f.find(":input[name=variations]");if(c.length){var h=c.val();if(!h||h=="__null__")return pinkoi.drawer.on(_("請選擇規格尺寸")),pinkoi.focused(f.find("select[name=variations]")),!1;l.variation=h}var p=t.data("preorder");if(p){var a=confirm(_("此商品為「預購」的商品，待你下單付款後，設計師會在")+"\n\n"+p+_(" 後開始出貨"));if(!a)return!1}gTrackEvent("Shopping","Cart",pinkoi.globals.get("uid")?"logged in":"not logged in");var d="/apiv2/cart/fast_add?tid="+encodeURIComponent(l.tid)+"&quantity="+encodeURIComponent(l.quantity);l.variation&&(d+="&variation="+encodeURIComponent(l.variation)),pinkoi.cookie.flushCache(),(pinkoi.cookie.get("sessionid")&&pinkoi.cookie.get("st")||pinkoi.isLogin(d))&&pinkoi.request("POST","/apiv2/cart/add",{data:l,success:function(e){pinkoi.drawer.on(_("商品已放進購物車")),require(["app/modules/cart","storage/local"],function(t,n){t.updateNum(e.result[0].cart_num),n.set("g.cartNotification",!0,"1M"),location.href="/cart"})}})},pinkoi.product.addQuantity=function(e){if(!pinkoi.isLogin())return;var t=$(e),n=parseInt(t.val(),10)||1;n>parseInt(t.attr("max"),10)&&(pinkoi.drawer.on(pinkoi.template(_("商品存貨只剩下 %s 個，請調整你的購買數量"),t.attr("max"))),pinkoi.focused(t.val("")))},pinkoi.product.playYoutube=function(e){pinkoi.playYoutube(e,'<div style="margin-top:15px;text-align:center;font-weight:bold;font-size:11px;letter-spacing:1px;">'+$('head meta[property="og:title"]').attr("content")+"</div>")},pinkoi.cart=function(){var e=pinkoi,t=function(){},n=t.prototype,r=!1,i='        <div class="box_">            <div class="title_">'+_("商品總運費")+'<div class="caption_">'+_("如果你跟同一間設計館購買多樣商品，可以利用「聯絡設計師」與設計師討論商品「是否可以合併運費」，並在下方填入協議後運費總金額，若擅自更改運費，設計師及 Pinkoi 站方將保留取消訂單的權利")+'</div></div>            <div class="fillbg_ "><input type="text" name="shipping" limit_val="integer" /></div>        </div>        <a class="submit m-button">'+_("更新，我已經跟設計師確認最後運費")+"</a>";return n.checkEmpty=function(e){var t=!1;return e.find(".order").length||(e.remove(),t=!0),$("#cart .group").length===0&&(location.href="/cart"),t},n.init=function(){$("#cart .quantity input").keyup(function(e){if(e.keyCode===46||e.keyCode===8)return;var t=$(this),n=t.parents(".order"),r=t.parents(".group"),i=n.data("tid"),s=parseInt(t.val(),10),o=parseInt(t.data("max"),10);if(!s&&s!==0||s<0)s=1,t.val(1);var u=0;r.find(".tid-"+i).find('input[name="quantity"]').each(function(){u+=parseInt(this.value)}),u>o&&(s=o-(u-s),t.val(s),pinkoi.drawer.on(_("這件商品數量只剩 ")+o));var a={tid:i,quantity:s},f=n.data("variation");f&&(a.variation=f);var l=n.data("dummy-variation");l&&(a.dummy_variation=l),s===0?pinkoi.request("POST",pinkoi.cart.currentHost+"/apiv2/cart/delete",{data:a,success:function(e){require(["app/modules/cart"],function(t){t.updateNum(e.result[0].cart_num)}),n.remove(),pinkoi.cart.checkEmpty(r)||pinkoi.cart.sum(r)}}):(pinkoi.request("POST",pinkoi.cart.currentHost+"/apiv2/cart/add",{data:a,success:$.noop}),pinkoi.cart.sum(r))}).focus(function(e){$(this).val("")}).blur(function(e){var t=$(this),n=parseInt(t.val(),10);!n&&n!==0&&t.val(1)}),$("#cart .store_shipping select").on("change",function(e){var t=$(this),r=t.parents(".group");pinkoi.cart.sum(r,!0),n.resetStoreinfo(r),t.find("option:selected").hasClass("intl")?(r.find(".combined_rule.taiwan").hide(),r.find(".combined_rule.intl").show()):(r.find(".combined_rule.taiwan").show(),r.find(".combined_rule.intl").hide()),t.val()==="tranship"?(r.find(".store_shipping").append(_('<p id="whats-tranship" class="combined_rule">需要兩個不同設計館的商品才滿足<a class="inline" target="_blank" href="/magz/1fi34z1e">國際轉運</a>條件</p>')),r.find(".combined_rule.taiwan").hide()):r.find("#whats-tranship").remove(),t.val()?t.addClass("no-indent"):(t.removeClass("no-indent"),r.find(".combined_rule.taiwan").hide(),r.find(".combined_rule.intl").hide())}),$(".order a.close").click(function(e){var t=$(this),n=t.closest(".order"),r=t.closest(".group"),i=n.data("tid"),s={tid:i},o=n.data("variation");o&&(s.variation=o);var u=n.data("dummy-variation");u&&(s.dummy_variation=u),pinkoi.request("POST",pinkoi.cart.currentHost+"/apiv2/cart/delete",{data:s,success:function(e){require(["app/modules/cart"],function(t){t.updateNum(e.result[0].cart_num)}),n.remove(),pinkoi.cart.checkEmpty(r)||pinkoi.cart.sum(r)}})}),$("#cart .summary .shipping_edit").click(function(e){var t=$(this),n=t.parents(".group");t.data("edited")?(t.html("修改"),t.data("edited",!1),n.data("custom_shipping",!1),pinkoi.cart.sum(n)):(pinkoi.gmodal.load(pinkoi.template(i)),pinkoi.forms.limitVal(pinkoi.gmodal.content),pinkoi.gmodal.content.find(".submit").click(function(e){var r=$.trim(pinkoi.gmodal.content.find("input[name=shipping]").val());r=parseInt(r);if(r||r===0)n.data("custom_shipping",r),t.html("取消修改運費"),t.data("edited",!0);pinkoi.cart.sum(n),pinkoi.gmodal.close()}))}),r=!0},n.resetStoreinfo=function(e){var t=e.find(".storeinfo");return t.length||(t=$('<div class="storeinfo"></div>'),e.find(".store_shipping").append(t)),t.html(""),t},n.render711Storeinfo=function(e,t){var r=n.resetStoreinfo(e);setTimeout(function(){r.html('<img style="height:15px;width:15px;vertical-align:top;" src="http://cdn04.pinkoi.com/pinkoi.site/fgp/7-11-logo.jpg"/> '+t.storename+_(" 超商代碼：")+t.storeid+' <a class="inline" onclick="pinkoi.cart.select711Store(this)"><i style="font-size:11px;font-style:normal;font-weight:bold;">'+_("修改")+'</i> <img src="//s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/edit-white.gif"></a>')},0)},n.renderFamiportStoreinfo=function(e,t){var r=n.resetStoreinfo(e);setTimeout(function(){r.html('<img style="height:15px;width:15px;vertical-align:top;" src="http://cdn04.pinkoi.com/pinkoi.site/general/famiport_logo.png"/> '+t.storename+_(" 超商代碼：")+t.storeid+' <a class="inline" onclick="pinkoi.cart.selectFamiportStore(this)"><i style="font-size:11px;font-style:normal;font-weight:bold;">'+_("修改")+'</i> <img src="//s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/edit-white.gif"></a>')},0)},n.select711Store=function(e){e instanceof jQuery||(e=$(e)),e.is(".group")||(e=e.closest(".group")),pinkoi.select711Store(function(t){e.data("sevenstore",t),n.render711Storeinfo(e,t)})},n.selectFamiportStore=function(e){e instanceof jQuery||(e=$(e)),e.is(".group")||(e=e.closest(".group")),pinkoi.selectFamiportStore(function(t){e.data("famiportstore",t),n.renderFamiportStoreinfo(e,t)})},n.sum=function(e,t){var r=e.find(".summary"),i=e.find("select[name=shipping_method] option:selected"),s={};s.seller=e.data("store"),s.shipping_method=i.val(),e.data("coupon")&&(s.coupon=e.data("coupon")),e.data("reward")&&(s.reward=e.data("reward")),e.data("giftcard")&&(s.giftcard=e.data("giftcard"));if(e.data("custom_shipping")||e.data("custom_shipping")===0)s.custom_shipping=e.data("custom_shipping");s.items=[],e.find(".order").each(function(e,t){var n=$(t),r=n.data("tid"),i=n.data("variation")||"",o=n.data("dummy_variation")||"",u=parseInt(n.find("input[name=quantity]").val(),10);s.items.push({tid:r,quantity:u,variation:i,dummy_variation:o})});var o=pinkoi.request("POST",pinkoi.uri.cart_calculate,{data:JSON.stringify(s),contentType:"application/json"},"json",!1);if(o===undefined){var u=e.find("select[name=shipping_method]");u.val()!==""&&u.val(""),pinkoi.drawer.on(_("無法與伺服器連線，請再試一次"));return}if(o.error)o.error.message&&alert(o.error.message),location.replace("/cart");else{var a=o.result[0],f=e.find(".coupon");if(a.coupon&&a.coupon.valid)a.coupon.valid&&(f.show().find(".variable").html(a.coupon.save),f.find("[var=rule]").html(_("使用")+a.coupon.caption),e.find("input[name=coupon]").val(JSON.stringify(a.coupon)));else{if(s.coupon){pinkoi.drawer.on(_("你輸入的優惠券是無效的或者是該設計館並不適用優惠券優惠")),e.removeData("coupon"),n.sum(e,t);return}f.hide(),f.find(".variable").html(0),e.find("input[name=coupon]").val("")}a.reward&&a.reward.redemption?(r.find(".reward [var=points]").html(a.reward.redeemed_points+_("點")),r.find(".reward .variable").html(a.reward.redemption),e.find("input[name=reward]").val(JSON.stringify(a.reward))):(s.reward&&pinkoi.drawer.on(_("你目前紅利無效或是餘額不足，如需協助查詢請來信 service@pinkoi.com")),r.find(".reward [var=points]").html(""),r.find(".reward .variable").html(0),e.find("input[name=reward]").val("")),a.deductible?(r.find(".deductible").show(),r.find(".deductible .variable").html(a.deductible),e.find("input[name=deductible]").val(JSON.stringify(a.deductible))):(r.find(".deductible").hide().html(""),e.find("input[name=deductible]").val("")),a.giftcard&&a.giftcard.valid?(r.find(".giftcard .variable").html(a.giftcard.redemption),e.find(".giftcard label").html(_("禮物卡折抵後餘額")+" "+a.currency.symbol+a.giftcard.balance),e.find("input[name=giftcard]").val(JSON.stringify(a.giftcard))):(s.giftcard&&pinkoi.drawer.on(_("你輸入的禮物卡是無效的或是餘額不足，如需協助查詢請來信 service@pinkoi.com")),r.find(".giftcard .variable").html(0),e.find("input[name=giftcard]").val("")),e.find('input[name="total"]').val(a.total),r.find(".subtotal .variable").html(a.subtotal),e.find('input[name="ordersubtotal"]').val(a.subtotal),e.find('input[name="shipping"]').val(a.shipping),a.subshipping.tw_combined_shipping?(r.find(".combined_shipping").show().find(".variable").html(a.shipping),r.find(".combined_shipping_info")[a.is_intl_shipping_method?"hide":"show"](),r.find(".shipping .variable").html(a.subshipping.tw_combined_shipping).css({"text-decoration":"line-through"})):(r.find(".shipping .variable").html(a.shipping).css({"text-decoration":"none"}),r.find(".combined_shipping").hide(),r.find(".combined_shipping_info").hide()),r.find(".total .variable").html(a.total),a.shipping_note?r.find(".shipping-note").show().html(a.shipping_note):r.find(".shipping-note").hide(),a.additional_note?r.find(".additional-note").show().html(a.additional_note.replace(",","<br>")):r.find(".additional-note").hide().html(""),a.price_note?r.find(".price-note").show().html(a.price_note):r.find(".price-note").hide(),a.address&&e.data("address",a.address);if(t)if(!a.address||$.inArray(a.address.type,["tw-seven","tw-famiport"])&&!a.address.receiver.store_id)s.shipping_method==="sevenpickup"||s.shipping_method==="sevenpayatpickup"?n.select711Store(e):s.shipping_method=="famiportpickup"&&n.selectFamiportStore(e);else switch(a.address.receiver.method){case"sevenpickup":case"sevenpayatpickup":n.render711Storeinfo(e,{storeid:a.address.receiver.store_id,storeaddress:a.address.receiver.store_address,storename:a.address.receiver.store_name});break;case"famiportpickup":n.renderFamiportStoreinfo(e,{storeid:a.address.receiver.store_id,storeaddress:a.address.receiver.store_address,storename:a.address.receiver.store_name})}}},n.checkout=function(e){if(r){var t=$("#"+e);if(!t.find("[name=shipping_method]").val()){pinkoi.tip({selector:$(t.find("[name=shipping_method]").trigger("focus")),content:"<span onclick=\"$(this).closest('.qtip').remove();\">"+_("請先選擇運送方式")+"</span>",where:"top"});return}var i=this.pack(t);if(i){i.store=t.data("store")||t.attr("store"),gTrackEvent("Shopping","Preview",pinkoi.orderlabel(i));var s=$('<form action="'+pinkoi.cart.currentHost+'/cart/checkout" method="POST"><input type="hidden" name="order"/></form>');$(document.body).append(s);var o=t.find("[name=shipping_method]").val(),u=t.data("address");if(o==="sevenpickup"||o==="sevenpayatpickup"){var a=t.data("sevenstore");if(a)i.sevenstore=a;else if(!u||!u.receiver.store_id){n.select711Store(t);return}}else if(o=="famiportpickup"){var f=t.data("famiportstore");if(f)i.famiportstore=f;else if(!u||!u.receiver.store_id){n.selectFamiportStore(t);return}}if(t.data("custom_shipping")||t.data("custom_shipping")===0)i.custom_shipping=t.data("custom_shipping");s.find("input").val(JSON.stringify(i)),s.submit()}}else pinkoi.drawer.on(_("請再次確認購物金額和運費是否正確？"))},n.pack=function(e){var t={},n=!1;return t.items=[],e.find(".order").each(function(){var e={};e=pinkoi.forms.pack(this,!1,!0),e.quantity<0&&!n&&(alert(_("商品數量不能小於 0")),n=!0),t.items.push(e)}),n?!1:(t.shipping=e.find('input[name="shipping"]').val(),t.deductible=parseInt(e.find(".summary .deductible .variable").html(),10)||0,t.additional_note=e.find(".summary .additional-note").html(),t.shipping_method=e.find("select[name=shipping_method]").val(),t.coupon=e.find("input[name=coupon]").val(),t.coupon&&(t.coupon=JSON.parse(t.coupon)),t.reward=e.find("input[name=reward]").val(),t.reward&&(t.reward=JSON.parse(t.reward),t.reward.redeemed_points||(t.reward=null)),t.giftcard=e.find("input[name=giftcard]").val(),t.giftcard&&(t.giftcard=JSON.parse(t.giftcard),t.giftcard.redemption||(t.giftcard=null)),t.total=e.find('input[name="total"]').val(),t.subtotal=e.find('input[name="ordersubtotal"]').val(),t)},n.couponModal=function(e){var t=!1,n=!1,r=$(e).closest(".group"),i=r.find(".order");for(var s=0,o=i.length;s<o;s++)if(parseInt(i.eq(s).data("discount"))>0){t=!0;break}if(n){pinkoi.drawer.on("當你的訂單中包含有特殊折扣商品，則無法使用優惠券哦");return}if(r.data("reward")){pinkoi.drawer.on(_("當你的訂單中已使用紅利點數，將無法使用優惠券喔！"));return}pinkoi.gmodal.load(['<h3 class="title_">'+_("請輸入優惠券號碼")+"</h3>",'<div class="caption_">'+_("趕快來兌換屬於你的熟客優惠!")+"</div>",'<div class="form_ fillbg_"><input type="text" name="coupon"/></div>','<div class="footer_"><a class="m-button" data-id="confirm">'+_("確認")+"</a></div>"].join("")),pinkoi.gmodal.content.find("[data-id=confirm]").bind("click",function(t){var n=$.trim(pinkoi.gmodal.content.find("input[name=coupon]").val());if(n){pinkoi.gmodal.close();var r=$(e).closest(".group");r.data("coupon",n),pinkoi.cart.sum(r)}})},n.giftcardModal=function(e){var t=!1,n=$(e).closest(".group"),r=n.find(".order");pinkoi.gmodal.load(['<h3 class="title_">'+_("請輸入禮物卡號碼")+'<a class="message_" style="margin-left:5px;" href="/store/pinkoi">'+_("購買禮物卡")+"</a></h3>",'<div class="caption_">'+_("禮物卡的號碼可以在卡片的背面找到，總共十個字母數字!")+"</div>",'<div class="form_ fillbg_"><input type="text" name="giftcard"/></div>','<div class="footer_"><a class="m-button" data-id="confirm">'+_("確認")+"</a></div>"].join("")),pinkoi.gmodal.content.find("[data-id=confirm]").bind("click",function(t){var n=$.trim(pinkoi.gmodal.content.find('input[name="giftcard"]').val());if(n){pinkoi.gmodal.close();var r=$(e).closest(".group");r.data("giftcard",n),pinkoi.cart.sum(r)}})},n.reward=function(e){var t=$(e),n=t.closest(".group");if(n.data("coupon")){pinkoi.drawer.on(_("當你的訂單中使用優惠券，將無法使用紅利折抵喔！"));return}n.data("reward")?(n.data("reward",!1),t.html(_("使用"))):(n.data("reward",!0),t.html(_("取消"))),pinkoi.cart.sum(n)},new t}(),pinkoi.cart.currentHost=location.protocol+"//"+location.hostname,pinkoi.orderlabel=function(e){var t="";for(var n=0;n<e.items.length;++n)t+=e.items[n].title;return t},pinkoi.checkout=function(e){var t=$("#cart"),n=t.find(".step_1"),r=t.find(".step_2"),i=t.find(".step_3"),s=1,o=!0,u={samewithbuyer:0,tax:0,other:0};e.had_buyer&&$(".second-supbox-switch").click(),e.is_store&&($(".store-box").show(),e.had_buyer?($(".second-supbox").append($(".store-box")),$(".second-address-box").hide()):$(".first-address-box").hide(),$(".second-supbox-switch").click(function(){$(".second-supbox-switch").attr("checked")?($(".first-supbox").append($(".store-box")),$(".first-address-box").hide(),$(".second-address-box").show()):($(".first-address-box").show(),$(".second-supbox").append($(".store-box")),$(".second-address-box").hide())})),e.required_three_copies_invoice&&$(".tax-subbox-switch").click(),e.shipto={},n.bind("change",function(e){if(e.target.nodeName!=="INPUT")return;var t=$(e.target);t.attr("type")==="checkbox"?u[t.attr("name")]+=1:u.other+=1}),t.bind("click",function(a){var f=$(a.target);if(f.hasClass("dosth")){var l=f.attr("sth");if(l=="select-seven")pinkoi.select711Store(function(e){$("[name=store-name]").text(e.storename),$("[name=store-id]").text(e.storeid),$("[name=store-address]").text(e.storeaddress),u.other+=1});else if(l=="select-famiport")pinkoi.selectFamiportStore(function(e){$("[name=store-name]").text(e.storename),$("[name=store-id]").text(e.storeid),$("[name=store-address]").text(e.storeaddress),u.other+=1});else if(l=="go_step2"){var c=n.find(":input[name=name]");e.shipto.shiptoname=$.trim(c.val());if(!e.shipto.shiptoname||c.attr("default_val")==e.shipto.shiptoname){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_NAME),o=!1,n.find(":input[name=name]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}o=!0;if(e.shipping_method=="tranship"&&!/^(\+1|\+86|\+852|\+853)$/.test($.trim(n.find(":input[name=tel]").val()))){pinkoi.drawer.on("Pinkoi 國際轉運服務目前僅開放美加、中港澳地區喔！"),o=!1,n.find(":input[name=tel]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}o=!0;var h=n.find(":input[name=tel]").val()+n.find(":input[name=telLocal]").val();e.shipto.shiptophonenum=$.trim(h);if(/^\+886/.test(e.shipto.shiptophonenum)){var p=e.shipto.shiptophonenum.replace(/[^0-9+]/g,"").replace(/^\+88609/,"+8869");if(/^\+8869/.test(p)&&p.length!=13){pinkoi.drawer.on(_("手機號碼長度不正確")),o=!1,n.find(":input[name=telLocal]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}}if(!/[\d()\- ]{8}/i.test(e.shipto.shiptophonenum)){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_PHONE),o=!1,n.find(":input[name=telLocal]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}o=!0,$(".step_1").find(".col_narrow input:checked").length===1&&(e.taxtitle=$.trim(n.find(':input[name="taxtitle"]').val()),e.taxid=$.trim(n.find(':input[name="taxid"]').val()));var d=n.find(":input[name=message]"),v=$.trim(d.val());v!=d.attr("default_val")?e.message=v:e.message="",e.shipto.shiptoaddress=$.trim(n.find(':input[name="addr"]').val()),e.shipto.shiptozipcode=$.trim(n.find(':input[name="zipcode"]'
).val()),e.receiver_contact={name:e.shipto.shiptoname,tel:e.shipto.shiptophonenum,address:e.shipto.shiptoaddress,zipcode:e.shipto.shiptozipcode},e.buyer_contact=null;if($(".step_1").find(".col_wide input:checked").length===0){e.do_not_update_contact=1,e.buyer_contact=e.receiver_contact;var m=e.shipto.shiptoaddress;e.shipto.shiptoname=$.trim(n.find(':input[name="sname"]').val()),e.shipto.shiptophonenum=$.trim(n.find(':input[name="stel"]').val()+n.find(':input[name="stelLocal"]').val()),e.shipto.shiptoaddress=$.trim(n.find(':input[name="saddr"]').val()),e.shipto.shiptozipcode=$.trim(n.find(':input[name="szipcode"]').val().replace(/[^\d-]/g,"")),e.receiver_contact={name:e.shipto.shiptoname,tel:e.shipto.shiptophonenum,address:e.shipto.shiptoaddress,zipcode:e.shipto.shiptozipcode};if(e.shipto.shiptoname.length===0||e.shipto.shiptoname===n.find(':input[name="sname"]').attr("default_val")){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_NAME),o=!1,n.find(":input[name=sname]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(e.shipping_method=="mail"&&e.shipto.shiptozipcode.length<2){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_ZIPCODE),o=!1,n.find(':input[name="szipcode"]').focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(e.shipping_method!="sevenpickup"&&e.shipping_method!=="sevenpayatpickup"&&e.shipping_method!="famiportpickup"&&(e.shipto.shiptoaddress.length<6||e.shipto.shiptoaddress===n.find(':input[name="saddr"]').attr("default_val"))){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_SHIPPING_ADDRESS),o=!1,n.find(':input[name="saddr"]').focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(!/[\d()\- ]{8}/i.test(e.shipto.shiptophonenum)){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_PHONE),o=!1,n.find(":input[name=stelLocal]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}}if(e.shipto.shiptoname.length==0){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_NAME),o=!1,n.find(":input[name=name]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(!/[\d()\- ]{8}/i.test(e.shipto.shiptophonenum)){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_PHONE),o=!1,n.find(":input[name=telLocal]").focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(e.shipping_method=="mail"&&e.shipto.shiptozipcode.length<2){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_ZIPCODE),o=!1,n.find(':input[name="zipcode"]').focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}if(e.shipping_method==="sevenpickup"||e.shipping_method==="sevenpayatpickup"){if(!$("[name=store-address]").text()){$("[sth=select-seven]").click();return}}else if(e.shipping_method=="famiportpickup"){if(!$("[name=store-address]").text()){$("[sth=select-famiport]").click();return}}else{if(e.shipto.shiptoaddress.length<6){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_SHIPPING_ADDRESS),o=!1,n.find(':input[name="addr"]').focus().addClass("focused").one("blur",function(){$(this).removeClass("focused")});return}o=!0}e.shipping_method==="sevenpickup"||e.shipping_method==="sevenpayatpickup"?e.sevenstore={storeid:$("[name=store-id]").text(),storeaddress:$("[name=store-address]").text(),storename:$("[name=store-name]").text()}:e.shipping_method=="famiportpickup"&&(e.famiportstore={storeid:$("[name=store-id]").text(),storeaddress:$("[name=store-address]").text(),storename:$("[name=store-name]").text()}),n.find("[fillin=name]").text(e.shipto.shiptoname),n.find("[fillin=tel]").text(e.shipto.shiptophonenum),e.shipping_method==="sevenpickup"||e.shipping_method==="sevenpayatpickup"?n.find("[fillin=addr]").text(e.sevenstore.storeaddress+" (7-11門市地址)"):e.shipping_method=="famiportpickup"?n.find("[fillin=addr]").text(e.famiportstore.storeaddress+" (超商地址)"):n.find("[fillin=addr]").text(e.shipto.shiptoaddress),e.shipto.shiptozipcode?n.find("[fillin=zipcode]").text(e.shipto.shiptozipcode):n.find(".mid h3").first().hide(),n.find(".editable").hide(),n.find(".uneditable").show(),n.removeClass("active"),s<2&&(r.addClass("active").find(".hide").show(),$("html,body").animate({scrollTop:r.offset().top/2},800),s=2,n.find("[sth=go_step2]").html(_("更新")),gTrackEvent("Shopping","Preview Shipping",pinkoi.orderlabel(e))),r.find('input[name="payment"]:checked').length||r.find('input[name="payment"]').eq(0).click()}else if(l=="re_step1")n.addClass("active").find(".editable").show().find("[data-class=next]").html(_("更新")),n.find(".uneditable").hide();else if(l=="re_step2")r.addClass("active").find(".editable").show().find("[data-class=next]").html(_("更新")),r.find(".uneditable").hide();else if(l=="go_step3"){var g=r.find("input[name=payment]:checked");if(!g.val()){pinkoi.drawer.on(_("請選擇你的付款方式"));return}e.payment=g.val();var y=r.find("#card-confirmation-div").hide();if(e.payment==="jpcvs"||e.payment==="jppayeasy"){var b=e.receiver_contact.tel;e.buyer_contact&&(b=e.buyer_contact.tel);if(!/^\+81/.test(b)){e.payment==="jpcvs"?pinkoi.drawer.on(_("使用便利商店代碼繳費必須搭配日本電話喔")):e.payment==="jppayeasy"&&pinkoi.drawer.on(_("使用 Pay-easy 繳費必須搭配日本電話喔"));return}}if(e.payment==="jpcvs"){var w=r.find("#cvs-div select");e.cvs_code=w.val();if(!e.cvs_code){w.focus(),pinkoi.drawer.on(_("請選擇要去付款的便利商店"));return}r.find("[fillin=payment]").text($.trim(g.parent("label").text())+" ("+w.find("option:selected").text()+")")}else if(e.payment==="creditcard"||e.payment==="jpcreditcard"){if(pinkoi.amdCart===undefined){alert(_("發生了一點小問題，請重新整理網頁後再試一次，若問題持續發生，請聯繫 service@pinkoi.com。"));return}if(!pinkoi.amdCart.verifyCard())return;e.auth={pan:pinkoi.amdCart.getCardNo(),expiry:pinkoi.amdCart.getExpiry(),cvv:pinkoi.amdCart.getSecurityCode()},r.find("[fillin=payment]").html(_("信用卡安全加密付款<br>+200 點紅利"));var E=pinkoi.amdCart.getJQMap(),S=y.find(".card-no div"),x=y.find(".expiry div"),T=S.find("span");y.show();var N=E.cardNoInput.val();S.removeClass("mastercard"),S.removeClass("visa"),S.removeClass("jcb"),S.addClass($.payment.cardType(N)),T.text(N),x.text(E.expiryInput.val())}else r.find("[fillin=payment]").text($.trim(g.parent("label").text()));e.payment=="paypal"&&r.find(".uneditable img.paypal").show(),r.find(".editable").hide(),r.find(".uneditable").show(),r.removeClass("active"),s<3&&(i.addClass("active").find(".hide").show(),$("html,body").animate({scrollTop:i.offset().top/2.5},800),s=3,r.find("[sth=go_step3]").html(_("更新")),gTrackEvent("Shopping","Preview Payment",pinkoi.orderlabel(e)));if(e.shipping_method=="tranship"){var C=t.find(".step-tranship");C.length||(r.css("margin-bottom","5px"),r.after('<div class="group step-tranship" style="position: relative; margin-bottom: 20px;"><div style="margin: 25px; padding-left: 20px;">'+_('<label for="irtfm">我已仔細閱讀 <a target="_blank" href="/magz/1fi34z1e">Pinkoi 國際轉運的教學</a> 且了解相關規範：<br>將購買兩筆訂單以上，並無購買不可寄送商品。</label>')+'</div><input id="irtfm" class="irtfm" type="checkbox" style="position: absolute; top: 26px; left: 22px;"></div>'),e.permitted_tranship_order_count>=1&&t.find(".step-tranship .irtfm").prop("checked",!0))}}else if(l=="checkout"){if(e.shipping_method=="tranship"){var C=t.find(".step-tranship");if(!C.find(".irtfm").is(":checked")){C.css("background-color","#fdf9be");return}}if(o){var k=t.find(".step_1.active, .step_2.active");if(k.length){pinkoi.drawer.on(_("你還在更新訂單資料，若更新完成請按『更新』按鈕"));return}pinkoi.point.renew();var L=null;e.taxtitle&&e.taxid&&(L={title:e.taxtitle,id:e.taxid});var A=!1;e.reward&&e.reward.redemption&&(A=!0);var O=null;e.giftcard&&e.giftcard.valid&&(O=e.giftcard.code);var M=null;e.coupon&&e.coupon.valid&&(M=e.coupon.code),e.famiportstore?e.receiver_contact.pickup_store={id:e.famiportstore.storeid,store:e.famiportstore.storename,address:e.famiportstore.storeaddress}:e.sevenstore&&(e.receiver_contact.pickup_store={id:e.sevenstore.storeid,store:e.sevenstore.storename,address:e.sevenstore.storeaddress});var D={};e.address_index<0?_gaq.push(["_trackEvent","Web Cart","Use Address Book","new"]):u.other>0||u.samewithbuyer%2===1||u.tax%2===1?_gaq.push(["_trackEvent","Web Cart","Use Address Book","change"]):(D={index:e.address_index},_gaq.push(["_trackEvent","Web Cart","Use Address Book","hit"]));try{pinkoi.checkout.commit({seller:e.store,address:D,buyer_contact:e.buyer_contact,receiver_contact:e.receiver_contact,tax:L,custom_shipping:e.custom_shipping,shipping_method:e.shipping_method,payment_method:e.payment,cvs_code:e.cvs_code,auth:e.auth,items:e.items,giftcard:O,coupon:M,reward:A,message:e.message})}catch(a){alert(_("發生錯誤：")+a)}}}else if(l=="togglePayHint"){var P=f.val(),H=parseFloat(f.data("min-total")),B=parseFloat(f.data("max-total")),j=$(".summary [fillin=sum]"),F=$("#payment_hint");F.hide();if(P==="seven"||P==="famiport"||P==="vatm"){if(parseFloat(e.total)<H){a.preventDefault(),f.attr("checked",!1),pinkoi.drawer.on(pinkoi.template(_("你購買的商品總金額必需多於「$%s」才能使用這個付款方式喔"),H));return}if(parseFloat(e.total)>B){a.preventDefault(),f.attr("checked",!1),pinkoi.drawer.on(pinkoi.template(_("訂單總金額必需不超過「$%s」才能使用這個付款方式喔"),B));return}}if(P=="seven"||P=="famiport"){var I="";$(".summary [fillin=fee]").text(e.convenient_payment_fee),$('.summary [fillin="total"]').text(parseInt((parseFloat(e.total)+parseFloat(e.convenient_payment_fee))*100)/100),P==="seven"&&e.shipping_method==="sevenpickup"?I=_("請注意，這不是貨到付款服務，你需要先去超商完成付款後設計師才會出貨喔"):P==="famiport"&&e.shipping_method==="famiportpickup"&&(I=_("請注意，這不是貨到付款服務，你需要先去超商完成付款後設計師才會出貨喔")),I&&F.html(I).show()}else $(".summary [fillin=fee]").text(0),$('.summary [fillin="total"]').text(parseFloat(e.total));$("#cart #cvs-div").toggle(P=="jpcvs"),pinkoi.amdCart&&pinkoi.amdCart.toggle(P=="creditcard"||P=="jpcreditcard"),t.find(".pay-hint").hide(),t.find("#"+P+"_hint").show();var q=t.find("[data-id=confirm]").html(P==="paypal"||P==="cathaybk"||P==="cathaybk_3"||P==="cathaybk_6"||P==="alipay"||P==="tenpay"||P==="wechat"?_("立即結帳"):_("確認訂單"))}}});if(e.shipping_method==="sevenpickup"||e.shipping_method==="sevenpayatpickup"||e.shipping_method==="famiportpickup"){var a='<div class="notice noticeName">'+_("便利商店取貨需核對證件，請務必填寫 <b>中文本名</b>，避免糾紛")+"</div>",f='<div class="notice noticePhone">'+_("超商取貨需填寫<b>手機</b>（非市話）")+"</div>";n.find('input[name="name"]').after(a),n.find('input[name="sname"]').after(a),n.find('input[name="telLocal"]').after(f),n.find('input[name="stelLocal"]').after(f)}if(e.shipping_method==="mail"){var a='<div class="notice noticeName">'+_("郵局掛號若無人簽收，需憑身分證至郵局領取，請務必填寫<b>中文本名</b>，避免糾紛")+"</div>";n.find('input[name="name"]').after(a),n.find('input[name="sname"]').after(a)}var l=!1,c=!1,h=/[縣市鄉鎮市區村里路段街巷弄號樓]/,p=function(e){if(e){var t=["ㄅ","ㄆ","ㄇ","ㄈ","ㄉ","ㄊ","ㄋ","ㄌ","ㄍ","ㄎ","ㄏ","ㄐ","ㄑ","ㄒ","ㄓ","ㄔ","ㄕ","ㄖ","ㄗ","ㄘ","ㄙ","ㄧ","ㄨ","ㄩ","ㄚ","ㄛ","ㄜ","ㄝ","ㄞ","ㄟ","ㄠ","ㄡ","ㄢ","ㄣ","ㄤ","ㄥ","ㄦ"];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])!==-1)return!0}return!1},d=function(e,t){var n=!1,r=t.val();e.attr("addressCache",e.val());var i=function(e){pinkoi.request("GET_mute",pinkoi.cart.currentHost+"/apiv2/cart/find_zipcode?address="+encodeURIComponent(e)+(t.val()!==""?"&zipcode="+encodeURIComponent(t.val()):""),{success:function(e){e.result&&e.result[0].zipcode.length>0&&(t.val().length<e.result[0].zipcode.length||t.val().length===e.result[0].zipcode.length)&&(t.val(e.result[0].zipcode.length===4?e.result[0].zipcode.slice(0,3):e.result[0].zipcode),t.addClass("m_defaultval m_defaultval_changed"),r=t.val())}})};t.on("blur",function(e){$(e.target).val().length<3&&pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_ZIPCODE)}),e.on("keydown",function(e){e.metaKey&&e.keyCode===86&&(n=!0)}),e.on("keyup blur change",function(s){var o=$(s.target),u=o.val();parseInt(t.val(),10)||t.val("");if(n){o.attr("addressCache",u),i(u),n=!1;return}if(s.type==="blur"&&$.trim(u)===""){t.val("");return}s.type==="blur"&&u&&c&&$.trim(t.val()).length>0&&t.val().length<3&&(pinkoi.focused(e),pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_ZIPCODE_ADDZONE));if(l||o.attr("addressCache")===u||u.length<3||!h.test(u.slice(-1))||p(u)){o.attr("addressCache")===u&&t.val(r);return}o.attr("addressCache",u),l=!0,setTimeout(function(){l=!1},1e3),i(u),c=!0})};require(["settings"],function(e){e.get("locale")==="zh_TW"&&(d($('#cart input[name="addr"]'),$('#cart input[name="zipcode"]')),d($('#cart input[name="saddr"]'),$('#cart input[name="szipcode"]')))})},pinkoi.checkout.error={INCORRECT_NAME:_("請填寫收件人名稱"),INCORRECT_PHONE:_("請填寫正確的連絡電話(含左欄的國別碼)，這是運送必需的資訊哦"),INCORRECT_SHIPPING_ADDRESS:_("你的收件地址好像不太對耶，請檢查是否有填寫錯誤"),INCORRECT_ZIPCODE:_("請填寫郵遞區號"),INCORRECT_ZIPCODE_ADDZONE:_("請填寫區名（如：台北市大安區）")},pinkoi.checkout.validateAddress=function(e){var t={},n=$("#cart .step_1");t.shiptoaddress=e||$.trim(n.find(':input[name="addr"]').val());if(!t.shiptoaddress){pinkoi.drawer.on(pinkoi.checkout.error.INCORRECT_SHIPPING_ADDRESS);return}try{pinkoi.checkout.checkAddress(t,function(){n.find(':input[name="zipcode"]').val(t.shiptozipcode),n.find(".en_addr").html(t.formatted_address+' <b style="color:#78C042;">✔</b>')})}catch(r){}},pinkoi.checkout.checkAddress=function(e,t){var n=e.shiptoaddress.replace(/[（\(][^\)]+[\)）]/g,"");n=n.replace(/新北市(.{2})區?/g,"台北縣$1"),pinkoi.geocoder.query(n,function(r){try{if(r){e.formatted_address=r.formatted_address;var i=r.address_components;for(var s=0;s<i.length;++s){var o=i[s];if($.inArray("country",o.types)!==-1){e.shiptocountry=o.short_name,e.shiptostate=o.short_name;continue}if($.inArray("administrative_area_level_2",o.types)!==-1){e.shiptocity=o.long_name;continue}if($.inArray("postal_code",o.types)!==-1){e.shiptozipcode=o.long_name;continue}if($.inArray("street_number",o.types)!==-1){var u=e.shiptoaddress,a=u.substr(u.indexOf(o.long_name)+o.long_name.length,u.length);e.shiptostreet=o.long_name+(a?a:"");continue}if($.inArray("route",o.types)!==-1){if(!e.shiptostreet){var u=e.shiptoaddress;if(u){var a=u.substr(u.indexOf(o.long_name)+o.long_name.length,u.length);e.shiptostreet=o.long_name+(a?a:"")}else e.shiptostreet=o.long_name}else e.shiptostreet=o.long_name+e.shiptostreet;continue}if($.inArray("sublocality",o.types)!==-1){e.shiptostreet=o.long_name+e.shiptostreet;continue}if($.inArray("locality",o.types)!==-1){e.shiptocity?e.shiptostreet=o.long_name+e.shiptostreet:e.shiptocity=o.long_name;continue}}e.shiptoaddress||e.shiptostreet||e.shiptocity?t(!0,e):t(!1)}else e.shiptostreet=e.shiptostate=e.shiptocity=e.shiptocountry=e.shiptozipcode="",e.shiptoaddress=n,t(!0,e)}catch(f){t(!1)}})},pinkoi.checkout.commit=function(e){try{require(["app/modules/cart"],function(e){e.clearNum()})}catch(t){}pinkoi.loader.on(),pinkoi.fulldrop.on(),e.payment_method==="paypal"?pinkoi.drawer.on(_("Pinkoi正和PayPal做安全加密連線，頁面即將轉到PayPal，請安心付款！")):e.payment_method.indexOf("cathaybk")===0&&pinkoi.drawer.on(_("Pinkoi正和國泰世華銀行做安全加密連線，頁面即將轉到國泰世華銀行，請安心付款！")),pinkoi.request("POST",pinkoi.cart.currentHost+"/apiv2/cart/checkout",{data:JSON.stringify(e),contentType:"application/json",success:function(e){if(e.error){pinkoi.fulldrop.off(),pinkoi.loader.off(),setTimeout(function(){e.error.message?alert(e.error.message):alert(_("發生了不明錯誤，建議您重新整理網頁再試一次，若問題持續發生請聯繫 service@pinkoi.com。"))},0);return}var t=e.result[0],n=t.ga;if(n){_gaq.push(["_addTrans",t.oid,n.seller,String(n.total),"0",String(n.shipping)]);for(var r=0;r<n.items.length;++r)_gaq.push(["_addItem",t.oid,n.items[r].tid,n.items[r].title,n.items[r].variation,n.items[r].price,n.items[r].quantity]);_gaq.push(["_trackTrans"])}setTimeout(function(){t.redirect_to_url?location.replace(t.redirect_to_url):t.next_step&&(t.next_step.append_html?$(document.body).append(t.next_step.append_html):t.next_step.url&&location.replace(t.next_step.url))},500)},error:function(){pinkoi.fulldrop.off(),pinkoi.loader.off(),setTimeout(function(){alert(_("發生了不明錯誤，建議您重新整理網頁再試一次，若問題持續發生請聯繫 service@pinkoi.com。"))},0)}})},typeof pinkoi=="undefined"&&(pinkoi={}),pinkoi.order=function(){function e(e,t,n){typeof n!="string"&&(n=n.toString());for(var r=t-n.length;r>0;r--)n=e+n;return n}function t(t){if(!t)return"-";var n=new Date(t*1e3);return e("0",4,n.getFullYear())+"/"+e("0",2,n.getMonth()+1)+"/"+e("0",2,n.getDate())+" "+e("0",2,n.getHours())+":"+e("0",2,n.getMinutes())}function g(e,t){return e==="order_is_canceled"?'<span class="canceled">'+t+"</span>":e==="buyer_received"?'<span class="received">'+t+"</span>":t}function y(e){if(!e)return;e.title&&(e.title=e.title.replace(/'/g,"&#039;").replace(/&/g,"&amp;")),e.oid?c.order[e.oid]?c.order[e.oid].photo+=","+e.photo:c.order[e.oid]=e:pinkoi.error("parameter","oid Required"),e.role=u,e.currencySign=e.currency.symbol;var n="",i=T(e.status,e),s={role:u,oid:e.oid||"",uid:pinkoi.globals.uid,breviewed:e.breviewed||"-",sreviewed:e.sreviewed||"-",canceled:e.canceled||"-",reason:'<b style="color:#FF0000;">'+e.reason+"</b>"||"-",paid:e.paid||"-",scheduled:e.scheduled||"-",shipped:e.shipped||"-",received:e.received||"-",created:e.created||"-",overdue:e.overdue||!1,name:e.name||"",zipcode:e.zipcode||"",address:e.address||"",account:e.account||"",serial:e.serial||"",tracking:e.tracking||"-",total:e.total,subtotal:e.subtotal,price:e.price||"-",oprice:e.oprice,symbol:e.currency.symbol,payment_symbol:e.payment_currency.symbol,coupon_deduct:e.coupon_deduct||0,reward_deduct:e.reward_deduct||0,giftcard_deduct:e.giftcard_deduct||0,deductible:e.deductible||0,payment:e.payment||"-",shipping:e.shipping||"",tax:e.taxtitle?'<div class="tax"><span class="text">'+_("發票開立：")+"</span>"+_("抬頭：")+e.taxtitle+" "+_("統編：")+e.taxid+"</div>":"",sevenstore:!e.sevenstore||e.role=="seller"&&e.payment_method=="sevenpayatpickup"?"":'<div class="sevenstore"><span class="text">'+_("超商取貨：")+"</span><i>"+e.sevenstore+"</i></div>",address_hide:e.sevenstore?'style="display:none;"':"",handling:e.handling?e.currency.symbol+e.handling:"",tel:e.tel||"",statusTitle:g(e.status_key,e.status_text),itemURL:e.itemUrl||"",photo:e.photo||"",title:e.title||"",variation:e.variation||"",coupon:e.coupon||"",couponcaption:e.couponcaption||"",buyerProfile:e.buyerProfile||"",buyerNick:e.buyerNick||"",buyerRank:e.buyerRank?'<a class="m-tag" title="'+p[e.buyerRank][1]+'">'+p[e.buyerRank][0]+"</a>":"",buyerRepeated:e.repeated_buyer?'<b title="'+_("老客人回購")+'" class="m-icon-star"></b>':"",sellerProfile:e.sellerProfile||"",sellerNick:e.sellerNick||"",statusAction:i.action,reviewAction:i.review,quantity:e.quantity,message:pinkoi.template('<div>%(message)s <a class="dosth" sth="appendmsg" data-oid="%(oid)s" data-role="%(role)s">',e)+_("新增備註")+"</a></div>",memo:e.memo?'<div class="memo">'+_("★折抵說明：")+e.memo+"</div>":"",admin:e.admin?'<a class="m-button-gray m-button-mini dosth" sth="cancel" oid="'+e.oid+'" alt="'+_("取消訂單")+"</a>":"",isDetailed:v||u=="buyer"?"":"display:none;",currencySign:e.currency.symbol,destContactHTML:u=="buyer"&&e.dest_name?'\n                <div class="destName"><span class="text">'+_("轉運收件人姓名")+"：</span> <i>"+e.dest_name+'</i></div>                <div class="destAddress"><span class="text">'+_("轉運收件人地址")+"：</span> <i>"+e.dest_zipcode+" "+e.dest_address+'</i></div>                <div class="destTel"><span class="text">'+_("轉運收件人聯絡電話")+"：</span> <i>"+e.dest_tel+"</i></div>            ":"",portTimeHTML:e.dest_name?'\n                <div><span class="text">'+_("中心收到商品")+"：</span> "+t(e.port_received)+'</div>                <div><span class="text">'+_("買家許可出貨")+"：</span> "+t(e.port_permitted)+'</div>                <div><span class="text">'+_("中心寄出商品")+"：</span> "+t(e.port_shipped)+"</div>            ":""};s.paymentInfo="",s.paymentNotice="",s.paymentStatus=e.paid?_("已付款"):_("未付款"),s.total_deductible=s.coupon_deduct+s.reward_deduct+s.giftcard_deduct+s.deductible;var o=e.oid,a="";if(e.payment_method=="creditcard"||e.payment_method=="jpcreditcard"||e.payment_method=="paypal"||e.payment_method=="cathaybk"||e.payment_method=="alipay"||e.payment_method=="tenpay"||e.payment_method=="wechat")a=pinkoi.template(_("付款金額：%(payment_symbol)s %(payment)s　付款日期：%(paid)s　透過信用卡 / PayPal / 支付寶 / 財付通 / 微信掃碼付款"),e),s.paymentInfo=_("信用卡 / PayPal / 支付寶 / 財付通 / 微信掃碼安全付款"),!e.paid&&!e.canceled&&(s.paymentNotice='<span class="border_b message" style="font-size: 14px;float:right;">'+_("線上支付失敗訂單，系統十分鐘後會自動刪除")+"</span>");else if(e.payment_method=="seven")a=pinkoi.template(_("付款金額：%(payment_symbol)s%(payment)s　付款日期：%(paid)s 透過 7-11 付款"),e),s.paymentInfo='<span class="account">'+s.account+'</span><a href="/page/seven-payment" style="font-size:10px" target="_blank">'+_("如何繳費")+"?</a>";else if(e.payment_method==="sevenpayatpickup"&&u==="seller"){a=pinkoi.template(_("付款金額：%(payment_symbol)s%(payment)s　付款日期：%(paid)s 透過 7-11 付款"),e);var f=e.shipped?"":'<a class="m-button-mini" href="/apiv2/order/print_sevenpayatpickup?oid='+o+'" target="_blank" style="margin:0 0 10px;">列印寄貨服務單</a>';s.paymentInfo=' 7-11 統一超商取貨付款 <a class="m-button-mini" data-oid='+o+' onclick="pinkoi.order.getPincode(this)" style="margin:15px 0 10px">取得寄貨服務代碼</a>'+f}else e.payment_method=="famiport"?(a=pinkoi.template(_("付款金額：%(payment_symbol)s%(payment)s　付款日期：%(paid)s 透過全家付款"),e),s.paymentInfo='<span class="account">'+s.account+'</span> <a href="http://www.famiport.com.tw/intro.asp?page=5&oc=A05&ocsub=B02" style="font-size:10px" target="_blank">'+_("如何繳費")+"？</a>"):e.payment_method=="giftcard"?s.paymentInfo=_("Pinkoi 禮物卡"):(a=pinkoi.template(_("匯款金額：%(currencySign)s %(payment)s　匯款日期：%(paid)s　帳號尾數：%(serial)s"),e),s.paymentInfo=s.account);c.group[o]?(c.group[o].itemArray.push(e.tid),e.status=="open"?(c.group[o].unpaidSum+=e.subtotal,c.group[o].unpaidNum+=1*e.quantity):c.group[o].paidNum+=1*e.quantity,c.group[o].subtotal+=e.subtotal,c.group[o].handling=e.handling,c.group[o].deductible=s.total_deductible||0,c.group[o].paymentFee=e.payment_fee,c.group[o].paid!=e.paid&&(c.group[o].payment+=e.payment,c.group[o].paid=e.paid,c.group[o].paymentHistory+=a)):c.group[o]={oid:o,itemArray:[e.tid],unpaidSum:e.status=="open"?e.subtotal:0,unpaidNum:e.status=="open"?e.quantity:0,paymentFee:e.payment_fee,paidNum:e.status!="open"?e.quantity:0,subtotal:e.subtotal,handling:e.handling,deductible:s.total_deductible||0,payment:e.payment,paymentHistory:a,paid:e.paid,nick:u=="buyer"?e.sellerNick:e.buyerNick,uid:u=="buyer"?e.seller:e.buyer,currencySign:e.currency.symbol,shipping:e.shipping,created:e.created,total:e.total,symbol:e.currency.symbol,payment_total:e.payment_total,payment_symbol:e.payment_currency.symbol};var l=c.group[o],h=null;u=="seller"?s.qna=pinkoi.template("<a class=\"m-button-small\" onclick=\"pinkoi.message_modal.load({to: '%(buyer)s', title: '%(title)s', tid: '%(tid)s', oid: '%(oid)s'});\">"+_("聯絡買家")+"</a>",e):u=="buyer"&&(s.qna=pinkoi.template("<a class=\"m-button-small\" onclick=\"pinkoi.message_modal.load({to: '%(seller)s', title: '%(title)s', tid: '%(tid)s', oid: '%(oid)s'});\">"+_("聯絡設計師")+"</a>",e)),s.couponHtml="",s.couponcaption&&(s.couponHtml='<div class="coupon">'+_("使用")+s.couponcaption,s.couponsvae&&(s.couponHtml+=pinkoi.template(_("原價 $%s，優惠折抵 -$%s"),s.oprice,s.couponsave)),s.couponHtml+="</div>"),l&&l.subtotal==e.subtotal?(s.variationHtml="",s.variation&&(s.variationHtml='<div class="variation"><span class="text">'+_("商品規格：")+"</span> "+s.variation+"</div>"),s.item=pinkoi.template(m.itemRow,s),$("html").hasClass("s-zh_TW")||$("html").hasClass("s-zh_CN")?s.address_zipcode=s.zipcode+" "+s.address:s.address_zipcode=s.address+", "+s.zipcode,s.paymentActual=u=="buyer"?'<div><span class="text">'+_("總付款")+(s.payment!="-"?pinkoi.template("：</span> %(payment_symbol)s%(payment)s</div>",s):"：-"):"",n=pinkoi.template(m.detailRow,s),r.append('<div id="group_'+o+'" class="group" oid="'+o+'">                    <div class="topline clr" data-action="order">                        <div class="clr">                        <div class="sum"></div>                        <div class="toggle"><input '+(u==="buyer"?'style="display:none"':"")+'type="checkbox" class="hidden" data-action="hide" id="n-panel-order-toggle'+o+'"><label for="n-panel-order-toggle'+o+'" class="in-topline"></label></div>                        <div class="payaction"></div>                        </div>                        <div class="paid text"></div>                    </div>                    <div class="put hidden" id="n-panel-order-toggle'+o+'-put">'+n+"</div>                </div>"),h=$("#group_"+o)):(s.variationHtml="",s.variation&&(s.variationHtml='<div class="variation"><span class="text">'+_("商品規格：")+"</span> "+s.variation+"</div>"),h=$("#group_"+o),n=pinkoi.template(m.itemRow,s),h.find(".item_put").append(n)),e.status=="open"?w(o,h):b(o,h);return}function b(e,t){var n=c.group[e];u=="buyer"?(t.find(".sum").html(pinkoi.template(y.tpl.buyer_view.sum,$.extend(n,{storeURL:pinkoi.conf.storeURL(n.uid),thumb:E(e,5)}))),t.find(".minisum").html(pinkoi.template(y.tpl.buyer_view.minisum,n))):(t.find(".sum").html(pinkoi.template(y.tpl.seller_view.sum,$.extend(n,{profileURL:pinkoi.conf.profileURL(n.uid),thumb:E(e,5),numOverFive:n.itemArray.length>5}))),t.find(".minisum").html(pinkoi.template(y.tpl.seller_view.minisum,n)))}function w(e,t){var n=c.group[e];u=="buyer"?n.unpaidNum>=1?(t.find(".sum").html(pinkoi.template(y.tpl.buyer.sum,$.extend(n,{storeURL:pinkoi.conf.storeURL(n.uid)}))),t.find(".minisum").html(pinkoi.template(y.tpl.buyer.minisum,n))):t.fadeOut(1e3,function(){delete n,$(this).remove(),r.children().length==0&&C(u)}):(t.find(".sum").html(pinkoi.template(y.tpl.seller.sum,$.extend(n,{orderNum:n.itemArray.length,profileURL:pinkoi.conf.profileURL(n.uid),thumb:E(e,5),numOverFive:n.itemArray.length>5}))),t.find(".minisum").html(pinkoi.template(y.tpl.seller.minisum,$.extend(n,{orderNum:n.itemArray.length}))))}function E(e,t){var n="",r=c.group[e];t=t&&t<r.itemArray.length?t:r.itemArray.length;var i=c.order[e].photo.split(",");for(var s=0,o=Math.min(t,i.length);s<o;++s){var u=r.itemArray[s];n+=pinkoi.template('<a href="/product/%(tid)s" target="_blank"><img src="%(photo)s"/></a>',{tid:u,photo:i[s]})}return n}function S(e,t){var n=c.group[t],r="",i=E(t,5),o=n.unpaidSum,a=n.deductible,f=n.handling,l=n.payment_symbol,h=n.payment.total;if(e=="paid")r='<h3 class="title_">'+_("通知設計師你已付款 <b>$ %(payment_total)s</b>")+'</h3>                        <div class="topright">%(photo)s</div>                        <div class="form_ fillbg_">                            <div>                                <label>'+_("輸入匯款總金額，只需要輸入金額數字即可")+'</label>                                <input type="text" class="itext" limit_val="integer"/>                            </div>                            <div>                                <label>'+_("輸入帳號末五碼")+'</label>                                <input type="text" class="itext" limit_val="integer"/>                            </div>                        </div>                        <div class="clr">                            <a class="m-button dosth" sth="ajaxPaid" oid="%(oid)s">'+_("送出")+'</a>　<a class="gcancel" onclick="pinkoi.gmodal.close();">'+_("取消")+"</a>                        </div>";else if(e=="shipped")r='<h3 class="title_">'+_("商品已出貨通知 <b>訂單編號：%(oid)s)</b>")+'</h3>                        <div class="topright">%(photo)s</div>'+_("該欄位有最多能有 32 個字數限制，請提供追蹤號碼給買家查詢（例如：609346100435010 郵局掛號包裹），其餘事項請用「聯絡買家」溝通。")+'                        <div class="form_ fillbg_">                            <input type="text" class="itext" text_limit="32"/>                        </div>                        <div class="clr">                            <a class="m-button dosth" sth="ajaxShipped" oid="%(oid)s">'+_("送出")+'</a>　<a class="gcancel" onclick="pinkoi.gmodal.close();">'+_("取消")+"</a>                        </div>";else if(e=="received")u=="buyer"?s=_('<span style="color:#e00;">如果尚未收到，請不要按下「送出」</span>。按下確認後，系統會同步通知設計師您已經收到商品，該交易即完成。'):u=="seller"&&(s=_("按下確認，表示你確定買家已經收到商品，該交易即完成。")),r='<h3 class="title_">'+_("商品已收到確認 <b>訂單編號：%(oid)s</b>")+'</h3>                        <div class="topright">%(photo)s</div>                        <div class="message_" style="margin-bottom:15px;">'+s+'</div>                        <div class="clr">                            <a class="m-button dosth" sth="ajaxReceived" oid="%(oid)s">'+_("送出")+'</a>　<a class="gcancel" onclick="pinkoi.gmodal.close();">'+_("取消")+"</a>                        </div>";else if(e=="cancel"){var p=$("#order_"+t),d="",v=p.find(".left .who").html();return p.find("table .title").each(function(e,t){d+=$(t).html()}),r='<h3 class="title_">'+_("取消訂單")+' <b>(%(oid)s)</b></h3>                         <div class="topright">%(photo)s</div>                        <div class="caption_">'+_("維護買賣雙方的誠信原則，請勿任意取消訂單以免降低你的個人信用評價")+'</div>                        <div class="fillbg_ box_" style="font-size:14px;">                            <div><label>'+_("刪除訂單的原因")+'</label>                                <textarea name="cancelreason"></textarea>                            </div>                        </div>                        <div class="clr">                            <a class="m-button dosth" sth="ajaxCancel" oid="%(oid)s">'+_("確定取消訂單")+'</a>　                            <a class="gcancel" onclick="pinkoi.gmodal.close();">'+_("保留訂單")+"</a>                        </div>",pinkoi.template(r,{oid:t,title:d,seller:v,photo:i})}return pinkoi.template(r,{oid:t,subtotal:o,photo:i,handling:f,payment_total:h,payment_symbol:l})}function x(e,t){try{var n=S(t,e);pinkoi.gmodal.content.css({lineHeight:"28px"}),pinkoi.gmodal.load(n),pinkoi.forms.limitVal(".form_"),pinkoi.forms.textLimit(".form_")}catch(r){alert(r)}}function T(e,t){var n='<span class="text">'+_("目前狀態：")+"</span>",r="",i="";return e=="open"?(u=="seller"&&(!t.scheduled&&t.payment_method=="sevenpayatpickup"&&(i+=pinkoi.template('<a class="m-button-small dosth" id="scheduled_%(oid)s" sth="scheduled" data-oid="%(oid)s" data-buyer="%(buyer)s" role="%(role)s">'+_("通知預估出貨日期")+"</a>",t)),t.sreviewed||(i+=pinkoi.template(' <a class="m-button-small dosth" sth="reviewed" oid="%(oid)s" role="%(role)s">'+_("給買家評價")+"</a>",t)),t.payment_method=="sevenpayatpickup"&&(r+=' <a class="m-button-gray m-button-mini dosth" sth="cancel" oid="'+t.oid+'">'+_("取消訂單")+"</a>")),t.payment_method=="cathaybk"||t.payment_method=="paypal"||t.payment_method=="alipay"||t.payment_method=="creditcard"?u=="buyer"&&(r+='<a class="m-button-mini" href="/cart">'+_("請前往購物車重新付款")+"</a></span>"):t.payment_method!="sevenpayatpickup"&&(r+=' <a class="m-button-gray m-button-mini dosth" sth="cancel" oid="'+t.oid+'">'+_("取消訂單")+"</a>")):e=="paid"?u=="seller"?(r+='<a class="dosth m-button-mini" sth="shipped" oid="'+t.oid+'">'+_("通知買家已出貨")+"</a> ",t.scheduled||(i+=pinkoi.template('<a class="m-button-small dosth" id="scheduled_%(oid)s" sth="scheduled" data-oid="%(oid)s" data-buyer="%(buyer)s" role="%(role)s">'+_("通知預估出貨日期")+"</a>",t)),t.sreviewed||(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" oid="%(oid)s" role="%(role)s">'+_("給買家評價")+"</a>",t))):u=="buyer"&&!t.breviewed&&!t.overdue&&(t.port_shipped===undefined||t.port_shipped)&&(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" role="%(role)s" oid="%(oid)s">'+_("給評價拿優惠券")+"</a>",t)):e=="shipped"?u=="seller"?t.sreviewed||(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" oid="%(oid)s" role="%(role)s">'+_("給買家評價")+"</a>",t)):u=="buyer"&&!t.breviewed&&!t.overdue&&(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" role="%(role)s" oid="%(oid)s">'+_("給評價拿優惠券")+"</a>",t)):e=="received"||e=="reviewed"?u=="seller"?t.sreviewed||(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" oid="%(oid)s" role="%(role)s">'+_("給買家評價")+"</a>",t)):u=="buyer"&&!t.breviewed&&!t.overdue&&(i+=pinkoi.template('<a class="m-button-small dosth" sth="reviewed" role="%(role)s" oid="%(oid)s">'+_("給評價拿優惠券")+"</a>",t)):e=="canceled"&&u=="seller"&&(t.sreviewed||(i+=pinkoi.template(' <a class="m-button-small dosth" sth="reviewed" oid="%(oid)s" role="%(role)s">'+_("給買家評價")+"</a>",t))),u=="buyer"?i+=pinkoi.template('<a class="m-button-small" href="/message/thread?other=%(seller)s">'+_("查看對話記錄")+"</a>",t):i+=pinkoi.template('<a class="m-button-small" href="/message/thread?other=%(buyer)s">'+_("查看對話記錄")+"</a>",t),{action:r,review:i}}function N(){r.bind("click",function(e){e.stopPropagation();var t=$(e.target);if(t.hasClass("dosth")){var n=t.attr("sth");if(/scheduled/.test(n))pinkoi.order.scheduled_modal.load(t.data("oid"),t.data("buyer"));else if(/appendmsg/.test(n))pinkoi.order.append_message_modal.load(t.data("oid"),t.data("role"));else if(/cancel|paid|shipped|received/.test(n)){var r=t.attr("oid");r&&x(r,n)}else if(/reviewed/.test(n)){var r=t.attr("oid"),i=t.attr("role");if(r&&i){var s=c.order[r],o=c.group[r],u=function(){$("[sth=reviewed][oid="+r+"].dosth").remove()};i=="seller"?pinkoi.review_modal.load({to:s.buyer,nick:s.buyerNick,title:s.title,other:o.itemArray.slice(1).join(","),tid:o.itemArray[0],oid:s.oid,role:i,seller:s.
seller},u):pinkoi.review_modal.load({to:s.seller,nick:s.sellerNick,title:s.title,other:o.itemArray.slice(1).join(","),tid:o.itemArray[0],oid:s.oid,role:i,seller:s.seller},u)}}}}),pinkoi.gmodal.content.bind("click",function(e){var t=$(e.target);if(t.hasClass("dosth")){var n=t.attr("sth");if(/ajaxCancel|ajaxPaid|ajaxShipped|ajaxReceived|ajaxReviewed/.test(n)){var r=pinkoi.gmodal.content.find(".itext");if(r.length>1){var i=[];r.each(function(e,t){i.push($(t).val())})}else var i=r.val();var s=t.attr("oid");if(n=="ajaxShipped"&&s){if(!i){pinkoi.drawer.on(_("別忘了填寫商品包裹的追蹤編號，讓買家查詢，這也可以大大增進買家對你品牌的信任"));return}pinkoi.request("POST",pinkoi.uri.order_shipped,{data:{oid:s,tracking:i},success:function(e){e.result?(pinkoi.gmodal.close(),$("#group_"+s).fadeOut(1500,function(){$("#group_"+s).remove()}),pinkoi.drawer.on(_("已通知買家"))):pinkoi.error()}})}else if(n=="ajaxReceived")pinkoi.request("POST",pinkoi.uri.order_received,{data:{oid:s},success:function(e){e.result?(pinkoi.gmodal.close(),$("#group_"+s).fadeOut(1500,function(){$("#group_"+s).remove()}),pinkoi.drawer.on(_("訂單已完成，將自動歸檔到歷史訂單"))):pinkoi.error()}});else if(n=="ajaxCancel"){var o=pinkoi.gmodal.content.find("textarea[name=cancelreason]").val();if(!o){alert(_("為保障彼此交易的權利，請提供取消訂單的緣由！謝謝！"));return}pinkoi.request("POST",pinkoi.uri.order_canceled,{data:{oid:s,reason:o},success:function(e){if(e.result){pinkoi.gmodal.close();var t=e.result[0].oid,n=$("#order_"+t);n.fadeOut(1e3,function(){delete c.group[t],$(this).parents(".group").remove(),$(this).remove(),$("#panel .mod_orderlist .group").length==0&&C(u)}),pinkoi.point.renew()}else pinkoi.error()}})}}}})}function C(e){if(e=="buyer"){var t=$("#panel .menu .sub li a.active");t.length==0&&(t=$("#panel #nav .box a.active"));var n=pinkoi.template(_('<center class="noresult">目前沒有%(page)s訂單明細</center>'),{href:t.attr("href"),page:t.length?t.html():""})}else var t=$("#panel .menu .sub li a.active"),n=pinkoi.template(_('<center class="noresult">目前沒有%(page)s訂單明細</center>'),{href:t.attr("href"),page:t.length?t.html():""});r.html(n)}var n=0,r,o,u,a={seller:1,buyer:1},f={open:1,paid:1,shipped:1,received:1,reviewed:1,canceled:1},l={start:0,limit:20,nextIs:!0},c={};c.order={},c.group={};var h="order",p={vip:[_("尊貴級客戶"),_("累計消費超過 21600 元且會給交易評價")],platinum:[_("白金級客戶"),_("累積消費超過 14400 元且會給交易評價")],gold:[_("金級客戶"),_("累積消費超過 7200 元")],silver:[_("銀級客戶"),_("累積消費超過 5000 元")]},d=location.href,v=!1;d.indexOf(pinkoi.conf.host+"/order")!==-1&&(v=!0);var m={detailRow:'<div class="order  clr" id="order_%(oid)s">                <div class="head">'+_("訂單內容")+'%(paymentNotice)s</div>                <div class="clr">                    <div class="left">                            <div class="time"><span class="text">%(created)s</span></div>                            <div class="serial"><span class="text">'+_("訂單編號")+'：</span> <a onclick="pinkoi.order.toggleDetail(this);return false;">%(oid)s</a> <a target="_blank" class="newtab" href="/order?role=%(role)s&oid=%(oid)s"><img src="//s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/newtab.png"></a></div>                            <div class="who"><span class="text">'+_("設計師")+'：</span> <a href="%(sellerProfile)s">%(sellerNick)s</a></div>                            <div class="buyer"><span class="text">'+_("購買人")+'：</span> <a href="%(buyerProfile)s">%(buyerNick)s</a> %(buyerRepeated)s %(buyerRank)s</div>                            <div class="recipient"><span class="text">'+_("收件人姓名")+'：</span> <i>%(name)s</i></div>                            <div class="address" %(address_hide)s><span class="text">'+_("收件人地址")+'：</span> <i>%(address_zipcode)s</i></div>                            <div class="tel"><span class="text">'+_("收件人聯絡電話")+'：</span> <i>%(tel)s</i></div>                            <div class="shipping"><span class="text">'+_("運送方式")+'：</span><i> %(shipping)s </i> %(handling)s</div>                            %(destContactHTML)s                            %(tax)s                            %(sevenstore)s                            <div class="payment-method"><span class="text">'+_("付款方式")+'：</span> %(paymentInfo)s</div>                            <div><span class="text">'+_("付款狀態")+'：</span> %(paymentStatus)s</div>                            <div class="scheduled"><span class="text">'+_("預計出貨時間")+'：</span> %(scheduled)s</div>                    </div>                    <div class="right detail_right">                        <div class="current_action">%(statusAction)s</div>                        <div class="review_action">%(qna)s%(reviewAction)s</div>                        <table width="100%" height="100%"><tbody>                            <tr>                                <td class="border_b status">%(statusTitle)s</td>                            </tr>                            <tr>                                <td class="item_put">%(item)s</td>                            </tr>                            <tr><td class="admin">%(admin)s</td></tr>                        </tbody></table>                    </div>                </div>                <div class="bottom">                    <table width="100%" height="100%"><tbody>                            <tr><td class="minisum"></td></tr>                            <tr><td class="message">%(memo)s%(message)s</td></tr>                            <tr><td>'+_('如有任何問題，請參考 <a href="/faq/seller">常見問與答</a>')+'</td></tr>                    </tbody></table>                </div>            </div>            <div class="clr payment" id="payment_%(oid)s" style="%(isDetailed)s">            <div class="head">'+_("交易追蹤")+'</div>            <div class="left">                <div><span class="text">'+_("訂單確認")+'：</span> %(created)s</div>                <div><span class="text">'+_("訂單取消")+'：</span> <b style="color:#FF0000;">%(canceled)s</b></div>                <div><span class="text">'+_("買家付款")+'：</span> %(paid)s</div>                <div><span class="text">'+_("商品寄出")+'：</span> %(shipped)s</div>                %(portTimeHTML)s                <div><span class="text">'+_("買家評價")+'：</span> <a href="/user/%(uid)s?onload=cb_review">%(breviewed)s</a></div>                <div><span class="text">'+_("設計師評價")+'：</span> <a href="/user/%(uid)s?onload=cb_review">%(sreviewed)s</a></div>            </div>            <div class="right">                <div><span class="text">'+_("付款資訊")+'：</span> %(paymentInfo)s</div>                <div><span class="text">'+_("付款狀態")+'：</span> %(paymentStatus)s</div>                <div><span class="text">'+_("商品追蹤號碼")+'：</span> %(tracking)s</div>                %(paymentActual)s                <div><span class="text">'+_("訂單取消理由")+": </span> %(reason)s</div>            </div>            </div>",itemRow:['<div class="item clr">','<div class="box_">','<div class="photo"><a href="%(itemURL)s"><img src="%(photo)s"/></a></div>',"</div>",'<div class="midbox_ box_">','<div class="title"><a href="%(itemURL)s">%(title)s</a></div>','<div class="quantity"><span class="text">'+_("訂購數量")+'：</span> <i>%(quantity)s</i>，<span class="text">'+_("售價：")+'</span>%(symbol)s%(price)s，<span class="text">'+_("原價：")+"</span>%(symbol)s%(oprice)s</div>","%(variationHtml)s","%(couponHtml)s",'<div class="subtotal"><span class="text">'+_("價錢加總")+"：</span>%(symbol)s%(subtotal)s</div>","</div>","</div>"].join("")};return y.tpl={buyer_view:{sum:_('對設計師 <a href="%(storeURL)s" target="_blank">%(nick)s</a> 的訂單，總共 %(paidNum)s 件商品，訂單總金額：%(symbol)s%(total)s，金流手續費：%(symbol)s%(paymentFee)s，折抵金額：%(symbol)s%(deductible)s'),paid:"%(paymentHistory)s",minisum:_('總金額：%(subtotal)s (商品) + %(handling)s (運費) + %(paymentFee)s (金流手續費) - %(deductible)s (折抵) = <b class="mark-value">%(symbol)s%(total)s</b>')},buyer:{sum:_('訂單共有 %(unpaidNum)s 件商品　總金額：%(unpaidSum)s (商品) + %(handling)s (運費) + %(paymentFee)s (金流手續費) - %(deductible)s (折抵) = <b class="mark-value">%(symbol)s%(total)s</b>　設計師：<a href="%(storeURL)s" target="_blank">%(nick)s</a>'),minisum:_('總金額：%(unpaidSum)s (商品) + %(handling)s (運費) + %(paymentFee)s (金流手續費) - %(deductible)s (折抵) = <b class="mark-value">%(symbol)s%(total)s</b>')},seller_view:{sum:'<div class="order-row"><div class="order-checkbox order-col print-toggle"><input type="checkbox" value="%(oid)s" checked data-action="single-order"></div><div class="order-col"><span>%(oid)s</span><a href="%(profileURL)s" target="_blank">%(nick)s</a></div><div class="order-thumb order-col overflow-%(numOverFive)s">%(thumb)s</div><div class="order-sum order-col"><span>'+_("購買共 %(paidNum)s 件商品")+"</span>"+"<span>"+_("總計")+" %(symbol)s%(total)s</span>"+"</div>"+'<div class="order-shipping order-col">'+"<span>%(created)s</span>"+"<span>%(shipping)s</span>"+"</div>"+"</div>",paid:"%(paymentHistory)s",minisum:_('總金額：%(subtotal)s (商品) + %(handling)s (運費) + %(paymentFee)s (金流手續費) - %(deductible)s (折抵) = <b class="mark-value">%(symbol)s%(total)s</b>')},seller:{sum:'<div class="order-row"><div class="order-checkbox order-col print-toggle"><input type="checkbox" value="%(oid)s" checked data-action="single-order"></div><div class="order-col"><a>%(oid)s</a><a href="%(profileURL)s" target="_blank">%(nick)s</a></div><div class="order-thumb order-col overflow-%(numOverFive)s">%(thumb)s</div><div class="order-sum order-col"><span>'+_("購買共 %(unpaidNum)s 件商品")+"</span>"+"<span>"+_("總計")+" %(symbol)s%(total)s</span>"+"</div>"+'<div class="order-shipping order-col">'+"<span>%(created)s</span>"+"<span>%(shipping)s</span>"+"</div>"+"</div>",minisum:_('總金額：%(unpaidSum)s (商品) + %(handling)s (運費) + %(paymentFee)s (金流手續費) - %(deductible)s (折抵) = <b class="mark-value">%(symbol)s%(total)s</b>')}},{init:function(e,t,n){if(!t||!a[t])return pinkoi.error("init","wrong order type: buyer or seller required"),!1;u=t,r=$("#"+e),$(function(){N()});if(n){var s="";if(n instanceof Array)if(n.length>0)for(i in n)n.hasOwnProperty(i)&&y(n[i]);else C(t);else n instanceof Object&&y(n)}var o=pinkoi.urlParam.get("oid");o&&pinkoi.urlParam.get("action")=="scheduled"&&setTimeout(function(){$("#scheduled_"+o).click()},0)},toggleGroup:function(e){var t=$(e),n=t.attr("action");n=="hide"?(t.parents(".topline").next(".put").hide(),t.children("img").attr("src","/media/img/plus.png"),t.attr("action","show")):(t.parents(".topline").next(".put").show(),t.children("img").attr("src","/media/img/minus.png"),t.attr("action","hide"))},toggleDetail:function(e){var t=$(e);t.closest(".group").find(".payment").toggle(800)}}}(),pinkoi.order.scheduled_modal=function(){var e=['<div class="g_mod_scheduled">','<h2 class="title_">',_("通知買家預估出貨時間"),"</h2>","<form>",'<div class="fillbg_">',"<p>"+_('此訂單預計於 <input class="scheduled" readonly style="width:80px;"> 出貨。')+"</p>","</div>",'<h2 class="title_">',_("想對買家說的話（選填）"),"</h2>",'<div class="fillbg_"><textarea class="scheduled-message" rows="7" score="5"></textarea></div>',"</div>","</form>",'<div class="footer_"><a class="m-button g_btns_send submit">'+_("送出")+"</a></div>","</div>"].join("");return{load:function(t,n){if(t===undefined)return;var r=pinkoi.template(e,{oid:t});pinkoi.gmodal.load(r),pinkoi.gmodal.content.find(".scheduled").datepicker({closeText:_("好"),currentText:_("現在"),closeText:_("確定"),prevText:"<",nextText:">",dateFormat:"yy/mm/dd",monthNames:[_("一月"),_("二月"),_("三月"),_("四月"),_("五月"),_("六月"),_("七月"),_("八月"),_("九月"),_("十月"),_("十一月"),_("十二月")],monthNamesShort:[_("一月"),_("二月"),_("三月"),_("四月"),_("五月"),_("六月"),_("七月"),_("八月"),_("九月"),_("十月"),_("十一月"),_("十二月")],dayNamesMin:[_("日"),_("一"),_("二"),_("三"),_("四"),_("五"),_("六")],minDate:new Date}),pinkoi.gmodal.content.find(".submit").click(function(e){var n=$(e.target);if(n.data("disabled"))return;var r=pinkoi.gmodal.content.find(".scheduled").val();if(!/\d{4}\/\d{1,2}\/\d{1,2}/.test(r)){pinkoi.gmodal.content.find(".scheduled").css("background-color","#FFE6E6"),pinkoi.drawer.on(_("請選擇正確的日期。"));return}var i={scheduled:r.replace(/\//g,"-"),oid:t,description:$(".scheduled-message").val()||""};n.data("disabled",!0),pinkoi.request("POST",pinkoi.uri.order_scheduled,{data:i,success:function(){n.data("disabled",!1),pinkoi.order.scheduled_modal.close(),pinkoi.drawer.on(_("已送出訊息")),$("[sth=scheduled][data-oid="+t+"]").remove()}})})},close:function(){pinkoi.gmodal.close()}}}(),pinkoi.order.append_message_modal=function(){var e=['<div class="g_mod_scheduled">','<h2 class="title_">'+_("新增你的備註訊息，你的訊息將會被加到原本備註訊息後面")+"</h2>",'<div class="caption_">%(caption)s</div>',"<form>",'<div class="fillbg_"><textarea rows="5"></textarea></div>',"</div>","</form>",'<div class="footer_"><a class="m-button g_btns_send submit">'+_("送出")+"</a></div>","</div>"].join("");return{load:function(t,n){var r="";if(t===undefined)return;n=="buyer"?r=_("下單後若有些資料需要補充或是修改，請在這裡註記，設計師會另外收到一封提醒信"):r=_("提醒你，訂單備註內容同時會寄一份副本給客人，以便雙方確認細節，填寫時請注意措辭與內容，以免造成誤會");var i=pinkoi.template(e,{oid:t,caption:r});pinkoi.gmodal.load(i),pinkoi.gmodal.content.find(".submit").click(function(e){var n=$(e.target),r=pinkoi.gmodal.content.find("textarea").val();if(n.data("disabled"))return;if(!r)return;pinkoi.request("POST",pinkoi.uri.order_append,{data:{oid:t,description:r},success:function(){n.data("disabled",!1),pinkoi.order.append_message_modal.close(),$groupJQ=$("#group_"+t);var e=$groupJQ.find(".message"),i=e.find("div").html()||"";i?e.find("div").html(i+" "+r):e.append(" "+r),pinkoi.drawer.on(_("已新增"))}})})},close:function(){pinkoi.gmodal.close()}}}(),pinkoi.order.getPincode=function(e){require(["ui/backdrop","app/modules/request"],function(t,n){t.show({loader:1});var r=$(e),i=r.attr("data-oid");n({type:"POST",url:"/apiv2/order/get_pincode",data:{oid:i}}).done(function(e){t.hide(),e.error?alert(e.error.message):r.replaceWith('<div style="margin:15px 0 10px;">寄貨服務代碼為 '+e.result[0].pincode+'<br><a href="/magz/1yJT5Spx" target="_blank">了解出貨流程？</a></div>')})})},typeof pinkoi=="undefined"&&(pinkoi={}),pinkoi.category=function(){function s(){var s='<select id="category" size="10" name="category">';for(var u in e)e.hasOwnProperty(u)&&(s+='<option value="'+u+'">'+e[u][0]+"</option>");s+="</select>",t.html(s),t.find("select").change(function(e){var t=parseInt(this.value,10);t>=0&&(o(t),n&&(r.html(this.options[this.selectedIndex].innerHTML),i.empty(),n.css({fontSize:12})))})}function o(r){$("#subcategory").remove();var s='<select size="10" id="subcategory" name="subcategory">';for(var o in e[r][1])e[r][1].hasOwnProperty(o)&&(s+='<option value="'+e[r][1][o][1]+'">'+e[r][1][o][2]+"</option> ");s+="</select>";var u=$(s);u.click(function(e){e.stopPropagation();var t=e.target;if(t.tagName.toLowerCase()=="option"){var r=$(t).attr("value");r&&n&&i.html(" ＞ "+t.innerHTML)}}),t.append(u)}function u(o,u,a,f){e=o,t=$("#"+u),s(),f&&(n=$("#"+f),n.html('<span class="catrst"></span><span class="subrst"></span>'),r=n.find(".catrst").eq(0),i=n.find(".subrst").eq(0))}var e,t,n=null,r,i;return{init:u}}();pinkoi=typeof pinkoi=="undefined"?{}:pinkoi,pinkoi.namespace("pinkoi.store"),pinkoi.store.showPolicyModal=function(e){function n(e,t){return'            <div class="box_">                <h2 class="title_">'+e+'</h2>                <p class="fillbg_">'+pinkoi.util.nl2br(t)+"</p>            </div>"}var t='<div class="g_page_store_policy">%(payment)s%(shipping)s%(rnr)s%(other)s</div>';pinkoi.request("GET",pinkoi.uri.store_get,{data:{uid:e,attr:"policy"},success:function(r){var i=r.result||{};pinkoi.gmodal.load(pinkoi.template(t,{payment:i.payment?n(_("付款政策"),i.payment):"",shipping:i.shipping?n(_("商品運送政策"),i.shipping):"",rnr:i.rnr?n(_("退換貨政策"),i.rnr):"",other:i.other?n(_("一般政策"),i.other):""}),{bypass:!0})}})},pinkoi.store.showStoryModal=function(e){var t='        <h2 class="title_">'+_("關於這間設計館")+'</h2>        <p class="fillbg_ p_" style="text-align:left;">%(story)s</p>';pinkoi.request("GET",pinkoi.uri.store_get,{data:{uid:e,attr:"story"},success:function(n){pinkoi.gmodal.load(pinkoi.template(t,{story:pinkoi.util.nl2br(n.result||"")}),{bypass:!0})}})},pinkoi.store.makeFan=function(e,t,n){pinkoi.makeFan(t,n,function(){n=="fan"?(pinkoi.drawer.on(_("已關注")),$(e).replaceWith('<a class="m-button-gray m-button-stretch" onclick="pinkoi.store.makeFan(this, \''+t+"', 'unfan');\">"+_("移除關注")+"</a>")):n=="unfan"&&($(e).replaceWith('<a class="m-button-green m-button-stretch" onclick="pinkoi.store.makeFan(this, \''+t+"', 'fan');\">"+_("加入關注")+"</a>"),pinkoi.drawer.on(_("已移除關注")))})},typeof pinkoi=="undefined"&&(pinkoi=typeof pinkoi=="undefined"?{}:pinkoi),pinkoi.namespace("pinkoi.panel.store.list"),pinkoi.panel.store.list=function(){function v(e){e.stopPropagation();var t=$(e.target);if(t.hasClass("draggable")){var n=t.attr("src"),r=t.attr("srcuri"),s=t.hasClass("picked"),o=t.hasClass("official-photo"),u=t.hasClass("official-photo-thumb");s?i.addClass("picked"):i.removeClass("picked"),o?(i.addClass("official-photo-proxy"),i.data("title",t.data("title"))):(i.removeClass("official-photo-proxy"),i.removeData("title")),u?i.addClass("official-photo-thumb"):i.removeClass("official-photo-thumb"),i.attr("src","http://cdn04.pinkoi.com/pinkoi.site/space.gif"),document.body.style.width,i.attr("src",n);var a=s?0:parseInt(t.css("border-top-width"));i.css({width:t.width(),height:t.height(),left:t.position().left+a,top:t.position().top+a}).show()}}function m(e){i.hide()}function g(e){var t=$(e.target);if(t.hasClass("ui-draggable"))if(!t.hasClass("picked")){if(t.hasClass("official-photo-proxy")){b(i,l[0]);return}var n=a.length;if(n>=f){pinkoi.drawer.on(_("慢一點慢一點，每件商品只能有五張圖片"));return}b(i,l[n])}else w(t)}function y(e,t,n,r,i){var s=a.length,u=!1;for(var c=0;c<l.length;c++)l[c].find(".official-photo-proxy").length&&(u=!0);if(n)r=0;else{if(r>=s||u&&t)r=s;!u&&t&&(r=0)}var h=$.inArray(e,a);if(h!==-1){if(h===r||r>=s)return pinkoi.drawer.on(_("這張圖片已經被選過了")),!1;var d=a[r];a[r]=e,a[h]=d,l[h].html('<img src="'+d+'" class="draggable picked"/>'),l[r].html('<img src="'+e+'" class="draggable picked"/>')}else{n&&u?a.splice(0,1,e):a.splice(r,0,e);if(a.length>=f){var v=a[f];a.length=f,o.find('img[src="'+v+'"]').removeClass("hide")}for(var c=0;c<a.length;c++)l[c].html('<img src="'+a[c]+'" class="draggable picked"/>');i&&$("#i18n-meta").find('[name="title"]').val(i+" - ");if(n||!n&&u)l[0].children("img").droppable("disable").addClass("official-photo-proxy official-photo-thumb"),l[0].droppable("disable");!n&&!u&&l[0].droppable("enable"),o.find('img[src="'+e+'"]').addClass("hide")}a[0]&&p.html('<img src="'+a[0]+'" class="picked"/>')}function b(e,t){var n=t.hasClass("main_photo"),r=e.hasClass("official-photo-proxy"),i=e.attr("src"),s=parseInt(t.attr("no")),o=r?e.data("title"):null;y(i,n,r,s,o),e.hide()}function w(e){var t=e.attr("src"),n=$.inArray(t,a);if(n!==-1){l[a.length-1].html(""),a.remove(n);for(var r=n;r<a.length;r++)l[r].html('<img src="'+a[r]+'" class="draggable picked"/>');a[0]?p.html('<img src="'+a[0]+'" class="picked"/>'):p.html(""),i.data("dragging")||i.hide(),o.find('img[src="'+t+'"]').removeClass("hide")}}var e=$("#wizard").scrollable({size:1,clickable:!1,keyboard:!1});if(!e.length)return;var t=e.scrollable(),n=$("#drawer");pinkoi.panel.store.list.scrollableApi=t;var r=e.find("#current_list");t.onBeforeSeek(function(t,n){$("#status a").removeClass("active").eq(n).addClass("active");var i="",s=e.find("#dragdrop_wrap #droppable_put .thumb_photos img");$.each(s,function(){i+='<img src="'+$(this).attr("src")+'"/>'}),r.html(i),$("html,body").animate({scrollTop:$("#status").offset().top-5},400)}),$("#status a").bind("click",function(e){var n=parseInt($(e.target).attr("seekto"));t.seekTo(n),n==5&&pinkoi.panel.store.list.preview()});var i=$("#draggable_proxy").css({position:"absolute"}),s=$("#dragdrop_wrap").disableSelection(),o=$("#dragdrop_get"),u=$("#droppable_put"),a=[];pinkoi.panel.store.list.picked=a;var f=5,l=[],c=$(["<div>",'<div class="droppable main_photo"></div>','<div class="thumb_photos"></div></div>','<div class="note">','<h3 style="font-size:12px;margin:0px;padding:0px;">',_("上架小秘訣："),"</h3>","<ol>","<li>",_("用滑鼠在方框中的圖片上點一下，可以移除照片"),"</li>","<li>",_("用滑鼠按住方框中的圖片，可以拖拉圖片來互換排列順序"),"</li>","<li>",_("公版圖片固定在第一張，成為此商品縮圖，無法改變排序"),"</li>","</ol>","</div>"].join(""));u.append(c);var h=c.find(".thumb_photos").eq(0),p=c.find(".main_photo").eq(0);for(var d=0;d<f;d++)l[d]=$('<div class="droppable thumb_photo" no="'+d+'"></div>'),h.append(l[d]);i.draggable({containment:"document",start:function(e,t){i.data("dragging",!0),s.unbind("mouseover",v),i.unbind("mouseleave",m)},stop:function(e,t){i.hide(),s.bind("mouseover",v),i.bind("mouseleave",m),i.data("dragging",!1)},cancel:".official-photo-thumb"}),$(".dragdrop_put .droppable").droppable({tolerance:"pointer",drop:function(e,t){var n=t.draggable,r=$(this);if(!n.hasClass("official-photo-proxy")&&a.length>=f){pinkoi.drawer.on(_("慢一點慢一點，每件商品只能有五張圖片"));return}b(n,r)},out:function(e,t){if(i.hasClass("picked")){var n=t.draggable;w(n)}}}),s.bind("mouseover",v),i.bind("mouseleave",m),s.bind("click",g),$("#dragdrop_wrap").find(".official-photo-add-link").on("click",function(e){e.preventDefault();var t=$(this),n=t.parent().find("img"),r=n.attr("srcuri"),i=n.data("title");y(r,!0,!0,0,i)}),pinkoi.panel.store.list.i18nMeta=new pinkoi.panel.itemI18nMeta("#i18n-meta");var E=e.find(".variation-holder"),S=function(e){var t=E.find(":input[name=variation]"),n=0;t.each(function(){var e=$(this),t=$.trim(e.val());t&&(n+=1)}),t.length-n<2&&E.find(":input[name=variation]:last").after('<input type="text" name="variation" class="text" onblur="pinkoi.panel.store.list.variationOnblur();"/>')};E.bind("click",S),pinkoi.panel.store.list.variationOnblur=S;var x=new Date;$("#preorder").on("click",function(){$("#checkpreorder").attr("checked","checked"),$("#preorderNote").show()}).datetimepicker({closeText:_("好"),timeText:_("時間"),hourText:_("時"),minuteText:_("分"),currentText:_("現在"),closeText:_("確定"),prevText:"<",nextText:">",dateFormat:"yy-mm-dd",monthNames:[_("一月"),_("二月"),_("三月"),_("四月"),_("五月"),_("六月"),_("七月"),_("八月"),_("九月"),_("十月"),_("十一月"),_("十二月")],monthNamesShort:[_("一月"),_("二月"),_("三月"),_("四月"),_("五月"),_("六月"),_("七月"),_("八月"),_("九月"),_("十月"),_("十一月"),_("十二月")],dayNamesMin:[_("日"),_("一"),_("二"),_("三"),_("四"),_("五"),_("六")],minDateTime:x,maxDateTime:new Date(+x+5184e6)}),pinkoi.onbeforeunload(function(){if($("#droppable_put .thumb_photos img").length)return _("離開頁面後，目前的編輯將會被清空......")})},pinkoi.panel.store.list.preview=function(){var e="",t={};$("#droppable_put").find("img.picked").each(function(n){var r=this.src.split("/");r=r[r.length-1],r.indexOf(".png")>-1&&(r=r.replace(".png",""));if(n===0){var i='                <div class="primary">                    <div style="border:1px solid #EAEAEA;padding:6px;width:90%;"><img src="%(src)s"/></div>                </div>                <div class="thumb">                    <img src="%(src)s"/><input type="hidden" name="photo" value="%(key)s"/>';e+=pinkoi.template(i,{src:this.src,key:r})}else if(!t[r]){var i='<img src="%(src)s"/><input type="hidden" name="photo" value="%(key)s"/>';e+=pinkoi.template(i,{src:this.src,key:r})}t[r]=!0}),e!==""&&(e+="</div>");var n='<div class="double">                        <div class="photos clr">%(photolist)s</div>                    </div>                    <div class="double">                        <div class="wrap">                            <div class="title">%(title)s</div>                        </div>                        <div class="wrap hr">                            <div><span class="price">'+pinkoi.globals.get("storeCurrency").symbol+" %(price)s</span>（"+_("現貨數量：")+'%(quantity)s）</div>                        </div>                        <div class="wrap hr">                            <div class="category">'+_("分類：")+'%(category)s</div>                            <div class="material">'+_("材質：")+'%(material)s</div>                            <div class="madein">'+_("產地/製造方式：")+'%(madein)s</div>                            <div class="color">'+_("顏色：")+'%(color)s                                 <a style="background-color:%(color)s;display:inline-block;height:20px;width:20px;vertical-align:middle;"></a>                            </div>                            <div class="tag" style="margin-top:25px;">%(tag)s</div>                        </div>                        <div class="description wrap hr"><p>%(description)s</p></div>                        <div class="wrap hr">                            '+_("提醒你可以到")+' <a href="/panel/store?p=shipping" target="_blank">'+_("運送/運費設定")+"</a>"+_(" 及")+'                             <a href="/panel/store?p=payment" target="_blank">'+_("交易/付款設定")+"</a> <br/>                            "+_("做運費及交易的設定, 只需要設定一次喔!")+"                        </div>                    </div>",r=$("#result_put .catrst").text();r?r=[$("#result_put .catrst").text(),$("#result_put .subrst").text()].join(" "):r="";var i="";$("#gender option:selected").val()&&(i+=pinkoi.template('<a class="m-tag">%s</a>',$("#gender option:selected").text())),$("#occasion option:selected").val()&&(i+=pinkoi.template('<a class="m-tag">%s</a>',$("#occasion option:selected").text())),$("#style option:selected").val()&&(i+=pinkoi.template('<a class="m-tag">%s</a>',$("#style option:selected").text()));if($("#tag").val()){var s=$("#tag").val().split(" ");for(var o=0;o<s.length;++o)i+=pinkoi.template('<a class="m-tag">%s</a>',s[o])}var u=[];$("#meta input:checked").each(function(){u.push($(this).attr("phrase"))});for(var o=0;o<u.length;++o)i+=pinkoi.template('<a class="m-tag">%s</a>',u[o]);var a=pinkoi.panel.store.list.i18nMeta.pack()[pinkoi.panel.store.list.i18nMeta.gLocale];$("#preview").html(pinkoi.template(n,{title:a.title,description:pinkoi.util.nl2br(a.description),price:$("#price").val(),category:r,material:$("#material option:selected").text(),shipping:$("#shipping").val(),tag:i,madein:pinkoi.util.nl2br($("#madein").val()),quantity:$("#quantity").val(),photolist:e,color:$(".m-palette a.active").attr("value")||""}))},pinkoi.panel.store.list.submit=function(){if(window.panel_store_list_submitting)return;var e=$("#sell [name=photo]:input");if(!e.length)return pinkoi.drawer.on(_("記得挑選你的商品圖片哦")),pinkoi.panel.store.list.scrollableApi.seekTo(0),!1;var t=pinkoi.panel.store.list.i18nMeta.checkUnfilled();if(t.length)return pinkoi.drawer.on(_("記得輸入你的商品內容哦，詳細的描述會增加消費者對你商品的了解和信心！")),pinkoi.panel.store.list.i18nMeta.show(t[0]),pinkoi.panel.store.list.scrollableApi.seekTo(1),!1;var n=$("#madein"),r=$.trim(n.val());if(!r)return pinkoi.drawer.on(_("記得標明你的商品產地及製造方式")),pinkoi.panel.store.list.scrollableApi.seekTo(1),pinkoi.focused(n),!1;var i=pinkoi.panel.store.list.i18nMeta.pack();for(var s in i)if(i.hasOwnProperty(s)){if(!pinkoi.checkViolation(i[s].description))return pinkoi.panel.store.list.i18nMeta.show(s),pinkoi.panel.store.list.scrollableApi.seekTo(1),!1;pinkoi.globals.locale==s&&(i[s].description+=_("\n產地/製造方式\n")+r)}var o=$("#category");if(typeof o.val()!="string")return pinkoi.drawer.on(_("記得幫你的商品分類，這樣大家才能迅速的找到它")),pinkoi.panel.store.list.scrollableApi.seekTo(2),pinkoi.focused(o),!1;var u=$("#subcategory");if(typeof u.val()!="string")return pinkoi.drawer.on(_("記得幫你的商品｢細部｣分類，這樣大家才能迅速的找到它")),pinkoi.panel.store.list.scrollableApi.seekTo(2),pinkoi.focused(u),!1;var a=$("#price"),f=parseInt(a.val(),10);if(!f)return pinkoi.drawer.on(_("你忘記設定價錢了，還是你要免費大放送?!")),pinkoi.panel.store.list.scrollableApi.seekTo(3),pinkoi.focused(a),!1;var l=$("#madetoorder");if(l.is(":checked")&&!parseInt($("#waittime").val(),10))return pinkoi.drawer.on(_("請設定接單訂製的等待時間")),pinkoi.panel.store.list.scrollableApi.seekTo(3),pinkoi.focused($("#waittime")),!1;if($("#checkautomanage").is(":checked")&&!parseInt($("#automanage").val(),10))return pinkoi.drawer.on(_("請設定自動更新多少數量")),pinkoi.panel.store.list.scrollableApi.seekTo(3),pinkoi.focused($("#automanage")),!1;if($("#checkpreorder").is(":checked")&&!$("#preorder").val())return pinkoi.drawer.on(_("請設定預計開始出貨的日期和時間")),pinkoi.panel.store.list.scrollableApi.seekTo(3),pinkoi.focused($("#preorder")),!1;var c=$("#quantity"),h=parseInt(c.val(),10);if(!h)return pinkoi.drawer.on(_("請設定商品的數量")),pinkoi.panel.store.list.scrollableApi.seekTo(3),pinkoi.focused(c),!1;var p={i18n_meta:JSON.stringify(i)};$.each($("#sell").find(":input"),function(){var e=$(this),t=e.attr("name"),n=e.val();if(t==="i18n-meta-selectbox"||t==="title"||t==="description")return!0;t=="variation"&&(n=$.trim(n.replace(/\s*,\s*/," "))),t!=="meta"&&(p[t]?p[t]=p[t]+","+n:p[t]=n)}),$("#meta input:checked").each(function(){var e=$(this),t=e.attr("name"),n=e.val();p.meta?p.meta=p.meta+","+n:p.meta=n});var d=$("#permissions").find("input:checked");if(!d.length)return pinkoi.drawer.on(_("請選擇此商品的販售種類")),pinkoi.panel.store.list.scrollableApi.seekTo(4),!1;p.meta?p.meta=p.meta+","+d.eq(0).val():p.meta=d.eq(0).val(),p.permit=d.eq(0).val(),$("#madetoorder").is(":checked")?p.madetoorder=parseInt($("#waittime").val(),10)||7:p.madetoorder=0,$("#checkautomanage").is(":checked")?p.automanage=parseInt($("#automanage").val())||1:p.automanage=0,$("#checkpreorder").is(":checked")||(p.preorder="");var v=$(".m-palette a.active");v?p.color=v.attr("value"):p.color="";var m=$("#gender option:selected");m.val()?p.gender=m.val():p.gender="";var g=$("#occasion option:selected");g.val()?p.occasion=g.val():p.occasion="";var y=$("#style option:selected");y.val()?p.style=y.val():p.style="",window.panel_store_list_submitting=!0,pinkoi.drawer.on(_("請耐心稍候，商品上架中.......")),pinkoi.onbeforeunload(function(){return _("可能有點緩慢，但商品仍然還在上架中.......")}),require(["ui/backdrop","app/pages/panel/sizechart"],function(e,t){e.show({withLoader:!0}),pinkoi.panel.store.sizechart=!1,t.edited&&(p.sizechart=t.edited,pinkoi.panel.store.sizechart=!0),pinkoi.request("POST",pinkoi.uri.sell,{data:p,success:function(t){e.hide(),window.onbeforeunload=$.noop,window.panel_store_list_submitting=!1;if(t.status=="ok"){var n=p.photo.split(",");$.each($("#wizard #dragdrop_get img"),function(){var e=$(this);$.each(n,function(t,n){var r=new RegExp("/"+n+"$");if(r.test(e.attr("srcuri")))return e.remove(),!1})}),$("#dragdrop_get img").length?pinkoi.gmodal.load('                        <h3 class="g_panel_store_list">'+_("你的商品已經被成功上架")+'</h3>                        <table class="g_panel_store_list"><tbody><tr>                            <td class="g_panel_store_list"><a class="button" onclick="pinkoi.panel.store.list.resetForm();pinkoi.gmodal.close();">'+_("繼續上架新商品")+'</a></td>                            <td class="g_panel_store_list"><a class="button" onclick="pinkoi.panel.store.list.resetForm(true);pinkoi.gmodal.close();">'+_("不清空表單內容<br/>繼續上架新商品<b>方便你同性質的商品重複上架</b>")+'</a></td>                            <td class="g_panel_store_list"><a class="button" href="'+pinkoi.conf.itemURL(t.result.tid)+'">'+_("看你剛上架的商品")+"</a></td>                        </tr></tbody></table>"):pinkoi.gmodal.load('                        <h3 class="g_panel_store_list">'+_("你的商品已經被成功上架")+'</h3>                        <table class="g_panel_store_list"><tbody><tr>                            <td class="g_panel_store_list"><a class="button" onclick="location.reload();">'+_("繼續上架新商品")+'</a></td>                            <td class="g_panel_store_list"><a class="button" href="'+pinkoi.conf.itemURL(t.result.tid)+'">'+_("看你剛上架的商品")+"</a></td>                        </tr></tbody></table>"),pinkoi.gmodal.onetimeOnBeforeClose=function(){window.location.href=pinkoi.conf.itemURL(t.result.tid)}}else pinkoi.error()}})})},pinkoi.panel.store.list.resetForm=function(e){pinkoi.gmodal.onetimeOnBeforeClose=$.noop;if(e){pinkoi.panel.store.list.picked.length=0,$.each($("#dragdrop_wrap #droppable_put .droppable img"),function(){$(this).remove()}),pinkoi.panel.store.list.scrollableApi.seekTo(0);return}pinkoi.panel.store.list.picked.length=0,$.each($("#dragdrop_wrap #droppable_put .droppable img"),function(){$(this).remove()}),$("#wizard [name=photo]:input").remove(),$("#wizard #description, #wizard #title, #wizard #price, #wizard #tag").val(""),$("#quantity option").eq(0).attr("selected","selected"),$("#category option").eq(0).attr("selected","selected"),$("#category").eq(0).change(),$("#material option").eq(0).attr("selected","selected"),$("#meta :checked").each(function(){$(this).attr("checked",!1)}),$("#wizard :input[name=variation]").val("").each(function(e){e>1&&$(this).remove()}),pinkoi.panel.store.list.i18nMeta.reset(),pinkoi.panel.store.list.scrollableApi.seekTo(0)},pinkoi=typeof pinkoi=="undefined"?{}:pinkoi,pinkoi.embed||(pinkoi.embed=function(e,t){this.opt=t||{},this.type=e,this.mode=this.opt.mode||"detail",this.rows=parseInt(this.opt.rows||1),this.cols=parseInt(this.opt.cols||1),this.uid=this.opt.uid||null,this.tid=this.opt.tid||null,this.store=this.opt.store||null},pinkoi.embed.prototype={getHeight:function(){return this.type=="choose"?(pinkoi.embed.config.style.item[this.mode].height+pinkoi.embed.config.style.item[this.mode].pad)*(this.rows+1)+pinkoi.embed.config.style.footer.height:(pinkoi.embed.config.style.item[this.mode].height+pinkoi.embed.config.style.item[this.mode].pad)*this.rows+pinkoi.embed.config.style.footer.height},getWidth:function(){return(pinkoi.embed.config.style.item[this.mode].width+pinkoi.embed.config.style.item[this.mode].pad)*this.cols},getSrc:function(){return pinkoi.embed.config.iframeURL+"type="+this.type+(this.mode?"&mode="+this.mode:"")+(this.uid?"&uid="+encodeURIComponent(this.uid):"")+(this.tid?"&tid="+encodeURIComponent(this.tid):"")+(this.store?"&store="+encodeURIComponent(this.store):"")+(this.rows?"&rows="+this.rows:"")+(this.cols?"&cols="+this.cols:"")+"&ts="+(new Date).getTime()/1e5},render:function(e){var t='<iframe allowtransparency="true" scrolling="yes" frameborder="0" height="'+this.getHeight()+'" width="'+this.getWidth()+'" '+'style="width:'+this.getWidth()+"px;"+"height:"+this.getHeight()+'px;" '+'src="'+this.getSrc()+'"></iframe>';e?document.getElementById(e).innerHTML=t:document.write(t)}},pinkoi.embed.config={iframeURL:"http://www.pinkoi.com/embed?",style:{item:{detail:{height:195,width:160,pad:30},simple:{height:80,width:80,pad:18}},footer:{height:30}}}),pinkoi.namespace("pinkoi.browseHistory"),pinkoi.browseHistory=function(){var e=$.webStorage.local().getItem(pinkoi.webStorageConf.local.itemBrowseHistory)||[],t=$.webStorage.local().getItem(pinkoi.webStorageConf.local.postBrowseHistory)||[],n=["new","list","preview"];if(pinkoi.pwd.where=="product")try{var r=pinkoi.pwd.tid;if(r&&$.inArray(r,n)==-1){for(var i=0,s=e.length;i<s;i++)if(r==e[i].tid){e.splice(i,1);break}var o=$('head meta[property="og:title"]').attr("content"),u=$("#cart .price i").html()+$("#cart .price b").html();o&&u&&(e=[{tid:r,title:o,price:u}].concat(e),e.length>35&&(e.length=35),$.webStorage.local().setItem(pinkoi.webStorageConf.local.itemBrowseHistory,e))}}catch(a){}else if(pinkoi.pwd.where=="magz")try{var r=pinkoi.pwd.tid;if(r&&$.inArray(r,n)==-1){for(var i=0,s=t.length;i<s;i++)if(r==t[i].tid){t.splice(i,1);break}var o=$('head meta[property="og:title"]').attr("content"),f=$('head meta[property="og:image"]').attr("content");o&&f&&(t=[{tid:r,title:o,photo:f}].concat(t),t.length>35&&(t.length=35),$.webStorage.local().setItem(pinkoi.webStorageConf.local.postBrowseHistory,t))}}catch(a){}pinkoi.browseHistory.render(7,!0)},pinkoi.browseHistory.render=function(e,t){$(".g-browse-history").remove(),e=e||7;var n=c="",r="<li onclick=\"gTrackEvent('History', '%(itemUrl)s'); location.href='%(itemUrl)s';\"><img "+(t?"":'class="m-dom-lazy" src="http://cdn04.pinkoi.com/pinkoi.site/space.gif" data-')+'src="%(photo)s"><div><span>%(title)s</span><i>%(price)s</i></div></li>',i="<li onclick=\"gTrackEvent('History', '%(magzUrl)s'); location.href='%(magzUrl)s';\"><img "+(t?"":'class="m-dom-lazy" src="http://cdn04.pinkoi.com/pinkoi.site/space.gif" data-')+'src="%(photo)s" onload="window.imgload(this,1);" onerror="window.imgerror(this,1);" resize_onload="1" mindim="120" external_source="1"><div><span>%(title)s</span></div></li>',s=$.webStorage.local().getItem(pinkoi.webStorageConf.local.itemBrowseHistory),o=$.webStorage.local().getItem(pinkoi.webStorageConf.local.postBrowseHistory);if(s){var u,n=[];for(var a=0,f=s.length;a<f;a++){if(a>=e)break;u=s[a],n.push(pinkoi.template(r,{itemUrl:pinkoi.conf.itemURL(u.tid),photo:pinkoi.conf.itemImageUrl(u.tid,"160x160"),title:u.title,price:u.price}))}n='<ul class="g-browse-history-item clr">'+n.join("")+"</ul>"}if(o){var l,c=[];for(var a=0,f=o.length;a<f;a++){if(a>=e)break;l=o[a],c.push(pinkoi.template(i,{magzUrl:pinkoi.conf.magzUrl(l.tid),photo:l.photo,title:l.title}))}c='<ul class="g-browse-history-post clr">'+c.join("")+"</ul>"}if(n||c){var h='<section class="g-browse-history"><h2>'+_("你的瀏覽紀錄小秘書")+"</h2>";n&&(h+="<h3>"+_("你最近瀏覽過的商品")+"...</h3>"+n),c&&(h+="<h3>"+_("你最近瀏覽過的設計誌")+"...</h3>"+c);if(o&&o.length>e||s&&s.length>e)h+='<a class="more" onclick="pinkoi.browseHistory.render(35, true);">'+_("看更多紀錄")+"</a>";$("#g-footer").before(h+"</section>")}},pinkoi.namespace("pinkoi.point"),pinkoi.point.conf={expired:15,fullBar:10,plusExpired:600},pinkoi.point.init=function(){if(pinkoi.globals.get("uid")){pinkoi.point.now=parseInt((new Date).getTime()/1e3,10);var e=$.webStorage.local().getItem(pinkoi.webStorageConf.local.point);(!e||pinkoi.point.now-e.updated>pinkoi.point.conf.expired)&&pinkoi.request("GET_mute",pinkoi.uri.user_point+"?"+pinkoi.point.now,{success:function(t){if(t.status=="ok"){var n=t.result;e={updated:pinkoi.point.now,points:n.points},n.plus&&n.now-n.updated<pinkoi.point.conf.plusExpired&&(e.plus=n.plus,e.plusUpdated=pinkoi.point.now-(n.now-n.updated)),$.webStorage.local().setItem(pinkoi.webStorageConf.local.point,e),pinkoi.point.render(e)}}}),pinkoi.point.$point=$("#gheader").find(".point"),pinkoi.point.$point.html(_("目前紅利")+'：<b class="total"></b>'+_("點")+' ( <a href="/page/reward" target="_blank">?</a> )<div class="barwrap"><b style="width:0"><i style="width:0"></i></b><img src="//s3-ap-southeast-1.amazonaws.com/pinkoi.site/general/point-bg.gif"></div><div class="bubble" style="display:none"><div class="arrow"></div><div class="lt"></div><div class="plus"></div><div class="rt"></div></div>'),pinkoi.point.render(e)}},pinkoi.point.commit=function(){pinkoi.notify(_("你的紅利點數正在重新計算中")+' (<a href="/page/reward" target="_blank">?</a>)');var e=$.webStorage.local().getItem(pinkoi.webStorageConf.local.point);if(e){var t=parseInt((new Date).getTime()/1e3,10),n=3;e.updated=t-pinkoi.point.conf.expired+n,$.webStorage.local().setItem(pinkoi.webStorageConf.local.point,e)}},pinkoi.point.renew=function(){$.webStorage.local().removeItem(pinkoi.webStorageConf.local.point)},pinkoi.point.get=function(){return $.webStorage.local().getItem(pinkoi.webStorageConf.local.point)||0},pinkoi.point.render=function(e){e=e||$.webStorage.local().getItem(pinkoi.webStorageConf.local.point),pinkoi.point.$point.find(".total").html(e.points);var t=parseInt(Math.sqrt(e.points),10);t=t>99?100:t,pinkoi.point.$point.find(".barwrap b").css({width:t+"%"}),e.plus&&(pinkoi.point.now-e.plusUpdated>pinkoi.point.conf.plusExpired||(pinkoi.point.$point.find(".barwrap b i").css({width:parseInt(e.plus/e.points*100,10)+"%"}),pinkoi.point.$point.find(".bubble").css({marginLeft:pinkoi.point.$point.find("i").position().left-12}).show().find(".plus").html("+"+e.plus)))};pinkoi.tip=function(e){e=e||{};var t="bottomMiddle",n="topMiddle";e.where=="top"?(t="bottomMiddle",n="topMiddle"):e.where=="right"?(t="leftTop",n="rightTop"):e.where=="bottom"?(t="topMiddle",n="bottomMiddle"):e.where=="left"&&(t="rightTop",n="leftMiddle"),$(function(){$(e.selector).qtip({content:e.content||"",position:{corner:{tooltip:t,target:n}},show:{ready:!0,effect:{length:30}},hide:!1,style:{width:"auto",fontSize:"12px",letterSpacing:"1px",lineHeight:"1.5em",color:"#333333",border:{width:6,radius:6,color:"#96cdc6"},background:"#FFFFFF",padding:8,tip:{corner:t,color:"#96cdc6",size:{x:12,y:12}}}}),$(e.selector).on("change",function(e){$(".qtip").remove()})})},pinkoi.tip.remove=function(e,t){pinkoi.mark.mark(t),$(e).closest(".qtip").remove()},$(function(){var e=pinkoi.pwd.where;e=="product"&&(pinkoi.mark.hasa("tip_product_fav")||(pinkoi.tip({selector:"#cart a.g_favlist",content:_("你可以收藏商品到你專屬的慾望清單<br/>還可以在你的個人頁管理慾望清單")+'<br/><a class="g_remove_btn" onclick="pinkoi.tip.remove(this, \'tip_product_fav\');">'+_("好! 我知道了")+"</a>",where:"right"}),$("#cart a.g_favlist").bind("click",function(){pinkoi.mark.mark("tip_product_fav")})))}),pinkoi.globals.get("uid")?pinkoi.globals.get("unreadMsg")&&$("#gheader .message").after('<a class="notice_unread" href="/message">'+pinkoi.globals.get("unreadMsg")+"</a>"):pinkoi.urlParam.get("next")&&pinkoi.login_modal.load(),pinkoi.loadjscssfile=function(e,t){if(t=="js"){var n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e)}else if(t=="css"){var n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href",e)}typeof n!="undefined"&&document.getElementsByTagName("head")[0].appendChild(n)},/Windows NT 5.1/.test(navigator.userAgent)&&pinkoi.loadjscssfile("/media/css/xp.css","css"),function(e){function i(e){return e.nodeName.toLowerCase()=="input"&&(e.type.toLowerCase()=="text"||e.typetoLowerCase()=="button")}function s(t){try{function s(r,s,o){var u={};u.appid=n.appID,u.to=t,u.from=n.listLanguage,u.text=r,u.contentType="text/html",e.ajax({url:"http://api.microsofttranslator.com/V2/Ajax.svc/Translate",data:u,dataType:"jsonp",jsonp:"oncomplete",complete:function(e,t){},success:function(t,r){i(s)?e(s).val(t):e(s).html(t),s===o&&n.callback&&n.callback()},error:function(e,t,n){}})}var o=null,u=null;r.$this.each(function(t,n){if(!n)return;o=e(n).attr("src_text");if(!o)return;s(o,n,r.$this.length-1===t?n:null)})}catch(a){alert(a.messsage)}}function o(){function o(i){function u(){function o(o){setupLanguageNamesList=function(o){function f(){var t=e("#_supportedLanguagesList option");t.sort(function(e,t){return e.text.localeCompare(t.text)}),e("#_supportedLanguagesList").empty().append(t)}var u=document.createElement("select");u.id="_supportedLanguagesList";var l=[];for(var v=0;v<o.length;v++)l.push({value:i[v],text:o[v]});for(var v=0;v<o.length;v++){var m=e(document.createElement("option"));m.text(l[v].text),m.val(l[v].value),u.appendChild(m.get(0))}e(u).bind("change",function(){var n=e("#_supportedLanguagesList").val();t.create(r.cookieName,n,365),s(n)}),u.style.cssText="margin:0; padding:0;";var y=document.createElement("div");y.id="_translateElements",y.appendChild(u),n.languageListNode?(y.style.cssText="position:relative;overflow:hidden;z-index:3;",n.languageListNode.style.visibility="visible"):(n.languageListNode=document.body,y.style.cssText="top:8px;right:12px;position:absolute");var b=n.languageListNode;b.appendChild(y),f();var w=t.read(r.cookieName),E=w?w:n.listLanguage;e(u).val(E),w?s(w):n.callback&&n.callback()};var u={appid:n.appID,locale:n.listLanguage,languageCodes:o};e.ajax({url:"http://api.microsofttranslator.com/V2/Ajax.svc/GetLanguageNames",data:u,dataType:"jsonp",jsonp:"oncomplete",complete:function(e,t){},success:function(e,t){setupLanguageNamesList(e)}})}var i=[];formatLanguageCodes=function(e){i=e;for(var t=0;t<e.length;t++)u+=(u.length?",":"")+'"'+e[t]+'"';return o("["+u+"]")};var u="";if(n.languagesList)formatLanguageCodes(n.languagesList);else{var f={appid:n.appID};e.ajax({url:"http://api.microsofttranslator.com/V2/Ajax.svc/GetLanguagesForTranslate",data:f,dataType:"jsonp",jsonp:"oncomplete",complete:function(e,t){},success:function(e,t){formatLanguageCodes(e)}})}}function f(){try{var t=!1;r.$this.each(function(r,i){src_text=e(i).attr("src_text");if(!n.listLanguage&&src_text.length>20){var s={appid:n.appID,text:src_text};e.ajax({url:"http://api.microsofttranslator.com/V2/Ajax.svc/Detect",data:s,dataType:"jsonp",jsonp:"oncomplete",complete:function(e,t){},success:function(e,r){return t?!1:(n.listLanguage=e,t=!0,u())}})}})}catch(i){throw i}}var o=null;f()}function u(){try{r.$this.each(function(t,n){src_text=i(n)?e(n).val():e(n).html(),e(n).attr("src_text",src_text)})}catch(t){throw t}}u(),n.tolang?s(n.tolang):n.nolist?n.callback&&n.callback():o()}var t={read:function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return null},create:function(e,t,n){if(n){var r=new Date;r.setTime(r.getTime()+n*24*60*60*1e3);var i="; expires="+r.toGMTString()}else var i="";try{document.cookie=e+"="+t+i+"; path=/"}catch(s){}},erase:function(e){this.create(e,"",-1)}},n={appID:null,listLanguage:"",languageListNode:null,languagesList:null,nolist:!1,tolang:null,callback:null},r={$this:null,cookieName:"bhcTranslator"},u={init:function(t){return r.$this=this,t&&e.extend(n,t),o(),this},destroy:function(){return this.each(function(){e(window).unbind(".translator")})}};e.fn.translator=function(t){if(u[t])return u[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return u.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.translator")}}(jQuery);